
<!doctype html>
<html lang="en" class="no-js">
  <head>
    
      <meta charset="utf-8">
      <meta name="viewport" content="width=device-width,initial-scale=1">
      
      
      
        <link rel="canonical" href="http://Documentacion_Renovacion:Reaseguro.com/Docstrings/">
      
      
        <link rel="prev" href="../S4_Calculos_Renovacion/">
      
      
      
      <link rel="icon" href="../assets/images/favicon.png">
      <meta name="generator" content="mkdocs-1.6.1, mkdocs-material-9.5.49">
    
    
      
        <title>Docstrings - Documentacion</title>
      
    
    
      <link rel="stylesheet" href="../assets/stylesheets/main.6f8fc17f.min.css">
      
        
        <link rel="stylesheet" href="../assets/stylesheets/palette.06af60db.min.css">
      
      


    
    
      
    
    
      
        
        
        <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
        <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Roboto:300,300i,400,400i,700,700i%7CRoboto+Mono:400,400i,700,700i&display=fallback">
        <style>:root{--md-text-font:"Roboto";--md-code-font:"Roboto Mono"}</style>
      
    
    
      <link rel="stylesheet" href="../assets/_mkdocstrings.css">
    
    <script>__md_scope=new URL("..",location),__md_hash=e=>[...e].reduce(((e,_)=>(e<<5)-e+_.charCodeAt(0)),0),__md_get=(e,_=localStorage,t=__md_scope)=>JSON.parse(_.getItem(t.pathname+"."+e)),__md_set=(e,_,t=localStorage,a=__md_scope)=>{try{t.setItem(a.pathname+"."+e,JSON.stringify(_))}catch(e){}}</script>
    
      

    
    
    
  </head>
  
  
    
    
      
    
    
    
    
    <body dir="ltr" data-md-color-scheme="slate" data-md-color-primary="green" data-md-color-accent="deep-purple">
  
    
    <input class="md-toggle" data-md-toggle="drawer" type="checkbox" id="__drawer" autocomplete="off">
    <input class="md-toggle" data-md-toggle="search" type="checkbox" id="__search" autocomplete="off">
    <label class="md-overlay" for="__drawer"></label>
    <div data-md-component="skip">
      
        
        <a href="#S0_Loaders" class="md-skip">
          Skip to content
        </a>
      
    </div>
    <div data-md-component="announce">
      
    </div>
    
    
      

  

<header class="md-header md-header--shadow" data-md-component="header">
  <nav class="md-header__inner md-grid" aria-label="Header">
    <a href=".." title="Documentacion" class="md-header__button md-logo" aria-label="Documentacion" data-md-component="logo">
      
  
  <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M12 8a3 3 0 0 0 3-3 3 3 0 0 0-3-3 3 3 0 0 0-3 3 3 3 0 0 0 3 3m0 3.54C9.64 9.35 6.5 8 3 8v11c3.5 0 6.64 1.35 9 3.54 2.36-2.19 5.5-3.54 9-3.54V8c-3.5 0-6.64 1.35-9 3.54"/></svg>

    </a>
    <label class="md-header__button md-icon" for="__drawer">
      
      <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M3 6h18v2H3zm0 5h18v2H3zm0 5h18v2H3z"/></svg>
    </label>
    <div class="md-header__title" data-md-component="header-title">
      <div class="md-header__ellipsis">
        <div class="md-header__topic">
          <span class="md-ellipsis">
            Documentacion
          </span>
        </div>
        <div class="md-header__topic" data-md-component="header-topic">
          <span class="md-ellipsis">
            
              Docstrings
            
          </span>
        </div>
      </div>
    </div>
    
      
        <form class="md-header__option" data-md-component="palette">
  
    
    
    
    <input class="md-option" data-md-color-media="" data-md-color-scheme="slate" data-md-color-primary="green" data-md-color-accent="deep-purple"  aria-label="Dark mode"  type="radio" name="__palette" id="__palette_0">
    
      <label class="md-header__button md-icon" title="Dark mode" for="__palette_1" hidden>
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M12 7a5 5 0 0 1 5 5 5 5 0 0 1-5 5 5 5 0 0 1-5-5 5 5 0 0 1 5-5m0 2a3 3 0 0 0-3 3 3 3 0 0 0 3 3 3 3 0 0 0 3-3 3 3 0 0 0-3-3m0-7 2.39 3.42C13.65 5.15 12.84 5 12 5s-1.65.15-2.39.42zM3.34 7l4.16-.35A7.2 7.2 0 0 0 5.94 8.5c-.44.74-.69 1.5-.83 2.29zm.02 10 1.76-3.77a7.131 7.131 0 0 0 2.38 4.14zM20.65 7l-1.77 3.79a7.02 7.02 0 0 0-2.38-4.15zm-.01 10-4.14.36c.59-.51 1.12-1.14 1.54-1.86.42-.73.69-1.5.83-2.29zM12 22l-2.41-3.44c.74.27 1.55.44 2.41.44.82 0 1.63-.17 2.37-.44z"/></svg>
      </label>
    
  
    
    
    
    <input class="md-option" data-md-color-media="" data-md-color-scheme="default" data-md-color-primary="blue" data-md-color-accent="deep-orange"  aria-label="Light mode"  type="radio" name="__palette" id="__palette_1">
    
      <label class="md-header__button md-icon" title="Light mode" for="__palette_0" hidden>
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="m17.75 4.09-2.53 1.94.91 3.06-2.63-1.81-2.63 1.81.91-3.06-2.53-1.94L12.44 4l1.06-3 1.06 3zm3.5 6.91-1.64 1.25.59 1.98-1.7-1.17-1.7 1.17.59-1.98L15.75 11l2.06-.05L18.5 9l.69 1.95zm-2.28 4.95c.83-.08 1.72 1.1 1.19 1.85-.32.45-.66.87-1.08 1.27C15.17 23 8.84 23 4.94 19.07c-3.91-3.9-3.91-10.24 0-14.14.4-.4.82-.76 1.27-1.08.75-.53 1.93.36 1.85 1.19-.27 2.86.69 5.83 2.89 8.02a9.96 9.96 0 0 0 8.02 2.89m-1.64 2.02a12.08 12.08 0 0 1-7.8-3.47c-2.17-2.19-3.33-5-3.49-7.82-2.81 3.14-2.7 7.96.31 10.98 3.02 3.01 7.84 3.12 10.98.31"/></svg>
      </label>
    
  
</form>
      
    
    
      <script>var palette=__md_get("__palette");if(palette&&palette.color){if("(prefers-color-scheme)"===palette.color.media){var media=matchMedia("(prefers-color-scheme: light)"),input=document.querySelector(media.matches?"[data-md-color-media='(prefers-color-scheme: light)']":"[data-md-color-media='(prefers-color-scheme: dark)']");palette.color.media=input.getAttribute("data-md-color-media"),palette.color.scheme=input.getAttribute("data-md-color-scheme"),palette.color.primary=input.getAttribute("data-md-color-primary"),palette.color.accent=input.getAttribute("data-md-color-accent")}for(var[key,value]of Object.entries(palette.color))document.body.setAttribute("data-md-color-"+key,value)}</script>
    
    
    
      <label class="md-header__button md-icon" for="__search">
        
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M9.5 3A6.5 6.5 0 0 1 16 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.52 6.52 0 0 1 9.5 16 6.5 6.5 0 0 1 3 9.5 6.5 6.5 0 0 1 9.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5"/></svg>
      </label>
      <div class="md-search" data-md-component="search" role="dialog">
  <label class="md-search__overlay" for="__search"></label>
  <div class="md-search__inner" role="search">
    <form class="md-search__form" name="search">
      <input type="text" class="md-search__input" name="query" aria-label="Search" placeholder="Search" autocapitalize="off" autocorrect="off" autocomplete="off" spellcheck="false" data-md-component="search-query" required>
      <label class="md-search__icon md-icon" for="__search">
        
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M9.5 3A6.5 6.5 0 0 1 16 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.52 6.52 0 0 1 9.5 16 6.5 6.5 0 0 1 3 9.5 6.5 6.5 0 0 1 9.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5"/></svg>
        
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M20 11v2H8l5.5 5.5-1.42 1.42L4.16 12l7.92-7.92L13.5 5.5 8 11z"/></svg>
      </label>
      <nav class="md-search__options" aria-label="Search">
        
        <button type="reset" class="md-search__icon md-icon" title="Clear" aria-label="Clear" tabindex="-1">
          
          <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M19 6.41 17.59 5 12 10.59 6.41 5 5 6.41 10.59 12 5 17.59 6.41 19 12 13.41 17.59 19 19 17.59 13.41 12z"/></svg>
        </button>
      </nav>
      
    </form>
    <div class="md-search__output">
      <div class="md-search__scrollwrap" tabindex="0" data-md-scrollfix>
        <div class="md-search-result" data-md-component="search-result">
          <div class="md-search-result__meta">
            Initializing search
          </div>
          <ol class="md-search-result__list" role="presentation"></ol>
        </div>
      </div>
    </div>
  </div>
</div>
    
    
  </nav>
  
</header>
    
    <div class="md-container" data-md-component="container">
      
      
        
          
        
      
      <main class="md-main" data-md-component="main">
        <div class="md-main__inner md-grid">
          
            
              
              <div class="md-sidebar md-sidebar--primary" data-md-component="sidebar" data-md-type="navigation" >
                <div class="md-sidebar__scrollwrap">
                  <div class="md-sidebar__inner">
                    



<nav class="md-nav md-nav--primary" aria-label="Navigation" data-md-level="0">
  <label class="md-nav__title" for="__drawer">
    <a href=".." title="Documentacion" class="md-nav__button md-logo" aria-label="Documentacion" data-md-component="logo">
      
  
  <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M12 8a3 3 0 0 0 3-3 3 3 0 0 0-3-3 3 3 0 0 0-3 3 3 3 0 0 0 3 3m0 3.54C9.64 9.35 6.5 8 3 8v11c3.5 0 6.64 1.35 9 3.54 2.36-2.19 5.5-3.54 9-3.54V8c-3.5 0-6.64 1.35-9 3.54"/></svg>

    </a>
    Documentacion
  </label>
  
  <ul class="md-nav__list" data-md-scrollfix>
    
      
      
  
  
  
  
    <li class="md-nav__item">
      <a href="../S0_Loaders/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Clase Loaders
  </span>
  

      </a>
    </li>
  

    
      
      
  
  
  
  
    <li class="md-nav__item">
      <a href="../S1_Parametros_Calculo/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Parametros de Calculo
  </span>
  

      </a>
    </li>
  

    
      
      
  
  
  
  
    <li class="md-nav__item">
      <a href="../S2_Funciones.md" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Funciones
  </span>
  

      </a>
    </li>
  

    
      
      
  
  
  
  
    <li class="md-nav__item">
      <a href="../S3_Pre_Procesamiento/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Preprocesamiento
  </span>
  

      </a>
    </li>
  

    
      
      
  
  
  
  
    <li class="md-nav__item">
      <a href="../S4_Calculos_Renovacion/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Renovacion
  </span>
  

      </a>
    </li>
  

    
      
      
  
  
  
  
    <li class="md-nav__item">
      <a href="../S5_Automatizacion_Calculos.md" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Funcion Principal
  </span>
  

      </a>
    </li>
  

    
      
      
  
  
    
  
  
  
    <li class="md-nav__item md-nav__item--active">
      
      <input class="md-nav__toggle md-toggle" type="checkbox" id="__toc">
      
      
      
        <label class="md-nav__link md-nav__link--active" for="__toc">
          
  
  <span class="md-ellipsis">
    Docstrings
  </span>
  

          <span class="md-nav__icon md-icon"></span>
        </label>
      
      <a href="./" class="md-nav__link md-nav__link--active">
        
  
  <span class="md-ellipsis">
    Docstrings
  </span>
  

      </a>
      
        

<nav class="md-nav md-nav--secondary" aria-label="Table of contents">
  
  
  
  
    <label class="md-nav__title" for="__toc">
      <span class="md-nav__icon md-icon"></span>
      Table of contents
    </label>
    <ul class="md-nav__list" data-md-component="toc" data-md-scrollfix>
      
        <li class="md-nav__item">
  <a href="#S0_Loaders" class="md-nav__link">
    <span class="md-ellipsis">
      S0_Loaders
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#S0_Loaders.Parameter_Loader" class="md-nav__link">
    <span class="md-ellipsis">
      Parameter_Loader
    </span>
  </a>
  
    <nav class="md-nav" aria-label="Parameter_Loader">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#S0_Loaders.Parameter_Loader.__init__" class="md-nav__link">
    <span class="md-ellipsis">
      __init__
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#S0_Loaders.Parameter_Loader.get_reference" class="md-nav__link">
    <span class="md-ellipsis">
      get_reference
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#S0_Loaders.Parameter_Loader.get_table_txt" class="md-nav__link">
    <span class="md-ellipsis">
      get_table_txt
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#S0_Loaders.Parameter_Loader.get_table_xlsx" class="md-nav__link">
    <span class="md-ellipsis">
      get_table_xlsx
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#S1_Parametros_Calculo" class="md-nav__link">
    <span class="md-ellipsis">
      S1_Parametros_Calculo
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#S1_Parametros_Calculo.carga_parametros" class="md-nav__link">
    <span class="md-ellipsis">
      carga_parametros
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#S2_Funciones" class="md-nav__link">
    <span class="md-ellipsis">
      S2_Funciones
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#S2_Funciones.asignacion_contratos" class="md-nav__link">
    <span class="md-ellipsis">
      asignacion_contratos
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#S2_Funciones.asignacion_vigencias" class="md-nav__link">
    <span class="md-ellipsis">
      asignacion_vigencias
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#S2_Funciones.automatizacion_querys" class="md-nav__link">
    <span class="md-ellipsis">
      automatizacion_querys
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#S2_Funciones.calcula_edad" class="md-nav__link">
    <span class="md-ellipsis">
      calcula_edad
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#S2_Funciones.calcula_exposicion" class="md-nav__link">
    <span class="md-ellipsis">
      calcula_exposicion
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#S2_Funciones.calculo_fechas_renovacion" class="md-nav__link">
    <span class="md-ellipsis">
      calculo_fechas_renovacion
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#S2_Funciones.completa_campo" class="md-nav__link">
    <span class="md-ellipsis">
      completa_campo
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#S2_Funciones.completa_campo_total" class="md-nav__link">
    <span class="md-ellipsis">
      completa_campo_total
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#S2_Funciones.corrige_tasas_ges" class="md-nav__link">
    <span class="md-ellipsis">
      corrige_tasas_ges
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#S2_Funciones.cruce_left" class="md-nav__link">
    <span class="md-ellipsis">
      cruce_left
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#S2_Funciones.cumulo_riesgo" class="md-nav__link">
    <span class="md-ellipsis">
      cumulo_riesgo
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#S2_Funciones.cumulos" class="md-nav__link">
    <span class="md-ellipsis">
      cumulos
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#S2_Funciones.ejecuta_query" class="md-nav__link">
    <span class="md-ellipsis">
      ejecuta_query
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#S2_Funciones.escribe_reporta" class="md-nav__link">
    <span class="md-ellipsis">
      escribe_reporta
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#S2_Funciones.filtra_una_combinacion" class="md-nav__link">
    <span class="md-ellipsis">
      filtra_una_combinacion
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#S2_Funciones.get_all_subsets" class="md-nav__link">
    <span class="md-ellipsis">
      get_all_subsets
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#S2_Funciones.identificador_anonimo" class="md-nav__link">
    <span class="md-ellipsis">
      identificador_anonimo
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#S2_Funciones.recargos" class="md-nav__link">
    <span class="md-ellipsis">
      recargos
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#S2_Funciones.split_querys" class="md-nav__link">
    <span class="md-ellipsis">
      split_querys
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#S3_Pre_Procesamiento" class="md-nav__link">
    <span class="md-ellipsis">
      S3_Pre_Procesamiento
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#S3_Pre_Procesamiento.pre_procesamiento" class="md-nav__link">
    <span class="md-ellipsis">
      pre_procesamiento
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#S4_Calculos_Renovacion" class="md-nav__link">
    <span class="md-ellipsis">
      S4_Calculos_Renovacion
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#S4_Calculos_Renovacion.calculos_renovacion" class="md-nav__link">
    <span class="md-ellipsis">
      calculos_renovacion
    </span>
  </a>
  
</li>
      
    </ul>
  
</nav>
      
    </li>
  

    
  </ul>
</nav>
                  </div>
                </div>
              </div>
            
            
              
              <div class="md-sidebar md-sidebar--secondary" data-md-component="sidebar" data-md-type="toc" >
                <div class="md-sidebar__scrollwrap">
                  <div class="md-sidebar__inner">
                    

<nav class="md-nav md-nav--secondary" aria-label="Table of contents">
  
  
  
  
    <label class="md-nav__title" for="__toc">
      <span class="md-nav__icon md-icon"></span>
      Table of contents
    </label>
    <ul class="md-nav__list" data-md-component="toc" data-md-scrollfix>
      
        <li class="md-nav__item">
  <a href="#S0_Loaders" class="md-nav__link">
    <span class="md-ellipsis">
      S0_Loaders
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#S0_Loaders.Parameter_Loader" class="md-nav__link">
    <span class="md-ellipsis">
      Parameter_Loader
    </span>
  </a>
  
    <nav class="md-nav" aria-label="Parameter_Loader">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#S0_Loaders.Parameter_Loader.__init__" class="md-nav__link">
    <span class="md-ellipsis">
      __init__
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#S0_Loaders.Parameter_Loader.get_reference" class="md-nav__link">
    <span class="md-ellipsis">
      get_reference
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#S0_Loaders.Parameter_Loader.get_table_txt" class="md-nav__link">
    <span class="md-ellipsis">
      get_table_txt
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#S0_Loaders.Parameter_Loader.get_table_xlsx" class="md-nav__link">
    <span class="md-ellipsis">
      get_table_xlsx
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#S1_Parametros_Calculo" class="md-nav__link">
    <span class="md-ellipsis">
      S1_Parametros_Calculo
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#S1_Parametros_Calculo.carga_parametros" class="md-nav__link">
    <span class="md-ellipsis">
      carga_parametros
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#S2_Funciones" class="md-nav__link">
    <span class="md-ellipsis">
      S2_Funciones
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#S2_Funciones.asignacion_contratos" class="md-nav__link">
    <span class="md-ellipsis">
      asignacion_contratos
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#S2_Funciones.asignacion_vigencias" class="md-nav__link">
    <span class="md-ellipsis">
      asignacion_vigencias
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#S2_Funciones.automatizacion_querys" class="md-nav__link">
    <span class="md-ellipsis">
      automatizacion_querys
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#S2_Funciones.calcula_edad" class="md-nav__link">
    <span class="md-ellipsis">
      calcula_edad
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#S2_Funciones.calcula_exposicion" class="md-nav__link">
    <span class="md-ellipsis">
      calcula_exposicion
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#S2_Funciones.calculo_fechas_renovacion" class="md-nav__link">
    <span class="md-ellipsis">
      calculo_fechas_renovacion
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#S2_Funciones.completa_campo" class="md-nav__link">
    <span class="md-ellipsis">
      completa_campo
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#S2_Funciones.completa_campo_total" class="md-nav__link">
    <span class="md-ellipsis">
      completa_campo_total
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#S2_Funciones.corrige_tasas_ges" class="md-nav__link">
    <span class="md-ellipsis">
      corrige_tasas_ges
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#S2_Funciones.cruce_left" class="md-nav__link">
    <span class="md-ellipsis">
      cruce_left
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#S2_Funciones.cumulo_riesgo" class="md-nav__link">
    <span class="md-ellipsis">
      cumulo_riesgo
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#S2_Funciones.cumulos" class="md-nav__link">
    <span class="md-ellipsis">
      cumulos
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#S2_Funciones.ejecuta_query" class="md-nav__link">
    <span class="md-ellipsis">
      ejecuta_query
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#S2_Funciones.escribe_reporta" class="md-nav__link">
    <span class="md-ellipsis">
      escribe_reporta
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#S2_Funciones.filtra_una_combinacion" class="md-nav__link">
    <span class="md-ellipsis">
      filtra_una_combinacion
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#S2_Funciones.get_all_subsets" class="md-nav__link">
    <span class="md-ellipsis">
      get_all_subsets
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#S2_Funciones.identificador_anonimo" class="md-nav__link">
    <span class="md-ellipsis">
      identificador_anonimo
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#S2_Funciones.recargos" class="md-nav__link">
    <span class="md-ellipsis">
      recargos
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#S2_Funciones.split_querys" class="md-nav__link">
    <span class="md-ellipsis">
      split_querys
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#S3_Pre_Procesamiento" class="md-nav__link">
    <span class="md-ellipsis">
      S3_Pre_Procesamiento
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#S3_Pre_Procesamiento.pre_procesamiento" class="md-nav__link">
    <span class="md-ellipsis">
      pre_procesamiento
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#S4_Calculos_Renovacion" class="md-nav__link">
    <span class="md-ellipsis">
      S4_Calculos_Renovacion
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#S4_Calculos_Renovacion.calculos_renovacion" class="md-nav__link">
    <span class="md-ellipsis">
      calculos_renovacion
    </span>
  </a>
  
</li>
      
    </ul>
  
</nav>
                  </div>
                </div>
              </div>
            
          
          
            <div class="md-content" data-md-component="content">
              <article class="md-content__inner md-typeset">
                
                  


  <h1>Docstrings</h1>

<div class="doc doc-object doc-module">



<a id="S0_Loaders"></a>
    <div class="doc doc-contents first">








  <div class="doc doc-children">








<div class="doc doc-object doc-class">



<h2 id="S0_Loaders.Parameter_Loader" class="doc doc-heading">
            <code>Parameter_Loader</code>


</h2>


    <div class="doc doc-contents ">


        <p>Clase que se encarga de cargar parámetros y tablas desde archivos Excel (.xlsx) y archivos de texto (.txt, .csv, etc.).</p>






              <details class="quote">
                <summary>Source code in <code>S0_Loaders.py</code></summary>
                <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">  5</span>
<span class="normal">  6</span>
<span class="normal">  7</span>
<span class="normal">  8</span>
<span class="normal">  9</span>
<span class="normal"> 10</span>
<span class="normal"> 11</span>
<span class="normal"> 12</span>
<span class="normal"> 13</span>
<span class="normal"> 14</span>
<span class="normal"> 15</span>
<span class="normal"> 16</span>
<span class="normal"> 17</span>
<span class="normal"> 18</span>
<span class="normal"> 19</span>
<span class="normal"> 20</span>
<span class="normal"> 21</span>
<span class="normal"> 22</span>
<span class="normal"> 23</span>
<span class="normal"> 24</span>
<span class="normal"> 25</span>
<span class="normal"> 26</span>
<span class="normal"> 27</span>
<span class="normal"> 28</span>
<span class="normal"> 29</span>
<span class="normal"> 30</span>
<span class="normal"> 31</span>
<span class="normal"> 32</span>
<span class="normal"> 33</span>
<span class="normal"> 34</span>
<span class="normal"> 35</span>
<span class="normal"> 36</span>
<span class="normal"> 37</span>
<span class="normal"> 38</span>
<span class="normal"> 39</span>
<span class="normal"> 40</span>
<span class="normal"> 41</span>
<span class="normal"> 42</span>
<span class="normal"> 43</span>
<span class="normal"> 44</span>
<span class="normal"> 45</span>
<span class="normal"> 46</span>
<span class="normal"> 47</span>
<span class="normal"> 48</span>
<span class="normal"> 49</span>
<span class="normal"> 50</span>
<span class="normal"> 51</span>
<span class="normal"> 52</span>
<span class="normal"> 53</span>
<span class="normal"> 54</span>
<span class="normal"> 55</span>
<span class="normal"> 56</span>
<span class="normal"> 57</span>
<span class="normal"> 58</span>
<span class="normal"> 59</span>
<span class="normal"> 60</span>
<span class="normal"> 61</span>
<span class="normal"> 62</span>
<span class="normal"> 63</span>
<span class="normal"> 64</span>
<span class="normal"> 65</span>
<span class="normal"> 66</span>
<span class="normal"> 67</span>
<span class="normal"> 68</span>
<span class="normal"> 69</span>
<span class="normal"> 70</span>
<span class="normal"> 71</span>
<span class="normal"> 72</span>
<span class="normal"> 73</span>
<span class="normal"> 74</span>
<span class="normal"> 75</span>
<span class="normal"> 76</span>
<span class="normal"> 77</span>
<span class="normal"> 78</span>
<span class="normal"> 79</span>
<span class="normal"> 80</span>
<span class="normal"> 81</span>
<span class="normal"> 82</span>
<span class="normal"> 83</span>
<span class="normal"> 84</span>
<span class="normal"> 85</span>
<span class="normal"> 86</span>
<span class="normal"> 87</span>
<span class="normal"> 88</span>
<span class="normal"> 89</span>
<span class="normal"> 90</span>
<span class="normal"> 91</span>
<span class="normal"> 92</span>
<span class="normal"> 93</span>
<span class="normal"> 94</span>
<span class="normal"> 95</span>
<span class="normal"> 96</span>
<span class="normal"> 97</span>
<span class="normal"> 98</span>
<span class="normal"> 99</span>
<span class="normal">100</span>
<span class="normal">101</span>
<span class="normal">102</span>
<span class="normal">103</span>
<span class="normal">104</span>
<span class="normal">105</span>
<span class="normal">106</span>
<span class="normal">107</span>
<span class="normal">108</span>
<span class="normal">109</span>
<span class="normal">110</span>
<span class="normal">111</span>
<span class="normal">112</span>
<span class="normal">113</span>
<span class="normal">114</span>
<span class="normal">115</span>
<span class="normal">116</span>
<span class="normal">117</span>
<span class="normal">118</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">class</span> <span class="nc">Parameter_Loader</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Clase que se encarga de cargar parámetros y tablas desde archivos Excel (.xlsx) y archivos de texto (.txt, .csv, etc.).</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">excel_file</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">open_wb</span><span class="p">:</span> <span class="nb">bool</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">ruta_extensa</span><span class="p">:</span> <span class="nb">str</span><span class="o">=</span><span class="s1">&#39;&#39;</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Constructor de la clase Parameter_Loader.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        excel_file : str</span>
<span class="sd">            Ruta del archivo Excel (.xlsx) que se usará para cargar parámetros.</span>
<span class="sd">        open_wb : bool, optional</span>
<span class="sd">            Indica si se debe abrir el archivo Excel con openpyxl al crear la instancia., by default False</span>
<span class="sd">        ruta_extensa : str, optional</span>
<span class="sd">            Campo opcional para almacenar rutas de archivos de texto o uso genérico., by default &#39;&#39;</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># Definimos atributo excel_file</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">excel_file</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="n">excel_file</span>
        <span class="c1"># Diccionario para almacenar tablas o valores que ya han sido cargados (cache).</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">parameters</span><span class="p">:</span> <span class="nb">dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]</span> <span class="o">=</span> <span class="p">{}</span>

        <span class="c1"># Ruta adicional o extensiva, en caso de necesitar guardar/elaborar alguna ruta completa.</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">ruta_extensa</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="n">ruta_extensa</span>

        <span class="c1"># Si se indica open_wb como True, se abre el archivo Excel con openpyxl y se guarda el objeto Workbook.</span>
        <span class="k">if</span> <span class="n">open_wb</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">wb</span><span class="p">:</span> <span class="n">openpyxl</span><span class="o">.</span><span class="n">Workbook</span> <span class="o">=</span> <span class="n">openpyxl</span><span class="o">.</span><span class="n">load_workbook</span><span class="p">(</span><span class="n">excel_file</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">get_table_xlsx</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">sheet_name</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Retorna un DataFrame de la hoja sheet_name del archivo Excel self.excel_file.</span>
<span class="sd">        Si ya está cargado en self.parameters, se reutiliza la versión en memoria.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        sheet_name : str</span>
<span class="sd">            Nombre de la hoja (sheet) en el archivo Excel.</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        pd.DataFrame</span>
<span class="sd">            DataFrame con el contenido de la hoja especificada.</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="c1"># Carga la hoja de Excel solo si no ha sido cargada antes.</span>
        <span class="k">if</span> <span class="n">sheet_name</span> <span class="ow">not</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">parameters</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">parameters</span><span class="p">[</span><span class="n">sheet_name</span><span class="p">]</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">read_excel</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">excel_file</span><span class="p">,</span> <span class="n">sheet_name</span><span class="o">=</span><span class="n">sheet_name</span><span class="p">)</span>
            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;Se ha cargado la tabla &quot;</span><span class="si">{</span><span class="n">sheet_name</span><span class="si">}</span><span class="s1">&quot; del archivo &quot;</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">excel_file</span><span class="si">}</span><span class="s1">&quot;.&#39;</span><span class="p">)</span>

        <span class="c1"># Retorna el DataFrame correspondiente.</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">parameters</span><span class="p">[</span><span class="n">sheet_name</span><span class="p">]</span>

    <span class="k">def</span> <span class="nf">get_table_txt</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">file_path</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">decimal</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">separador</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">campos_fecha</span><span class="p">:</span> <span class="n">Any</span> <span class="o">=</span> <span class="s1">&#39;&#39;</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Any</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Retorna un DataFrame cargado desde un archivo de texto (csv, txt, etc.).</span>
<span class="sd">        Si ya está cargado en self.parameters, se reutiliza la versión en memoria.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        file_path : str</span>
<span class="sd">            Ruta del archivo de texto a cargar.</span>
<span class="sd">        decimal : str</span>
<span class="sd">            Carácter que define el separador decimal en el archivo.</span>
<span class="sd">        separador : str</span>
<span class="sd">            Separador de campos en el archivo (por ejemplo, &#39;,&#39;, &#39;;&#39;, &#39; &#39;).</span>
<span class="sd">        campos_fecha : Any, optional</span>
<span class="sd">            Columnas que deben ser interpretadas como fechas (opcional)., by default &#39;&#39;</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        Any</span>
<span class="sd">            DataFrame con el contenido del archivo.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># Carga la tabla de texto solo si no ha sido cargada antes.</span>
        <span class="k">if</span> <span class="n">file_path</span> <span class="ow">not</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">parameters</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">parameters</span><span class="p">[</span><span class="n">file_path</span><span class="p">]:</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">read_csv</span><span class="p">(</span>
                <span class="n">file_path</span><span class="p">,</span> 
                <span class="n">decimal</span><span class="o">=</span><span class="n">decimal</span><span class="p">,</span> 
                <span class="n">sep</span><span class="o">=</span><span class="n">separador</span><span class="p">,</span>
                <span class="n">date_format</span><span class="o">=</span><span class="s1">&#39;</span><span class="si">%d</span><span class="s1">-%m-%Y&#39;</span><span class="p">,</span> 
                <span class="n">parse_dates</span><span class="o">=</span><span class="n">campos_fecha</span><span class="p">,</span>
                <span class="n">encoding</span><span class="o">=</span><span class="s1">&#39;latin-1&#39;</span><span class="p">,</span>
                <span class="n">low_memory</span><span class="o">=</span><span class="kc">False</span>  <span class="c1"># Evita problemas con archivos muy grandes</span>
            <span class="p">)</span>
            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;Se ha cargado la tabla desde el archivo &quot;</span><span class="si">{</span><span class="n">file_path</span><span class="si">}</span><span class="s1">&quot;.&#39;</span><span class="p">)</span>

        <span class="c1"># Retorna el DataFrame correspondiente.</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">parameters</span><span class="p">[</span><span class="n">file_path</span><span class="p">]</span>

    <span class="k">def</span> <span class="nf">get_reference</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">reference</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Any</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Retorna el valor de una celda definida como nombre en el archivo Excel,</span>
<span class="sd">        usando openpyxl y la propiedad defined_names.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        reference : str</span>
<span class="sd">            Nombre definido en el libro de Excel que hace referencia a una celda.</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        Any</span>
<span class="sd">            Carga la referencia solo si no ha sido cargada antes.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">reference</span> <span class="ow">not</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">parameters</span><span class="p">:</span>
            <span class="c1"># Toma la dirección (fila, columna) de la referencia y obtiene el valor de la celda.</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">parameters</span><span class="p">[</span><span class="n">reference</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">wb</span><span class="p">[</span>
                <span class="nb">next</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">wb</span><span class="o">.</span><span class="n">defined_names</span><span class="p">[</span><span class="n">reference</span><span class="p">]</span><span class="o">.</span><span class="n">destinations</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
            <span class="p">][</span>
                <span class="nb">next</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">wb</span><span class="o">.</span><span class="n">defined_names</span><span class="p">[</span><span class="n">reference</span><span class="p">]</span><span class="o">.</span><span class="n">destinations</span><span class="p">)[</span><span class="mi">1</span><span class="p">]</span>
            <span class="p">]</span><span class="o">.</span><span class="n">value</span>  <span class="c1"># type: ignore</span>

            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;Se ha cargado la variable &quot;</span><span class="si">{</span><span class="n">reference</span><span class="si">}</span><span class="s1">&quot; del archivo &quot;</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">excel_file</span><span class="si">}</span><span class="s1">&quot;.&#39;</span><span class="p">)</span>

        <span class="c1"># Retorna el valor correspondiente.</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">parameters</span><span class="p">[</span><span class="n">reference</span><span class="p">]</span>
</code></pre></div></td></tr></table></div>
              </details>



  <div class="doc doc-children">









<div class="doc doc-object doc-function">


<h3 id="S0_Loaders.Parameter_Loader.__init__" class="doc doc-heading">
            <code class="highlight language-python"><span class="fm">__init__</span><span class="p">(</span><span class="n">excel_file</span><span class="p">,</span> <span class="n">open_wb</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">ruta_extensa</span><span class="o">=</span><span class="s1">&#39;&#39;</span><span class="p">)</span></code>

</h3>


    <div class="doc doc-contents ">

        <p>Constructor de la clase Parameter_Loader.</p>


<p><span class="doc-section-title">Parameters:</span></p>
    <table>
      <thead>
        <tr>
          <th>Name</th>
          <th>Type</th>
          <th>Description</th>
          <th>Default</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
                <code>excel_file</code>
            </td>
            <td>
                  <code>str</code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Ruta del archivo Excel (.xlsx) que se usará para cargar parámetros.</p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>open_wb</code>
            </td>
            <td>
                  <code>bool</code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Indica si se debe abrir el archivo Excel con openpyxl al crear la instancia., by default False</p>
              </div>
            </td>
            <td>
                  <code>False</code>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>ruta_extensa</code>
            </td>
            <td>
                  <code>str</code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Campo opcional para almacenar rutas de archivos de texto o uso genérico., by default ''</p>
              </div>
            </td>
            <td>
                  <code>&#39;&#39;</code>
            </td>
          </tr>
      </tbody>
    </table>

            <details class="quote">
              <summary>Source code in <code>S0_Loaders.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">10</span>
<span class="normal">11</span>
<span class="normal">12</span>
<span class="normal">13</span>
<span class="normal">14</span>
<span class="normal">15</span>
<span class="normal">16</span>
<span class="normal">17</span>
<span class="normal">18</span>
<span class="normal">19</span>
<span class="normal">20</span>
<span class="normal">21</span>
<span class="normal">22</span>
<span class="normal">23</span>
<span class="normal">24</span>
<span class="normal">25</span>
<span class="normal">26</span>
<span class="normal">27</span>
<span class="normal">28</span>
<span class="normal">29</span>
<span class="normal">30</span>
<span class="normal">31</span>
<span class="normal">32</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">excel_file</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">open_wb</span><span class="p">:</span> <span class="nb">bool</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">ruta_extensa</span><span class="p">:</span> <span class="nb">str</span><span class="o">=</span><span class="s1">&#39;&#39;</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Constructor de la clase Parameter_Loader.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    excel_file : str</span>
<span class="sd">        Ruta del archivo Excel (.xlsx) que se usará para cargar parámetros.</span>
<span class="sd">    open_wb : bool, optional</span>
<span class="sd">        Indica si se debe abrir el archivo Excel con openpyxl al crear la instancia., by default False</span>
<span class="sd">    ruta_extensa : str, optional</span>
<span class="sd">        Campo opcional para almacenar rutas de archivos de texto o uso genérico., by default &#39;&#39;</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="c1"># Definimos atributo excel_file</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">excel_file</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="n">excel_file</span>
    <span class="c1"># Diccionario para almacenar tablas o valores que ya han sido cargados (cache).</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">parameters</span><span class="p">:</span> <span class="nb">dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]</span> <span class="o">=</span> <span class="p">{}</span>

    <span class="c1"># Ruta adicional o extensiva, en caso de necesitar guardar/elaborar alguna ruta completa.</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">ruta_extensa</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="n">ruta_extensa</span>

    <span class="c1"># Si se indica open_wb como True, se abre el archivo Excel con openpyxl y se guarda el objeto Workbook.</span>
    <span class="k">if</span> <span class="n">open_wb</span><span class="p">:</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">wb</span><span class="p">:</span> <span class="n">openpyxl</span><span class="o">.</span><span class="n">Workbook</span> <span class="o">=</span> <span class="n">openpyxl</span><span class="o">.</span><span class="n">load_workbook</span><span class="p">(</span><span class="n">excel_file</span><span class="p">)</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>

<div class="doc doc-object doc-function">


<h3 id="S0_Loaders.Parameter_Loader.get_reference" class="doc doc-heading">
            <code class="highlight language-python"><span class="n">get_reference</span><span class="p">(</span><span class="n">reference</span><span class="p">)</span></code>

</h3>


    <div class="doc doc-contents ">

        <p>Retorna el valor de una celda definida como nombre en el archivo Excel,
usando openpyxl y la propiedad defined_names.</p>


<p><span class="doc-section-title">Parameters:</span></p>
    <table>
      <thead>
        <tr>
          <th>Name</th>
          <th>Type</th>
          <th>Description</th>
          <th>Default</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
                <code>reference</code>
            </td>
            <td>
                  <code>str</code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Nombre definido en el libro de Excel que hace referencia a una celda.</p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
      </tbody>
    </table>


    <p><span class="doc-section-title">Returns:</span></p>
    <table>
      <thead>
        <tr>
          <th>Type</th>
          <th>Description</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
                  <code><span title="typing.Any">Any</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Carga la referencia solo si no ha sido cargada antes.</p>
              </div>
            </td>
          </tr>
      </tbody>
    </table>

            <details class="quote">
              <summary>Source code in <code>S0_Loaders.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"> 93</span>
<span class="normal"> 94</span>
<span class="normal"> 95</span>
<span class="normal"> 96</span>
<span class="normal"> 97</span>
<span class="normal"> 98</span>
<span class="normal"> 99</span>
<span class="normal">100</span>
<span class="normal">101</span>
<span class="normal">102</span>
<span class="normal">103</span>
<span class="normal">104</span>
<span class="normal">105</span>
<span class="normal">106</span>
<span class="normal">107</span>
<span class="normal">108</span>
<span class="normal">109</span>
<span class="normal">110</span>
<span class="normal">111</span>
<span class="normal">112</span>
<span class="normal">113</span>
<span class="normal">114</span>
<span class="normal">115</span>
<span class="normal">116</span>
<span class="normal">117</span>
<span class="normal">118</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span> <span class="nf">get_reference</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">reference</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Any</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Retorna el valor de una celda definida como nombre en el archivo Excel,</span>
<span class="sd">    usando openpyxl y la propiedad defined_names.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    reference : str</span>
<span class="sd">        Nombre definido en el libro de Excel que hace referencia a una celda.</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    Any</span>
<span class="sd">        Carga la referencia solo si no ha sido cargada antes.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="n">reference</span> <span class="ow">not</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">parameters</span><span class="p">:</span>
        <span class="c1"># Toma la dirección (fila, columna) de la referencia y obtiene el valor de la celda.</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">parameters</span><span class="p">[</span><span class="n">reference</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">wb</span><span class="p">[</span>
            <span class="nb">next</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">wb</span><span class="o">.</span><span class="n">defined_names</span><span class="p">[</span><span class="n">reference</span><span class="p">]</span><span class="o">.</span><span class="n">destinations</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
        <span class="p">][</span>
            <span class="nb">next</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">wb</span><span class="o">.</span><span class="n">defined_names</span><span class="p">[</span><span class="n">reference</span><span class="p">]</span><span class="o">.</span><span class="n">destinations</span><span class="p">)[</span><span class="mi">1</span><span class="p">]</span>
        <span class="p">]</span><span class="o">.</span><span class="n">value</span>  <span class="c1"># type: ignore</span>

        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;Se ha cargado la variable &quot;</span><span class="si">{</span><span class="n">reference</span><span class="si">}</span><span class="s1">&quot; del archivo &quot;</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">excel_file</span><span class="si">}</span><span class="s1">&quot;.&#39;</span><span class="p">)</span>

    <span class="c1"># Retorna el valor correspondiente.</span>
    <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">parameters</span><span class="p">[</span><span class="n">reference</span><span class="p">]</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>

<div class="doc doc-object doc-function">


<h3 id="S0_Loaders.Parameter_Loader.get_table_txt" class="doc doc-heading">
            <code class="highlight language-python"><span class="n">get_table_txt</span><span class="p">(</span><span class="n">file_path</span><span class="p">,</span> <span class="n">decimal</span><span class="p">,</span> <span class="n">separador</span><span class="p">,</span> <span class="n">campos_fecha</span><span class="o">=</span><span class="s1">&#39;&#39;</span><span class="p">)</span></code>

</h3>


    <div class="doc doc-contents ">

        <p>Retorna un DataFrame cargado desde un archivo de texto (csv, txt, etc.).
Si ya está cargado en self.parameters, se reutiliza la versión en memoria.</p>


<p><span class="doc-section-title">Parameters:</span></p>
    <table>
      <thead>
        <tr>
          <th>Name</th>
          <th>Type</th>
          <th>Description</th>
          <th>Default</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
                <code>file_path</code>
            </td>
            <td>
                  <code>str</code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Ruta del archivo de texto a cargar.</p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>decimal</code>
            </td>
            <td>
                  <code>str</code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Carácter que define el separador decimal en el archivo.</p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>separador</code>
            </td>
            <td>
                  <code>str</code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Separador de campos en el archivo (por ejemplo, ',', ';', ' ').</p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>campos_fecha</code>
            </td>
            <td>
                  <code><span title="typing.Any">Any</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Columnas que deben ser interpretadas como fechas (opcional)., by default ''</p>
              </div>
            </td>
            <td>
                  <code>&#39;&#39;</code>
            </td>
          </tr>
      </tbody>
    </table>


    <p><span class="doc-section-title">Returns:</span></p>
    <table>
      <thead>
        <tr>
          <th>Type</th>
          <th>Description</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
                  <code><span title="typing.Any">Any</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>DataFrame con el contenido del archivo.</p>
              </div>
            </td>
          </tr>
      </tbody>
    </table>

            <details class="quote">
              <summary>Source code in <code>S0_Loaders.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">57</span>
<span class="normal">58</span>
<span class="normal">59</span>
<span class="normal">60</span>
<span class="normal">61</span>
<span class="normal">62</span>
<span class="normal">63</span>
<span class="normal">64</span>
<span class="normal">65</span>
<span class="normal">66</span>
<span class="normal">67</span>
<span class="normal">68</span>
<span class="normal">69</span>
<span class="normal">70</span>
<span class="normal">71</span>
<span class="normal">72</span>
<span class="normal">73</span>
<span class="normal">74</span>
<span class="normal">75</span>
<span class="normal">76</span>
<span class="normal">77</span>
<span class="normal">78</span>
<span class="normal">79</span>
<span class="normal">80</span>
<span class="normal">81</span>
<span class="normal">82</span>
<span class="normal">83</span>
<span class="normal">84</span>
<span class="normal">85</span>
<span class="normal">86</span>
<span class="normal">87</span>
<span class="normal">88</span>
<span class="normal">89</span>
<span class="normal">90</span>
<span class="normal">91</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span> <span class="nf">get_table_txt</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">file_path</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">decimal</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">separador</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">campos_fecha</span><span class="p">:</span> <span class="n">Any</span> <span class="o">=</span> <span class="s1">&#39;&#39;</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Any</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Retorna un DataFrame cargado desde un archivo de texto (csv, txt, etc.).</span>
<span class="sd">    Si ya está cargado en self.parameters, se reutiliza la versión en memoria.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    file_path : str</span>
<span class="sd">        Ruta del archivo de texto a cargar.</span>
<span class="sd">    decimal : str</span>
<span class="sd">        Carácter que define el separador decimal en el archivo.</span>
<span class="sd">    separador : str</span>
<span class="sd">        Separador de campos en el archivo (por ejemplo, &#39;,&#39;, &#39;;&#39;, &#39; &#39;).</span>
<span class="sd">    campos_fecha : Any, optional</span>
<span class="sd">        Columnas que deben ser interpretadas como fechas (opcional)., by default &#39;&#39;</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    Any</span>
<span class="sd">        DataFrame con el contenido del archivo.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="c1"># Carga la tabla de texto solo si no ha sido cargada antes.</span>
    <span class="k">if</span> <span class="n">file_path</span> <span class="ow">not</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">parameters</span><span class="p">:</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">parameters</span><span class="p">[</span><span class="n">file_path</span><span class="p">]:</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">read_csv</span><span class="p">(</span>
            <span class="n">file_path</span><span class="p">,</span> 
            <span class="n">decimal</span><span class="o">=</span><span class="n">decimal</span><span class="p">,</span> 
            <span class="n">sep</span><span class="o">=</span><span class="n">separador</span><span class="p">,</span>
            <span class="n">date_format</span><span class="o">=</span><span class="s1">&#39;</span><span class="si">%d</span><span class="s1">-%m-%Y&#39;</span><span class="p">,</span> 
            <span class="n">parse_dates</span><span class="o">=</span><span class="n">campos_fecha</span><span class="p">,</span>
            <span class="n">encoding</span><span class="o">=</span><span class="s1">&#39;latin-1&#39;</span><span class="p">,</span>
            <span class="n">low_memory</span><span class="o">=</span><span class="kc">False</span>  <span class="c1"># Evita problemas con archivos muy grandes</span>
        <span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;Se ha cargado la tabla desde el archivo &quot;</span><span class="si">{</span><span class="n">file_path</span><span class="si">}</span><span class="s1">&quot;.&#39;</span><span class="p">)</span>

    <span class="c1"># Retorna el DataFrame correspondiente.</span>
    <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">parameters</span><span class="p">[</span><span class="n">file_path</span><span class="p">]</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>

<div class="doc doc-object doc-function">


<h3 id="S0_Loaders.Parameter_Loader.get_table_xlsx" class="doc doc-heading">
            <code class="highlight language-python"><span class="n">get_table_xlsx</span><span class="p">(</span><span class="n">sheet_name</span><span class="p">)</span></code>

</h3>


    <div class="doc doc-contents ">

        <p>Retorna un DataFrame de la hoja sheet_name del archivo Excel self.excel_file.
Si ya está cargado en self.parameters, se reutiliza la versión en memoria.</p>


<p><span class="doc-section-title">Parameters:</span></p>
    <table>
      <thead>
        <tr>
          <th>Name</th>
          <th>Type</th>
          <th>Description</th>
          <th>Default</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
                <code>sheet_name</code>
            </td>
            <td>
                  <code>str</code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Nombre de la hoja (sheet) en el archivo Excel.</p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
      </tbody>
    </table>


    <p><span class="doc-section-title">Returns:</span></p>
    <table>
      <thead>
        <tr>
          <th>Type</th>
          <th>Description</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
                  <code><span title="pandas.DataFrame">DataFrame</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>DataFrame con el contenido de la hoja especificada.</p>
              </div>
            </td>
          </tr>
      </tbody>
    </table>

            <details class="quote">
              <summary>Source code in <code>S0_Loaders.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">34</span>
<span class="normal">35</span>
<span class="normal">36</span>
<span class="normal">37</span>
<span class="normal">38</span>
<span class="normal">39</span>
<span class="normal">40</span>
<span class="normal">41</span>
<span class="normal">42</span>
<span class="normal">43</span>
<span class="normal">44</span>
<span class="normal">45</span>
<span class="normal">46</span>
<span class="normal">47</span>
<span class="normal">48</span>
<span class="normal">49</span>
<span class="normal">50</span>
<span class="normal">51</span>
<span class="normal">52</span>
<span class="normal">53</span>
<span class="normal">54</span>
<span class="normal">55</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span> <span class="nf">get_table_xlsx</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">sheet_name</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Retorna un DataFrame de la hoja sheet_name del archivo Excel self.excel_file.</span>
<span class="sd">    Si ya está cargado en self.parameters, se reutiliza la versión en memoria.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    sheet_name : str</span>
<span class="sd">        Nombre de la hoja (sheet) en el archivo Excel.</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    pd.DataFrame</span>
<span class="sd">        DataFrame con el contenido de la hoja especificada.</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="c1"># Carga la hoja de Excel solo si no ha sido cargada antes.</span>
    <span class="k">if</span> <span class="n">sheet_name</span> <span class="ow">not</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">parameters</span><span class="p">:</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">parameters</span><span class="p">[</span><span class="n">sheet_name</span><span class="p">]</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">read_excel</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">excel_file</span><span class="p">,</span> <span class="n">sheet_name</span><span class="o">=</span><span class="n">sheet_name</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;Se ha cargado la tabla &quot;</span><span class="si">{</span><span class="n">sheet_name</span><span class="si">}</span><span class="s1">&quot; del archivo &quot;</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">excel_file</span><span class="si">}</span><span class="s1">&quot;.&#39;</span><span class="p">)</span>

    <span class="c1"># Retorna el DataFrame correspondiente.</span>
    <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">parameters</span><span class="p">[</span><span class="n">sheet_name</span><span class="p">]</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>



  </div>

    </div>

</div>




  </div>

    </div>

</div>

<div class="doc doc-object doc-module">



<a id="S1_Parametros_Calculo"></a>
    <div class="doc doc-contents first">

        <p>Script que carga todos los parametros del archivo de parametros de calculo para que sean recogidos en los procesos posteriores</p>








  <div class="doc doc-children">









<div class="doc doc-object doc-function">


<h2 id="S1_Parametros_Calculo.carga_parametros" class="doc doc-heading">
            <code class="highlight language-python"><span class="n">carga_parametros</span><span class="p">(</span><span class="n">files</span><span class="p">,</span> <span class="n">parameter_loader</span><span class="p">)</span></code>

</h2>


    <div class="doc doc-contents ">

        <p>Cargador de parametros del proceso</p>


<p><span class="doc-section-title">Parameters:</span></p>
    <table>
      <thead>
        <tr>
          <th>Name</th>
          <th>Type</th>
          <th>Description</th>
          <th>Default</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
                <code>files</code>
            </td>
            <td>
                  <code><a class="autorefs autorefs-internal" title="S0_Loaders.Parameter_Loader" href="#S0_Loaders.Parameter_Loader">Parameter_Loader</a></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>archivo de la clase Parameter_Loader que contiene informacion de los archivos excel que alimentaran el proceso</p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>parameter_loader</code>
            </td>
            <td>
                  <code><a class="autorefs autorefs-internal" title="S0_Loaders.Parameter_Loader" href="#S0_Loaders.Parameter_Loader">Parameter_Loader</a></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>archivo de la clase Parameter_Loader que contiene informacion de los parametros de la ejecución (1 contrato de reaseguro en particular)</p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
      </tbody>
    </table>

            <details class="quote">
              <summary>Source code in <code>S1_Parametros_Calculo.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"> 10</span>
<span class="normal"> 11</span>
<span class="normal"> 12</span>
<span class="normal"> 13</span>
<span class="normal"> 14</span>
<span class="normal"> 15</span>
<span class="normal"> 16</span>
<span class="normal"> 17</span>
<span class="normal"> 18</span>
<span class="normal"> 19</span>
<span class="normal"> 20</span>
<span class="normal"> 21</span>
<span class="normal"> 22</span>
<span class="normal"> 23</span>
<span class="normal"> 24</span>
<span class="normal"> 25</span>
<span class="normal"> 26</span>
<span class="normal"> 27</span>
<span class="normal"> 28</span>
<span class="normal"> 29</span>
<span class="normal"> 30</span>
<span class="normal"> 31</span>
<span class="normal"> 32</span>
<span class="normal"> 33</span>
<span class="normal"> 34</span>
<span class="normal"> 35</span>
<span class="normal"> 36</span>
<span class="normal"> 37</span>
<span class="normal"> 38</span>
<span class="normal"> 39</span>
<span class="normal"> 40</span>
<span class="normal"> 41</span>
<span class="normal"> 42</span>
<span class="normal"> 43</span>
<span class="normal"> 44</span>
<span class="normal"> 45</span>
<span class="normal"> 46</span>
<span class="normal"> 47</span>
<span class="normal"> 48</span>
<span class="normal"> 49</span>
<span class="normal"> 50</span>
<span class="normal"> 51</span>
<span class="normal"> 52</span>
<span class="normal"> 53</span>
<span class="normal"> 54</span>
<span class="normal"> 55</span>
<span class="normal"> 56</span>
<span class="normal"> 57</span>
<span class="normal"> 58</span>
<span class="normal"> 59</span>
<span class="normal"> 60</span>
<span class="normal"> 61</span>
<span class="normal"> 62</span>
<span class="normal"> 63</span>
<span class="normal"> 64</span>
<span class="normal"> 65</span>
<span class="normal"> 66</span>
<span class="normal"> 67</span>
<span class="normal"> 68</span>
<span class="normal"> 69</span>
<span class="normal"> 70</span>
<span class="normal"> 71</span>
<span class="normal"> 72</span>
<span class="normal"> 73</span>
<span class="normal"> 74</span>
<span class="normal"> 75</span>
<span class="normal"> 76</span>
<span class="normal"> 77</span>
<span class="normal"> 78</span>
<span class="normal"> 79</span>
<span class="normal"> 80</span>
<span class="normal"> 81</span>
<span class="normal"> 82</span>
<span class="normal"> 83</span>
<span class="normal"> 84</span>
<span class="normal"> 85</span>
<span class="normal"> 86</span>
<span class="normal"> 87</span>
<span class="normal"> 88</span>
<span class="normal"> 89</span>
<span class="normal"> 90</span>
<span class="normal"> 91</span>
<span class="normal"> 92</span>
<span class="normal"> 93</span>
<span class="normal"> 94</span>
<span class="normal"> 95</span>
<span class="normal"> 96</span>
<span class="normal"> 97</span>
<span class="normal"> 98</span>
<span class="normal"> 99</span>
<span class="normal">100</span>
<span class="normal">101</span>
<span class="normal">102</span>
<span class="normal">103</span>
<span class="normal">104</span>
<span class="normal">105</span>
<span class="normal">106</span>
<span class="normal">107</span>
<span class="normal">108</span>
<span class="normal">109</span>
<span class="normal">110</span>
<span class="normal">111</span>
<span class="normal">112</span>
<span class="normal">113</span>
<span class="normal">114</span>
<span class="normal">115</span>
<span class="normal">116</span>
<span class="normal">117</span>
<span class="normal">118</span>
<span class="normal">119</span>
<span class="normal">120</span>
<span class="normal">121</span>
<span class="normal">122</span>
<span class="normal">123</span>
<span class="normal">124</span>
<span class="normal">125</span>
<span class="normal">126</span>
<span class="normal">127</span>
<span class="normal">128</span>
<span class="normal">129</span>
<span class="normal">130</span>
<span class="normal">131</span>
<span class="normal">132</span>
<span class="normal">133</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span> <span class="nf">carga_parametros</span><span class="p">(</span><span class="n">files</span><span class="p">:</span> <span class="n">Parameter_Loader</span><span class="p">,</span> <span class="n">parameter_loader</span><span class="p">:</span> <span class="n">Parameter_Loader</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Cargador de parametros del proceso</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    files : Parameter_Loader</span>
<span class="sd">        archivo de la clase Parameter_Loader que contiene informacion de los archivos excel que alimentaran el proceso</span>
<span class="sd">    parameter_loader : Parameter_Loader</span>
<span class="sd">        archivo de la clase Parameter_Loader que contiene informacion de los parametros de la ejecución (1 contrato de reaseguro en particular)</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="c1"># * Utilizamos funciones de la clase para cargar algunas variables</span>
    <span class="n">parameter_loader</span><span class="o">.</span><span class="n">get_reference</span><span class="p">(</span><span class="n">reference</span><span class="o">=</span><span class="s1">&#39;tipo_calculo&#39;</span><span class="p">)</span>
    <span class="n">parameter_loader</span><span class="o">.</span><span class="n">get_reference</span><span class="p">(</span><span class="n">reference</span><span class="o">=</span><span class="s1">&#39;contrato&#39;</span><span class="p">)</span>
    <span class="n">parameter_loader</span><span class="o">.</span><span class="n">get_reference</span><span class="p">(</span><span class="n">reference</span><span class="o">=</span><span class="s1">&#39;fecha_cierre&#39;</span><span class="p">)</span>
    <span class="n">tasa_dscto_mensualidades</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="n">parameter_loader</span><span class="o">.</span><span class="n">get_reference</span><span class="p">(</span><span class="n">reference</span><span class="o">=</span><span class="s1">&#39;tasa_dscto_mensualidades&#39;</span><span class="p">)</span>
    <span class="n">parameter_loader</span><span class="o">.</span><span class="n">get_reference</span><span class="p">(</span><span class="n">reference</span><span class="o">=</span><span class="s1">&#39;edad_casos_perdidos&#39;</span><span class="p">)</span>
    <span class="n">subcarpeta_input</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="n">parameter_loader</span><span class="o">.</span><span class="n">get_reference</span><span class="p">(</span><span class="n">reference</span><span class="o">=</span><span class="s1">&#39;subcarpeta_input&#39;</span><span class="p">)</span>
    <span class="n">subcarpeta_historico</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="n">parameter_loader</span><span class="o">.</span><span class="n">get_reference</span><span class="p">(</span><span class="n">reference</span><span class="o">=</span><span class="s1">&#39;subcarpeta_historico&#39;</span><span class="p">)</span>
    <span class="n">subcarpeta_pyme</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="n">parameter_loader</span><span class="o">.</span><span class="n">get_reference</span><span class="p">(</span><span class="n">reference</span><span class="o">=</span><span class="s1">&#39;subcarpeta_pyme&#39;</span><span class="p">)</span>
    <span class="n">subcarpeta_recargos</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="n">parameter_loader</span><span class="o">.</span><span class="n">get_reference</span><span class="p">(</span><span class="n">reference</span><span class="o">=</span><span class="s1">&#39;subcarpeta_recargos&#39;</span><span class="p">)</span>
    <span class="n">subcarpeta_regiones</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="n">parameter_loader</span><span class="o">.</span><span class="n">get_reference</span><span class="p">(</span><span class="n">reference</span><span class="o">=</span><span class="s1">&#39;subcarpeta_regiones&#39;</span><span class="p">)</span>
    <span class="n">subcarpeta_si</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="n">parameter_loader</span><span class="o">.</span><span class="n">get_reference</span><span class="p">(</span><span class="n">reference</span><span class="o">=</span><span class="s1">&#39;subcarpeta_si&#39;</span><span class="p">)</span>
    <span class="n">subcarpeta_otros</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="n">parameter_loader</span><span class="o">.</span><span class="n">get_reference</span><span class="p">(</span><span class="n">reference</span><span class="o">=</span><span class="s1">&#39;subcarpeta_otros&#39;</span><span class="p">)</span>
    <span class="n">subcarpeta_lob</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="n">parameter_loader</span><span class="o">.</span><span class="n">get_reference</span><span class="p">(</span><span class="n">reference</span><span class="o">=</span><span class="s1">&#39;subcarpeta_lob&#39;</span><span class="p">)</span>
    <span class="n">subcarpeta_uso_seguro</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="n">parameter_loader</span><span class="o">.</span><span class="n">get_reference</span><span class="p">(</span><span class="n">reference</span><span class="o">=</span><span class="s1">&#39;subcarpeta_uso_seguro&#39;</span><span class="p">)</span>
    <span class="n">subcarpeta_output</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="n">parameter_loader</span><span class="o">.</span><span class="n">get_reference</span><span class="p">(</span><span class="n">reference</span><span class="o">=</span><span class="s1">&#39;subcarpeta_output&#39;</span><span class="p">)</span>
    <span class="n">parameter_loader</span><span class="o">.</span><span class="n">get_reference</span><span class="p">(</span><span class="n">reference</span><span class="o">=</span><span class="s1">&#39;separador_input&#39;</span><span class="p">)</span>
    <span class="n">parameter_loader</span><span class="o">.</span><span class="n">get_reference</span><span class="p">(</span><span class="n">reference</span><span class="o">=</span><span class="s1">&#39;decimal_input&#39;</span><span class="p">)</span>
    <span class="n">parameter_loader</span><span class="o">.</span><span class="n">get_reference</span><span class="p">(</span><span class="n">reference</span><span class="o">=</span><span class="s1">&#39;separador_fechas_input&#39;</span><span class="p">)</span>
    <span class="n">parameter_loader</span><span class="o">.</span><span class="n">get_reference</span><span class="p">(</span><span class="n">reference</span><span class="o">=</span><span class="s1">&#39;separador_output&#39;</span><span class="p">)</span>
    <span class="n">parameter_loader</span><span class="o">.</span><span class="n">get_reference</span><span class="p">(</span><span class="n">reference</span><span class="o">=</span><span class="s1">&#39;decimal_output&#39;</span><span class="p">)</span>
    <span class="n">parameter_loader</span><span class="o">.</span><span class="n">get_reference</span><span class="p">(</span><span class="n">reference</span><span class="o">=</span><span class="s1">&#39;periodo_historico&#39;</span><span class="p">)</span>
    <span class="n">parameter_loader</span><span class="o">.</span><span class="n">get_reference</span><span class="p">(</span><span class="n">reference</span><span class="o">=</span><span class="s1">&#39;aplica_check_parametros&#39;</span><span class="p">)</span>
    <span class="n">parameter_loader</span><span class="o">.</span><span class="n">get_reference</span><span class="p">(</span><span class="n">reference</span><span class="o">=</span><span class="s1">&#39;uso_fecha_anulacion_historico&#39;</span><span class="p">)</span>
    <span class="n">tipo_base_expuestos</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="n">parameter_loader</span><span class="o">.</span><span class="n">get_reference</span><span class="p">(</span><span class="n">reference</span><span class="o">=</span><span class="s1">&#39;tipo_base_expuestos&#39;</span><span class="p">)</span>
    <span class="n">add_base_expuestos</span><span class="p">:</span> <span class="n">Any</span> <span class="o">=</span> <span class="n">parameter_loader</span><span class="o">.</span><span class="n">get_reference</span><span class="p">(</span><span class="n">reference</span><span class="o">=</span><span class="s1">&#39;add_base_expuestos&#39;</span><span class="p">)</span>
    <span class="n">parameter_loader</span><span class="o">.</span><span class="n">get_reference</span><span class="p">(</span><span class="n">reference</span><span class="o">=</span><span class="s1">&#39;tipo_proceso&#39;</span><span class="p">)</span>
    <span class="n">parameter_loader</span><span class="o">.</span><span class="n">get_reference</span><span class="p">(</span><span class="n">reference</span><span class="o">=</span><span class="s1">&#39;base_input_siniestros_generales&#39;</span><span class="p">)</span>
    <span class="n">parameter_loader</span><span class="o">.</span><span class="n">get_table_xlsx</span><span class="p">(</span><span class="n">sheet_name</span> <span class="o">=</span> <span class="s1">&#39;Diccionario Contratos&#39;</span><span class="p">)</span>
    <span class="n">parameter_loader</span><span class="o">.</span><span class="n">wb</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>

    <span class="c1"># Definimos algunas variables que utilizaremos frecuentemente en el guardado de informacion dentro de la clase</span>
    <span class="n">parameter_loader</span><span class="o">.</span><span class="n">parameters</span><span class="p">[</span><span class="s1">&#39;diccionario_contratos&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">parameter_loader</span><span class="o">.</span><span class="n">parameters</span><span class="p">[</span><span class="s1">&#39;Diccionario Contratos&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">set_index</span><span class="p">(</span><span class="s1">&#39;CONTRATO&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">to_dict</span><span class="p">()</span>
    <span class="n">diccionario_contratos</span><span class="p">:</span> <span class="nb">dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span><span class="n">Any</span><span class="p">]</span> <span class="o">=</span> <span class="n">parameter_loader</span><span class="o">.</span><span class="n">parameters</span><span class="p">[</span><span class="s1">&#39;diccionario_contratos&#39;</span><span class="p">]</span>
    <span class="n">contrato</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="n">parameter_loader</span><span class="o">.</span><span class="n">parameters</span><span class="p">[</span><span class="s1">&#39;contrato&#39;</span><span class="p">]</span>
    <span class="n">tipo_calculo</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="n">parameter_loader</span><span class="o">.</span><span class="n">parameters</span><span class="p">[</span><span class="s1">&#39;tipo_calculo&#39;</span><span class="p">]</span>
    <span class="n">fecha_cierre</span><span class="p">:</span> <span class="n">datetime</span><span class="o">.</span><span class="n">datetime</span> <span class="o">=</span> <span class="n">parameter_loader</span><span class="o">.</span><span class="n">parameters</span><span class="p">[</span><span class="s1">&#39;fecha_cierre&#39;</span><span class="p">]</span>
    <span class="n">ruta_inputs</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">parameter_loader</span><span class="o">.</span><span class="n">ruta_extensa</span><span class="si">}</span><span class="s1">1 Input</span><span class="se">\\</span><span class="si">{</span><span class="n">tipo_calculo</span><span class="si">}</span><span class="se">\\</span><span class="s1">&#39;</span>
    <span class="n">periodo</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="n">fecha_cierre</span><span class="o">.</span><span class="n">year</span><span class="o">*</span><span class="mi">100</span><span class="o">+</span><span class="n">fecha_cierre</span><span class="o">.</span><span class="n">month</span>

    <span class="c1"># * Calculos sobre la variable diccionario_contratos</span>
    <span class="n">parameter_loader</span><span class="o">.</span><span class="n">parameters</span><span class="p">[</span><span class="s1">&#39;tipo_contrato&#39;</span><span class="p">]</span><span class="o">=</span><span class="n">diccionario_contratos</span><span class="p">[</span><span class="s1">&#39;TIPO CONTRATO&#39;</span><span class="p">][</span><span class="n">contrato</span><span class="p">]</span>
    <span class="n">parameter_loader</span><span class="o">.</span><span class="n">parameters</span><span class="p">[</span><span class="s1">&#39;tipo_prima&#39;</span><span class="p">]</span><span class="o">=</span><span class="n">diccionario_contratos</span><span class="p">[</span><span class="s1">&#39;TIPO PRIMA&#39;</span><span class="p">][</span><span class="n">contrato</span><span class="p">]</span>
    <span class="n">parameter_loader</span><span class="o">.</span><span class="n">parameters</span><span class="p">[</span><span class="s1">&#39;clasificacion_contrato&#39;</span><span class="p">]</span><span class="o">=</span><span class="n">diccionario_contratos</span><span class="p">[</span><span class="s1">&#39;CLASIFICACION CONTRATO&#39;</span><span class="p">][</span><span class="n">contrato</span><span class="p">]</span>
    <span class="n">parameter_loader</span><span class="o">.</span><span class="n">parameters</span><span class="p">[</span><span class="s1">&#39;base_ges&#39;</span><span class="p">]</span><span class="o">=</span><span class="n">diccionario_contratos</span><span class="p">[</span><span class="s1">&#39;BASE GES&#39;</span><span class="p">][</span><span class="n">contrato</span><span class="p">]</span>
    <span class="n">parameter_loader</span><span class="o">.</span><span class="n">parameters</span><span class="p">[</span><span class="s1">&#39;base_iaxis&#39;</span><span class="p">]</span><span class="o">=</span><span class="n">diccionario_contratos</span><span class="p">[</span><span class="s1">&#39;BASE IAXIS&#39;</span><span class="p">][</span><span class="n">contrato</span><span class="p">]</span>
    <span class="n">parameter_loader</span><span class="o">.</span><span class="n">parameters</span><span class="p">[</span><span class="s1">&#39;cap_expuestos&#39;</span><span class="p">]</span><span class="o">=</span><span class="n">diccionario_contratos</span><span class="p">[</span><span class="s1">&#39;CAPS EXPUESTOS&#39;</span><span class="p">][</span><span class="n">contrato</span><span class="p">]</span>
    <span class="n">parameter_loader</span><span class="o">.</span><span class="n">parameters</span><span class="p">[</span><span class="s1">&#39;pivotea_df&#39;</span><span class="p">]</span><span class="o">=</span><span class="n">diccionario_contratos</span><span class="p">[</span><span class="s1">&#39;PIVOTEA CONTRATO&#39;</span><span class="p">][</span><span class="n">contrato</span><span class="p">]</span>
    <span class="n">nombre_base</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="n">diccionario_contratos</span><span class="p">[</span><span class="s1">&#39;NOMBRE BASE&#39;</span><span class="p">][</span><span class="n">contrato</span><span class="p">]</span>

    <span class="c1"># * Calculos de fechas para el cierre</span>
    <span class="n">parameter_loader</span><span class="o">.</span><span class="n">parameters</span><span class="p">[</span><span class="s1">&#39;fecha_inicio_mes&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">datetime</span><span class="o">.</span><span class="n">datetime</span><span class="p">(</span><span class="n">fecha_cierre</span><span class="o">.</span><span class="n">year</span><span class="p">,</span><span class="n">fecha_cierre</span><span class="o">.</span><span class="n">month</span><span class="p">,</span><span class="mi">1</span><span class="p">)</span>
    <span class="n">parameter_loader</span><span class="o">.</span><span class="n">parameters</span><span class="p">[</span><span class="s1">&#39;fecha_cierre_mes_anterior&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">parameter_loader</span><span class="o">.</span><span class="n">parameters</span><span class="p">[</span><span class="s1">&#39;fecha_inicio_mes&#39;</span><span class="p">]</span><span class="o">-</span><span class="n">datetime</span><span class="o">.</span><span class="n">timedelta</span><span class="p">(</span><span class="n">days</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
    <span class="n">parameter_loader</span><span class="o">.</span><span class="n">parameters</span><span class="p">[</span><span class="s1">&#39;dias_exposicion&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">fecha_cierre</span><span class="o">-</span><span class="n">parameter_loader</span><span class="o">.</span><span class="n">parameters</span><span class="p">[</span><span class="s1">&#39;fecha_inicio_mes&#39;</span><span class="p">])</span><span class="o">.</span><span class="n">days</span><span class="o">+</span><span class="mi">1</span>
    <span class="n">parameter_loader</span><span class="o">.</span><span class="n">parameters</span><span class="p">[</span><span class="s1">&#39;periodo&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">periodo</span>
    <span class="n">parameter_loader</span><span class="o">.</span><span class="n">parameters</span><span class="p">[</span><span class="s1">&#39;periodo_anterior&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">parameter_loader</span><span class="o">.</span><span class="n">parameters</span><span class="p">[</span><span class="s1">&#39;periodo&#39;</span><span class="p">]</span> <span class="o">-</span> <span class="p">(</span><span class="mi">1</span> <span class="k">if</span> <span class="n">parameter_loader</span><span class="o">.</span><span class="n">parameters</span><span class="p">[</span><span class="s1">&#39;periodo&#39;</span><span class="p">]</span><span class="o">%</span><span class="mi">100</span><span class="o">&gt;</span><span class="mi">1</span> <span class="k">else</span> <span class="mi">89</span><span class="p">)</span>
    <span class="n">parameter_loader</span><span class="o">.</span><span class="n">parameters</span><span class="p">[</span><span class="s1">&#39;año_cierre&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">fecha_cierre</span><span class="o">.</span><span class="n">year</span>

    <span class="c1"># * Calculo sobre las rutas de entrada y de salida</span>
    <span class="n">parameter_loader</span><span class="o">.</span><span class="n">parameters</span><span class="p">[</span><span class="s1">&#39;ruta_input&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">ruta_inputs</span><span class="si">}{</span><span class="n">subcarpeta_input</span><span class="si">}</span><span class="se">\\</span><span class="si">{</span><span class="n">nombre_base</span><span class="si">}</span><span class="se">\\</span><span class="s1">&#39;</span>
    <span class="n">parameter_loader</span><span class="o">.</span><span class="n">parameters</span><span class="p">[</span><span class="s1">&#39;ruta_historico_input&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">ruta_inputs</span><span class="si">}{</span><span class="n">subcarpeta_historico</span><span class="si">}</span><span class="se">\\</span><span class="s1">&#39;</span>
    <span class="n">parameter_loader</span><span class="o">.</span><span class="n">parameters</span><span class="p">[</span><span class="s1">&#39;ruta_pyme&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">ruta_inputs</span><span class="si">}{</span><span class="n">subcarpeta_pyme</span><span class="si">}</span><span class="se">\\</span><span class="s1">&#39;</span>
    <span class="n">parameter_loader</span><span class="o">.</span><span class="n">parameters</span><span class="p">[</span><span class="s1">&#39;ruta_recargos&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">ruta_inputs</span><span class="si">}{</span><span class="n">subcarpeta_recargos</span><span class="si">}</span><span class="se">\\</span><span class="s1">&#39;</span>
    <span class="n">parameter_loader</span><span class="o">.</span><span class="n">parameters</span><span class="p">[</span><span class="s1">&#39;ruta_regiones&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">ruta_inputs</span><span class="si">}{</span><span class="n">subcarpeta_regiones</span><span class="si">}</span><span class="se">\\</span><span class="s1">&#39;</span>
    <span class="n">parameter_loader</span><span class="o">.</span><span class="n">parameters</span><span class="p">[</span><span class="s1">&#39;ruta_si&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">ruta_inputs</span><span class="si">}{</span><span class="n">subcarpeta_si</span><span class="si">}</span><span class="se">\\</span><span class="s1">&#39;</span>
    <span class="n">parameter_loader</span><span class="o">.</span><span class="n">parameters</span><span class="p">[</span><span class="s1">&#39;ruta_otros&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">ruta_inputs</span><span class="si">}{</span><span class="n">subcarpeta_otros</span><span class="si">}</span><span class="se">\\</span><span class="s1">&#39;</span>
    <span class="n">parameter_loader</span><span class="o">.</span><span class="n">parameters</span><span class="p">[</span><span class="s1">&#39;ruta_lob&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">ruta_inputs</span><span class="si">}{</span><span class="n">subcarpeta_lob</span><span class="si">}</span><span class="se">\\</span><span class="s1">&#39;</span>
    <span class="n">parameter_loader</span><span class="o">.</span><span class="n">parameters</span><span class="p">[</span><span class="s1">&#39;ruta_uso_seguro&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">ruta_inputs</span><span class="si">}{</span><span class="n">subcarpeta_uso_seguro</span><span class="si">}</span><span class="se">\\</span><span class="s1">&#39;</span>
    <span class="n">parameter_loader</span><span class="o">.</span><span class="n">parameters</span><span class="p">[</span><span class="s1">&#39;ruta_output&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">parameter_loader</span><span class="o">.</span><span class="n">ruta_extensa</span><span class="si">}</span><span class="s1">2 Output</span><span class="se">\\</span><span class="si">{</span><span class="n">tipo_calculo</span><span class="si">}</span><span class="se">\\</span><span class="si">{</span><span class="n">periodo</span><span class="si">}</span><span class="se">\\</span><span class="si">{</span><span class="n">contrato</span><span class="si">}</span><span class="se">\\</span><span class="si">{</span><span class="n">subcarpeta_output</span><span class="si">}</span><span class="se">\\</span><span class="s1">&#39;</span>
    <span class="n">parameter_loader</span><span class="o">.</span><span class="n">parameters</span><span class="p">[</span><span class="s1">&#39;ruta_historico_output&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">parameter_loader</span><span class="o">.</span><span class="n">parameters</span><span class="p">[</span><span class="s2">&quot;ruta_output&quot;</span><span class="p">]</span><span class="si">}</span><span class="s1">Duplicados Cruce Historico&#39;</span>

    <span class="c1"># * Otros calculos</span>
    <span class="c1"># Tasa de descuento para calculo de monto asegurado para coberturas de rentas</span>
    <span class="n">parameter_loader</span><span class="o">.</span><span class="n">parameters</span><span class="p">[</span><span class="s1">&#39;tdm_mensual&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="mi">1</span><span class="o">+</span><span class="n">tasa_dscto_mensualidades</span><span class="p">)</span><span class="o">**</span><span class="p">(</span><span class="mi">1</span><span class="o">/</span><span class="mi">12</span><span class="p">)</span><span class="o">-</span><span class="mi">1</span>
    <span class="c1"># Campo de rut para revisar duplicados</span>
    <span class="n">parameter_loader</span><span class="o">.</span><span class="n">parameters</span><span class="p">[</span><span class="s1">&#39;campo_rut_duplicados&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;RUT_CONTRATANTE&#39;</span> <span class="k">if</span> <span class="p">(</span><span class="n">parameter_loader</span><span class="o">.</span><span class="n">parameters</span><span class="p">[</span><span class="s1">&#39;tipo_contrato&#39;</span><span class="p">]</span><span class="o">==</span><span class="s1">&#39;Generales&#39;</span><span class="p">)</span><span class="o">&amp;</span><span class="p">(</span><span class="s1">&#39;Incendio y Sismo&#39;</span> <span class="ow">in</span> <span class="n">contrato</span><span class="p">)</span> <span class="k">else</span> <span class="s1">&#39;RUT&#39;</span>
    <span class="c1"># Campo del tipo de base que sirve para ir a buscar los archivos de expuestos</span>
    <span class="n">nombre_tipo_base</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s1">&#39;Expuestos &#39;</span> <span class="k">if</span> <span class="n">tipo_calculo</span><span class="o">==</span><span class="s1">&#39;Prima de Reaseguro&#39;</span> <span class="k">else</span> <span class="s1">&#39;Siniestros &#39;</span>
    <span class="c1"># Calculo de ruta y nombres de archivos de expuestos que iremos a buscar</span>
    <span class="k">if</span> <span class="n">tipo_base_expuestos</span><span class="o">==</span><span class="s1">&#39;Mensual&#39;</span><span class="p">:</span>
        <span class="n">archivo_input</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">nombre_tipo_base</span><span class="si">}{</span><span class="n">nombre_base</span><span class="si">}</span><span class="s1"> </span><span class="si">{</span><span class="n">periodo</span><span class="si">}</span><span class="s1">.txt&#39;</span>
        <span class="n">archivo_input_ges</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">nombre_tipo_base</span><span class="si">}{</span><span class="n">nombre_base</span><span class="si">}</span><span class="s1"> GES </span><span class="si">{</span><span class="n">periodo</span><span class="si">}</span><span class="s1">.txt&#39;</span>
    <span class="k">elif</span> <span class="n">tipo_base_expuestos</span><span class="o">==</span><span class="s1">&#39;Anual&#39;</span><span class="p">:</span>
        <span class="n">archivo_input</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">nombre_tipo_base</span><span class="si">}{</span><span class="n">nombre_base</span><span class="si">}</span><span class="s1"> </span><span class="si">{</span><span class="n">parameter_loader</span><span class="o">.</span><span class="n">parameters</span><span class="p">[</span><span class="s2">&quot;año_cierre&quot;</span><span class="p">]</span><span class="si">}</span><span class="s1">.txt&#39;</span>
        <span class="n">archivo_input_ges</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">nombre_tipo_base</span><span class="si">}{</span><span class="n">nombre_base</span><span class="si">}</span><span class="s1"> GES </span><span class="si">{</span><span class="n">parameter_loader</span><span class="o">.</span><span class="n">parameters</span><span class="p">[</span><span class="s2">&quot;año_cierre&quot;</span><span class="p">]</span><span class="si">}</span><span class="s1">.txt&#39;</span>
    <span class="k">elif</span> <span class="n">tipo_base_expuestos</span><span class="o">==</span><span class="s1">&#39;Historico&#39;</span><span class="p">:</span>
        <span class="n">archivo_input</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">nombre_tipo_base</span><span class="si">}{</span><span class="n">nombre_base</span><span class="si">}</span><span class="s1">.txt&#39;</span>
        <span class="n">archivo_input_ges</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">nombre_tipo_base</span><span class="si">}{</span><span class="n">nombre_base</span><span class="si">}</span><span class="s1"> GES.txt&#39;</span>
    <span class="k">elif</span> <span class="n">tipo_base_expuestos</span><span class="o">==</span><span class="s1">&#39;Fecha&#39;</span><span class="p">:</span>
        <span class="n">archivo_input</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">nombre_tipo_base</span><span class="si">}{</span><span class="n">nombre_base</span><span class="si">}</span><span class="s1"> </span><span class="si">{</span><span class="nb">str</span><span class="p">(</span><span class="n">add_base_expuestos</span><span class="p">)[</span><span class="mi">0</span><span class="p">:</span><span class="mi">10</span><span class="p">]</span><span class="si">}</span><span class="s1">.txt&#39;</span>
        <span class="n">archivo_input_ges</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">nombre_tipo_base</span><span class="si">}{</span><span class="n">nombre_base</span><span class="si">}</span><span class="s1"> GES </span><span class="si">{</span><span class="nb">str</span><span class="p">(</span><span class="n">add_base_expuestos</span><span class="p">)[</span><span class="mi">0</span><span class="p">:</span><span class="mi">10</span><span class="p">]</span><span class="si">}</span><span class="s1">.txt&#39;</span>
    <span class="k">elif</span> <span class="n">tipo_base_expuestos</span><span class="o">==</span><span class="s1">&#39;Periodos&#39;</span><span class="p">:</span>
        <span class="n">archivo_input</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">nombre_tipo_base</span><span class="si">}{</span><span class="n">nombre_base</span><span class="si">}</span><span class="s1"> </span><span class="si">{</span><span class="n">add_base_expuestos</span><span class="si">}</span><span class="s1">.txt&#39;</span>
        <span class="n">archivo_input_ges</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">nombre_tipo_base</span><span class="si">}{</span><span class="n">nombre_base</span><span class="si">}</span><span class="s1"> GES </span><span class="si">{</span><span class="n">add_base_expuestos</span><span class="si">}</span><span class="s1">.txt&#39;</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">archivo_input</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s1">&#39;&#39;</span>
        <span class="n">archivo_input_ges</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s1">&#39;&#39;</span>
    <span class="c1"># Nombre de la base de expuestos de los sistemas de administracion de BBDD GES e iAxis</span>
    <span class="n">parameter_loader</span><span class="o">.</span><span class="n">parameters</span><span class="p">[</span><span class="s1">&#39;archivo_input&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">archivo_input</span>
    <span class="n">parameter_loader</span><span class="o">.</span><span class="n">parameters</span><span class="p">[</span><span class="s1">&#39;archivo_input_ges&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">archivo_input_ges</span>

    <span class="c1"># Crea las rutas de salidas</span>
    <span class="n">rutas</span><span class="p">:</span> <span class="nb">list</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;ruta_input&#39;</span><span class="p">,</span> <span class="s1">&#39;ruta_historico_input&#39;</span><span class="p">,</span> <span class="s1">&#39;ruta_pyme&#39;</span><span class="p">,</span> <span class="s1">&#39;ruta_recargos&#39;</span><span class="p">,</span> <span class="s1">&#39;ruta_regiones&#39;</span><span class="p">,</span> <span class="s1">&#39;ruta_si&#39;</span><span class="p">,</span> <span class="s1">&#39;ruta_otros&#39;</span><span class="p">,</span> <span class="s1">&#39;ruta_output&#39;</span><span class="p">]</span>
    <span class="k">for</span> <span class="n">ruta</span> <span class="ow">in</span> <span class="n">rutas</span><span class="p">:</span>
        <span class="n">Path</span><span class="p">(</span><span class="n">parameter_loader</span><span class="o">.</span><span class="n">parameters</span><span class="p">[</span><span class="n">ruta</span><span class="p">])</span><span class="o">.</span><span class="n">mkdir</span><span class="p">(</span><span class="n">parents</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">exist_ok</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">parameter_loader</span><span class="o">.</span><span class="n">parameters</span><span class="p">[</span><span class="s1">&#39;tipo_prima&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;Prima Unica&#39;</span> <span class="p">:</span> <span class="n">Path</span><span class="p">(</span><span class="n">parameter_loader</span><span class="o">.</span><span class="n">parameters</span><span class="p">[</span><span class="s1">&#39;ruta_historico_output&#39;</span><span class="p">])</span><span class="o">.</span><span class="n">mkdir</span><span class="p">(</span><span class="n">parents</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">exist_ok</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

    <span class="c1"># Comienzo a escribir en el archivo de reporte</span>
    <span class="n">parameter_loader</span><span class="o">.</span><span class="n">parameters</span><span class="p">[</span><span class="s1">&#39;archivo_reporte&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="nb">open</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">parameter_loader</span><span class="o">.</span><span class="n">parameters</span><span class="p">[</span><span class="s2">&quot;ruta_output&quot;</span><span class="p">]</span><span class="si">}</span><span class="s1">0. Reporte Errores.txt&#39;</span><span class="p">,</span><span class="s1">&#39;w&#39;</span><span class="p">)</span>
    <span class="n">parameter_loader</span><span class="o">.</span><span class="n">parameters</span><span class="p">[</span><span class="s1">&#39;archivo_reporte&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;Comienzo de reporte de errores de </span><span class="si">{</span><span class="n">tipo_calculo</span><span class="si">}</span><span class="s1"> - </span><span class="si">{</span><span class="n">contrato</span><span class="si">}</span><span class="s1"> al periodo </span><span class="si">{</span><span class="n">periodo</span><span class="si">}</span><span class="se">\n\n</span><span class="s1">&#39;</span><span class="p">)</span>

    <span class="c1"># Copia del archivo de parametros en la ruta del output</span>
    <span class="n">shutil</span><span class="o">.</span><span class="n">copyfile</span><span class="p">(</span><span class="n">files</span><span class="o">.</span><span class="n">parameters</span><span class="p">[</span><span class="s1">&#39;archivo_calculos&#39;</span><span class="p">],</span> <span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">parameter_loader</span><span class="o">.</span><span class="n">parameters</span><span class="p">[</span><span class="s2">&quot;ruta_output&quot;</span><span class="p">]</span><span class="si">}{</span><span class="n">files</span><span class="o">.</span><span class="n">parameters</span><span class="p">[</span><span class="s2">&quot;archivo_calculos&quot;</span><span class="p">]</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>
    <span class="n">shutil</span><span class="o">.</span><span class="n">copyfile</span><span class="p">(</span><span class="n">files</span><span class="o">.</span><span class="n">parameters</span><span class="p">[</span><span class="s1">&#39;archivo_parametros&#39;</span><span class="p">],</span> <span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">parameter_loader</span><span class="o">.</span><span class="n">parameters</span><span class="p">[</span><span class="s2">&quot;ruta_output&quot;</span><span class="p">]</span><span class="si">}{</span><span class="n">files</span><span class="o">.</span><span class="n">parameters</span><span class="p">[</span><span class="s2">&quot;archivo_parametros&quot;</span><span class="p">]</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>



  </div>

    </div>

</div>

<div class="doc doc-object doc-module">



<a id="S2_Funciones"></a>
    <div class="doc doc-contents first">

        <p>Este script contiene todas las funciones externas que ayudan ya sea a preprocesar la data o a calcular el reaseguro</p>








  <div class="doc doc-children">









<div class="doc doc-object doc-function">


<h2 id="S2_Funciones.asignacion_contratos" class="doc doc-heading">
            <code class="highlight language-python"><span class="n">asignacion_contratos</span><span class="p">(</span><span class="n">df</span><span class="p">,</span> <span class="n">parameters</span><span class="p">,</span> <span class="n">tables</span><span class="p">,</span> <span class="n">mantiene_na</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span></code>

</h2>


    <div class="doc doc-contents ">

        <p>Asignacion de contratos de reaseguro, de acuerdo al contrato seleccionado
    Utiliza la funcion filtra_una_combinacion tantas veces como sea necesario hasta filtrar todo lo que el contrato tiene</p>


<p><span class="doc-section-title">Parameters:</span></p>
    <table>
      <thead>
        <tr>
          <th>Name</th>
          <th>Type</th>
          <th>Description</th>
          <th>Default</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
                <code>df</code>
            </td>
            <td>
                  <code><span title="pandas.DataFrame">DataFrame</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>dataframe con la data de asegurados</p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>parameters</code>
            </td>
            <td>
                  <code><a class="autorefs autorefs-internal" title="S0_Loaders.Parameter_Loader" href="#S0_Loaders.Parameter_Loader">Parameter_Loader</a></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Contiene los parametros del calculo</p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>tables</code>
            </td>
            <td>
                  <code><a class="autorefs autorefs-internal" title="S0_Loaders.Parameter_Loader" href="#S0_Loaders.Parameter_Loader">Parameter_Loader</a></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Contiene las tablas que ayudan a calcular los contratos de reaseguro</p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>mantiene_na</code>
            </td>
            <td>
                  <code>int</code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>binario que permite mantener los registros que no fueron asignados al contrato de reaseguro, by default 0</p>
              </div>
            </td>
            <td>
                  <code>0</code>
            </td>
          </tr>
      </tbody>
    </table>


    <p><span class="doc-section-title">Returns:</span></p>
    <table>
      <thead>
        <tr>
          <th>Type</th>
          <th>Description</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
                  <code><span title="pandas.DataFrame">DataFrame</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>dataframe original pero con mayor cantidad de campos que indican caracteristicas del contrato asignado</p>
              </div>
            </td>
          </tr>
      </tbody>
    </table>

            <details class="quote">
              <summary>Source code in <code>S2_Funciones.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">118</span>
<span class="normal">119</span>
<span class="normal">120</span>
<span class="normal">121</span>
<span class="normal">122</span>
<span class="normal">123</span>
<span class="normal">124</span>
<span class="normal">125</span>
<span class="normal">126</span>
<span class="normal">127</span>
<span class="normal">128</span>
<span class="normal">129</span>
<span class="normal">130</span>
<span class="normal">131</span>
<span class="normal">132</span>
<span class="normal">133</span>
<span class="normal">134</span>
<span class="normal">135</span>
<span class="normal">136</span>
<span class="normal">137</span>
<span class="normal">138</span>
<span class="normal">139</span>
<span class="normal">140</span>
<span class="normal">141</span>
<span class="normal">142</span>
<span class="normal">143</span>
<span class="normal">144</span>
<span class="normal">145</span>
<span class="normal">146</span>
<span class="normal">147</span>
<span class="normal">148</span>
<span class="normal">149</span>
<span class="normal">150</span>
<span class="normal">151</span>
<span class="normal">152</span>
<span class="normal">153</span>
<span class="normal">154</span>
<span class="normal">155</span>
<span class="normal">156</span>
<span class="normal">157</span>
<span class="normal">158</span>
<span class="normal">159</span>
<span class="normal">160</span>
<span class="normal">161</span>
<span class="normal">162</span>
<span class="normal">163</span>
<span class="normal">164</span>
<span class="normal">165</span>
<span class="normal">166</span>
<span class="normal">167</span>
<span class="normal">168</span>
<span class="normal">169</span>
<span class="normal">170</span>
<span class="normal">171</span>
<span class="normal">172</span>
<span class="normal">173</span>
<span class="normal">174</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span> <span class="nf">asignacion_contratos</span><span class="p">(</span><span class="n">df</span><span class="p">:</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">,</span> <span class="n">parameters</span><span class="p">:</span> <span class="n">Parameter_Loader</span><span class="p">,</span> <span class="n">tables</span><span class="p">:</span> <span class="n">Parameter_Loader</span><span class="p">,</span><span class="n">mantiene_na</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">0</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Asignacion de contratos de reaseguro, de acuerdo al contrato seleccionado</span>
<span class="sd">        Utiliza la funcion filtra_una_combinacion tantas veces como sea necesario hasta filtrar todo lo que el contrato tiene</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    df : pd.DataFrame</span>
<span class="sd">        dataframe con la data de asegurados</span>
<span class="sd">    parameters : Parameter_Loader</span>
<span class="sd">        Contiene los parametros del calculo</span>
<span class="sd">    tables : Parameter_Loader</span>
<span class="sd">        Contiene las tablas que ayudan a calcular los contratos de reaseguro</span>
<span class="sd">    mantiene_na : int, optional</span>
<span class="sd">        binario que permite mantener los registros que no fueron asignados al contrato de reaseguro, by default 0</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    pd.DataFrame</span>
<span class="sd">        dataframe original pero con mayor cantidad de campos que indican caracteristicas del contrato asignado</span>
<span class="sd">    &quot;&quot;&quot;</span>


    <span class="c1"># Contiene las polizas que debo asignar por ocurrencia al reaseguro</span>
    <span class="n">ocurrencias</span><span class="p">:</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span> <span class="o">=</span> <span class="n">tables</span><span class="o">.</span><span class="n">get_table_xlsx</span><span class="p">(</span><span class="n">sheet_name</span> <span class="o">=</span> <span class="s1">&#39;Ocurrencias&#39;</span><span class="p">)</span>
    <span class="n">tabla_parametros</span><span class="p">:</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span> <span class="o">=</span> <span class="n">tables</span><span class="o">.</span><span class="n">get_table_xlsx</span><span class="p">(</span><span class="n">sheet_name</span> <span class="o">=</span> <span class="s1">&#39;Matriz Contrato-Cobertura&#39;</span><span class="p">)</span>
    <span class="n">contrato</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="n">parameters</span><span class="o">.</span><span class="n">parameters</span><span class="p">[</span><span class="s1">&#39;contrato&#39;</span><span class="p">]</span>
    <span class="n">tipo_calculo</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="n">parameters</span><span class="o">.</span><span class="n">parameters</span><span class="p">[</span><span class="s1">&#39;tipo_calculo&#39;</span><span class="p">]</span>
    <span class="n">tipo_prima</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="n">parameters</span><span class="o">.</span><span class="n">parameters</span><span class="p">[</span><span class="s1">&#39;tipo_prima&#39;</span><span class="p">]</span>
    <span class="n">archivo_reporte</span><span class="p">:</span> <span class="n">Any</span> <span class="o">=</span> <span class="n">parameters</span><span class="o">.</span><span class="n">parameters</span><span class="p">[</span><span class="s1">&#39;archivo_reporte&#39;</span><span class="p">]</span>
    <span class="c1"># Definiciones preliminares del proceso</span>
    <span class="n">original_rows</span><span class="o">=</span><span class="n">df</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
    <span class="c1"># Solo tomo los registros asociados al proceso que estoy corriendo. Mayor info en el diccionario de contratos</span>
    <span class="k">if</span> <span class="n">tipo_calculo</span> <span class="o">==</span> <span class="s1">&#39;Prima de Reaseguro&#39;</span><span class="p">:</span> <span class="n">tabla_parametros</span><span class="o">=</span><span class="n">tabla_parametros</span><span class="p">[</span><span class="n">tabla_parametros</span><span class="p">[</span><span class="s1">&#39;CONTRATO REASEGURO&#39;</span><span class="p">]</span><span class="o">==</span><span class="n">contrato</span><span class="p">]</span>
    <span class="n">cols_cruce</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;CONTRATO REASEGURO&#39;</span><span class="p">,</span><span class="s1">&#39;COBERTURA DEL CONTRATO&#39;</span><span class="p">,</span><span class="s1">&#39;INICIO DEL CONTRATO&#39;</span><span class="p">]</span>
    <span class="n">lista_campos</span><span class="p">:</span> <span class="nb">list</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span><span class="o">=</span><span class="nb">list</span><span class="p">(</span><span class="nb">set</span><span class="p">(</span><span class="nb">list</span><span class="p">(</span><span class="n">tabla_parametros</span><span class="o">.</span><span class="n">columns</span><span class="p">))</span><span class="o">.</span><span class="n">difference</span><span class="p">(</span><span class="n">cols_cruce</span><span class="p">))</span>
    <span class="n">lista_combinaciones</span><span class="p">:</span> <span class="nb">list</span><span class="p">[</span><span class="nb">set</span><span class="p">[</span><span class="nb">str</span><span class="p">]]</span> <span class="o">=</span> <span class="n">get_all_subsets</span><span class="p">(</span><span class="n">lista_campos</span><span class="p">)</span>
    <span class="n">lista_combinaciones</span><span class="o">.</span><span class="n">remove</span><span class="p">(</span><span class="nb">set</span><span class="p">())</span>
    <span class="n">df_final</span><span class="o">=</span><span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">()</span>
    <span class="n">escribe_reporta</span><span class="p">(</span><span class="n">archivo_reporte</span><span class="p">,</span><span class="s1">&#39;COMIENZA LA ASIGNACION DE CONTRATOS DE REASEGURO:</span><span class="se">\n</span><span class="si">{}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">time</span><span class="o">.</span><span class="n">strftime</span><span class="p">(</span><span class="s1">&#39;%Y-%m-</span><span class="si">%d</span><span class="s1"> %H:%M:%S&#39;</span><span class="p">,</span> <span class="n">time</span><span class="o">.</span><span class="n">localtime</span><span class="p">(</span><span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()))))</span>
    <span class="c1"># Asigna la fecha que debemos tener en consideracion para asignar tipo_calculo</span>
    <span class="c1"># Si el tipo_calculo es por suscripcion, se toma la fecha de inicio vigencia</span>
    <span class="c1"># Si el tipo_calculo es por ocurrencia, se toma la fecha de cierre</span>
    <span class="n">df</span><span class="o">=</span><span class="n">df</span><span class="o">.</span><span class="n">merge</span><span class="p">(</span><span class="n">ocurrencias</span><span class="p">,</span><span class="n">how</span><span class="o">=</span><span class="s1">&#39;left&#39;</span><span class="p">,</span><span class="n">on</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;POLIZA&#39;</span><span class="p">])</span>
    <span class="k">if</span> <span class="n">pd</span><span class="o">.</span><span class="n">concat</span><span class="p">([</span><span class="n">df_final</span><span class="p">,</span><span class="n">df</span><span class="p">])</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">&gt;</span><span class="n">original_rows</span><span class="p">:</span> <span class="n">escribe_reporta</span><span class="p">(</span><span class="n">archivo_reporte</span><span class="p">,</span> <span class="s1">&#39;El dataframe posterior a la tabla de ocurrencias tiene más registros. REVISAR!&#39;</span><span class="p">)</span>
    <span class="n">df</span><span class="p">[</span><span class="s1">&#39;PERIODO DEL CONTRATO&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">df</span><span class="p">[</span><span class="s1">&#39;PERIODO DEL CONTRATO&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">fillna</span><span class="p">(</span><span class="s1">&#39;Ocurrencia&#39;</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">tipo_calculo</span> <span class="o">==</span> <span class="s1">&#39;Siniestros de Reaseguro&#39;</span><span class="p">:</span> <span class="n">df</span><span class="p">[</span><span class="s1">&#39;FECHA CRUCE VIGENCIAS&#39;</span><span class="p">]</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">df</span><span class="p">[</span><span class="s1">&#39;PERIODO DEL CONTRATO&#39;</span><span class="p">]</span><span class="o">==</span><span class="s1">&#39;Ocurrencia&#39;</span><span class="p">,</span><span class="n">df</span><span class="p">[</span><span class="s1">&#39;FECHA_SINIESTRO&#39;</span><span class="p">],</span><span class="n">df</span><span class="p">[</span><span class="s1">&#39;INICIO_VIGENCIA&#39;</span><span class="p">])</span>
    <span class="k">elif</span> <span class="n">tipo_prima</span><span class="o">==</span><span class="s1">&#39;Prima Unica&#39;</span><span class="p">:</span> <span class="n">df</span><span class="p">[</span><span class="s1">&#39;FECHA CRUCE VIGENCIAS&#39;</span><span class="p">]</span><span class="o">=</span><span class="n">df</span><span class="p">[</span><span class="s1">&#39;FECHA_EFECTO&#39;</span><span class="p">]</span> 
    <span class="k">else</span> <span class="p">:</span> <span class="n">df</span><span class="p">[</span><span class="s1">&#39;FECHA CRUCE VIGENCIAS&#39;</span><span class="p">]</span><span class="o">=</span><span class="n">df</span><span class="p">[</span><span class="s1">&#39;FECHA CIERRE&#39;</span><span class="p">]</span>
    <span class="c1"># Recorre el dataframe para cada registro de filtro que deba hacer, para ir concatenandolos en el df que necesitamos</span>
    <span class="k">for</span> <span class="n">combinacion</span> <span class="ow">in</span> <span class="n">lista_combinaciones</span><span class="p">:</span>
        <span class="k">if</span> <span class="nb">all</span><span class="p">(</span><span class="n">x</span> <span class="ow">in</span> <span class="n">df</span><span class="o">.</span><span class="n">columns</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">combinacion</span><span class="p">):</span>        
            <span class="n">df_filtrado</span><span class="p">,</span><span class="n">df</span><span class="p">,</span><span class="n">tabla_parametros</span><span class="o">=</span><span class="n">filtra_una_combinacion</span><span class="p">(</span><span class="n">df</span><span class="p">,</span><span class="n">lista_campos</span><span class="p">,</span><span class="n">tabla_parametros</span><span class="p">,</span><span class="n">combinacion</span><span class="p">,</span><span class="n">cols_cruce</span><span class="p">)</span>
            <span class="n">df_final</span><span class="o">=</span><span class="n">pd</span><span class="o">.</span><span class="n">concat</span><span class="p">([</span><span class="n">df_final</span><span class="p">,</span><span class="n">df_filtrado</span><span class="p">],</span><span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
    <span class="k">if</span> <span class="nb">list</span><span class="p">(</span><span class="nb">set</span><span class="p">(</span><span class="n">lista_campos</span><span class="p">)</span> <span class="o">-</span> <span class="nb">set</span><span class="p">(</span><span class="n">df</span><span class="o">.</span><span class="n">columns</span><span class="p">))</span> <span class="o">!=</span> <span class="p">[]:</span> <span class="n">escribe_reporta</span><span class="p">(</span><span class="n">archivo_reporte</span><span class="p">,</span> <span class="sa">f</span><span class="s1">&#39;Las siguientes columnas no se encuentran en el df para poder asignar contratos</span><span class="se">\n</span><span class="si">{</span><span class="nb">list</span><span class="p">(</span><span class="nb">set</span><span class="p">(</span><span class="n">lista_campos</span><span class="p">)</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="nb">set</span><span class="p">(</span><span class="n">df</span><span class="o">.</span><span class="n">columns</span><span class="p">))</span><span class="si">}</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">pd</span><span class="o">.</span><span class="n">concat</span><span class="p">([</span><span class="n">df_final</span><span class="p">,</span><span class="n">df</span><span class="p">])</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">&gt;</span><span class="n">original_rows</span><span class="p">:</span> <span class="n">escribe_reporta</span><span class="p">(</span><span class="n">archivo_reporte</span><span class="p">,</span> <span class="s1">&#39;El dataframe posterior a la asignación de contratos tiene más registros. REVISAR!&#39;</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">mantiene_na</span><span class="o">==</span><span class="mi">1</span><span class="p">:</span> <span class="k">return</span> <span class="n">pd</span><span class="o">.</span><span class="n">concat</span><span class="p">([</span><span class="n">df_final</span><span class="p">,</span><span class="n">df</span><span class="p">],</span><span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span> <span class="k">return</span> <span class="n">df_final</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>

<div class="doc doc-object doc-function">


<h2 id="S2_Funciones.asignacion_vigencias" class="doc doc-heading">
            <code class="highlight language-python"><span class="n">asignacion_vigencias</span><span class="p">(</span><span class="n">df</span><span class="p">,</span> <span class="n">parameters</span><span class="p">,</span> <span class="n">tables</span><span class="p">,</span> <span class="n">mantiene_na</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span></code>

</h2>


    <div class="doc doc-contents ">

        <p>Asigna la vigencia del reaseguro a la cual pertenece cada registro. Tambien puede quitar del reaseguro aquellos registros que por fechas de inicio y fin no deban pertencer al contrato de reaseguro</p>


<p><span class="doc-section-title">Parameters:</span></p>
    <table>
      <thead>
        <tr>
          <th>Name</th>
          <th>Type</th>
          <th>Description</th>
          <th>Default</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
                <code>df</code>
            </td>
            <td>
                  <code><span title="pandas.DataFrame">DataFrame</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>dataframe con la data de asegurados</p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>parameters</code>
            </td>
            <td>
                  <code><a class="autorefs autorefs-internal" title="S0_Loaders.Parameter_Loader" href="#S0_Loaders.Parameter_Loader">Parameter_Loader</a></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Contiene los parametros del calculo</p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>tables</code>
            </td>
            <td>
                  <code><a class="autorefs autorefs-internal" title="S0_Loaders.Parameter_Loader" href="#S0_Loaders.Parameter_Loader">Parameter_Loader</a></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Contiene las tablas que ayudan a calcular</p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>mantiene_na</code>
            </td>
            <td>
                  <code>int</code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>binario que permite mantener los registros que no fueron asignados al contrato de reaseguro, by default 0</p>
              </div>
            </td>
            <td>
                  <code>0</code>
            </td>
          </tr>
      </tbody>
    </table>


    <p><span class="doc-section-title">Returns:</span></p>
    <table>
      <thead>
        <tr>
          <th>Type</th>
          <th>Description</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
                  <code>tuple[<span title="pandas.DataFrame">DataFrame</span>, <span title="pandas.DataFrame">DataFrame</span>]</code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>dataframe original pero con mayor cantidad de campos que indican caracteristicas de la vigencia del contrato asignado</p>
              </div>
            </td>
          </tr>
      </tbody>
    </table>

            <details class="quote">
              <summary>Source code in <code>S2_Funciones.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">177</span>
<span class="normal">178</span>
<span class="normal">179</span>
<span class="normal">180</span>
<span class="normal">181</span>
<span class="normal">182</span>
<span class="normal">183</span>
<span class="normal">184</span>
<span class="normal">185</span>
<span class="normal">186</span>
<span class="normal">187</span>
<span class="normal">188</span>
<span class="normal">189</span>
<span class="normal">190</span>
<span class="normal">191</span>
<span class="normal">192</span>
<span class="normal">193</span>
<span class="normal">194</span>
<span class="normal">195</span>
<span class="normal">196</span>
<span class="normal">197</span>
<span class="normal">198</span>
<span class="normal">199</span>
<span class="normal">200</span>
<span class="normal">201</span>
<span class="normal">202</span>
<span class="normal">203</span>
<span class="normal">204</span>
<span class="normal">205</span>
<span class="normal">206</span>
<span class="normal">207</span>
<span class="normal">208</span>
<span class="normal">209</span>
<span class="normal">210</span>
<span class="normal">211</span>
<span class="normal">212</span>
<span class="normal">213</span>
<span class="normal">214</span>
<span class="normal">215</span>
<span class="normal">216</span>
<span class="normal">217</span>
<span class="normal">218</span>
<span class="normal">219</span>
<span class="normal">220</span>
<span class="normal">221</span>
<span class="normal">222</span>
<span class="normal">223</span>
<span class="normal">224</span>
<span class="normal">225</span>
<span class="normal">226</span>
<span class="normal">227</span>
<span class="normal">228</span>
<span class="normal">229</span>
<span class="normal">230</span>
<span class="normal">231</span>
<span class="normal">232</span>
<span class="normal">233</span>
<span class="normal">234</span>
<span class="normal">235</span>
<span class="normal">236</span>
<span class="normal">237</span>
<span class="normal">238</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span> <span class="nf">asignacion_vigencias</span><span class="p">(</span><span class="n">df</span><span class="p">:</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">,</span> <span class="n">parameters</span><span class="p">:</span> <span class="n">Parameter_Loader</span><span class="p">,</span> <span class="n">tables</span><span class="p">:</span> <span class="n">Parameter_Loader</span><span class="p">,</span><span class="n">mantiene_na</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">0</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">tuple</span><span class="p">[</span><span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">,</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">]:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Asigna la vigencia del reaseguro a la cual pertenece cada registro. Tambien puede quitar del reaseguro aquellos registros que por fechas de inicio y fin no deban pertencer al contrato de reaseguro</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    df : pd.DataFrame</span>
<span class="sd">        dataframe con la data de asegurados</span>
<span class="sd">    parameters : Parameter_Loader</span>
<span class="sd">        Contiene los parametros del calculo</span>
<span class="sd">    tables : Parameter_Loader</span>
<span class="sd">        Contiene las tablas que ayudan a calcular </span>
<span class="sd">    mantiene_na : int, optional</span>
<span class="sd">        binario que permite mantener los registros que no fueron asignados al contrato de reaseguro, by default 0</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    tuple[pd.DataFrame, pd.DataFrame]</span>
<span class="sd">        dataframe original pero con mayor cantidad de campos que indican caracteristicas de la vigencia del contrato asignado</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="n">archivo_reporte</span><span class="p">:</span> <span class="n">Any</span> <span class="o">=</span> <span class="n">parameters</span><span class="o">.</span><span class="n">parameters</span><span class="p">[</span><span class="s1">&#39;archivo_reporte&#39;</span><span class="p">]</span>
    <span class="n">contrato</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="n">parameters</span><span class="o">.</span><span class="n">parameters</span><span class="p">[</span><span class="s1">&#39;contrato&#39;</span><span class="p">]</span>
    <span class="n">tipo_calculo</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="n">parameters</span><span class="o">.</span><span class="n">parameters</span><span class="p">[</span><span class="s1">&#39;tipo_calculo&#39;</span><span class="p">]</span>
    <span class="n">tabla_parametros</span><span class="p">:</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span> <span class="o">=</span> <span class="n">tables</span><span class="o">.</span><span class="n">get_table_xlsx</span><span class="p">(</span><span class="n">sheet_name</span> <span class="o">=</span> <span class="s1">&#39;Matriz Vigencias&#39;</span><span class="p">)</span>
    <span class="n">escribe_reporta</span><span class="p">(</span><span class="n">archivo_reporte</span><span class="p">,</span><span class="s1">&#39;COMIENZA LA ASIGNACION DE VIGENCIAS DE LOS CONTRATOS DE REASEGURO:</span><span class="se">\n</span><span class="si">{}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">time</span><span class="o">.</span><span class="n">strftime</span><span class="p">(</span><span class="s1">&#39;%Y-%m-</span><span class="si">%d</span><span class="s1"> %H:%M:%S&#39;</span><span class="p">,</span> <span class="n">time</span><span class="o">.</span><span class="n">localtime</span><span class="p">(</span><span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()))))</span>
    <span class="n">cols_iniciales</span><span class="o">=</span><span class="nb">list</span><span class="p">(</span><span class="n">df</span><span class="o">.</span><span class="n">columns</span><span class="p">)</span>
    <span class="n">df_nuls</span><span class="o">=</span><span class="n">df</span><span class="p">[</span><span class="n">df</span><span class="p">[</span><span class="s1">&#39;CONTRATO REASEGURO&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">isnull</span><span class="p">()]</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
    <span class="n">df_final</span><span class="o">=</span><span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">()</span>

    <span class="k">if</span> <span class="n">tipo_calculo</span> <span class="o">==</span> <span class="s1">&#39;Prima de Reaseguro&#39;</span><span class="p">:</span>
        <span class="n">tabla_parametros</span><span class="o">=</span><span class="n">tabla_parametros</span><span class="p">[</span><span class="n">tabla_parametros</span><span class="p">[</span><span class="s1">&#39;CONTRATO REASEGURO&#39;</span><span class="p">]</span><span class="o">==</span><span class="n">contrato</span><span class="p">]</span>
        <span class="n">cobs_reaseguro</span><span class="o">=</span><span class="n">tabla_parametros</span><span class="p">[</span><span class="n">tabla_parametros</span><span class="p">[</span><span class="s1">&#39;CONTRATO REASEGURO&#39;</span><span class="p">]</span><span class="o">==</span><span class="n">contrato</span><span class="p">][</span><span class="s1">&#39;COBERTURA DEL CONTRATO&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">unique</span><span class="p">()</span>
        <span class="c1"># Ciclo que recorre cada uno de los elementos de la losta para ir filtrando y asignado vigencias</span>
        <span class="k">for</span> <span class="n">cobertura_reaseg</span> <span class="ow">in</span> <span class="n">cobs_reaseguro</span><span class="p">:</span>
            <span class="n">df_filtrado</span><span class="p">:</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span> <span class="o">=</span> <span class="n">df</span><span class="p">[</span><span class="n">df</span><span class="p">[</span><span class="s1">&#39;COBERTURA DEL CONTRATO&#39;</span><span class="p">]</span><span class="o">==</span><span class="n">cobertura_reaseg</span><span class="p">]</span>
            <span class="n">tabla_filtrada</span><span class="p">:</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span> <span class="o">=</span> <span class="n">tabla_parametros</span><span class="p">[</span><span class="n">tabla_parametros</span><span class="p">[</span><span class="s1">&#39;COBERTURA DEL CONTRATO&#39;</span><span class="p">]</span><span class="o">==</span><span class="n">cobertura_reaseg</span><span class="p">]</span>
            <span class="n">df_final</span><span class="p">:</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">concat</span><span class="p">(</span><span class="n">objs</span><span class="o">=</span><span class="p">[</span><span class="n">df_final</span><span class="p">,</span><span class="n">pd</span><span class="o">.</span><span class="n">merge_asof</span><span class="p">(</span><span class="n">df_filtrado</span><span class="o">.</span><span class="n">sort_values</span><span class="p">(</span><span class="s1">&#39;FECHA CRUCE VIGENCIAS&#39;</span><span class="p">),</span><span class="n">tabla_filtrada</span><span class="o">.</span><span class="n">sort_values</span><span class="p">(</span><span class="s1">&#39;FECHA INICIO CONTRATO&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">drop</span><span class="p">([</span><span class="s1">&#39;CONTRATO REASEGURO&#39;</span><span class="p">,</span><span class="s1">&#39;COBERTURA DEL CONTRATO&#39;</span><span class="p">],</span><span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">),</span><span class="n">left_on</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;FECHA CRUCE VIGENCIAS&#39;</span><span class="p">],</span><span class="n">right_on</span><span class="o">=</span><span class="s1">&#39;FECHA INICIO CONTRATO&#39;</span><span class="p">)],</span><span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span> <span class="c1"># type: ignore</span>
    <span class="k">if</span> <span class="n">tipo_calculo</span> <span class="o">==</span> <span class="s1">&#39;Siniestros de Reaseguro&#39;</span><span class="p">:</span>
        <span class="n">contratos_reaseguro</span> <span class="o">=</span> <span class="n">df</span><span class="p">[</span><span class="s1">&#39;CONTRATO REASEGURO&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">unique</span><span class="p">()</span>
        <span class="k">for</span> <span class="n">contrato_reaseg</span> <span class="ow">in</span> <span class="n">contratos_reaseguro</span><span class="p">:</span>
            <span class="n">tabla_parametros_contrato</span><span class="o">=</span><span class="n">tabla_parametros</span><span class="p">[</span><span class="n">tabla_parametros</span><span class="p">[</span><span class="s1">&#39;CONTRATO REASEGURO&#39;</span><span class="p">]</span><span class="o">==</span><span class="n">contrato_reaseg</span><span class="p">]</span>
            <span class="n">cobs_reaseguro</span><span class="o">=</span><span class="n">tabla_parametros_contrato</span><span class="p">[</span><span class="n">tabla_parametros_contrato</span><span class="p">[</span><span class="s1">&#39;CONTRATO REASEGURO&#39;</span><span class="p">]</span><span class="o">==</span><span class="n">contrato_reaseg</span><span class="p">][</span><span class="s1">&#39;COBERTURA DEL CONTRATO&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">unique</span><span class="p">()</span>
            <span class="n">df_contrato</span> <span class="o">=</span> <span class="n">df</span><span class="p">[</span><span class="n">df</span><span class="p">[</span><span class="s1">&#39;CONTRATO REASEGURO&#39;</span><span class="p">]</span><span class="o">==</span><span class="n">contrato_reaseg</span><span class="p">]</span>
            <span class="c1"># Ciclo que recorre cada uno de los elementos de la losta para ir filtrando y asignado vigencias</span>
            <span class="k">for</span> <span class="n">cobertura_reaseg</span> <span class="ow">in</span> <span class="n">cobs_reaseguro</span><span class="p">:</span>
                <span class="n">df_filtrado</span><span class="o">=</span><span class="n">df_contrato</span><span class="p">[(</span><span class="n">df_contrato</span><span class="p">[</span><span class="s1">&#39;COBERTURA DEL CONTRATO&#39;</span><span class="p">]</span><span class="o">==</span><span class="n">cobertura_reaseg</span><span class="p">)]</span>
                <span class="n">tabla_filtrada</span><span class="o">=</span><span class="n">tabla_parametros_contrato</span><span class="p">[</span><span class="n">tabla_parametros_contrato</span><span class="p">[</span><span class="s1">&#39;COBERTURA DEL CONTRATO&#39;</span><span class="p">]</span><span class="o">==</span><span class="n">cobertura_reaseg</span><span class="p">]</span>
                <span class="n">df_final</span><span class="o">=</span><span class="n">pd</span><span class="o">.</span><span class="n">concat</span><span class="p">([</span><span class="n">df_final</span><span class="p">,</span><span class="n">pd</span><span class="o">.</span><span class="n">merge_asof</span><span class="p">(</span><span class="n">df_filtrado</span><span class="o">.</span><span class="n">sort_values</span><span class="p">(</span><span class="s1">&#39;FECHA CRUCE VIGENCIAS&#39;</span><span class="p">),</span><span class="n">tabla_filtrada</span><span class="o">.</span><span class="n">sort_values</span><span class="p">(</span><span class="s1">&#39;FECHA INICIO CONTRATO&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">drop</span><span class="p">([</span><span class="s1">&#39;CONTRATO REASEGURO&#39;</span><span class="p">,</span><span class="s1">&#39;COBERTURA DEL CONTRATO&#39;</span><span class="p">],</span><span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">),</span><span class="n">left_on</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;FECHA CRUCE VIGENCIAS&#39;</span><span class="p">],</span><span class="n">right_on</span><span class="o">=</span><span class="s1">&#39;FECHA INICIO CONTRATO&#39;</span><span class="p">)],</span><span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span> <span class="c1"># type: ignore</span>

    <span class="c1"># Eliminamos registros con fecha posterior o anterior a los contratos de vigencia establecidos</span>
    <span class="n">cols_finales</span><span class="o">=</span><span class="nb">list</span><span class="p">(</span><span class="n">df_final</span><span class="o">.</span><span class="n">columns</span><span class="p">)</span>
    <span class="n">cols_extra</span><span class="o">=</span><span class="p">[</span><span class="n">x</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">cols_finales</span> <span class="k">if</span> <span class="ow">not</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">cols_iniciales</span><span class="p">]</span>
    <span class="n">df_final_01</span><span class="o">=</span><span class="n">df_final</span><span class="p">[</span><span class="o">~</span><span class="n">df_final</span><span class="p">[</span><span class="s1">&#39;VIGENCIA CONTRATO&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">isnull</span><span class="p">()]</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
    <span class="n">df_final_02</span><span class="o">=</span><span class="n">df_final_01</span><span class="p">[</span><span class="n">df_final_01</span><span class="p">[</span><span class="s1">&#39;FECHA CRUCE VIGENCIAS&#39;</span><span class="p">]</span><span class="o">&lt;=</span><span class="n">df_final_01</span><span class="p">[</span><span class="s1">&#39;FECHA FIN CONTRATO&#39;</span><span class="p">]]</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
    <span class="n">df_deleted</span><span class="o">=</span><span class="n">df_final</span><span class="p">[(</span><span class="n">df_final</span><span class="p">[</span><span class="s1">&#39;VIGENCIA CONTRATO&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">isnull</span><span class="p">())</span><span class="o">|</span><span class="p">(</span><span class="n">df_final</span><span class="p">[</span><span class="s1">&#39;FECHA CRUCE VIGENCIAS&#39;</span><span class="p">]</span><span class="o">&gt;</span><span class="n">df_final</span><span class="p">[</span><span class="s1">&#39;FECHA FIN CONTRATO&#39;</span><span class="p">])]</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
    <span class="c1"># Revisamos cuantos elementos se eliminaron por temas de fechas</span>
    <span class="n">reg_elim_ant</span><span class="o">=</span><span class="nb">sum</span><span class="p">(</span><span class="n">df_final</span><span class="p">[</span><span class="s1">&#39;VIGENCIA CONTRATO&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">isnull</span><span class="p">())</span>
    <span class="n">reg_elim_post</span><span class="o">=</span><span class="nb">sum</span><span class="p">(</span><span class="n">df_final_01</span><span class="p">[</span><span class="s1">&#39;FECHA CRUCE VIGENCIAS&#39;</span><span class="p">]</span><span class="o">&gt;</span><span class="n">df_final_01</span><span class="p">[</span><span class="s1">&#39;FECHA FIN CONTRATO&#39;</span><span class="p">])</span>
    <span class="k">if</span> <span class="n">reg_elim_ant</span><span class="o">&gt;</span><span class="mi">0</span><span class="p">:</span><span class="n">escribe_reporta</span><span class="p">(</span><span class="n">archivo_reporte</span><span class="p">,</span><span class="sa">f</span><span class="s1">&#39;Se eliminaron </span><span class="si">{</span><span class="n">reg_elim_ant</span><span class="si">}</span><span class="s1"> registros cuya fecha es anterior al primer </span><span class="si">{</span><span class="n">tipo_calculo</span><span class="si">}</span><span class="s1"> de reaseguro establecido&#39;</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">reg_elim_post</span><span class="o">&gt;</span><span class="mi">0</span><span class="p">:</span><span class="n">escribe_reporta</span><span class="p">(</span><span class="n">archivo_reporte</span><span class="p">,</span><span class="sa">f</span><span class="s1">&#39;Se eliminaron </span><span class="si">{</span><span class="n">reg_elim_post</span><span class="si">}</span><span class="s1"> registros cuya fecha es posterior al ultimo </span><span class="si">{</span><span class="n">tipo_calculo</span><span class="si">}</span><span class="s1"> de reaseguro establecido&#39;</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">mantiene_na</span><span class="o">==</span><span class="mi">1</span><span class="p">:</span> <span class="k">return</span> <span class="n">pd</span><span class="o">.</span><span class="n">concat</span><span class="p">([</span><span class="n">df_final_02</span><span class="p">,</span><span class="n">df_deleted</span><span class="o">.</span><span class="n">drop</span><span class="p">([</span><span class="s1">&#39;CONTRATO REASEGURO&#39;</span><span class="p">,</span><span class="s1">&#39;COBERTURA DEL CONTRATO&#39;</span><span class="p">,</span><span class="s1">&#39;INICIO DEL CONTRATO&#39;</span><span class="p">]</span><span class="o">+</span><span class="n">cols_extra</span><span class="p">,</span><span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">),</span><span class="n">df_nuls</span><span class="p">],</span><span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">),</span><span class="n">df_deleted</span>
    <span class="k">else</span><span class="p">:</span> <span class="k">return</span> <span class="n">df_final_02</span><span class="p">,</span><span class="n">df_deleted</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>

<div class="doc doc-object doc-function">


<h2 id="S2_Funciones.automatizacion_querys" class="doc doc-heading">
            <code class="highlight language-python"><span class="n">automatizacion_querys</span><span class="p">(</span><span class="n">files</span><span class="p">)</span></code>

</h2>


    <div class="doc doc-contents ">

        <p>Ejecucion de querys de extraccion de data necesaria para el proceso</p>


<p><span class="doc-section-title">Parameters:</span></p>
    <table>
      <thead>
        <tr>
          <th>Name</th>
          <th>Type</th>
          <th>Description</th>
          <th>Default</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
                <code>files</code>
            </td>
            <td>
                  <code><a class="autorefs autorefs-internal" title="S0_Loaders.Parameter_Loader" href="#S0_Loaders.Parameter_Loader">Parameter_Loader</a></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Contiene informacion del archivo de querys que debemos mirar para este proceso</p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
      </tbody>
    </table>

            <details class="quote">
              <summary>Source code in <code>S2_Funciones.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">1124</span>
<span class="normal">1125</span>
<span class="normal">1126</span>
<span class="normal">1127</span>
<span class="normal">1128</span>
<span class="normal">1129</span>
<span class="normal">1130</span>
<span class="normal">1131</span>
<span class="normal">1132</span>
<span class="normal">1133</span>
<span class="normal">1134</span>
<span class="normal">1135</span>
<span class="normal">1136</span>
<span class="normal">1137</span>
<span class="normal">1138</span>
<span class="normal">1139</span>
<span class="normal">1140</span>
<span class="normal">1141</span>
<span class="normal">1142</span>
<span class="normal">1143</span>
<span class="normal">1144</span>
<span class="normal">1145</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span> <span class="nf">automatizacion_querys</span><span class="p">(</span><span class="n">files</span><span class="p">:</span> <span class="n">Parameter_Loader</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Ejecucion de querys de extraccion de data necesaria para el proceso</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    files : Parameter_Loader</span>
<span class="sd">        Contiene informacion del archivo de querys que debemos mirar para este proceso</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="c1"># Parametros de la consulta</span>
    <span class="n">querys</span><span class="p">:</span> <span class="n">Parameter_Loader</span> <span class="o">=</span> <span class="n">Parameter_Loader</span><span class="p">(</span><span class="n">excel_file</span><span class="o">=</span><span class="n">files</span><span class="o">.</span><span class="n">parameters</span><span class="p">[</span><span class="s1">&#39;archivo_querys&#39;</span><span class="p">],</span> <span class="n">open_wb</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">ruta_extensa</span><span class="o">=</span><span class="s1">&#39;&#39;</span><span class="p">)</span>
    <span class="n">ruta_extensa</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="n">files</span><span class="o">.</span><span class="n">ruta_extensa</span>
    <span class="n">periodo_inicio</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="n">querys</span><span class="o">.</span><span class="n">get_reference</span><span class="p">(</span><span class="n">reference</span><span class="o">=</span><span class="s1">&#39;periodo_inicio&#39;</span><span class="p">)</span>
    <span class="n">periodo_fin</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="n">querys</span><span class="o">.</span><span class="n">get_reference</span><span class="p">(</span><span class="n">reference</span><span class="o">=</span><span class="s1">&#39;periodo_fin&#39;</span><span class="p">)</span>
    <span class="n">querys</span><span class="o">.</span><span class="n">wb</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
    <span class="n">parametros_split</span><span class="p">:</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span> <span class="o">=</span> <span class="n">querys</span><span class="o">.</span><span class="n">get_table_xlsx</span><span class="p">(</span><span class="n">sheet_name</span> <span class="o">=</span> <span class="s1">&#39;Split Querys&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">nan</span><span class="p">,</span> <span class="s1">&#39;&#39;</span><span class="p">,</span> <span class="n">regex</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
    <span class="n">parametros_querys</span><span class="p">:</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span> <span class="o">=</span> <span class="n">querys</span><span class="o">.</span><span class="n">get_table_xlsx</span><span class="p">(</span><span class="n">sheet_name</span> <span class="o">=</span> <span class="s1">&#39;Diccionario Querys&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">nan</span><span class="p">,</span> <span class="s1">&#39;&#39;</span><span class="p">,</span> <span class="n">regex</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
    <span class="n">diccionario_querys</span><span class="p">:</span> <span class="nb">dict</span><span class="p">[</span><span class="n">Hashable</span><span class="p">,</span> <span class="n">Any</span><span class="p">]</span><span class="o">=</span><span class="n">parametros_querys</span><span class="o">.</span><span class="n">set_index</span><span class="p">(</span><span class="s1">&#39;QUERY&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">to_dict</span><span class="p">()</span>

    <span class="k">for</span> <span class="n">consulta</span> <span class="ow">in</span> <span class="n">parametros_querys</span><span class="p">[</span><span class="s1">&#39;QUERY&#39;</span><span class="p">]:</span>
        <span class="n">aplica</span><span class="o">=</span><span class="n">diccionario_querys</span><span class="p">[</span><span class="s1">&#39;APLICA&#39;</span><span class="p">][</span><span class="n">consulta</span><span class="p">]</span>
        <span class="k">if</span> <span class="n">aplica</span><span class="o">==</span><span class="mi">1</span><span class="p">:</span> 
            <span class="n">ejecuta_query</span><span class="p">(</span><span class="n">consulta</span><span class="p">,</span><span class="n">periodo_inicio</span><span class="p">,</span><span class="n">periodo_fin</span><span class="p">,</span><span class="n">diccionario_querys</span><span class="p">,</span><span class="n">parametros_split</span><span class="p">,</span> <span class="n">ruta_extensa</span><span class="p">)</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>

<div class="doc doc-object doc-function">


<h2 id="S2_Funciones.calcula_edad" class="doc doc-heading">
            <code class="highlight language-python"><span class="n">calcula_edad</span><span class="p">(</span><span class="n">rut_series</span><span class="p">,</span> <span class="n">fec_nac_series</span><span class="p">,</span> <span class="n">fec_corte_series</span><span class="p">,</span> <span class="n">edad_perdidos</span><span class="p">,</span> <span class="n">edad_tope</span><span class="p">,</span> <span class="n">archivo_reporte</span><span class="p">,</span> <span class="n">reporta_issues</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">edad_inf</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">aplica_edad_prom_cartera</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span></code>

</h2>


    <div class="doc doc-contents ">

        <p>Calcula la edad de cada registro en una serie, basado en la fecha de nacimiento (fec_nac_series)
y la fecha de corte (fec_corte_series). Además, aplica reglas de corrección en casos de datos
perdidos o inválidos, y puede reportar información adicional sobre los registros problemáticos.</p>


<p><span class="doc-section-title">Parameters:</span></p>
    <table>
      <thead>
        <tr>
          <th>Name</th>
          <th>Type</th>
          <th>Description</th>
          <th>Default</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
                <code>rut_series</code>
            </td>
            <td>
                  <code><span title="pandas.Series">Series</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Serie que contiene los RUT (identificador único) de cada registro.</p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>fec_nac_series</code>
            </td>
            <td>
                  <code><span title="pandas.Series">Series</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Serie que contiene las fechas de nacimiento de cada registro.</p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>fec_corte_series</code>
            </td>
            <td>
                  <code><span title="typing.Any">Any</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Fecha de corte o serie de fechas de corte para el cálculo de la edad.
Puede ser un objeto datetime o un pd.Series de fechas.</p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>edad_perdidos</code>
            </td>
            <td>
                  <code>int</code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Edad que se asigna a los registros con fecha de nacimiento nula o mala cuando
NO se aplica la edad promedio de la cartera.</p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>edad_tope</code>
            </td>
            <td>
                  <code>int</code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Edad máxima permitida. Si la edad calculada supera este valor y no se aplica
la edad promedio de la cartera, se recorta a este tope.</p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>archivo_reporte</code>
            </td>
            <td>
                  <code><span title="typing.TextIO">TextIO</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Objeto de archivo para escribir los reportes de problemas detectados.</p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>reporta_issues</code>
            </td>
            <td>
                  <code>int</code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Indica si se debe retornar también el arreglo con los registros que presentan
problemas. Valor por defecto = 0 (no se reportan).</p>
              </div>
            </td>
            <td>
                  <code>0</code>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>edad_inf</code>
            </td>
            <td>
                  <code>int</code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Edad mínima permitida. Si la edad calculada es menor a este valor y no se aplica
la edad promedio de la cartera, se ajusta a este valor. Valor por defecto = 0.</p>
              </div>
            </td>
            <td>
                  <code>0</code>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>aplica_edad_prom_cartera</code>
            </td>
            <td>
                  <code>int</code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Indica si se utiliza la edad promedio de la cartera para reemplazar las edades
perdidas o fuera de rango en lugar de los valores por defecto (edad_perdidos,
edad_inf, edad_tope). Valor por defecto = 0 (no se aplica).</p>
              </div>
            </td>
            <td>
                  <code>0</code>
            </td>
          </tr>
      </tbody>
    </table>


    <p><span class="doc-section-title">Returns:</span></p>
    <table>
      <thead>
        <tr>
          <th>Type</th>
          <th>Description</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
                  <code><span title="numpy._typing._array_like.NDArray">NDArray</span>[<span title="numpy.int_">int_</span>]</code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Arreglo unidimensional con la edad final calculada para cada registro.</p>
              </div>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                  <code>(<span title="typing.Any">Any</span>, optional)</code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Si <code>reporta_issues</code> es 1, además de la edad se retorna un arreglo (np.array) que
marca con 1 los registros problemáticos y con 0 los registros correctos.</p>
              </div>
            </td>
          </tr>
      </tbody>
    </table>

            <details class="quote">
              <summary>Source code in <code>S2_Funciones.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">511</span>
<span class="normal">512</span>
<span class="normal">513</span>
<span class="normal">514</span>
<span class="normal">515</span>
<span class="normal">516</span>
<span class="normal">517</span>
<span class="normal">518</span>
<span class="normal">519</span>
<span class="normal">520</span>
<span class="normal">521</span>
<span class="normal">522</span>
<span class="normal">523</span>
<span class="normal">524</span>
<span class="normal">525</span>
<span class="normal">526</span>
<span class="normal">527</span>
<span class="normal">528</span>
<span class="normal">529</span>
<span class="normal">530</span>
<span class="normal">531</span>
<span class="normal">532</span>
<span class="normal">533</span>
<span class="normal">534</span>
<span class="normal">535</span>
<span class="normal">536</span>
<span class="normal">537</span>
<span class="normal">538</span>
<span class="normal">539</span>
<span class="normal">540</span>
<span class="normal">541</span>
<span class="normal">542</span>
<span class="normal">543</span>
<span class="normal">544</span>
<span class="normal">545</span>
<span class="normal">546</span>
<span class="normal">547</span>
<span class="normal">548</span>
<span class="normal">549</span>
<span class="normal">550</span>
<span class="normal">551</span>
<span class="normal">552</span>
<span class="normal">553</span>
<span class="normal">554</span>
<span class="normal">555</span>
<span class="normal">556</span>
<span class="normal">557</span>
<span class="normal">558</span>
<span class="normal">559</span>
<span class="normal">560</span>
<span class="normal">561</span>
<span class="normal">562</span>
<span class="normal">563</span>
<span class="normal">564</span>
<span class="normal">565</span>
<span class="normal">566</span>
<span class="normal">567</span>
<span class="normal">568</span>
<span class="normal">569</span>
<span class="normal">570</span>
<span class="normal">571</span>
<span class="normal">572</span>
<span class="normal">573</span>
<span class="normal">574</span>
<span class="normal">575</span>
<span class="normal">576</span>
<span class="normal">577</span>
<span class="normal">578</span>
<span class="normal">579</span>
<span class="normal">580</span>
<span class="normal">581</span>
<span class="normal">582</span>
<span class="normal">583</span>
<span class="normal">584</span>
<span class="normal">585</span>
<span class="normal">586</span>
<span class="normal">587</span>
<span class="normal">588</span>
<span class="normal">589</span>
<span class="normal">590</span>
<span class="normal">591</span>
<span class="normal">592</span>
<span class="normal">593</span>
<span class="normal">594</span>
<span class="normal">595</span>
<span class="normal">596</span>
<span class="normal">597</span>
<span class="normal">598</span>
<span class="normal">599</span>
<span class="normal">600</span>
<span class="normal">601</span>
<span class="normal">602</span>
<span class="normal">603</span>
<span class="normal">604</span>
<span class="normal">605</span>
<span class="normal">606</span>
<span class="normal">607</span>
<span class="normal">608</span>
<span class="normal">609</span>
<span class="normal">610</span>
<span class="normal">611</span>
<span class="normal">612</span>
<span class="normal">613</span>
<span class="normal">614</span>
<span class="normal">615</span>
<span class="normal">616</span>
<span class="normal">617</span>
<span class="normal">618</span>
<span class="normal">619</span>
<span class="normal">620</span>
<span class="normal">621</span>
<span class="normal">622</span>
<span class="normal">623</span>
<span class="normal">624</span>
<span class="normal">625</span>
<span class="normal">626</span>
<span class="normal">627</span>
<span class="normal">628</span>
<span class="normal">629</span>
<span class="normal">630</span>
<span class="normal">631</span>
<span class="normal">632</span>
<span class="normal">633</span>
<span class="normal">634</span>
<span class="normal">635</span>
<span class="normal">636</span>
<span class="normal">637</span>
<span class="normal">638</span>
<span class="normal">639</span>
<span class="normal">640</span>
<span class="normal">641</span>
<span class="normal">642</span>
<span class="normal">643</span>
<span class="normal">644</span>
<span class="normal">645</span>
<span class="normal">646</span>
<span class="normal">647</span>
<span class="normal">648</span>
<span class="normal">649</span>
<span class="normal">650</span>
<span class="normal">651</span>
<span class="normal">652</span>
<span class="normal">653</span>
<span class="normal">654</span>
<span class="normal">655</span>
<span class="normal">656</span>
<span class="normal">657</span>
<span class="normal">658</span>
<span class="normal">659</span>
<span class="normal">660</span>
<span class="normal">661</span>
<span class="normal">662</span>
<span class="normal">663</span>
<span class="normal">664</span>
<span class="normal">665</span>
<span class="normal">666</span>
<span class="normal">667</span>
<span class="normal">668</span>
<span class="normal">669</span>
<span class="normal">670</span>
<span class="normal">671</span>
<span class="normal">672</span>
<span class="normal">673</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span> <span class="nf">calcula_edad</span><span class="p">(</span><span class="n">rut_series</span><span class="p">:</span> <span class="n">pd</span><span class="o">.</span><span class="n">Series</span><span class="p">,</span><span class="n">fec_nac_series</span><span class="p">:</span> <span class="n">pd</span><span class="o">.</span><span class="n">Series</span><span class="p">,</span><span class="n">fec_corte_series</span><span class="p">:</span> <span class="n">Any</span><span class="p">,</span><span class="n">edad_perdidos</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span><span class="n">edad_tope</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span><span class="n">archivo_reporte</span><span class="p">:</span> <span class="n">TextIO</span><span class="p">,</span> <span class="n">reporta_issues</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span> <span class="n">edad_inf</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span> <span class="n">aplica_edad_prom_cartera</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">0</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">tuple</span><span class="p">[</span><span class="n">NDArray</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">int_</span><span class="p">],</span> <span class="n">Any</span><span class="p">]:</span> <span class="c1"># type: ignore</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Calcula la edad de cada registro en una serie, basado en la fecha de nacimiento (fec_nac_series)</span>
<span class="sd">    y la fecha de corte (fec_corte_series). Además, aplica reglas de corrección en casos de datos</span>
<span class="sd">    perdidos o inválidos, y puede reportar información adicional sobre los registros problemáticos.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    rut_series : pd.Series</span>
<span class="sd">        Serie que contiene los RUT (identificador único) de cada registro.</span>
<span class="sd">    fec_nac_series : pd.Series</span>
<span class="sd">        Serie que contiene las fechas de nacimiento de cada registro.</span>
<span class="sd">    fec_corte_series : Any</span>
<span class="sd">        Fecha de corte o serie de fechas de corte para el cálculo de la edad.</span>
<span class="sd">        Puede ser un objeto datetime o un pd.Series de fechas.</span>
<span class="sd">    edad_perdidos : int</span>
<span class="sd">        Edad que se asigna a los registros con fecha de nacimiento nula o mala cuando</span>
<span class="sd">        NO se aplica la edad promedio de la cartera.</span>
<span class="sd">    edad_tope : int</span>
<span class="sd">        Edad máxima permitida. Si la edad calculada supera este valor y no se aplica</span>
<span class="sd">        la edad promedio de la cartera, se recorta a este tope.</span>
<span class="sd">    archivo_reporte : TextIO</span>
<span class="sd">        Objeto de archivo para escribir los reportes de problemas detectados.</span>
<span class="sd">    reporta_issues : int, optional</span>
<span class="sd">        Indica si se debe retornar también el arreglo con los registros que presentan</span>
<span class="sd">        problemas. Valor por defecto = 0 (no se reportan).</span>
<span class="sd">    edad_inf : int, optional</span>
<span class="sd">        Edad mínima permitida. Si la edad calculada es menor a este valor y no se aplica</span>
<span class="sd">        la edad promedio de la cartera, se ajusta a este valor. Valor por defecto = 0.</span>
<span class="sd">    aplica_edad_prom_cartera : int, optional</span>
<span class="sd">        Indica si se utiliza la edad promedio de la cartera para reemplazar las edades</span>
<span class="sd">        perdidas o fuera de rango en lugar de los valores por defecto (edad_perdidos,</span>
<span class="sd">        edad_inf, edad_tope). Valor por defecto = 0 (no se aplica).</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    NDArray[np.int_]</span>
<span class="sd">        Arreglo unidimensional con la edad final calculada para cada registro.</span>
<span class="sd">    Any, optional</span>
<span class="sd">        Si `reporta_issues` es 1, además de la edad se retorna un arreglo (np.array) que</span>
<span class="sd">        marca con 1 los registros problemáticos y con 0 los registros correctos.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="c1"># Se crea un DataFrame base con el RUT y la fecha de nacimiento (posiblemente repetidos).</span>
    <span class="n">df_ruts</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">({</span><span class="s1">&#39;RUT&#39;</span><span class="p">:</span> <span class="n">rut_series</span><span class="p">,</span> <span class="s1">&#39;FEC_NAC&#39;</span><span class="p">:</span> <span class="n">fec_nac_series</span><span class="p">})</span>

    <span class="c1"># Se crea otro DataFrame para obtener la fecha de nacimiento mínima por RUT (manejo de duplicados).</span>
    <span class="n">df_fechas_nac</span> <span class="o">=</span> <span class="p">(</span>
        <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">({</span><span class="s1">&#39;RUT&#39;</span><span class="p">:</span> <span class="n">rut_series</span><span class="p">,</span> <span class="s1">&#39;FEC_NAC&#39;</span><span class="p">:</span> <span class="n">fec_nac_series</span><span class="p">})</span>
        <span class="o">.</span><span class="n">groupby</span><span class="p">([</span><span class="s1">&#39;RUT&#39;</span><span class="p">])</span>
        <span class="o">.</span><span class="n">min</span><span class="p">()</span>
        <span class="o">.</span><span class="n">reset_index</span><span class="p">()</span>
    <span class="p">)</span>

    <span class="c1"># Se hace un merge para que cada RUT tenga su fecha de nacimiento mínima.</span>
    <span class="n">df_ruts_final</span> <span class="o">=</span> <span class="n">df_ruts</span><span class="o">.</span><span class="n">merge</span><span class="p">(</span><span class="n">df_fechas_nac</span><span class="p">,</span> <span class="n">how</span><span class="o">=</span><span class="s1">&#39;left&#39;</span><span class="p">,</span> <span class="n">on</span><span class="o">=</span><span class="s1">&#39;RUT&#39;</span><span class="p">)</span>

    <span class="c1"># Se actualiza la serie de fechas de nacimiento con el valor mínimo encontrado.</span>
    <span class="n">fec_nac_series</span> <span class="o">=</span> <span class="n">df_ruts_final</span><span class="p">[</span><span class="s1">&#39;FEC_NAC_y&#39;</span><span class="p">]</span>

    <span class="c1"># Se identifican fechas nulas o iguales a 1900-01-01 como &quot;malas&quot;.</span>
    <span class="n">edad_malas</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span>
        <span class="p">(</span><span class="n">fec_nac_series</span><span class="o">.</span><span class="n">isnull</span><span class="p">())</span> <span class="o">|</span> <span class="p">(</span><span class="n">fec_nac_series</span> <span class="o">==</span> <span class="n">datetime</span><span class="o">.</span><span class="n">datetime</span><span class="p">(</span><span class="mi">1900</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">)),</span><span class="mi">1</span><span class="p">,</span><span class="mi">0</span><span class="p">)</span>

    <span class="c1"># Se obtienen año y combinación de mes/día a partir de la fecha de nacimiento.</span>
    <span class="n">serie_year</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DatetimeIndex</span><span class="p">(</span><span class="n">fec_nac_series</span><span class="p">)</span><span class="o">.</span><span class="n">year</span>  <span class="c1"># type: ignore</span>
    <span class="n">serie_monthday</span> <span class="o">=</span> <span class="p">(</span>
        <span class="n">pd</span><span class="o">.</span><span class="n">DatetimeIndex</span><span class="p">(</span><span class="n">fec_nac_series</span><span class="p">)</span><span class="o">.</span><span class="n">month</span> <span class="o">*</span> <span class="mi">100</span> <span class="c1"># type: ignore</span>
        <span class="o">+</span> <span class="n">pd</span><span class="o">.</span><span class="n">DatetimeIndex</span><span class="p">(</span><span class="n">fec_nac_series</span><span class="p">)</span><span class="o">.</span><span class="n">day</span> <span class="c1"># type: ignore</span>
    <span class="p">)</span>  <span class="c1"># type: ignore</span>

    <span class="c1"># Dependiendo del tipo de fec_corte_series (puede ser serie o fecha puntual),</span>
    <span class="c1"># se calculan el año y la combinación de mes/día.</span>
    <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">fec_corte_series</span><span class="p">,</span> <span class="n">pd</span><span class="o">.</span><span class="n">core</span><span class="o">.</span><span class="n">series</span><span class="o">.</span><span class="n">Series</span><span class="p">):</span>  <span class="c1"># type: ignore</span>
        <span class="n">fec_corte_year</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DatetimeIndex</span><span class="p">(</span><span class="n">fec_corte_series</span><span class="p">)</span><span class="o">.</span><span class="n">year</span>
        <span class="n">fec_corte_monthday</span> <span class="o">=</span> <span class="p">(</span>
            <span class="n">pd</span><span class="o">.</span><span class="n">DatetimeIndex</span><span class="p">(</span><span class="n">fec_corte_series</span><span class="p">)</span><span class="o">.</span><span class="n">month</span> <span class="o">*</span> <span class="mi">100</span>
            <span class="o">+</span> <span class="n">pd</span><span class="o">.</span><span class="n">DatetimeIndex</span><span class="p">(</span><span class="n">fec_corte_series</span><span class="p">)</span><span class="o">.</span><span class="n">day</span>
        <span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">fec_corte_year</span> <span class="o">=</span> <span class="n">fec_corte_series</span><span class="o">.</span><span class="n">year</span>
        <span class="n">fec_corte_monthday</span> <span class="o">=</span> <span class="n">fec_corte_series</span><span class="o">.</span><span class="n">month</span> <span class="o">*</span> <span class="mi">100</span> <span class="o">+</span> <span class="n">fec_corte_series</span><span class="o">.</span><span class="n">day</span>

    <span class="c1"># Se calcula la edad promedio en la cartera, ignorando las fechas malas</span>
    <span class="c1"># (usando np.nan en lugar de esos valores).</span>
    <span class="n">edad_promedio_cartera</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">nanmean</span><span class="p">(</span>
        <span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span>
            <span class="n">edad_malas</span> <span class="o">==</span> <span class="mi">1</span><span class="p">,</span>
            <span class="n">np</span><span class="o">.</span><span class="n">nan</span><span class="p">,</span>
            <span class="n">fec_corte_year</span>
            <span class="o">-</span> <span class="n">serie_year</span>
            <span class="o">+</span> <span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">serie_monthday</span> <span class="o">&lt;=</span> <span class="n">fec_corte_monthday</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">)</span>
        <span class="p">)</span>
    <span class="p">)</span>

    <span class="c1"># Si no se aplica la edad promedio de la cartera, se asigna edad_perdidos a fechas malas.</span>
    <span class="k">if</span> <span class="n">aplica_edad_prom_cartera</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
        <span class="n">edad_series</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span>
            <span class="n">edad_malas</span> <span class="o">==</span> <span class="mi">1</span><span class="p">,</span>
            <span class="n">edad_perdidos</span><span class="p">,</span>
            <span class="n">fec_corte_year</span>
            <span class="o">-</span> <span class="n">serie_year</span>
            <span class="o">+</span> <span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">serie_monthday</span> <span class="o">&lt;=</span> <span class="n">fec_corte_monthday</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">)</span>
        <span class="p">)</span>
    <span class="c1"># Si se aplica la edad promedio de la cartera, se reemplaza la edad de fechas malas por ese promedio.</span>
    <span class="k">elif</span> <span class="n">aplica_edad_prom_cartera</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
        <span class="n">edad_series</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span>
            <span class="n">edad_malas</span> <span class="o">==</span> <span class="mi">1</span><span class="p">,</span>
            <span class="n">edad_promedio_cartera</span><span class="p">,</span>
            <span class="n">fec_corte_year</span>
            <span class="o">-</span> <span class="n">serie_year</span>
            <span class="o">+</span> <span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">serie_monthday</span> <span class="o">&lt;=</span> <span class="n">fec_corte_monthday</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">)</span>
        <span class="p">)</span>

    <span class="c1"># Se marcan los registros que presentan algún problema:</span>
    <span class="c1">#    - Fecha mala</span>
    <span class="c1">#    - Edad mayor que el tope</span>
    <span class="c1">#    - Edad menor que el mínimo permitido</span>
    <span class="n">registros_issues</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span>
        <span class="p">(</span><span class="n">edad_malas</span> <span class="o">==</span> <span class="mi">1</span><span class="p">)</span>
        <span class="o">|</span> <span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">edad_series</span> <span class="o">&gt;</span> <span class="n">edad_tope</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span> <span class="o">==</span> <span class="mi">1</span><span class="p">)</span>
        <span class="o">|</span> <span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">edad_series</span> <span class="o">&lt;</span> <span class="n">edad_inf</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span> <span class="o">==</span> <span class="mi">1</span><span class="p">),</span>
        <span class="mi">1</span><span class="p">,</span>
        <span class="mi">0</span>
    <span class="p">)</span>

    <span class="c1"># Se cuentan la cantidad de fechas malas y de fechas que exceden el tope.</span>
    <span class="n">cont_fecnac_malas</span> <span class="o">=</span> <span class="nb">sum</span><span class="p">(</span><span class="n">edad_malas</span><span class="p">)</span>
    <span class="n">cont_fecnac_tope</span> <span class="o">=</span> <span class="nb">sum</span><span class="p">(</span><span class="n">edad_series</span> <span class="o">&gt;</span> <span class="n">edad_tope</span><span class="p">)</span> <span class="c1"># type: ignore</span>

    <span class="c1"># Ajuste final de edades según se aplique o no la edad promedio, y según los límites establecidos.</span>
    <span class="k">if</span> <span class="n">aplica_edad_prom_cartera</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
        <span class="n">edad_series_final</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span>
            <span class="n">edad_series</span> <span class="o">&gt;</span> <span class="n">edad_tope</span><span class="p">,</span>
            <span class="n">edad_tope</span><span class="p">,</span>
            <span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">edad_series</span> <span class="o">&lt;</span> <span class="n">edad_inf</span><span class="p">,</span> <span class="n">edad_inf</span><span class="p">,</span> <span class="n">edad_series</span><span class="p">)</span>
        <span class="p">)</span>
    <span class="k">elif</span> <span class="n">aplica_edad_prom_cartera</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
        <span class="n">edad_series_final</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span>
            <span class="n">edad_series</span> <span class="o">&gt;</span> <span class="n">edad_tope</span><span class="p">,</span>
            <span class="n">edad_promedio_cartera</span><span class="p">,</span>
            <span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">edad_series</span> <span class="o">&lt;</span> <span class="n">edad_inf</span><span class="p">,</span> <span class="n">edad_promedio_cartera</span><span class="p">,</span> <span class="n">edad_series</span><span class="p">)</span>
        <span class="p">)</span>

    <span class="c1"># Se escriben en el archivo de reporte los conteos de problemas detectados, si los hay.</span>
    <span class="k">if</span> <span class="n">cont_fecnac_malas</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
        <span class="n">escribe_reporta</span><span class="p">(</span>
            <span class="n">archivo_reporte</span><span class="p">,</span>
            <span class="s1">&#39;La cantidad de registros con la fecha nula o mala es de </span><span class="si">{}</span><span class="s1"> registros&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">cont_fecnac_malas</span><span class="p">)</span>
        <span class="p">)</span>

    <span class="k">if</span> <span class="n">cont_fecnac_tope</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
        <span class="n">escribe_reporta</span><span class="p">(</span>
            <span class="n">archivo_reporte</span><span class="p">,</span>
            <span class="s1">&#39;Un total de </span><span class="si">{}</span><span class="s1"> registros tienen edad mayor a 108 año. &#39;</span>
            <span class="s1">&#39;Fueron topados en 108 para poder encontrar valores en las tablas de incidencia&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">cont_fecnac_tope</span><span class="p">)</span>
        <span class="p">)</span>

    <span class="c1"># Retorna solamente la serie final con las edades o, si se especifica,</span>
    <span class="c1"># también retorna el array de issues.</span>
    <span class="k">if</span> <span class="n">reporta_issues</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">edad_series_final</span> <span class="c1"># type: ignore</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">edad_series_final</span><span class="p">,</span> <span class="n">registros_issues</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>

<div class="doc doc-object doc-function">


<h2 id="S2_Funciones.calcula_exposicion" class="doc doc-heading">
            <code class="highlight language-python"><span class="n">calcula_exposicion</span><span class="p">(</span><span class="n">df</span><span class="p">,</span> <span class="n">campo_inicio</span><span class="p">,</span> <span class="n">campo_fin</span><span class="p">,</span> <span class="n">exp_days</span><span class="p">,</span> <span class="n">fec_bop</span><span class="p">,</span> <span class="n">fec_eop</span><span class="p">)</span></code>

</h2>


    <div class="doc doc-contents ">

        <p>Calcula la exposición de cada registro en función de rangos de fechas de inicio y fin,
ajustada a un período definido por <code>fec_bop</code> y <code>fec_eop</code>. El resultado se expresa
como la proporción de días expuestos sobre <code>exp_days</code>.</p>


<p><span class="doc-section-title">Parameters:</span></p>
    <table>
      <thead>
        <tr>
          <th>Name</th>
          <th>Type</th>
          <th>Description</th>
          <th>Default</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
                <code>df</code>
            </td>
            <td>
                  <code><span title="pandas.DataFrame">DataFrame</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>DataFrame de entrada con la información de fechas (columnas de inicio y fin).</p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>campo_inicio</code>
            </td>
            <td>
                  <code>str</code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Nombre de la columna en <code>df</code> que representa la fecha de inicio de validez.</p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>campo_fin</code>
            </td>
            <td>
                  <code>str</code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Nombre de la columna en <code>df</code> que representa la fecha de fin de validez.</p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>exp_days</code>
            </td>
            <td>
                  <code>int</code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Número de días que representan un período estándar de exposición (por ejemplo, 365).</p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>fec_bop</code>
            </td>
            <td>
                  <code><span title="datetime.datetime">datetime</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Fecha de inicio (Beginning of Period) para el cálculo de la exposición.</p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>fec_eop</code>
            </td>
            <td>
                  <code><span title="datetime.datetime">datetime</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Fecha de fin (End of Period) para el cálculo de la exposición.</p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
      </tbody>
    </table>


    <p><span class="doc-section-title">Returns:</span></p>
    <table>
      <thead>
        <tr>
          <th>Type</th>
          <th>Description</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
                  <code><span title="numpy.typing.NDArray">NDArray</span>[<span title="numpy.int_">int_</span>]</code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Arreglo de NumPy con los valores de exposición. Cada posición indica la proporción
de exposición del registro correspondiente, calculada en relación a <code>exp_days</code>.</p>
              </div>
            </td>
          </tr>
      </tbody>
    </table>

            <details class="quote">
              <summary>Source code in <code>S2_Funciones.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">675</span>
<span class="normal">676</span>
<span class="normal">677</span>
<span class="normal">678</span>
<span class="normal">679</span>
<span class="normal">680</span>
<span class="normal">681</span>
<span class="normal">682</span>
<span class="normal">683</span>
<span class="normal">684</span>
<span class="normal">685</span>
<span class="normal">686</span>
<span class="normal">687</span>
<span class="normal">688</span>
<span class="normal">689</span>
<span class="normal">690</span>
<span class="normal">691</span>
<span class="normal">692</span>
<span class="normal">693</span>
<span class="normal">694</span>
<span class="normal">695</span>
<span class="normal">696</span>
<span class="normal">697</span>
<span class="normal">698</span>
<span class="normal">699</span>
<span class="normal">700</span>
<span class="normal">701</span>
<span class="normal">702</span>
<span class="normal">703</span>
<span class="normal">704</span>
<span class="normal">705</span>
<span class="normal">706</span>
<span class="normal">707</span>
<span class="normal">708</span>
<span class="normal">709</span>
<span class="normal">710</span>
<span class="normal">711</span>
<span class="normal">712</span>
<span class="normal">713</span>
<span class="normal">714</span>
<span class="normal">715</span>
<span class="normal">716</span>
<span class="normal">717</span>
<span class="normal">718</span>
<span class="normal">719</span>
<span class="normal">720</span>
<span class="normal">721</span>
<span class="normal">722</span>
<span class="normal">723</span>
<span class="normal">724</span>
<span class="normal">725</span>
<span class="normal">726</span>
<span class="normal">727</span>
<span class="normal">728</span>
<span class="normal">729</span>
<span class="normal">730</span>
<span class="normal">731</span>
<span class="normal">732</span>
<span class="normal">733</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span> <span class="nf">calcula_exposicion</span><span class="p">(</span><span class="n">df</span><span class="p">:</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">,</span> <span class="n">campo_inicio</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span><span class="n">campo_fin</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">exp_days</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span> <span class="n">fec_bop</span><span class="p">:</span> <span class="n">datetime</span><span class="o">.</span><span class="n">datetime</span><span class="p">,</span> <span class="n">fec_eop</span><span class="p">:</span> <span class="n">datetime</span><span class="o">.</span><span class="n">datetime</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">NDArray</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">int_</span><span class="p">]:</span> 
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Calcula la exposición de cada registro en función de rangos de fechas de inicio y fin,</span>
<span class="sd">    ajustada a un período definido por `fec_bop` y `fec_eop`. El resultado se expresa</span>
<span class="sd">    como la proporción de días expuestos sobre `exp_days`.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    df : pd.DataFrame</span>
<span class="sd">        DataFrame de entrada con la información de fechas (columnas de inicio y fin).</span>
<span class="sd">    campo_inicio : str</span>
<span class="sd">        Nombre de la columna en `df` que representa la fecha de inicio de validez.</span>
<span class="sd">    campo_fin : str</span>
<span class="sd">        Nombre de la columna en `df` que representa la fecha de fin de validez.</span>
<span class="sd">    exp_days : int</span>
<span class="sd">        Número de días que representan un período estándar de exposición (por ejemplo, 365).</span>
<span class="sd">    fec_bop : datetime.datetime</span>
<span class="sd">        Fecha de inicio (Beginning of Period) para el cálculo de la exposición.</span>
<span class="sd">    fec_eop : datetime.datetime</span>
<span class="sd">        Fecha de fin (End of Period) para el cálculo de la exposición.</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    np.typing.NDArray[np.int_]</span>
<span class="sd">        Arreglo de NumPy con los valores de exposición. Cada posición indica la proporción</span>
<span class="sd">        de exposición del registro correspondiente, calculada en relación a `exp_days`.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="c1"># Se realiza una copia del DataFrame original para no modificarlo directamente.</span>
    <span class="n">df_aux</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>

    <span class="c1"># Se crean dos columnas que definen el período de cálculo de la exposición:</span>
    <span class="c1"># &#39;INICIO MES&#39; (fec_bop) y &#39;FIN MES&#39; (fec_eop + 1 día).</span>
    <span class="n">df_aux</span><span class="p">[</span><span class="s1">&#39;INICIO MES&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">Timestamp</span><span class="p">(</span><span class="n">fec_bop</span><span class="o">.</span><span class="n">year</span><span class="p">,</span> <span class="n">fec_bop</span><span class="o">.</span><span class="n">month</span><span class="p">,</span> <span class="n">fec_bop</span><span class="o">.</span><span class="n">day</span><span class="p">)</span>
    <span class="n">df_aux</span><span class="p">[</span><span class="s1">&#39;FIN MES&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">Timestamp</span><span class="p">(</span><span class="n">fec_eop</span><span class="o">.</span><span class="n">year</span><span class="p">,</span> <span class="n">fec_eop</span><span class="o">.</span><span class="n">month</span><span class="p">,</span> <span class="n">fec_eop</span><span class="o">.</span><span class="n">day</span><span class="p">)</span> <span class="o">+</span> <span class="n">datetime</span><span class="o">.</span><span class="n">timedelta</span><span class="p">(</span><span class="n">days</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>

    <span class="c1"># Calcula la fecha de inicio real para cada registro como el máximo entre</span>
    <span class="c1"># la fecha de inicio del período y la fecha de inicio propia del registro.</span>
    <span class="n">serie_inicio</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">maximum</span><span class="p">(</span><span class="n">df_aux</span><span class="p">[</span><span class="s1">&#39;INICIO MES&#39;</span><span class="p">],</span> <span class="n">df_aux</span><span class="p">[</span><span class="n">campo_inicio</span><span class="p">])</span>

    <span class="c1"># Calcula la fecha de fin real para cada registro como el mínimo entre</span>
    <span class="c1"># la fecha de fin del período y la fecha de fin propia del registro.</span>
    <span class="n">serie_fin</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">minimum</span><span class="p">(</span><span class="n">df_aux</span><span class="p">[</span><span class="s1">&#39;FIN MES&#39;</span><span class="p">],</span> <span class="n">df_aux</span><span class="p">[</span><span class="n">campo_fin</span><span class="p">])</span>

    <span class="c1"># Calcula la exposición de cada registro:</span>
    <span class="c1"># - Si la fecha de inicio es posterior a &#39;fec_eop&#39;,</span>
    <span class="c1">#   o la fecha de fin es anterior a &#39;fec_bop&#39;,</span>
    <span class="c1">#   o la fecha de inicio supera a la fecha de fin del registro,</span>
    <span class="c1">#   entonces la exposición es 0.</span>
    <span class="c1"># - En caso contrario, se toma la diferencia de días entre serie_fin y serie_inicio,</span>
    <span class="c1">#   y se normaliza dividiendo por exp_days.</span>
    <span class="n">serie_exposicion</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span>
        <span class="p">(</span><span class="n">df_aux</span><span class="p">[</span><span class="n">campo_inicio</span><span class="p">]</span> <span class="o">&gt;</span> <span class="n">fec_eop</span><span class="p">)</span> <span class="o">|</span>
        <span class="p">(</span><span class="n">df_aux</span><span class="p">[</span><span class="n">campo_fin</span><span class="p">]</span> <span class="o">&lt;</span> <span class="n">fec_bop</span><span class="p">)</span> <span class="o">|</span>
        <span class="p">(</span><span class="n">df_aux</span><span class="p">[</span><span class="n">campo_inicio</span><span class="p">]</span> <span class="o">&gt;</span> <span class="n">df_aux</span><span class="p">[</span><span class="n">campo_fin</span><span class="p">]),</span>
        <span class="mi">0</span><span class="p">,</span>
        <span class="p">((</span><span class="n">serie_fin</span> <span class="o">-</span> <span class="n">serie_inicio</span><span class="p">)</span><span class="o">.</span><span class="n">dt</span><span class="o">.</span><span class="n">days</span><span class="p">)</span> <span class="o">/</span> <span class="n">exp_days</span>
    <span class="p">)</span>

    <span class="k">return</span> <span class="n">serie_exposicion</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>

<div class="doc doc-object doc-function">


<h2 id="S2_Funciones.calculo_fechas_renovacion" class="doc doc-heading">
            <code class="highlight language-python"><span class="n">calculo_fechas_renovacion</span><span class="p">(</span><span class="n">df</span><span class="p">,</span> <span class="n">campo_inicio</span><span class="p">,</span> <span class="n">campo_fin</span><span class="p">,</span> <span class="n">campo_anulacion</span><span class="p">,</span> <span class="n">campo_periodicidad</span><span class="p">,</span> <span class="n">periodo_cierre</span><span class="p">,</span> <span class="n">ajuste_pu</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span></code>

</h2>


    <div class="doc doc-contents ">

        <p>calcula fechas de renovacion para contratos de reaseguro de prima anual renovable</p>


<p><span class="doc-section-title">Parameters:</span></p>
    <table>
      <thead>
        <tr>
          <th>Name</th>
          <th>Type</th>
          <th>Description</th>
          <th>Default</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
                <code>df</code>
            </td>
            <td>
                  <code><span title="pandas.DataFrame">DataFrame</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>dataframe con la informacion de asegurados expuestos</p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>campo_inicio</code>
            </td>
            <td>
                  <code>str</code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>campo donde inician vigencia los registros</p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>campo_fin</code>
            </td>
            <td>
                  <code>str</code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>campo que indica donde los registros terminan vigencia</p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>campo_anulacion</code>
            </td>
            <td>
                  <code>str</code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>campos que indica la fecha de anulacion de los asegurados</p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>campo_periodicidad</code>
            </td>
            <td>
                  <code>str</code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>indica la periodicidad: Si es prima unica no se calcula nada</p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>periodo_cierre</code>
            </td>
            <td>
                  <code>int</code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>periodo de cierre</p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>ajuste_pu</code>
            </td>
            <td>
                  <code>int</code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>binario que indica si realizamos cambios o no a los asegurados de prima unica, by default 1</p>
              </div>
            </td>
            <td>
                  <code>1</code>
            </td>
          </tr>
      </tbody>
    </table>


    <p><span class="doc-section-title">Returns:</span></p>
    <table>
      <thead>
        <tr>
          <th>Type</th>
          <th>Description</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
                  <code>tuple[<span title="numpy._typing._array_like.NDArray">NDArray</span>[<span title="numpy.int_">int_</span>], <span title="numpy._typing._array_like.NDArray">NDArray</span>[<span title="numpy.datetime64">datetime64</span>]]</code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>entrega dos vectores, uno con la fecha de inicio de renovacion y otro con la fecha de fin de renovacion</p>
              </div>
            </td>
          </tr>
      </tbody>
    </table>

            <details class="quote">
              <summary>Source code in <code>S2_Funciones.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">1075</span>
<span class="normal">1076</span>
<span class="normal">1077</span>
<span class="normal">1078</span>
<span class="normal">1079</span>
<span class="normal">1080</span>
<span class="normal">1081</span>
<span class="normal">1082</span>
<span class="normal">1083</span>
<span class="normal">1084</span>
<span class="normal">1085</span>
<span class="normal">1086</span>
<span class="normal">1087</span>
<span class="normal">1088</span>
<span class="normal">1089</span>
<span class="normal">1090</span>
<span class="normal">1091</span>
<span class="normal">1092</span>
<span class="normal">1093</span>
<span class="normal">1094</span>
<span class="normal">1095</span>
<span class="normal">1096</span>
<span class="normal">1097</span>
<span class="normal">1098</span>
<span class="normal">1099</span>
<span class="normal">1100</span>
<span class="normal">1101</span>
<span class="normal">1102</span>
<span class="normal">1103</span>
<span class="normal">1104</span>
<span class="normal">1105</span>
<span class="normal">1106</span>
<span class="normal">1107</span>
<span class="normal">1108</span>
<span class="normal">1109</span>
<span class="normal">1110</span>
<span class="normal">1111</span>
<span class="normal">1112</span>
<span class="normal">1113</span>
<span class="normal">1114</span>
<span class="normal">1115</span>
<span class="normal">1116</span>
<span class="normal">1117</span>
<span class="normal">1118</span>
<span class="normal">1119</span>
<span class="normal">1120</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span> <span class="nf">calculo_fechas_renovacion</span><span class="p">(</span><span class="n">df</span><span class="p">:</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">,</span><span class="n">campo_inicio</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span><span class="n">campo_fin</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span><span class="n">campo_anulacion</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span><span class="n">campo_periodicidad</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span><span class="n">periodo_cierre</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span><span class="n">ajuste_pu</span><span class="p">:</span> <span class="nb">int</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">tuple</span><span class="p">[</span><span class="n">NDArray</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">int_</span><span class="p">],</span><span class="n">NDArray</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">datetime64</span><span class="p">]]:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;calcula fechas de renovacion para contratos de reaseguro de prima anual renovable</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    df : pd.DataFrame</span>
<span class="sd">        dataframe con la informacion de asegurados expuestos</span>
<span class="sd">    campo_inicio : str</span>
<span class="sd">        campo donde inician vigencia los registros</span>
<span class="sd">    campo_fin : str</span>
<span class="sd">        campo que indica donde los registros terminan vigencia</span>
<span class="sd">    campo_anulacion : str</span>
<span class="sd">        campos que indica la fecha de anulacion de los asegurados</span>
<span class="sd">    campo_periodicidad : str</span>
<span class="sd">        indica la periodicidad: Si es prima unica no se calcula nada</span>
<span class="sd">    periodo_cierre : int</span>
<span class="sd">        periodo de cierre</span>
<span class="sd">    ajuste_pu : int, optional</span>
<span class="sd">        binario que indica si realizamos cambios o no a los asegurados de prima unica, by default 1</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    tuple[NDArray[np.int_],NDArray[np.datetime64]]</span>
<span class="sd">        entrega dos vectores, uno con la fecha de inicio de renovacion y otro con la fecha de fin de renovacion</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">df_aux</span><span class="o">=</span><span class="n">df</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
    <span class="n">cierre_month</span><span class="o">=</span><span class="n">periodo_cierre</span><span class="o">%</span><span class="mi">100</span>
    <span class="n">cierre_year</span><span class="o">=</span><span class="nb">int</span><span class="p">(</span><span class="n">periodo_cierre</span><span class="o">/</span><span class="mi">100</span><span class="p">)</span>
    <span class="c1"># fecha_cierre=datetime.datetime(int(periodo_cierre/100),periodo_cierre%100,calendar.monthrange(int(periodo_cierre/100), periodo_cierre%100)[1])</span>
    <span class="c1"># Defino los campos de dia mes y año para la fecha de la ultima renovacion</span>
    <span class="n">df_aux</span><span class="p">[</span><span class="s1">&#39;year&#39;</span><span class="p">]</span><span class="o">=</span><span class="n">cierre_year</span><span class="o">-</span><span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">((</span><span class="n">df_aux</span><span class="p">[</span><span class="n">campo_inicio</span><span class="p">]</span><span class="o">.</span><span class="n">dt</span><span class="o">.</span><span class="n">month</span><span class="o">&gt;</span><span class="n">cierre_month</span><span class="p">)</span><span class="o">|</span><span class="p">((</span><span class="n">df_aux</span><span class="p">[</span><span class="n">campo_anulacion</span><span class="p">]</span><span class="o">.</span><span class="n">dt</span><span class="o">.</span><span class="n">month</span><span class="o">*</span><span class="mi">100</span><span class="o">+</span><span class="n">df_aux</span><span class="p">[</span><span class="n">campo_anulacion</span><span class="p">]</span><span class="o">.</span><span class="n">dt</span><span class="o">.</span><span class="n">day</span><span class="o">&lt;</span><span class="n">df_aux</span><span class="p">[</span><span class="n">campo_inicio</span><span class="p">]</span><span class="o">.</span><span class="n">dt</span><span class="o">.</span><span class="n">month</span><span class="o">*</span><span class="mi">100</span><span class="o">+</span><span class="n">df_aux</span><span class="p">[</span><span class="n">campo_inicio</span><span class="p">]</span><span class="o">.</span><span class="n">dt</span><span class="o">.</span><span class="n">day</span><span class="p">)</span><span class="o">&amp;</span><span class="p">(</span><span class="o">~</span><span class="n">df_aux</span><span class="p">[</span><span class="n">campo_anulacion</span><span class="p">]</span><span class="o">.</span><span class="n">isnull</span><span class="p">())),</span><span class="mi">1</span><span class="p">,</span><span class="mi">0</span><span class="p">)</span>
    <span class="n">df_aux</span><span class="p">[</span><span class="s1">&#39;month&#39;</span><span class="p">]</span><span class="o">=</span><span class="n">df_aux</span><span class="p">[</span><span class="n">campo_inicio</span><span class="p">]</span><span class="o">.</span><span class="n">dt</span><span class="o">.</span><span class="n">month</span>
    <span class="n">df_aux</span><span class="p">[</span><span class="s1">&#39;day&#39;</span><span class="p">]</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">((</span><span class="n">df_aux</span><span class="p">[</span><span class="n">campo_inicio</span><span class="p">]</span><span class="o">.</span><span class="n">dt</span><span class="o">.</span><span class="n">day</span><span class="o">==</span><span class="mi">29</span><span class="p">)</span><span class="o">&amp;</span><span class="p">(</span><span class="n">df_aux</span><span class="p">[</span><span class="s1">&#39;month&#39;</span><span class="p">]</span><span class="o">==</span><span class="mi">2</span><span class="p">)</span><span class="o">&amp;</span><span class="p">(</span><span class="n">df_aux</span><span class="p">[</span><span class="s1">&#39;year&#39;</span><span class="p">]</span><span class="o">%</span><span class="mi">4</span><span class="o">&gt;</span><span class="mi">0</span><span class="p">),</span><span class="mi">28</span><span class="p">,</span><span class="n">df_aux</span><span class="p">[</span><span class="n">campo_inicio</span><span class="p">]</span><span class="o">.</span><span class="n">dt</span><span class="o">.</span><span class="n">day</span><span class="p">)</span>
    <span class="n">df_aux</span><span class="p">[</span><span class="s1">&#39;INICIO RENOVACION&#39;</span><span class="p">]</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">maximum</span><span class="p">(</span><span class="n">pd</span><span class="o">.</span><span class="n">to_datetime</span><span class="p">(</span><span class="n">df_aux</span><span class="p">[[</span><span class="s1">&#39;year&#39;</span><span class="p">,</span><span class="s1">&#39;month&#39;</span><span class="p">,</span><span class="s1">&#39;day&#39;</span><span class="p">]]),</span><span class="n">df_aux</span><span class="p">[</span><span class="n">campo_inicio</span><span class="p">])</span>
    <span class="c1"># Defino los campos de dia mes y año para la fecha de la proxima renovacion</span>
    <span class="n">df_aux</span><span class="p">[</span><span class="s1">&#39;year&#39;</span><span class="p">]</span><span class="o">=</span><span class="n">df_aux</span><span class="p">[</span><span class="s1">&#39;INICIO RENOVACION&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">dt</span><span class="o">.</span><span class="n">year</span><span class="o">+</span><span class="mi">1</span>
    <span class="n">df_aux</span><span class="p">[</span><span class="s1">&#39;day&#39;</span><span class="p">]</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">((</span><span class="n">df_aux</span><span class="p">[</span><span class="n">campo_inicio</span><span class="p">]</span><span class="o">.</span><span class="n">dt</span><span class="o">.</span><span class="n">day</span><span class="o">==</span><span class="mi">29</span><span class="p">)</span><span class="o">&amp;</span><span class="p">(</span><span class="n">df_aux</span><span class="p">[</span><span class="s1">&#39;month&#39;</span><span class="p">]</span><span class="o">==</span><span class="mi">2</span><span class="p">)</span><span class="o">&amp;</span><span class="p">(</span><span class="n">df_aux</span><span class="p">[</span><span class="s1">&#39;year&#39;</span><span class="p">]</span><span class="o">%</span><span class="mi">4</span><span class="o">&gt;</span><span class="mi">0</span><span class="p">),</span><span class="mi">28</span><span class="p">,</span><span class="n">df_aux</span><span class="p">[</span><span class="n">campo_inicio</span><span class="p">]</span><span class="o">.</span><span class="n">dt</span><span class="o">.</span><span class="n">day</span><span class="p">)</span>
    <span class="n">df_aux</span><span class="p">[</span><span class="s1">&#39;FIN RENOVACION&#39;</span><span class="p">]</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">df_aux</span><span class="p">[</span><span class="n">campo_fin</span><span class="p">]</span><span class="o">.</span><span class="n">isnull</span><span class="p">(),</span><span class="n">pd</span><span class="o">.</span><span class="n">to_datetime</span><span class="p">(</span><span class="n">df_aux</span><span class="p">[[</span><span class="s1">&#39;year&#39;</span><span class="p">,</span><span class="s1">&#39;month&#39;</span><span class="p">,</span><span class="s1">&#39;day&#39;</span><span class="p">]]),</span><span class="n">np</span><span class="o">.</span><span class="n">minimum</span><span class="p">(</span><span class="n">pd</span><span class="o">.</span><span class="n">to_datetime</span><span class="p">(</span><span class="n">df_aux</span><span class="p">[[</span><span class="s1">&#39;year&#39;</span><span class="p">,</span><span class="s1">&#39;month&#39;</span><span class="p">,</span><span class="s1">&#39;day&#39;</span><span class="p">]]),</span><span class="n">df_aux</span><span class="p">[</span><span class="n">campo_fin</span><span class="p">]))</span>
    <span class="c1"># Ajusto en caso de primas unicas</span>
    <span class="k">if</span> <span class="n">ajuste_pu</span><span class="o">==</span><span class="mi">1</span><span class="p">:</span> 
        <span class="n">series_inicio</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">df_aux</span><span class="p">[</span><span class="n">campo_periodicidad</span><span class="p">]</span><span class="o">==</span><span class="mi">0</span><span class="p">,</span><span class="n">df_aux</span><span class="p">[</span><span class="n">campo_inicio</span><span class="p">],</span><span class="n">df_aux</span><span class="p">[</span><span class="s1">&#39;INICIO RENOVACION&#39;</span><span class="p">])</span>
        <span class="n">series_fin</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">df_aux</span><span class="p">[</span><span class="n">campo_periodicidad</span><span class="p">]</span><span class="o">==</span><span class="mi">0</span><span class="p">,</span><span class="n">df_aux</span><span class="p">[</span><span class="n">campo_fin</span><span class="p">],</span><span class="n">df_aux</span><span class="p">[</span><span class="s1">&#39;FIN RENOVACION&#39;</span><span class="p">])</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">series_inicio</span><span class="o">=</span><span class="n">df_aux</span><span class="p">[</span><span class="s1">&#39;INICIO RENOVACION&#39;</span><span class="p">]</span>
        <span class="n">series_fin</span><span class="o">=</span><span class="n">df_aux</span><span class="p">[</span><span class="s1">&#39;FIN RENOVACION&#39;</span><span class="p">]</span>
    <span class="k">return</span> <span class="n">series_inicio</span><span class="p">,</span><span class="n">series_fin</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>

<div class="doc doc-object doc-function">


<h2 id="S2_Funciones.completa_campo" class="doc doc-heading">
            <code class="highlight language-python"><span class="n">completa_campo</span><span class="p">(</span><span class="n">df</span><span class="p">,</span> <span class="n">campo_rellenar</span><span class="p">,</span> <span class="n">campos_agrupar</span><span class="p">,</span> <span class="n">parameters</span><span class="p">,</span> <span class="n">campo_cero</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span></code>

</h2>


    <div class="doc doc-contents ">

        <p>Completa valores faltantes en la columna especificada (campo_rellenar) de un DataFrame
utilizando el promedio de esa columna agrupado por los campos proporcionados. Además,
exporta la tabla de agregación a un archivo CSV.</p>


<p><span class="doc-section-title">Parameters:</span></p>
    <table>
      <thead>
        <tr>
          <th>Name</th>
          <th>Type</th>
          <th>Description</th>
          <th>Default</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
                <code>df</code>
            </td>
            <td>
                  <code><span title="pandas.DataFrame">DataFrame</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>DataFrame de entrada que contiene la columna a rellenar y las columnas para agrupar.</p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>campo_rellenar</code>
            </td>
            <td>
                  <code>str</code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Nombre de la columna en el DataFrame <code>df</code> cuyos valores faltantes se desean completar.</p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>campos_agrupar</code>
            </td>
            <td>
                  <code>list of str</code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Lista de columnas utilizadas para agrupar y calcular el promedio de <code>campo_rellenar</code>.</p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>parameters</code>
            </td>
            <td>
                  <code><a class="autorefs autorefs-internal" title="S0_Loaders.Parameter_Loader" href="#S0_Loaders.Parameter_Loader">Parameter_Loader</a></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Objeto que proporciona, entre otros, la ruta de salida (<code>ruta_output</code>),
separador (<code>separador_output</code>) y formato decimal (<code>decimal_output</code>)
para la exportación del archivo CSV.</p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>campo_cero</code>
            </td>
            <td>
                  <code>bool</code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Parámetro no implementado en la lógica actual de la función. Su valor no
altera la forma en que se completan los datos. Por defecto es False.</p>
              </div>
            </td>
            <td>
                  <code>False</code>
            </td>
          </tr>
      </tbody>
    </table>


    <p><span class="doc-section-title">Returns:</span></p>
    <table>
      <thead>
        <tr>
          <th>Type</th>
          <th>Description</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
                  <code><span title="pandas.DataFrame">DataFrame</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>DataFrame con los valores faltantes de <code>campo_rellenar</code> completados a partir
del promedio calculado sobre los grupos definidos por <code>campos_agrupar</code>. 
La columna resultante conserva el nombre original (<code>campo_rellenar</code>).</p>
              </div>
            </td>
          </tr>
      </tbody>
    </table>


<details class="note" open>
  <summary>Notes</summary>
  <ol>
<li>Para los registros con valor nulo en <code>campo_rellenar</code>, la función elimina temporalmente
   dicha columna, realiza el cruce con los promedios agrupados y luego rellena
   los valores nulos.</li>
<li>El DataFrame agrupado (<code>df_agrupado</code>) se exporta a un archivo CSV nombrado con
   el prefijo <code>"0. Tabla Agrup"</code>, seguido del nombre de la columna y los campos
   que intervienen en el agrupamiento.</li>
<li>La ruta y los parámetros de exportación se toman de <code>parameters.parameters</code>.</li>
<li>Si no hay filas con valores no nulos en <code>campo_rellenar</code>, los valores faltantes
   no podrán ser rellenados con un promedio y permanecerán como nulos.</li>
</ol>
</details>
            <details class="quote">
              <summary>Source code in <code>S2_Funciones.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">738</span>
<span class="normal">739</span>
<span class="normal">740</span>
<span class="normal">741</span>
<span class="normal">742</span>
<span class="normal">743</span>
<span class="normal">744</span>
<span class="normal">745</span>
<span class="normal">746</span>
<span class="normal">747</span>
<span class="normal">748</span>
<span class="normal">749</span>
<span class="normal">750</span>
<span class="normal">751</span>
<span class="normal">752</span>
<span class="normal">753</span>
<span class="normal">754</span>
<span class="normal">755</span>
<span class="normal">756</span>
<span class="normal">757</span>
<span class="normal">758</span>
<span class="normal">759</span>
<span class="normal">760</span>
<span class="normal">761</span>
<span class="normal">762</span>
<span class="normal">763</span>
<span class="normal">764</span>
<span class="normal">765</span>
<span class="normal">766</span>
<span class="normal">767</span>
<span class="normal">768</span>
<span class="normal">769</span>
<span class="normal">770</span>
<span class="normal">771</span>
<span class="normal">772</span>
<span class="normal">773</span>
<span class="normal">774</span>
<span class="normal">775</span>
<span class="normal">776</span>
<span class="normal">777</span>
<span class="normal">778</span>
<span class="normal">779</span>
<span class="normal">780</span>
<span class="normal">781</span>
<span class="normal">782</span>
<span class="normal">783</span>
<span class="normal">784</span>
<span class="normal">785</span>
<span class="normal">786</span>
<span class="normal">787</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span> <span class="nf">completa_campo</span><span class="p">(</span><span class="n">df</span><span class="p">:</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">,</span><span class="n">campo_rellenar</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span><span class="n">campos_agrupar</span><span class="p">:</span> <span class="nb">list</span><span class="p">[</span><span class="nb">str</span><span class="p">],</span><span class="n">parameters</span><span class="p">:</span> <span class="n">Parameter_Loader</span><span class="p">,</span><span class="n">campo_cero</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Completa valores faltantes en la columna especificada (campo_rellenar) de un DataFrame</span>
<span class="sd">    utilizando el promedio de esa columna agrupado por los campos proporcionados. Además,</span>
<span class="sd">    exporta la tabla de agregación a un archivo CSV.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    df : pd.DataFrame</span>
<span class="sd">        DataFrame de entrada que contiene la columna a rellenar y las columnas para agrupar.</span>
<span class="sd">    campo_rellenar : str</span>
<span class="sd">        Nombre de la columna en el DataFrame `df` cuyos valores faltantes se desean completar.</span>
<span class="sd">    campos_agrupar : list of str</span>
<span class="sd">        Lista de columnas utilizadas para agrupar y calcular el promedio de `campo_rellenar`.</span>
<span class="sd">    parameters : Parameter_Loader</span>
<span class="sd">        Objeto que proporciona, entre otros, la ruta de salida (`ruta_output`),</span>
<span class="sd">        separador (`separador_output`) y formato decimal (`decimal_output`)</span>
<span class="sd">        para la exportación del archivo CSV.</span>
<span class="sd">    campo_cero : bool, optional</span>
<span class="sd">        Parámetro no implementado en la lógica actual de la función. Su valor no</span>
<span class="sd">        altera la forma en que se completan los datos. Por defecto es False.</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    pd.DataFrame</span>
<span class="sd">        DataFrame con los valores faltantes de `campo_rellenar` completados a partir</span>
<span class="sd">        del promedio calculado sobre los grupos definidos por `campos_agrupar`. </span>
<span class="sd">        La columna resultante conserva el nombre original (`campo_rellenar`).</span>

<span class="sd">    Notes</span>
<span class="sd">    -----</span>
<span class="sd">    1. Para los registros con valor nulo en `campo_rellenar`, la función elimina temporalmente</span>
<span class="sd">       dicha columna, realiza el cruce con los promedios agrupados y luego rellena</span>
<span class="sd">       los valores nulos.</span>
<span class="sd">    2. El DataFrame agrupado (`df_agrupado`) se exporta a un archivo CSV nombrado con</span>
<span class="sd">       el prefijo `&quot;0. Tabla Agrup&quot;`, seguido del nombre de la columna y los campos</span>
<span class="sd">       que intervienen en el agrupamiento.</span>
<span class="sd">    3. La ruta y los parámetros de exportación se toman de `parameters.parameters`.</span>
<span class="sd">    4. Si no hay filas con valores no nulos en `campo_rellenar`, los valores faltantes</span>
<span class="sd">       no podrán ser rellenados con un promedio y permanecerán como nulos.</span>
<span class="sd">    &quot;&quot;&quot;</span>    
    <span class="c1"># if campo_cero==True: df_sin_valores,df_con_valores=df[df[campo_rellenar].isnull()].copy(),df[~df[campo_rellenar].isnull()].copy()</span>
    <span class="c1"># elif campo_cero==False: df_sin_valores,df_con_valores=df[(df[campo_rellenar].isnull())|(df[campo_rellenar]==0)].copy(),df[(~df[campo_rellenar].isnull())&amp;(df[campo_rellenar]&gt;0)].copy()</span>
    <span class="n">df_sin_valores</span><span class="p">,</span><span class="n">df_con_valores</span><span class="o">=</span><span class="n">df</span><span class="p">[</span><span class="n">df</span><span class="p">[</span><span class="n">campo_rellenar</span><span class="p">]</span><span class="o">.</span><span class="n">isnull</span><span class="p">()]</span><span class="o">.</span><span class="n">copy</span><span class="p">(),</span><span class="n">df</span><span class="p">[</span><span class="o">~</span><span class="n">df</span><span class="p">[</span><span class="n">campo_rellenar</span><span class="p">]</span><span class="o">.</span><span class="n">isnull</span><span class="p">()]</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
    <span class="n">df_sin_valores</span><span class="o">.</span><span class="n">drop</span><span class="p">(</span><span class="n">columns</span><span class="o">=</span><span class="p">[</span><span class="n">campo_rellenar</span><span class="p">],</span><span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span><span class="n">inplace</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
    <span class="n">df_agrupado</span><span class="o">=</span><span class="n">df_con_valores</span><span class="p">[[</span><span class="n">campo_rellenar</span><span class="p">]</span><span class="o">+</span><span class="n">campos_agrupar</span><span class="p">]</span><span class="o">.</span><span class="n">groupby</span><span class="p">(</span><span class="n">campos_agrupar</span><span class="p">,</span> <span class="n">dropna</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span><span class="o">.</span><span class="n">agg</span><span class="p">(</span><span class="s1">&#39;mean&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">reset_index</span><span class="p">()</span>
    <span class="n">df_sin_valores</span><span class="o">=</span><span class="n">df_sin_valores</span><span class="o">.</span><span class="n">merge</span><span class="p">(</span><span class="n">df_agrupado</span><span class="p">,</span><span class="n">how</span><span class="o">=</span><span class="s1">&#39;left&#39;</span><span class="p">,</span><span class="n">on</span><span class="o">=</span><span class="n">campos_agrupar</span><span class="p">)</span>
    <span class="n">df_final</span><span class="o">=</span><span class="n">pd</span><span class="o">.</span><span class="n">concat</span><span class="p">([</span><span class="n">df_con_valores</span><span class="p">,</span><span class="n">df_sin_valores</span><span class="p">],</span><span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
    <span class="n">df_agrupado</span><span class="o">.</span><span class="n">to_csv</span><span class="p">(</span><span class="n">parameters</span><span class="o">.</span><span class="n">parameters</span><span class="p">[</span><span class="s1">&#39;ruta_output&#39;</span><span class="p">]</span><span class="o">+</span><span class="s1">&#39;0. Tabla Agrup &#39;</span><span class="o">+</span><span class="n">campo_rellenar</span><span class="o">+</span><span class="s1">&#39; campos &#39;</span><span class="o">+</span><span class="s1">&#39;_&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">campos_agrupar</span><span class="p">)</span><span class="o">+</span><span class="s1">&#39;.csv&#39;</span><span class="p">,</span><span class="n">sep</span><span class="o">=</span><span class="n">parameters</span><span class="o">.</span><span class="n">parameters</span><span class="p">[</span><span class="s1">&#39;separador_output&#39;</span><span class="p">],</span><span class="n">decimal</span><span class="o">=</span><span class="n">parameters</span><span class="o">.</span><span class="n">parameters</span><span class="p">[</span><span class="s1">&#39;decimal_output&#39;</span><span class="p">],</span><span class="n">date_format</span><span class="o">=</span><span class="s1">&#39;</span><span class="si">%d</span><span class="s1">-%m-%Y&#39;</span><span class="p">,</span><span class="n">index</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">df_final</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>

<div class="doc doc-object doc-function">


<h2 id="S2_Funciones.completa_campo_total" class="doc doc-heading">
            <code class="highlight language-python"><span class="n">completa_campo_total</span><span class="p">(</span><span class="n">df</span><span class="p">,</span> <span class="n">campo_completar</span><span class="p">,</span> <span class="n">listas_campos_agrupar</span><span class="p">,</span> <span class="n">parameters</span><span class="p">,</span> <span class="n">campo_cero</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span></code>

</h2>


    <div class="doc doc-contents ">

        <p>Completa valores nulos o no válidos en un campo específico de un DataFrame mediante
agregaciones sucesivas. Finalmente, rellena los valores que siguen nulos con el
promedio global calculado.</p>


<p><span class="doc-section-title">Parameters:</span></p>
    <table>
      <thead>
        <tr>
          <th>Name</th>
          <th>Type</th>
          <th>Description</th>
          <th>Default</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
                <code>df</code>
            </td>
            <td>
                  <code><span title="pandas.DataFrame">DataFrame</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>DataFrame base que contiene la información donde se desea completar el campo.</p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>campo_completar</code>
            </td>
            <td>
                  <code>str</code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Nombre del campo a completar.</p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>listas_campos_agrupar</code>
            </td>
            <td>
                  <code>list of str</code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Lista de campos o combinaciones de campos que se utilizarán para agrupar
y completar el campo en cada paso.</p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>parameters</code>
            </td>
            <td>
                  <code><a class="autorefs autorefs-internal" title="S0_Loaders.Parameter_Loader" href="#S0_Loaders.Parameter_Loader">Parameter_Loader</a></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Objeto que contiene parámetros o configuraciones adicionales utilizadas
dentro de la función <code>completa_campo</code>.</p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>campo_cero</code>
            </td>
            <td>
                  <code>bool</code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Indica si el criterio de asignación de nulos incluye el valor cero.
- Si es True, se considera el 0 como un valor válido al calcular el promedio.
- Si es False, los ceros se tratarán como valores a reemplazar.
Por defecto es False.</p>
              </div>
            </td>
            <td>
                  <code>False</code>
            </td>
          </tr>
      </tbody>
    </table>


    <p><span class="doc-section-title">Returns:</span></p>
    <table>
      <thead>
        <tr>
          <th>Type</th>
          <th>Description</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
                  <code><span title="pandas.DataFrame">DataFrame</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>DataFrame con una nueva columna <code>&lt;campo_completar&gt;_FINAL</code> que contiene los
valores finales del campo completado.</p>
              </div>
            </td>
          </tr>
      </tbody>
    </table>


<details class="note" open>
  <summary>Notes</summary>
  <ol>
<li>La función crea internamente una copia del DataFrame original (<code>df_aux</code>) para
   no modificar los datos de entrada de manera directa.</li>
<li>Dependiendo del valor de <code>campo_cero</code>, el cálculo del promedio se realiza
   filtrando o no los valores ceros.</li>
<li>Después de cada agregación en <code>completa_campo</code>, los valores que continúan
   siendo nulos se completan con un promedio global calculado de manera inicial.</li>
<li>La función <code>completa_campo</code> debe estar disponible en el entorno o importada
   de manera adecuada para su uso en esta función.</li>
</ol>
</details>
            <details class="quote">
              <summary>Source code in <code>S2_Funciones.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">790</span>
<span class="normal">791</span>
<span class="normal">792</span>
<span class="normal">793</span>
<span class="normal">794</span>
<span class="normal">795</span>
<span class="normal">796</span>
<span class="normal">797</span>
<span class="normal">798</span>
<span class="normal">799</span>
<span class="normal">800</span>
<span class="normal">801</span>
<span class="normal">802</span>
<span class="normal">803</span>
<span class="normal">804</span>
<span class="normal">805</span>
<span class="normal">806</span>
<span class="normal">807</span>
<span class="normal">808</span>
<span class="normal">809</span>
<span class="normal">810</span>
<span class="normal">811</span>
<span class="normal">812</span>
<span class="normal">813</span>
<span class="normal">814</span>
<span class="normal">815</span>
<span class="normal">816</span>
<span class="normal">817</span>
<span class="normal">818</span>
<span class="normal">819</span>
<span class="normal">820</span>
<span class="normal">821</span>
<span class="normal">822</span>
<span class="normal">823</span>
<span class="normal">824</span>
<span class="normal">825</span>
<span class="normal">826</span>
<span class="normal">827</span>
<span class="normal">828</span>
<span class="normal">829</span>
<span class="normal">830</span>
<span class="normal">831</span>
<span class="normal">832</span>
<span class="normal">833</span>
<span class="normal">834</span>
<span class="normal">835</span>
<span class="normal">836</span>
<span class="normal">837</span>
<span class="normal">838</span>
<span class="normal">839</span>
<span class="normal">840</span>
<span class="normal">841</span>
<span class="normal">842</span>
<span class="normal">843</span>
<span class="normal">844</span>
<span class="normal">845</span>
<span class="normal">846</span>
<span class="normal">847</span>
<span class="normal">848</span>
<span class="normal">849</span>
<span class="normal">850</span>
<span class="normal">851</span>
<span class="normal">852</span>
<span class="normal">853</span>
<span class="normal">854</span>
<span class="normal">855</span>
<span class="normal">856</span>
<span class="normal">857</span>
<span class="normal">858</span>
<span class="normal">859</span>
<span class="normal">860</span>
<span class="normal">861</span>
<span class="normal">862</span>
<span class="normal">863</span>
<span class="normal">864</span>
<span class="normal">865</span>
<span class="normal">866</span>
<span class="normal">867</span>
<span class="normal">868</span>
<span class="normal">869</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span> <span class="nf">completa_campo_total</span><span class="p">(</span>
    <span class="n">df</span><span class="p">:</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">,</span>
    <span class="n">campo_completar</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
    <span class="n">listas_campos_agrupar</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="nb">str</span><span class="p">],</span>
    <span class="n">parameters</span><span class="p">:</span> <span class="n">Parameter_Loader</span><span class="p">,</span>
    <span class="n">campo_cero</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span>
<span class="p">)</span> <span class="o">-&gt;</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Completa valores nulos o no válidos en un campo específico de un DataFrame mediante</span>
<span class="sd">    agregaciones sucesivas. Finalmente, rellena los valores que siguen nulos con el</span>
<span class="sd">    promedio global calculado.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    df : pd.DataFrame</span>
<span class="sd">        DataFrame base que contiene la información donde se desea completar el campo.</span>
<span class="sd">    campo_completar : str</span>
<span class="sd">        Nombre del campo a completar.</span>
<span class="sd">    listas_campos_agrupar : list of str</span>
<span class="sd">        Lista de campos o combinaciones de campos que se utilizarán para agrupar</span>
<span class="sd">        y completar el campo en cada paso.</span>
<span class="sd">    parameters : Parameter_Loader</span>
<span class="sd">        Objeto que contiene parámetros o configuraciones adicionales utilizadas</span>
<span class="sd">        dentro de la función `completa_campo`.</span>
<span class="sd">    campo_cero : bool, optional</span>
<span class="sd">        Indica si el criterio de asignación de nulos incluye el valor cero.</span>
<span class="sd">        - Si es True, se considera el 0 como un valor válido al calcular el promedio.</span>
<span class="sd">        - Si es False, los ceros se tratarán como valores a reemplazar.</span>
<span class="sd">        Por defecto es False.</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    pd.DataFrame</span>
<span class="sd">        DataFrame con una nueva columna `&lt;campo_completar&gt;_FINAL` que contiene los</span>
<span class="sd">        valores finales del campo completado.</span>

<span class="sd">    Notes</span>
<span class="sd">    -----</span>
<span class="sd">    1. La función crea internamente una copia del DataFrame original (`df_aux`) para</span>
<span class="sd">       no modificar los datos de entrada de manera directa.</span>
<span class="sd">    2. Dependiendo del valor de `campo_cero`, el cálculo del promedio se realiza</span>
<span class="sd">       filtrando o no los valores ceros.</span>
<span class="sd">    3. Después de cada agregación en `completa_campo`, los valores que continúan</span>
<span class="sd">       siendo nulos se completan con un promedio global calculado de manera inicial.</span>
<span class="sd">    4. La función `completa_campo` debe estar disponible en el entorno o importada</span>
<span class="sd">       de manera adecuada para su uso en esta función.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="c1"># Se crea una copia del DataFrame original para no modificarlo directamente.</span>
    <span class="n">df_aux</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>

    <span class="c1"># Dependiendo del valor de &#39;campo_cero&#39;, se calcula el promedio general</span>
    <span class="c1"># y se definen los valores iniciales de la columna &#39;_FINAL&#39;.</span>
    <span class="k">if</span> <span class="n">campo_cero</span> <span class="ow">is</span> <span class="kc">True</span><span class="p">:</span>
        <span class="c1"># Cuando &#39;campo_cero&#39; es True, se consideran todos los valores distintos de nulo.</span>
        <span class="n">promedio_general</span> <span class="o">=</span> <span class="n">df_aux</span><span class="p">[</span><span class="o">~</span><span class="n">df_aux</span><span class="p">[</span><span class="n">campo_completar</span><span class="p">]</span><span class="o">.</span><span class="n">isnull</span><span class="p">()][</span><span class="n">campo_completar</span><span class="p">]</span><span class="o">.</span><span class="n">mean</span><span class="p">()</span>
        <span class="n">df_aux</span><span class="p">[</span><span class="n">campo_completar</span> <span class="o">+</span> <span class="s1">&#39;_FINAL&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">df_aux</span><span class="p">[</span><span class="n">campo_completar</span><span class="p">]</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="c1"># Cuando &#39;campo_cero&#39; es False, se excluyen los ceros y los nulos para el cálculo del promedio.</span>
        <span class="n">promedio_general</span> <span class="o">=</span> <span class="n">df_aux</span><span class="p">[</span>
            <span class="p">(</span><span class="o">~</span><span class="n">df_aux</span><span class="p">[</span><span class="n">campo_completar</span><span class="p">]</span><span class="o">.</span><span class="n">isnull</span><span class="p">())</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">df_aux</span><span class="p">[</span><span class="n">campo_completar</span><span class="p">]</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span>
        <span class="p">][</span><span class="n">campo_completar</span><span class="p">]</span><span class="o">.</span><span class="n">mean</span><span class="p">()</span>

        <span class="c1"># Se asigna NaN a aquellos registros con valor &lt;= 0, dejándolos listos para ser completados.</span>
        <span class="n">df_aux</span><span class="p">[</span><span class="n">campo_completar</span> <span class="o">+</span> <span class="s1">&#39;_FINAL&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span>
            <span class="n">df_aux</span><span class="p">[</span><span class="n">campo_completar</span><span class="p">]</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">,</span>
            <span class="n">df_aux</span><span class="p">[</span><span class="n">campo_completar</span><span class="p">],</span>
            <span class="n">np</span><span class="o">.</span><span class="n">nan</span>
        <span class="p">)</span>

    <span class="c1"># Para cada campo (o combinación de campos) en la lista de agrupaciones,</span>
    <span class="c1"># se realiza la función &#39;completa_campo&#39; que completa la columna &#39;_FINAL&#39;.</span>
    <span class="k">for</span> <span class="n">lista</span> <span class="ow">in</span> <span class="n">listas_campos_agrupar</span><span class="p">:</span>
        <span class="n">df_aux</span> <span class="o">=</span> <span class="n">df_aux</span><span class="o">=</span><span class="n">completa_campo</span><span class="p">(</span><span class="n">df_aux</span><span class="p">,</span><span class="n">campo_completar</span><span class="o">+</span><span class="s1">&#39;_FINAL&#39;</span><span class="p">,</span><span class="n">lista</span><span class="p">,</span><span class="n">parameters</span><span class="p">,</span><span class="n">campo_cero</span><span class="p">)</span>

    <span class="c1"># Luego de completar por grupos, se rellena con el promedio_general</span>
    <span class="c1"># los valores que aún estén nulos.</span>
    <span class="n">df_aux</span><span class="p">[</span><span class="n">campo_completar</span> <span class="o">+</span> <span class="s1">&#39;_FINAL&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">df_aux</span><span class="p">[</span><span class="n">campo_completar</span> <span class="o">+</span> <span class="s1">&#39;_FINAL&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">fillna</span><span class="p">(</span><span class="n">promedio_general</span><span class="p">)</span>

    <span class="c1"># Se retorna el DataFrame resultante con la nueva columna completada.</span>
    <span class="k">return</span> <span class="n">df_aux</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>

<div class="doc doc-object doc-function">


<h2 id="S2_Funciones.corrige_tasas_ges" class="doc doc-heading">
            <code class="highlight language-python"><span class="n">corrige_tasas_ges</span><span class="p">(</span><span class="n">df</span><span class="p">,</span> <span class="n">parameters</span><span class="p">)</span></code>

</h2>


    <div class="doc doc-contents ">

        <p>Corrige las tasas de un DataFrame, manejando registros duplicados y calculando tasas promedio.</p>
<p>Esta función identifica registros duplicados basados en un campo de RUT y otros identificadores.
Luego, calcula la tasa promedio de los duplicados, elimina las tasas originales y asigna la nueva
tasa promedio a los registros únicos, estableciendo además la periodicidad como 'M'.</p>


<p><span class="doc-section-title">Parameters:</span></p>
    <table>
      <thead>
        <tr>
          <th>Name</th>
          <th>Type</th>
          <th>Description</th>
          <th>Default</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
                <code>df</code>
            </td>
            <td>
                  <code><span title="pandas.DataFrame">DataFrame</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>DataFrame que contiene la información de tasas, incluyendo los identificadores
relevantes para la detección de duplicados.</p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>parameters</code>
            </td>
            <td>
                  <code><a class="autorefs autorefs-internal" title="S0_Loaders.Parameter_Loader" href="#S0_Loaders.Parameter_Loader">Parameter_Loader</a></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Objeto que carga parámetros de configuración, incluyendo el campo que define los registros duplicados.</p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
      </tbody>
    </table>


    <p><span class="doc-section-title">Returns:</span></p>
    <table>
      <thead>
        <tr>
          <th>Type</th>
          <th>Description</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
                  <code><span title="pandas.DataFrame">DataFrame</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>DataFrame corregido, donde los registros duplicados tienen su tasa ajustada
y la periodicidad establecida a 'M'.</p>
              </div>
            </td>
          </tr>
      </tbody>
    </table>

            <details class="quote">
              <summary>Source code in <code>S2_Funciones.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">872</span>
<span class="normal">873</span>
<span class="normal">874</span>
<span class="normal">875</span>
<span class="normal">876</span>
<span class="normal">877</span>
<span class="normal">878</span>
<span class="normal">879</span>
<span class="normal">880</span>
<span class="normal">881</span>
<span class="normal">882</span>
<span class="normal">883</span>
<span class="normal">884</span>
<span class="normal">885</span>
<span class="normal">886</span>
<span class="normal">887</span>
<span class="normal">888</span>
<span class="normal">889</span>
<span class="normal">890</span>
<span class="normal">891</span>
<span class="normal">892</span>
<span class="normal">893</span>
<span class="normal">894</span>
<span class="normal">895</span>
<span class="normal">896</span>
<span class="normal">897</span>
<span class="normal">898</span>
<span class="normal">899</span>
<span class="normal">900</span>
<span class="normal">901</span>
<span class="normal">902</span>
<span class="normal">903</span>
<span class="normal">904</span>
<span class="normal">905</span>
<span class="normal">906</span>
<span class="normal">907</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span> <span class="nf">corrige_tasas_ges</span><span class="p">(</span><span class="n">df</span><span class="p">:</span><span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">,</span> <span class="n">parameters</span><span class="p">:</span> <span class="n">Parameter_Loader</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Corrige las tasas de un DataFrame, manejando registros duplicados y calculando tasas promedio.</span>

<span class="sd">    Esta función identifica registros duplicados basados en un campo de RUT y otros identificadores.</span>
<span class="sd">    Luego, calcula la tasa promedio de los duplicados, elimina las tasas originales y asigna la nueva</span>
<span class="sd">    tasa promedio a los registros únicos, estableciendo además la periodicidad como &#39;M&#39;.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    df : pd.DataFrame</span>
<span class="sd">        DataFrame que contiene la información de tasas, incluyendo los identificadores</span>
<span class="sd">        relevantes para la detección de duplicados.</span>
<span class="sd">    parameters : Parameter_Loader</span>
<span class="sd">        Objeto que carga parámetros de configuración, incluyendo el campo que define los registros duplicados.</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    pd.DataFrame</span>
<span class="sd">        DataFrame corregido, donde los registros duplicados tienen su tasa ajustada</span>
<span class="sd">        y la periodicidad establecida a &#39;M&#39;.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="c1"># Defino registros duplicados y no duplicados</span>
    <span class="n">campo_rut_duplicados</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="n">parameters</span><span class="o">.</span><span class="n">parameters</span><span class="p">[</span><span class="s1">&#39;campo_rut_duplicados&#39;</span><span class="p">]</span>
    <span class="n">duplicados</span><span class="o">=</span><span class="n">df</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">df</span><span class="o">.</span><span class="n">duplicated</span><span class="p">(</span><span class="n">subset</span><span class="o">=</span><span class="p">[</span><span class="n">campo_rut_duplicados</span><span class="p">,</span><span class="s1">&#39;POLIZA&#39;</span><span class="p">,</span><span class="s1">&#39;CERTIFICADO&#39;</span><span class="p">,</span><span class="s1">&#39;NRO_OPERACION&#39;</span><span class="p">,</span><span class="s1">&#39;COD_COB&#39;</span><span class="p">],</span><span class="n">keep</span><span class="o">=</span><span class="kc">False</span><span class="p">)]</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
    <span class="n">no_duplicados_ges</span><span class="o">=</span><span class="n">df</span><span class="p">[</span><span class="o">~</span><span class="n">df</span><span class="o">.</span><span class="n">index</span><span class="o">.</span><span class="n">isin</span><span class="p">(</span><span class="n">duplicados</span><span class="o">.</span><span class="n">index</span><span class="p">)]</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
    <span class="c1"># Creo las tasas agrupadas de los registros duplicados (tomando la tasa promedio)</span>
    <span class="n">tasas_promedio</span><span class="o">=</span><span class="n">duplicados</span><span class="p">[[</span><span class="n">campo_rut_duplicados</span><span class="p">,</span><span class="s1">&#39;POLIZA&#39;</span><span class="p">,</span><span class="s1">&#39;CERTIFICADO&#39;</span><span class="p">,</span><span class="s1">&#39;NRO_OPERACION&#39;</span><span class="p">,</span><span class="s1">&#39;TASA_CRED&#39;</span><span class="p">]]</span><span class="o">.</span><span class="n">groupby</span><span class="p">([</span><span class="n">campo_rut_duplicados</span><span class="p">,</span><span class="s1">&#39;POLIZA&#39;</span><span class="p">,</span><span class="s1">&#39;CERTIFICADO&#39;</span><span class="p">,</span><span class="s1">&#39;NRO_OPERACION&#39;</span><span class="p">])</span><span class="o">.</span><span class="n">agg</span><span class="p">(</span><span class="s1">&#39;mean&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">reset_index</span><span class="p">()</span>
    <span class="c1"># Elimino la tasa y periodicidad de los duplicados, y luego elimino duplicados</span>
    <span class="n">duplicados</span><span class="o">=</span><span class="n">duplicados</span><span class="o">.</span><span class="n">drop</span><span class="p">(</span><span class="n">columns</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;PERIOD_TASA&#39;</span><span class="p">,</span><span class="s1">&#39;TASA_CRED&#39;</span><span class="p">],</span><span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
    <span class="n">duplicados</span><span class="o">=</span><span class="n">duplicados</span><span class="o">.</span><span class="n">drop_duplicates</span><span class="p">()</span>
    <span class="c1"># Cruzo ahora con las tasas promedio</span>
    <span class="n">duplicados</span><span class="o">=</span><span class="n">duplicados</span><span class="o">.</span><span class="n">merge</span><span class="p">(</span><span class="n">tasas_promedio</span><span class="p">,</span><span class="n">how</span><span class="o">=</span><span class="s1">&#39;left&#39;</span><span class="p">,</span><span class="n">on</span><span class="o">=</span><span class="p">[</span><span class="n">campo_rut_duplicados</span><span class="p">,</span><span class="s1">&#39;POLIZA&#39;</span><span class="p">,</span><span class="s1">&#39;CERTIFICADO&#39;</span><span class="p">,</span><span class="s1">&#39;NRO_OPERACION&#39;</span><span class="p">])</span>
    <span class="n">duplicados</span><span class="p">[</span><span class="s1">&#39;PERIOD_CRED&#39;</span><span class="p">]</span><span class="o">=</span><span class="s1">&#39;M&#39;</span>
    <span class="n">df_final</span><span class="o">=</span><span class="n">pd</span><span class="o">.</span><span class="n">concat</span><span class="p">([</span><span class="n">no_duplicados_ges</span><span class="p">,</span><span class="n">duplicados</span><span class="p">],</span><span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">df_final</span>    
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>

<div class="doc doc-object doc-function">


<h2 id="S2_Funciones.cruce_left" class="doc doc-heading">
            <code class="highlight language-python"><span class="n">cruce_left</span><span class="p">(</span><span class="n">df_1</span><span class="p">,</span> <span class="n">df_2</span><span class="p">,</span> <span class="n">left_on</span><span class="p">,</span> <span class="n">right_on</span><span class="p">,</span> <span class="n">parameters</span><span class="p">,</span> <span class="n">suffixes</span><span class="o">=</span><span class="p">(</span><span class="s1">&#39;_df1&#39;</span><span class="p">,</span> <span class="s1">&#39;_df2&#39;</span><span class="p">),</span> <span class="n">informa_no_cruces</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">name</span><span class="o">=</span><span class="s1">&#39;&#39;</span><span class="p">)</span></code>

</h2>


    <div class="doc doc-contents ">

        <p>Permite cruzar mediante merge left dos tablas</p>


<p><span class="doc-section-title">Parameters:</span></p>
    <table>
      <thead>
        <tr>
          <th>Name</th>
          <th>Type</th>
          <th>Description</th>
          <th>Default</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
                <code>df_1</code>
            </td>
            <td>
                  <code><span title="pandas.DataFrame">DataFrame</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>primer df</p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>df_2</code>
            </td>
            <td>
                  <code><span title="pandas.DataFrame">DataFrame</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>segundo df</p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>left_on</code>
            </td>
            <td>
                  <code>list[str]</code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>campos a cruzar primer df</p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>right_on</code>
            </td>
            <td>
                  <code>list[str]</code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>campos a cruzar segundo df</p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>parameters</code>
            </td>
            <td>
                  <code><a class="autorefs autorefs-internal" title="S0_Loaders.Parameter_Loader" href="#S0_Loaders.Parameter_Loader">Parameter_Loader</a></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Objeto con los parametros necesarios para calcular el cotnrato especifico</p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>suffixes</code>
            </td>
            <td>
                  <code>tuple[str, str]</code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>sufijos del cruce, by default ('_df1', '_df2')</p>
              </div>
            </td>
            <td>
                  <code>(&#39;_df1&#39;, &#39;_df2&#39;)</code>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>informa_no_cruces</code>
            </td>
            <td>
                  <code>int</code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>binario que indica si informamos o no los datos que no cruzaron, by default 1</p>
              </div>
            </td>
            <td>
                  <code>1</code>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>name</code>
            </td>
            <td>
                  <code>str</code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>nombre del archivo que tienen los datos que no cruzaron, by default ''</p>
              </div>
            </td>
            <td>
                  <code>&#39;&#39;</code>
            </td>
          </tr>
      </tbody>
    </table>


    <p><span class="doc-section-title">Returns:</span></p>
    <table>
      <thead>
        <tr>
          <th>Type</th>
          <th>Description</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
                  <code><span title="pandas.DataFrame">DataFrame</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>df cruzado</p>
              </div>
            </td>
          </tr>
      </tbody>
    </table>

            <details class="quote">
              <summary>Source code in <code>S2_Funciones.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"> 981</span>
<span class="normal"> 982</span>
<span class="normal"> 983</span>
<span class="normal"> 984</span>
<span class="normal"> 985</span>
<span class="normal"> 986</span>
<span class="normal"> 987</span>
<span class="normal"> 988</span>
<span class="normal"> 989</span>
<span class="normal"> 990</span>
<span class="normal"> 991</span>
<span class="normal"> 992</span>
<span class="normal"> 993</span>
<span class="normal"> 994</span>
<span class="normal"> 995</span>
<span class="normal"> 996</span>
<span class="normal"> 997</span>
<span class="normal"> 998</span>
<span class="normal"> 999</span>
<span class="normal">1000</span>
<span class="normal">1001</span>
<span class="normal">1002</span>
<span class="normal">1003</span>
<span class="normal">1004</span>
<span class="normal">1005</span>
<span class="normal">1006</span>
<span class="normal">1007</span>
<span class="normal">1008</span>
<span class="normal">1009</span>
<span class="normal">1010</span>
<span class="normal">1011</span>
<span class="normal">1012</span>
<span class="normal">1013</span>
<span class="normal">1014</span>
<span class="normal">1015</span>
<span class="normal">1016</span>
<span class="normal">1017</span>
<span class="normal">1018</span>
<span class="normal">1019</span>
<span class="normal">1020</span>
<span class="normal">1021</span>
<span class="normal">1022</span>
<span class="normal">1023</span>
<span class="normal">1024</span>
<span class="normal">1025</span>
<span class="normal">1026</span>
<span class="normal">1027</span>
<span class="normal">1028</span>
<span class="normal">1029</span>
<span class="normal">1030</span>
<span class="normal">1031</span>
<span class="normal">1032</span>
<span class="normal">1033</span>
<span class="normal">1034</span>
<span class="normal">1035</span>
<span class="normal">1036</span>
<span class="normal">1037</span>
<span class="normal">1038</span>
<span class="normal">1039</span>
<span class="normal">1040</span>
<span class="normal">1041</span>
<span class="normal">1042</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span> <span class="nf">cruce_left</span><span class="p">(</span><span class="n">df_1</span><span class="p">:</span><span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">,</span> <span class="n">df_2</span><span class="p">:</span><span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">,</span> <span class="n">left_on</span><span class="p">:</span> <span class="nb">list</span><span class="p">[</span><span class="nb">str</span><span class="p">],</span> <span class="n">right_on</span><span class="p">:</span> <span class="nb">list</span><span class="p">[</span><span class="nb">str</span><span class="p">],</span> <span class="n">parameters</span><span class="p">:</span> <span class="n">Parameter_Loader</span><span class="p">,</span> <span class="n">suffixes</span><span class="p">:</span> <span class="nb">tuple</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span><span class="nb">str</span><span class="p">]</span><span class="o">=</span><span class="p">(</span><span class="s1">&#39;_df1&#39;</span><span class="p">,</span> <span class="s1">&#39;_df2&#39;</span><span class="p">),</span> <span class="n">informa_no_cruces</span><span class="p">:</span> <span class="nb">int</span><span class="o">=</span><span class="mi">1</span> <span class="p">,</span> <span class="n">name</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s1">&#39;&#39;</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Permite cruzar mediante merge left dos tablas</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    df_1 : pd.DataFrame</span>
<span class="sd">        primer df</span>
<span class="sd">    df_2 : pd.DataFrame</span>
<span class="sd">        segundo df</span>
<span class="sd">    left_on : list[str]</span>
<span class="sd">        campos a cruzar primer df</span>
<span class="sd">    right_on : list[str]</span>
<span class="sd">        campos a cruzar segundo df</span>
<span class="sd">    parameters : Parameter_Loader</span>
<span class="sd">        Objeto con los parametros necesarios para calcular el cotnrato especifico</span>
<span class="sd">    suffixes : tuple[str,str], optional</span>
<span class="sd">        sufijos del cruce, by default (&#39;_df1&#39;, &#39;_df2&#39;)</span>
<span class="sd">    informa_no_cruces : int, optional</span>
<span class="sd">        binario que indica si informamos o no los datos que no cruzaron, by default 1</span>
<span class="sd">    name : str, optional</span>
<span class="sd">        nombre del archivo que tienen los datos que no cruzaron, by default &#39;&#39;</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    pd.DataFrame</span>
<span class="sd">        df cruzado</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">ruta_output</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="n">parameters</span><span class="o">.</span><span class="n">parameters</span><span class="p">[</span><span class="s1">&#39;ruta_output&#39;</span><span class="p">]</span>
    <span class="n">separador_output</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="n">parameters</span><span class="o">.</span><span class="n">parameters</span><span class="p">[</span><span class="s1">&#39;separador_output&#39;</span><span class="p">]</span>
    <span class="n">decimal_output</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="n">parameters</span><span class="o">.</span><span class="n">parameters</span><span class="p">[</span><span class="s1">&#39;decimal_output&#39;</span><span class="p">]</span>
    <span class="c1"># Realizar merge, especificando las columnas de fusión con left_on y right_on</span>
    <span class="c1"># Los sufijos _df1 y _df2 se agregan a los nombres de las columnas para diferenciar las columnas originales de cada DataFrame.</span>
    <span class="n">merged_df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">merge</span><span class="p">(</span><span class="n">df_1</span><span class="p">,</span> <span class="n">df_2</span><span class="p">,</span> <span class="n">how</span><span class="o">=</span><span class="s1">&#39;left&#39;</span><span class="p">,</span> <span class="n">right_on</span><span class="o">=</span><span class="n">right_on</span><span class="p">,</span> <span class="n">left_on</span><span class="o">=</span><span class="n">left_on</span><span class="p">,</span> <span class="n">suffixes</span><span class="o">=</span><span class="p">(</span><span class="s1">&#39;_df1&#39;</span><span class="p">,</span> <span class="s1">&#39;_df2&#39;</span><span class="p">),</span> <span class="n">indicator</span><span class="o">=</span><span class="s1">&#39;origen&#39;</span><span class="p">)</span>

    <span class="c1"># Encuentra los registros en df_1 que no cruzaron con df_2 </span>
    <span class="n">no_cruces</span> <span class="o">=</span> <span class="n">merged_df</span><span class="p">[</span><span class="n">merged_df</span><span class="p">[</span><span class="s1">&#39;origen&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;left_only&#39;</span><span class="p">]</span>

    <span class="k">if</span> <span class="n">no_cruces</span><span class="o">.</span><span class="n">empty</span><span class="p">:</span>
        <span class="n">informa_no_cruces</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">informa_no_cruces</span> <span class="o">=</span> <span class="mi">1</span>

    <span class="c1"># Informar en archivo.txt si es necesario</span>
    <span class="k">if</span> <span class="n">informa_no_cruces</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
        <span class="c1"># Guarda esos registros en un archivo no_cruces.txt en formato de texto tabular (separado por tabuladores).</span>
        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;Una cantidad de </span><span class="si">{</span><span class="n">no_cruces</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="si">}</span><span class="s1"> registros no cruzaron&#39;</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="n">no_cruces</span><span class="p">[</span><span class="n">left_on</span><span class="p">]</span><span class="o">.</span><span class="n">drop_duplicates</span><span class="p">(</span><span class="n">keep</span><span class="o">=</span><span class="s1">&#39;first&#39;</span><span class="p">))</span>
        <span class="n">no_cruces</span><span class="o">.</span><span class="n">to_csv</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">ruta_output</span><span class="si">}{</span><span class="n">name</span><span class="si">}</span><span class="s1"> no cruces.txt&#39;</span><span class="p">,</span> <span class="n">index</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span><span class="n">sep</span><span class="o">=</span><span class="n">separador_output</span><span class="p">,</span><span class="n">decimal</span><span class="o">=</span><span class="n">decimal_output</span><span class="p">)</span>
    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">merged_df</span><span class="p">)</span> <span class="o">&gt;</span> <span class="nb">len</span><span class="p">(</span><span class="n">df_1</span><span class="p">)</span> <span class="p">:</span>
        <span class="c1"># Identificar duplicados en merged_df que no estaban en df_1</span>
        <span class="n">duplicados_df_2</span> <span class="o">=</span><span class="n">df_2</span><span class="p">[</span><span class="n">df_2</span><span class="o">.</span><span class="n">duplicated</span><span class="p">(</span><span class="n">subset</span><span class="o">=</span><span class="n">right_on</span><span class="p">,</span> <span class="n">keep</span><span class="o">=</span><span class="kc">False</span><span class="p">)]</span>
        <span class="n">df_1_sin_duplicados</span><span class="o">=</span><span class="n">df_1</span><span class="o">.</span><span class="n">drop_duplicates</span><span class="p">(</span><span class="n">keep</span><span class="o">=</span><span class="s1">&#39;first&#39;</span><span class="p">)</span>
        <span class="n">duplicados_comunes</span> <span class="o">=</span> <span class="n">duplicados_df_2</span><span class="o">.</span><span class="n">merge</span><span class="p">(</span><span class="n">df_1_sin_duplicados</span><span class="p">,</span> <span class="n">how</span><span class="o">=</span><span class="s1">&#39;inner&#39;</span><span class="p">,</span> <span class="n">left_on</span><span class="o">=</span><span class="n">right_on</span><span class="p">,</span> <span class="n">right_on</span><span class="o">=</span><span class="n">left_on</span><span class="p">)</span>


        <span class="n">duplicados_comunes</span><span class="p">[</span><span class="n">df_2</span><span class="o">.</span><span class="n">columns</span><span class="p">]</span><span class="o">.</span><span class="n">to_csv</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">ruta_output</span><span class="si">}{</span><span class="n">name</span><span class="si">}</span><span class="s1"> duplicados.txt&#39;</span><span class="p">,</span><span class="n">sep</span><span class="o">=</span><span class="n">separador_output</span><span class="p">,</span><span class="n">decimal</span><span class="o">=</span><span class="n">decimal_output</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Registros duplicados:&quot;</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="n">duplicados_comunes</span><span class="p">[</span><span class="n">df_2</span><span class="o">.</span><span class="n">columns</span><span class="p">])</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;No hay duplicados adicionales. Tamaño original de df_1: </span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">df_1</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
    <span class="n">merged_df</span> <span class="o">=</span> <span class="n">merged_df</span><span class="o">.</span><span class="n">drop</span><span class="p">([</span><span class="s1">&#39;origen&#39;</span><span class="p">],</span> <span class="n">axis</span> <span class="o">=</span> <span class="mi">1</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">merged_df</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>

<div class="doc doc-object doc-function">


<h2 id="S2_Funciones.cumulo_riesgo" class="doc doc-heading">
            <code class="highlight language-python"><span class="n">cumulo_riesgo</span><span class="p">(</span><span class="n">df</span><span class="p">,</span> <span class="n">parameters</span><span class="p">,</span> <span class="n">tables</span><span class="p">,</span> <span class="n">riesgo_cumulo</span><span class="p">,</span> <span class="n">campos_str</span><span class="p">,</span> <span class="n">limite_retencion</span><span class="p">,</span> <span class="n">tipo_cumulo</span><span class="p">,</span> <span class="n">columna_capital</span><span class="p">)</span></code>

</h2>


    <div class="doc doc-contents ">

        <p>Calcula la suma de riesgos (cúmulos) y determina los límites o retenciones aplicables
sobre el capital de un conjunto de registros. Dependiendo de la configuración, se
cruzan tablas de referencia para determinar la retención y se calculan proporciones
para ajustar el capital según correspondan los casos de siniestros pagados o pendientes.</p>


<p><span class="doc-section-title">Parameters:</span></p>
    <table>
      <thead>
        <tr>
          <th>Name</th>
          <th>Type</th>
          <th>Description</th>
          <th>Default</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
                <code>df</code>
            </td>
            <td>
                  <code><span title="pandas.DataFrame">DataFrame</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>DataFrame principal que contiene la información de pólizas, capital y otros campos
necesarios para el cálculo.</p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>parameters</code>
            </td>
            <td>
                  <code><a class="autorefs autorefs-internal" title="S0_Loaders.Parameter_Loader" href="#S0_Loaders.Parameter_Loader">Parameter_Loader</a></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Objeto que contiene parámetros relevantes para la lógica del cálculo, tales como
tipo de cálculo, contrato de reaseguro, archivo de reporte, etc.</p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>tables</code>
            </td>
            <td>
                  <code><a class="autorefs autorefs-internal" title="S0_Loaders.Parameter_Loader" href="#S0_Loaders.Parameter_Loader">Parameter_Loader</a></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Objeto utilizado para cargar tablas auxiliares (por ejemplo, archivos de Excel)
que contienen información de retenciones o límites.</p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>riesgo_cumulo</code>
            </td>
            <td>
                  <code>str</code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Identificador del riesgo de cúmulo que se desea procesar (por ejemplo, 'Riesgo1').</p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>campos_str</code>
            </td>
            <td>
                  <code>str</code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>String que contiene los nombres de los campos (separados por comas) que serán
utilizados para agrupar los registros a fin de calcular los cúmulos.</p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>limite_retencion</code>
            </td>
            <td>
                  <code><span title="typing.Any">Any</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Puede ser un valor numérico que aplica como retención o el nombre de una tabla
(hoja de Excel) que contiene valores de retenciones variables según distintos
criterios. Si es un string, se intentará buscarlo en <code>tables</code>.</p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>tipo_cumulo</code>
            </td>
            <td>
                  <code>str</code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Nombre de la columna en <code>df</code> que se evalúa para filtrar los registros
correspondientes al <code>riesgo_cumulo</code> especificado.</p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>columna_capital</code>
            </td>
            <td>
                  <code>str</code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Nombre de la columna en <code>df</code> que contiene el valor de capital sobre el cual
se aplicará la lógica de retenciones o límites.</p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
      </tbody>
    </table>


    <p><span class="doc-section-title">Returns:</span></p>
    <table>
      <thead>
        <tr>
          <th>Type</th>
          <th>Description</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
                  <code><span title="pandas.DataFrame">DataFrame</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>DataFrame resultante con la información filtrada según el tipo de cúmulo y
contrato, y con nuevas columnas que describen:
- CUMULO: Suma del capital agrupado.
- (Opcional) CUMULO_PAGADOS: Suma del capital para siniestros pagados.
- PORCENTAJE: Porcentaje que se aplica para el cálculo de capital posterior,
  considerando la retención o el límite.
- CAPITAL POSTERIOR: Capital ajustado tras aplicar la retención o límite.
- (Opcional) PORCENTAJE PAGADOS y PORCENTAJE PENDIENTES: Se generan solamente
  en caso de que el <code>tipo_calculo</code> incluya siniestros. Luego se unifican en
  la columna final <code>PORCENTAJE</code>.</p>
              </div>
            </td>
          </tr>
      </tbody>
    </table>


<details class="note" open>
  <summary>Notes</summary>
  <ol>
<li>La función filtra <code>df</code> según las columnas <code>CONTRATO REASEGURO</code> y <code>tipo_cumulo</code>,
   y en caso de no encontrar registros, retorna el DataFrame filtrado vacío.</li>
<li>Se agrupan registros por los campos indicados en <code>campos_str</code> para sumar
   el <code>columna_capital</code>, resultando en la columna <code>CUMULO</code>.</li>
<li>El parámetro <code>limite_retencion</code> puede ser un valor único o el nombre de una tabla;
   si es el nombre de una tabla, se carga e incorpora la columna de retenciones.</li>
<li>En cálculos de siniestros, se separan los siniestros pagados para aplicar
   porcentajes distintos respecto de los pendientes.</li>
<li>Se generan reportes de advertencia (mediante la función <code>escribe_reporta</code>) en
   caso de que existan campos faltantes o discrepancias en la unión de los datos.</li>
</ol>
</details>
            <details class="quote">
              <summary>Source code in <code>S2_Funciones.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">241</span>
<span class="normal">242</span>
<span class="normal">243</span>
<span class="normal">244</span>
<span class="normal">245</span>
<span class="normal">246</span>
<span class="normal">247</span>
<span class="normal">248</span>
<span class="normal">249</span>
<span class="normal">250</span>
<span class="normal">251</span>
<span class="normal">252</span>
<span class="normal">253</span>
<span class="normal">254</span>
<span class="normal">255</span>
<span class="normal">256</span>
<span class="normal">257</span>
<span class="normal">258</span>
<span class="normal">259</span>
<span class="normal">260</span>
<span class="normal">261</span>
<span class="normal">262</span>
<span class="normal">263</span>
<span class="normal">264</span>
<span class="normal">265</span>
<span class="normal">266</span>
<span class="normal">267</span>
<span class="normal">268</span>
<span class="normal">269</span>
<span class="normal">270</span>
<span class="normal">271</span>
<span class="normal">272</span>
<span class="normal">273</span>
<span class="normal">274</span>
<span class="normal">275</span>
<span class="normal">276</span>
<span class="normal">277</span>
<span class="normal">278</span>
<span class="normal">279</span>
<span class="normal">280</span>
<span class="normal">281</span>
<span class="normal">282</span>
<span class="normal">283</span>
<span class="normal">284</span>
<span class="normal">285</span>
<span class="normal">286</span>
<span class="normal">287</span>
<span class="normal">288</span>
<span class="normal">289</span>
<span class="normal">290</span>
<span class="normal">291</span>
<span class="normal">292</span>
<span class="normal">293</span>
<span class="normal">294</span>
<span class="normal">295</span>
<span class="normal">296</span>
<span class="normal">297</span>
<span class="normal">298</span>
<span class="normal">299</span>
<span class="normal">300</span>
<span class="normal">301</span>
<span class="normal">302</span>
<span class="normal">303</span>
<span class="normal">304</span>
<span class="normal">305</span>
<span class="normal">306</span>
<span class="normal">307</span>
<span class="normal">308</span>
<span class="normal">309</span>
<span class="normal">310</span>
<span class="normal">311</span>
<span class="normal">312</span>
<span class="normal">313</span>
<span class="normal">314</span>
<span class="normal">315</span>
<span class="normal">316</span>
<span class="normal">317</span>
<span class="normal">318</span>
<span class="normal">319</span>
<span class="normal">320</span>
<span class="normal">321</span>
<span class="normal">322</span>
<span class="normal">323</span>
<span class="normal">324</span>
<span class="normal">325</span>
<span class="normal">326</span>
<span class="normal">327</span>
<span class="normal">328</span>
<span class="normal">329</span>
<span class="normal">330</span>
<span class="normal">331</span>
<span class="normal">332</span>
<span class="normal">333</span>
<span class="normal">334</span>
<span class="normal">335</span>
<span class="normal">336</span>
<span class="normal">337</span>
<span class="normal">338</span>
<span class="normal">339</span>
<span class="normal">340</span>
<span class="normal">341</span>
<span class="normal">342</span>
<span class="normal">343</span>
<span class="normal">344</span>
<span class="normal">345</span>
<span class="normal">346</span>
<span class="normal">347</span>
<span class="normal">348</span>
<span class="normal">349</span>
<span class="normal">350</span>
<span class="normal">351</span>
<span class="normal">352</span>
<span class="normal">353</span>
<span class="normal">354</span>
<span class="normal">355</span>
<span class="normal">356</span>
<span class="normal">357</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span> <span class="nf">cumulo_riesgo</span><span class="p">(</span><span class="n">df</span><span class="p">:</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">,</span> <span class="n">parameters</span><span class="p">:</span> <span class="n">Parameter_Loader</span><span class="p">,</span> <span class="n">tables</span><span class="p">:</span> <span class="n">Parameter_Loader</span><span class="p">,</span> <span class="n">riesgo_cumulo</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">campos_str</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">limite_retencion</span><span class="p">:</span><span class="n">Any</span><span class="p">,</span><span class="n">tipo_cumulo</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span><span class="n">columna_capital</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Calcula la suma de riesgos (cúmulos) y determina los límites o retenciones aplicables</span>
<span class="sd">    sobre el capital de un conjunto de registros. Dependiendo de la configuración, se</span>
<span class="sd">    cruzan tablas de referencia para determinar la retención y se calculan proporciones</span>
<span class="sd">    para ajustar el capital según correspondan los casos de siniestros pagados o pendientes.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    df : pd.DataFrame</span>
<span class="sd">        DataFrame principal que contiene la información de pólizas, capital y otros campos</span>
<span class="sd">        necesarios para el cálculo.</span>
<span class="sd">    parameters : Parameter_Loader</span>
<span class="sd">        Objeto que contiene parámetros relevantes para la lógica del cálculo, tales como</span>
<span class="sd">        tipo de cálculo, contrato de reaseguro, archivo de reporte, etc.</span>
<span class="sd">    tables : Parameter_Loader</span>
<span class="sd">        Objeto utilizado para cargar tablas auxiliares (por ejemplo, archivos de Excel)</span>
<span class="sd">        que contienen información de retenciones o límites.</span>
<span class="sd">    riesgo_cumulo : str</span>
<span class="sd">        Identificador del riesgo de cúmulo que se desea procesar (por ejemplo, &#39;Riesgo1&#39;).</span>
<span class="sd">    campos_str : str</span>
<span class="sd">        String que contiene los nombres de los campos (separados por comas) que serán</span>
<span class="sd">        utilizados para agrupar los registros a fin de calcular los cúmulos.</span>
<span class="sd">    limite_retencion : Any</span>
<span class="sd">        Puede ser un valor numérico que aplica como retención o el nombre de una tabla</span>
<span class="sd">        (hoja de Excel) que contiene valores de retenciones variables según distintos</span>
<span class="sd">        criterios. Si es un string, se intentará buscarlo en `tables`.</span>
<span class="sd">    tipo_cumulo : str</span>
<span class="sd">        Nombre de la columna en `df` que se evalúa para filtrar los registros</span>
<span class="sd">        correspondientes al `riesgo_cumulo` especificado.</span>
<span class="sd">    columna_capital : str</span>
<span class="sd">        Nombre de la columna en `df` que contiene el valor de capital sobre el cual</span>
<span class="sd">        se aplicará la lógica de retenciones o límites.</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    pd.DataFrame</span>
<span class="sd">        DataFrame resultante con la información filtrada según el tipo de cúmulo y</span>
<span class="sd">        contrato, y con nuevas columnas que describen:</span>
<span class="sd">        - CUMULO: Suma del capital agrupado.</span>
<span class="sd">        - (Opcional) CUMULO_PAGADOS: Suma del capital para siniestros pagados.</span>
<span class="sd">        - PORCENTAJE: Porcentaje que se aplica para el cálculo de capital posterior,</span>
<span class="sd">          considerando la retención o el límite.</span>
<span class="sd">        - CAPITAL POSTERIOR: Capital ajustado tras aplicar la retención o límite.</span>
<span class="sd">        - (Opcional) PORCENTAJE PAGADOS y PORCENTAJE PENDIENTES: Se generan solamente</span>
<span class="sd">          en caso de que el `tipo_calculo` incluya siniestros. Luego se unifican en</span>
<span class="sd">          la columna final `PORCENTAJE`.</span>

<span class="sd">    Notes</span>
<span class="sd">    -----</span>
<span class="sd">    1. La función filtra `df` según las columnas `CONTRATO REASEGURO` y `tipo_cumulo`,</span>
<span class="sd">       y en caso de no encontrar registros, retorna el DataFrame filtrado vacío.</span>
<span class="sd">    2. Se agrupan registros por los campos indicados en `campos_str` para sumar</span>
<span class="sd">       el `columna_capital`, resultando en la columna `CUMULO`.</span>
<span class="sd">    3. El parámetro `limite_retencion` puede ser un valor único o el nombre de una tabla;</span>
<span class="sd">       si es el nombre de una tabla, se carga e incorpora la columna de retenciones.</span>
<span class="sd">    4. En cálculos de siniestros, se separan los siniestros pagados para aplicar</span>
<span class="sd">       porcentajes distintos respecto de los pendientes.</span>
<span class="sd">    5. Se generan reportes de advertencia (mediante la función `escribe_reporta`) en</span>
<span class="sd">       caso de que existan campos faltantes o discrepancias en la unión de los datos.</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="n">tipo_calculo</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="n">parameters</span><span class="o">.</span><span class="n">parameters</span><span class="p">[</span><span class="s1">&#39;tipo_calculo&#39;</span><span class="p">]</span>
    <span class="n">contrato</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="n">parameters</span><span class="o">.</span><span class="n">parameters</span><span class="p">[</span><span class="s1">&#39;contrato&#39;</span><span class="p">]</span>
    <span class="n">archivo_reporte</span><span class="p">:</span> <span class="n">Any</span> <span class="o">=</span> <span class="n">parameters</span><span class="o">.</span><span class="n">parameters</span><span class="p">[</span><span class="s1">&#39;archivo_reporte&#39;</span><span class="p">]</span>
    <span class="n">ruta_extensa</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="n">parameters</span><span class="o">.</span><span class="n">ruta_extensa</span>
    <span class="c1"># * Funcion de calculo de cumulo para un tipo_calculo y riesgo particular</span>
    <span class="c1"># Filtro el df por el tipo_calculo y el riesgo de cumulo correspondiente</span>
    <span class="n">df_filter</span><span class="o">=</span><span class="n">df</span><span class="p">[(</span><span class="n">df</span><span class="p">[</span><span class="s1">&#39;CONTRATO REASEGURO&#39;</span><span class="p">]</span><span class="o">==</span><span class="n">contrato</span><span class="p">)</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">df</span><span class="p">[</span><span class="n">tipo_cumulo</span><span class="p">]</span><span class="o">==</span><span class="n">riesgo_cumulo</span><span class="p">)]</span>
    <span class="c1"># Si el df filtrado es vacio (pensado en que la funcion cumulos recorre todos los registros de su tabla de cumulos), entonces crea en el df las columnas que se crearán en caso de no ser vacio</span>
    <span class="k">if</span> <span class="n">df_filter</span><span class="o">.</span><span class="n">empty</span><span class="p">:</span>
        <span class="c1">#print(&#39;dataframe vacio para tipo_calculo de reaseguro {} y riesgo cumulo {}&#39;.format(contrato,riesgo_cumulo))</span>
        <span class="k">return</span> <span class="n">df_filter</span>
    <span class="c1"># Hacemos groupby por la lista de campos que entregamos. Tomamos como agregacion la columna de cumulos que indicamos en los parametros</span>
    <span class="n">lista_campos</span><span class="p">:</span> <span class="nb">list</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="n">campos_str</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;,&#39;</span><span class="p">)</span>
    <span class="k">if</span> <span class="nb">sum</span><span class="p">([</span><span class="mi">0</span> <span class="k">if</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">df</span><span class="o">.</span><span class="n">columns</span> <span class="k">else</span> <span class="mi">1</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">lista_campos</span><span class="p">])</span><span class="o">==</span><span class="mi">0</span><span class="p">:</span>
        <span class="n">df_grouped</span> <span class="o">=</span> <span class="n">df_filter</span><span class="o">.</span><span class="n">groupby</span><span class="p">(</span><span class="n">lista_campos</span><span class="p">)[</span><span class="n">columna_capital</span><span class="p">]</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span><span class="o">.</span><span class="n">reset_index</span><span class="p">()</span><span class="o">.</span><span class="n">rename</span><span class="p">(</span><span class="n">columns</span><span class="o">=</span><span class="p">{</span><span class="n">columna_capital</span><span class="p">:</span><span class="s1">&#39;CUMULO&#39;</span><span class="p">})</span>
        <span class="k">if</span> <span class="s1">&#39;Siniestro&#39;</span> <span class="ow">in</span> <span class="n">tipo_calculo</span><span class="p">:</span> <span class="n">df_grouped_pagados</span><span class="o">=</span><span class="n">df_filter</span><span class="p">[</span><span class="n">df_filter</span><span class="p">[</span><span class="s1">&#39;ESTADO SINIESTRO&#39;</span><span class="p">]</span><span class="o">==</span><span class="s1">&#39;PAGADO&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">groupby</span><span class="p">(</span><span class="n">lista_campos</span><span class="p">)[</span><span class="n">columna_capital</span><span class="p">]</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span><span class="o">.</span><span class="n">reset_index</span><span class="p">()</span><span class="o">.</span><span class="n">rename</span><span class="p">(</span><span class="n">columns</span><span class="o">=</span><span class="p">{</span><span class="n">columna_capital</span><span class="p">:</span><span class="s1">&#39;CUMULO_PAGADOS&#39;</span><span class="p">})</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">for</span> <span class="n">campo</span> <span class="ow">in</span> <span class="n">lista_campos</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">campo</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">df</span><span class="o">.</span><span class="n">columns</span><span class="p">:</span>
                <span class="n">escribe_reporta</span><span class="p">(</span><span class="n">archivo_reporte</span><span class="p">,</span><span class="s1">&#39;El campo </span><span class="si">{}</span><span class="s1"> para hacer cumulo no se encuentra dentro del dataframe, para tipo_calculo de reaseguro </span><span class="si">{}</span><span class="s1"> y riesgo cumulo </span><span class="si">{}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">campo</span><span class="p">,</span><span class="n">contrato</span><span class="p">,</span><span class="n">riesgo_cumulo</span><span class="p">))</span>
    <span class="c1"># Calculo de retencion: </span>
    <span class="c1"># Si la retencion no es igual para todos registros, se debe inrgesar el nombre de la tabla que parametriza aquello</span>
    <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">limite_retencion</span><span class="p">,</span> <span class="nb">str</span><span class="p">):</span>
        <span class="c1"># Busca la tabla del nombre que pusimos dentro de la tabla de cumulos</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">tabla_cumulos</span><span class="p">:</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span> <span class="o">=</span> <span class="n">tables</span><span class="o">.</span><span class="n">get_table_xlsx</span><span class="p">(</span><span class="n">sheet_name</span> <span class="o">=</span> <span class="n">limite_retencion</span><span class="p">)</span>
        <span class="k">except</span><span class="p">:</span>
            <span class="n">escribe_reporta</span><span class="p">(</span><span class="n">archivo_reporte</span><span class="p">,</span><span class="sa">f</span><span class="s1">&#39;la tabla de retenciones especificada no existe para el tipo_calculo de reaseguro </span><span class="si">{</span><span class="n">contrato</span><span class="si">}</span><span class="s1"> y riesgo cumulo </span><span class="si">{</span><span class="n">riesgo_cumulo</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>
        <span class="c1"># Revisa el nombre de los campos que tiene, y quita el que contiene el limite</span>
        <span class="n">campos</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">tabla_cumulos</span><span class="o">.</span><span class="n">columns</span><span class="p">)</span>
        <span class="n">campos</span><span class="o">.</span><span class="n">remove</span><span class="p">(</span><span class="s1">&#39;LIMITE O RETENCION&#39;</span><span class="p">)</span>
        <span class="c1"># Cruza con el df de acuerdo al resto de campos dentro de la tabla</span>
        <span class="n">df_grouped</span><span class="o">=</span><span class="n">df_grouped</span><span class="o">.</span><span class="n">merge</span><span class="p">(</span><span class="n">tabla_cumulos</span><span class="p">,</span><span class="n">how</span><span class="o">=</span><span class="s1">&#39;inner&#39;</span><span class="p">,</span> <span class="n">left_on</span><span class="o">=</span><span class="n">campos</span><span class="p">,</span> <span class="n">right_on</span><span class="o">=</span><span class="n">campos</span><span class="p">,</span><span class="n">suffixes</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;&#39;</span><span class="p">,</span><span class="s1">&#39;_x&#39;</span><span class="p">])</span> <span class="c1"># type: ignore</span>
    <span class="k">else</span><span class="p">:</span>
    <span class="c1"># Si la retencion es igual para todos los registros, rellena con ese valor dentro del df agrupado</span>
        <span class="n">df_grouped</span><span class="p">[</span><span class="s1">&#39;LIMITE O RETENCION&#39;</span><span class="p">]</span><span class="o">=</span><span class="n">limite_retencion</span>
    <span class="c1"># Crea la columna porcentaje</span>
    <span class="k">if</span> <span class="s1">&#39;Siniestro&#39;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">tipo_calculo</span><span class="p">:</span>
        <span class="n">df_grouped</span><span class="p">[</span><span class="s1">&#39;PORCENTAJE&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">df_grouped</span><span class="p">[</span><span class="s1">&#39;CUMULO&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">minimum</span><span class="p">(</span> <span class="mi">1</span><span class="p">,</span> <span class="n">df_grouped</span><span class="p">[</span><span class="s1">&#39;LIMITE O RETENCION&#39;</span><span class="p">]</span> <span class="o">/</span> <span class="n">df_grouped</span><span class="p">[</span><span class="s1">&#39;CUMULO&#39;</span><span class="p">]))</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">df_grouped</span><span class="o">=</span><span class="n">df_grouped</span><span class="o">.</span><span class="n">merge</span><span class="p">(</span><span class="n">df_grouped_pagados</span><span class="p">,</span><span class="n">how</span><span class="o">=</span><span class="s1">&#39;left&#39;</span><span class="p">,</span><span class="n">on</span><span class="o">=</span><span class="n">lista_campos</span><span class="p">)</span>
        <span class="n">df_grouped</span><span class="p">[</span><span class="s1">&#39;CUMULO_PAGADOS&#39;</span><span class="p">]</span><span class="o">=</span><span class="n">df_grouped</span><span class="p">[</span><span class="s1">&#39;CUMULO_PAGADOS&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">fillna</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
        <span class="n">df_grouped</span><span class="p">[</span><span class="s1">&#39;PORCENTAJE PAGADOS&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">df_grouped</span><span class="p">[</span><span class="s1">&#39;CUMULO_PAGADOS&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">minimum</span><span class="p">(</span> <span class="mi">1</span><span class="p">,</span> <span class="n">df_grouped</span><span class="p">[</span><span class="s1">&#39;LIMITE O RETENCION&#39;</span><span class="p">]</span> <span class="o">/</span> <span class="n">df_grouped</span><span class="p">[</span><span class="s1">&#39;CUMULO_PAGADOS&#39;</span><span class="p">]))</span>
        <span class="n">df_grouped</span><span class="p">[</span><span class="s1">&#39;PORCENTAJE PENDIENTES&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">df_grouped</span><span class="p">[</span><span class="s1">&#39;CUMULO_PAGADOS&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="n">df_grouped</span><span class="p">[</span><span class="s1">&#39;CUMULO&#39;</span><span class="p">],</span> <span class="mi">0</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">minimum</span><span class="p">(</span> <span class="mi">1</span><span class="p">,</span> <span class="p">(</span> <span class="n">df_grouped</span><span class="p">[</span><span class="s1">&#39;LIMITE O RETENCION&#39;</span><span class="p">]</span> <span class="o">-</span> <span class="n">np</span><span class="o">.</span><span class="n">minimum</span><span class="p">(</span> <span class="n">df_grouped</span><span class="p">[</span><span class="s1">&#39;LIMITE O RETENCION&#39;</span><span class="p">],</span> <span class="n">df_grouped</span><span class="p">[</span><span class="s1">&#39;CUMULO_PAGADOS&#39;</span><span class="p">]))</span> <span class="o">/</span> <span class="p">(</span> <span class="n">df_grouped</span><span class="p">[</span><span class="s1">&#39;CUMULO&#39;</span><span class="p">]</span> <span class="o">-</span> <span class="n">df_grouped</span><span class="p">[</span><span class="s1">&#39;CUMULO_PAGADOS&#39;</span><span class="p">])))</span>
    <span class="c1"># Finalmente, cruza el df original y filtrado con el df agrupado</span>
    <span class="n">df_final</span><span class="o">=</span><span class="n">df_filter</span><span class="o">.</span><span class="n">merge</span><span class="p">(</span><span class="n">df_grouped</span><span class="p">,</span><span class="n">how</span><span class="o">=</span><span class="s1">&#39;inner&#39;</span><span class="p">,</span> <span class="n">left_on</span><span class="o">=</span><span class="n">lista_campos</span><span class="p">,</span> <span class="n">right_on</span><span class="o">=</span><span class="n">lista_campos</span><span class="p">,</span><span class="n">suffixes</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;&#39;</span><span class="p">,</span><span class="s1">&#39;_x&#39;</span><span class="p">])</span> <span class="c1"># type: ignore</span>
    <span class="k">if</span> <span class="n">df_final</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">&gt;</span> <span class="n">df_filter</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]:</span>
        <span class="n">escribe_reporta</span><span class="p">(</span><span class="n">archivo_reporte</span><span class="p">,</span><span class="s1">&#39;la tabla agrupada con los limites y retenciones cruzó más registros que el df original, para el tipo_calculo de reaseguro </span><span class="si">{}</span><span class="s1"> y riesgo cumulo </span><span class="si">{}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">contrato</span><span class="p">,</span><span class="n">riesgo_cumulo</span><span class="p">))</span>
    <span class="k">elif</span> <span class="n">df_final</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">&lt;</span> <span class="n">df_filter</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]:</span>
        <span class="n">escribe_reporta</span><span class="p">(</span><span class="n">archivo_reporte</span><span class="p">,</span><span class="s1">&#39;la tabla agrupada con los limites y retenciones cruzó menos registros que el df original, para el tipo_calculo de reaseguro </span><span class="si">{}</span><span class="s1"> y riesgo cumulo </span><span class="si">{}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">contrato</span><span class="p">,</span><span class="n">riesgo_cumulo</span><span class="p">))</span>
    <span class="c1"># Columna que calcula el capital posterior a establecer limite o retencion, segun corresponda</span>
    <span class="k">if</span> <span class="s1">&#39;Siniestro&#39;</span> <span class="ow">in</span> <span class="n">tipo_calculo</span><span class="p">:</span> <span class="n">df_final</span><span class="p">[</span><span class="s1">&#39;PORCENTAJE&#39;</span><span class="p">]</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">df_final</span><span class="p">[</span><span class="s1">&#39;ESTADO SINIESTRO&#39;</span><span class="p">]</span><span class="o">==</span><span class="s1">&#39;PAGADO&#39;</span><span class="p">,</span><span class="n">df_final</span><span class="p">[</span><span class="s1">&#39;PORCENTAJE PAGADOS&#39;</span><span class="p">],</span><span class="n">df_final</span><span class="p">[</span><span class="s1">&#39;PORCENTAJE PENDIENTES&#39;</span><span class="p">])</span>
    <span class="n">df_final</span><span class="p">[</span><span class="s1">&#39;CAPITAL POSTERIOR&#39;</span><span class="p">]</span><span class="o">=</span><span class="n">df_final</span><span class="p">[</span><span class="s1">&#39;PORCENTAJE&#39;</span><span class="p">]</span><span class="o">*</span><span class="n">df_final</span><span class="p">[</span><span class="n">columna_capital</span><span class="p">]</span>
    <span class="k">if</span> <span class="s1">&#39;Siniestro&#39;</span> <span class="ow">in</span> <span class="n">tipo_calculo</span><span class="p">:</span> <span class="n">df_final</span><span class="o">.</span><span class="n">drop</span><span class="p">(</span><span class="n">columns</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;PORCENTAJE PAGADOS&#39;</span><span class="p">,</span> <span class="s1">&#39;PORCENTAJE PENDIENTES&#39;</span><span class="p">],</span><span class="n">inplace</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">df_final</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>

<div class="doc doc-object doc-function">


<h2 id="S2_Funciones.cumulos" class="doc doc-heading">
            <code class="highlight language-python"><span class="n">cumulos</span><span class="p">(</span><span class="n">df</span><span class="p">,</span> <span class="n">parameters</span><span class="p">,</span> <span class="n">tables</span><span class="p">,</span> <span class="n">campo_cumulo</span><span class="p">)</span></code>

</h2>


    <div class="doc doc-contents ">

        <p>Calcula y asigna los límites o retenciones de cúmulo de reaseguros 
según los parámetros y tablas de cúmulos definidos.</p>


<p><span class="doc-section-title">Parameters:</span></p>
    <table>
      <thead>
        <tr>
          <th>Name</th>
          <th>Type</th>
          <th>Description</th>
          <th>Default</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
                <code>df</code>
            </td>
            <td>
                  <code><span title="pandas.DataFrame">DataFrame</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>DataFrame con la información base sobre la cual se aplican 
los cálculos de cúmulos (pueden ser pólizas, siniestros, etc.).</p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>parameters</code>
            </td>
            <td>
                  <code><a class="autorefs autorefs-internal" title="S0_Loaders.Parameter_Loader" href="#S0_Loaders.Parameter_Loader">Parameter_Loader</a></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Objeto que contiene los parámetros de configuración necesarios 
para la función (por ejemplo, 'archivo_reporte', 'tipo_calculo', etc.).</p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>tables</code>
            </td>
            <td>
                  <code><a class="autorefs autorefs-internal" title="S0_Loaders.Parameter_Loader" href="#S0_Loaders.Parameter_Loader">Parameter_Loader</a></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Objeto que carga las tablas en formato xlsx para definir los 
diferentes tipos de cúmulos: 
- 'Matriz Cumulo Individual'
- 'Matriz Cumulo Contrato'
- 'Matriz Cumulo Excedente'</p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>campo_cumulo</code>
            </td>
            <td>
                  <code>str</code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Tipo de cúmulo a aplicar. Puede tomar valores como:
- 'RIESGO LIMITE INDIVIDUAL'
- 'RIESGO LIMITE CONTRATO'
- 'RIESGO RETENCION EXCEDENTE'</p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
      </tbody>
    </table>


    <p><span class="doc-section-title">Returns:</span></p>
    <table>
      <thead>
        <tr>
          <th>Type</th>
          <th>Description</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
                  <code><span title="pandas.DataFrame">DataFrame</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>DataFrame con la información actualizada según la aplicación
de los cálculos de cúmulo. Se añaden (o modifican) columnas para 
reflejar el cúmulo, la retención o límite asociado, los porcentajes 
aplicados y el capital posterior al cálculo, entre otros campos.</p>
              </div>
            </td>
          </tr>
      </tbody>
    </table>

            <details class="quote">
              <summary>Source code in <code>S2_Funciones.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">360</span>
<span class="normal">361</span>
<span class="normal">362</span>
<span class="normal">363</span>
<span class="normal">364</span>
<span class="normal">365</span>
<span class="normal">366</span>
<span class="normal">367</span>
<span class="normal">368</span>
<span class="normal">369</span>
<span class="normal">370</span>
<span class="normal">371</span>
<span class="normal">372</span>
<span class="normal">373</span>
<span class="normal">374</span>
<span class="normal">375</span>
<span class="normal">376</span>
<span class="normal">377</span>
<span class="normal">378</span>
<span class="normal">379</span>
<span class="normal">380</span>
<span class="normal">381</span>
<span class="normal">382</span>
<span class="normal">383</span>
<span class="normal">384</span>
<span class="normal">385</span>
<span class="normal">386</span>
<span class="normal">387</span>
<span class="normal">388</span>
<span class="normal">389</span>
<span class="normal">390</span>
<span class="normal">391</span>
<span class="normal">392</span>
<span class="normal">393</span>
<span class="normal">394</span>
<span class="normal">395</span>
<span class="normal">396</span>
<span class="normal">397</span>
<span class="normal">398</span>
<span class="normal">399</span>
<span class="normal">400</span>
<span class="normal">401</span>
<span class="normal">402</span>
<span class="normal">403</span>
<span class="normal">404</span>
<span class="normal">405</span>
<span class="normal">406</span>
<span class="normal">407</span>
<span class="normal">408</span>
<span class="normal">409</span>
<span class="normal">410</span>
<span class="normal">411</span>
<span class="normal">412</span>
<span class="normal">413</span>
<span class="normal">414</span>
<span class="normal">415</span>
<span class="normal">416</span>
<span class="normal">417</span>
<span class="normal">418</span>
<span class="normal">419</span>
<span class="normal">420</span>
<span class="normal">421</span>
<span class="normal">422</span>
<span class="normal">423</span>
<span class="normal">424</span>
<span class="normal">425</span>
<span class="normal">426</span>
<span class="normal">427</span>
<span class="normal">428</span>
<span class="normal">429</span>
<span class="normal">430</span>
<span class="normal">431</span>
<span class="normal">432</span>
<span class="normal">433</span>
<span class="normal">434</span>
<span class="normal">435</span>
<span class="normal">436</span>
<span class="normal">437</span>
<span class="normal">438</span>
<span class="normal">439</span>
<span class="normal">440</span>
<span class="normal">441</span>
<span class="normal">442</span>
<span class="normal">443</span>
<span class="normal">444</span>
<span class="normal">445</span>
<span class="normal">446</span>
<span class="normal">447</span>
<span class="normal">448</span>
<span class="normal">449</span>
<span class="normal">450</span>
<span class="normal">451</span>
<span class="normal">452</span>
<span class="normal">453</span>
<span class="normal">454</span>
<span class="normal">455</span>
<span class="normal">456</span>
<span class="normal">457</span>
<span class="normal">458</span>
<span class="normal">459</span>
<span class="normal">460</span>
<span class="normal">461</span>
<span class="normal">462</span>
<span class="normal">463</span>
<span class="normal">464</span>
<span class="normal">465</span>
<span class="normal">466</span>
<span class="normal">467</span>
<span class="normal">468</span>
<span class="normal">469</span>
<span class="normal">470</span>
<span class="normal">471</span>
<span class="normal">472</span>
<span class="normal">473</span>
<span class="normal">474</span>
<span class="normal">475</span>
<span class="normal">476</span>
<span class="normal">477</span>
<span class="normal">478</span>
<span class="normal">479</span>
<span class="normal">480</span>
<span class="normal">481</span>
<span class="normal">482</span>
<span class="normal">483</span>
<span class="normal">484</span>
<span class="normal">485</span>
<span class="normal">486</span>
<span class="normal">487</span>
<span class="normal">488</span>
<span class="normal">489</span>
<span class="normal">490</span>
<span class="normal">491</span>
<span class="normal">492</span>
<span class="normal">493</span>
<span class="normal">494</span>
<span class="normal">495</span>
<span class="normal">496</span>
<span class="normal">497</span>
<span class="normal">498</span>
<span class="normal">499</span>
<span class="normal">500</span>
<span class="normal">501</span>
<span class="normal">502</span>
<span class="normal">503</span>
<span class="normal">504</span>
<span class="normal">505</span>
<span class="normal">506</span>
<span class="normal">507</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span> <span class="nf">cumulos</span><span class="p">(</span><span class="n">df</span><span class="p">:</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">,</span> <span class="n">parameters</span><span class="p">:</span> <span class="n">Parameter_Loader</span><span class="p">,</span> <span class="n">tables</span><span class="p">:</span> <span class="n">Parameter_Loader</span><span class="p">,</span><span class="n">campo_cumulo</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Calcula y asigna los límites o retenciones de cúmulo de reaseguros </span>
<span class="sd">    según los parámetros y tablas de cúmulos definidos.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    df : pd.DataFrame</span>
<span class="sd">        DataFrame con la información base sobre la cual se aplican </span>
<span class="sd">        los cálculos de cúmulos (pueden ser pólizas, siniestros, etc.).</span>
<span class="sd">    parameters : Parameter_Loader</span>
<span class="sd">        Objeto que contiene los parámetros de configuración necesarios </span>
<span class="sd">        para la función (por ejemplo, &#39;archivo_reporte&#39;, &#39;tipo_calculo&#39;, etc.).</span>
<span class="sd">    tables : Parameter_Loader</span>
<span class="sd">        Objeto que carga las tablas en formato xlsx para definir los </span>
<span class="sd">        diferentes tipos de cúmulos: </span>
<span class="sd">        - &#39;Matriz Cumulo Individual&#39;</span>
<span class="sd">        - &#39;Matriz Cumulo Contrato&#39;</span>
<span class="sd">        - &#39;Matriz Cumulo Excedente&#39;</span>
<span class="sd">    campo_cumulo : str</span>
<span class="sd">        Tipo de cúmulo a aplicar. Puede tomar valores como:</span>
<span class="sd">        - &#39;RIESGO LIMITE INDIVIDUAL&#39;</span>
<span class="sd">        - &#39;RIESGO LIMITE CONTRATO&#39;</span>
<span class="sd">        - &#39;RIESGO RETENCION EXCEDENTE&#39;</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    pd.DataFrame</span>
<span class="sd">        DataFrame con la información actualizada según la aplicación</span>
<span class="sd">        de los cálculos de cúmulo. Se añaden (o modifican) columnas para </span>
<span class="sd">        reflejar el cúmulo, la retención o límite asociado, los porcentajes </span>
<span class="sd">        aplicados y el capital posterior al cálculo, entre otros campos.</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="c1"># Se obtienen las tablas con configuraciones de cúmulos de acuerdo con cada tipo.</span>
    <span class="n">cumulos_individuales</span> <span class="o">=</span> <span class="n">tables</span><span class="o">.</span><span class="n">get_table_xlsx</span><span class="p">(</span><span class="n">sheet_name</span><span class="o">=</span><span class="s1">&#39;Matriz Cumulo Individual&#39;</span><span class="p">)</span>
    <span class="n">cumulos_contrato</span> <span class="o">=</span> <span class="n">tables</span><span class="o">.</span><span class="n">get_table_xlsx</span><span class="p">(</span><span class="n">sheet_name</span><span class="o">=</span><span class="s1">&#39;Matriz Cumulo Contrato&#39;</span><span class="p">)</span>
    <span class="n">cumulos_excedente</span> <span class="o">=</span> <span class="n">tables</span><span class="o">.</span><span class="n">get_table_xlsx</span><span class="p">(</span><span class="n">sheet_name</span><span class="o">=</span><span class="s1">&#39;Matriz Cumulo Excedente&#39;</span><span class="p">)</span>

    <span class="c1"># Se recuperan algunos parámetros relevantes.</span>
    <span class="n">archivo_reporte</span><span class="p">:</span> <span class="n">Any</span> <span class="o">=</span> <span class="n">parameters</span><span class="o">.</span><span class="n">parameters</span><span class="p">[</span><span class="s1">&#39;archivo_reporte&#39;</span><span class="p">]</span>
    <span class="n">tipo_calculo</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="n">parameters</span><span class="o">.</span><span class="n">parameters</span><span class="p">[</span><span class="s1">&#39;tipo_calculo&#39;</span><span class="p">]</span>

    <span class="c1"># Diccionario que define los campos a utilizar dependiendo del tipo de cúmulo.</span>
    <span class="c1"># Índices:</span>
    <span class="c1">#   0: Nombre del campo de cúmulo total</span>
    <span class="c1">#   1: Nombre del campo de porcentaje</span>
    <span class="c1">#   2: Nombre del campo de retención o límite</span>
    <span class="c1">#   3: Tabla con los valores de retenciones o límites</span>
    <span class="c1">#   4: Campo base para el cálculo de montos asegurados</span>
    <span class="c1">#   5: Campo resultante después de aplicar límite o retención</span>
    <span class="c1">#   6: Campo de cúmulo de pagados (aplica para siniestros)</span>
    <span class="n">diccionario_cumulos</span> <span class="o">=</span> <span class="p">{</span>
        <span class="s1">&#39;RIESGO LIMITE INDIVIDUAL&#39;</span><span class="p">:</span> <span class="p">[</span>
            <span class="s1">&#39;CUMULO LIMITE INDIVIDUAL&#39;</span><span class="p">,</span>
            <span class="s1">&#39;PORCENTAJE LIMITE INDIVIDUAL&#39;</span><span class="p">,</span>
            <span class="s1">&#39;LIMITE INDIVIDUAL&#39;</span><span class="p">,</span>
            <span class="n">cumulos_individuales</span><span class="p">,</span>
            <span class="s1">&#39;MONTO ASEGURADO&#39;</span><span class="p">,</span>
            <span class="s1">&#39;CAPITAL POST LIMITE INDIVIDUAL&#39;</span><span class="p">,</span>
            <span class="s1">&#39;CUMULO PAGADOS LIMITE INDIVIDUAL&#39;</span>
        <span class="p">],</span>
        <span class="s1">&#39;RIESGO LIMITE CONTRATO&#39;</span><span class="p">:</span> <span class="p">[</span>
            <span class="s1">&#39;CUMULO LIMITE CONTRATO&#39;</span><span class="p">,</span>
            <span class="s1">&#39;PORCENTAJE LIMITE CONTRATO&#39;</span><span class="p">,</span>
            <span class="s1">&#39;LIMITE CONTRATO&#39;</span><span class="p">,</span>
            <span class="n">cumulos_contrato</span><span class="p">,</span>
            <span class="s1">&#39;CAPITAL POST LIMITE INDIVIDUAL&#39;</span><span class="p">,</span>
            <span class="s1">&#39;CAPITAL POST LIMITE CONTRATO&#39;</span><span class="p">,</span>
            <span class="s1">&#39;CUMULO PAGADOS LIMITE CONTRATO&#39;</span>
        <span class="p">],</span>
        <span class="s1">&#39;RIESGO RETENCION EXCEDENTE&#39;</span><span class="p">:</span> <span class="p">[</span>
            <span class="s1">&#39;CUMULO RETENCION EXCEDENTE&#39;</span><span class="p">,</span>
            <span class="s1">&#39;PORCENTAJE RETENCION EXCEDENTE&#39;</span><span class="p">,</span>
            <span class="s1">&#39;RETENCION EXCEDENTE&#39;</span><span class="p">,</span>
            <span class="n">cumulos_excedente</span><span class="p">,</span>
            <span class="s1">&#39;CAPITAL POST LIMITE CONTRATO&#39;</span><span class="p">,</span>
            <span class="s1">&#39;CAPITAL RETENIDO POST EXCEDENTE&#39;</span><span class="p">,</span>
            <span class="s1">&#39;CUMULO PAGADOS RETENCION EXCEDENTE&#39;</span>
        <span class="p">],</span>
    <span class="p">}</span>

    <span class="c1"># Se registra el inicio del proceso de cálculo de cúmulos.</span>
    <span class="n">escribe_reporta</span><span class="p">(</span>
        <span class="n">archivo_reporte</span><span class="p">,</span>
        <span class="s1">&#39;Comienza proceso de calculo de cumulos del tipo </span><span class="si">{}</span><span class="s1">:</span><span class="se">\n</span><span class="si">{}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
            <span class="n">campo_cumulo</span><span class="p">,</span>
            <span class="n">time</span><span class="o">.</span><span class="n">strftime</span><span class="p">(</span><span class="s1">&#39;%Y-%m-</span><span class="si">%d</span><span class="s1"> %H:%M:%S&#39;</span><span class="p">,</span> <span class="n">time</span><span class="o">.</span><span class="n">localtime</span><span class="p">(</span><span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()))</span>
        <span class="p">)</span>
    <span class="p">)</span>

    <span class="c1"># Se selecciona la tabla correspondiente al tipo de cúmulo especificado.</span>
    <span class="n">tabla_cumulos</span> <span class="o">=</span> <span class="n">diccionario_cumulos</span><span class="p">[</span><span class="n">campo_cumulo</span><span class="p">][</span><span class="mi">3</span><span class="p">]</span>

    <span class="c1"># Validación: se verifica que los campos requeridos existan en el DataFrame.</span>
    <span class="k">for</span> <span class="n">campo</span> <span class="ow">in</span> <span class="p">[</span><span class="n">campo_cumulo</span><span class="p">,</span> <span class="n">diccionario_cumulos</span><span class="p">[</span><span class="n">campo_cumulo</span><span class="p">][</span><span class="mi">4</span><span class="p">]]:</span>
        <span class="k">if</span> <span class="n">campo</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">df</span><span class="o">.</span><span class="n">columns</span><span class="p">:</span>
            <span class="n">escribe_reporta</span><span class="p">(</span>
                <span class="n">archivo_reporte</span><span class="p">,</span>
                <span class="s1">&#39;El campo </span><span class="si">{}</span><span class="s1"> no se encuentra dentro del dataframe&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">campo</span><span class="p">)</span>
            <span class="p">)</span>

    <span class="c1"># Se filtran los registros que no requieren ser acumulados (campo_cumulo nulo).</span>
    <span class="n">df_inicial</span> <span class="o">=</span> <span class="n">df</span><span class="p">[</span><span class="n">df</span><span class="p">[</span><span class="n">campo_cumulo</span><span class="p">]</span><span class="o">.</span><span class="n">isnull</span><span class="p">()]</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>

    <span class="c1"># Se inicializan campos para el DataFrame con valores por defecto.</span>
    <span class="n">df_inicial</span><span class="p">[</span><span class="s1">&#39;CUMULO&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">df_inicial</span><span class="p">[</span><span class="n">diccionario_cumulos</span><span class="p">[</span><span class="n">campo_cumulo</span><span class="p">][</span><span class="mi">4</span><span class="p">]]</span>
    <span class="n">df_inicial</span><span class="p">[</span><span class="s1">&#39;LIMITE O RETENCION&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">nan</span>

    <span class="c1"># Si se trata de siniestros, se calcula el cúmulo de pagados solo para los registros con estado &quot;PAGADO&quot;.</span>
    <span class="k">if</span> <span class="s1">&#39;Siniestro&#39;</span> <span class="ow">in</span> <span class="n">tipo_calculo</span><span class="p">:</span>
        <span class="n">df_inicial</span><span class="p">[</span><span class="s1">&#39;CUMULO_PAGADOS&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span>
            <span class="n">df_inicial</span><span class="p">[</span><span class="s1">&#39;ESTADO SINIESTRO&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;PAGADO&#39;</span><span class="p">,</span>
            <span class="n">df_inicial</span><span class="p">[</span><span class="n">diccionario_cumulos</span><span class="p">[</span><span class="n">campo_cumulo</span><span class="p">][</span><span class="mi">4</span><span class="p">]],</span>
            <span class="mi">0</span>
        <span class="p">)</span>

    <span class="n">df_inicial</span><span class="p">[</span><span class="s1">&#39;PORCENTAJE&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="mi">1</span>
    <span class="n">df_inicial</span><span class="p">[</span><span class="s1">&#39;CAPITAL POSTERIOR&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">df_inicial</span><span class="p">[</span><span class="n">diccionario_cumulos</span><span class="p">[</span><span class="n">campo_cumulo</span><span class="p">][</span><span class="mi">4</span><span class="p">]]</span>

    <span class="c1"># Por cada configuración en la tabla de cúmulos, se aplica la función `cumulo_riesgo`</span>
    <span class="c1"># y se concatenan los resultados al DataFrame inicial.</span>
    <span class="k">for</span> <span class="n">index</span><span class="p">,</span> <span class="n">row</span> <span class="ow">in</span> <span class="n">tabla_cumulos</span><span class="o">.</span><span class="n">iterrows</span><span class="p">():</span>
        <span class="n">df_agregar</span> <span class="o">=</span> <span class="n">cumulo_riesgo</span><span class="p">(</span>
            <span class="n">df</span><span class="p">,</span>
            <span class="n">parameters</span><span class="p">,</span>
            <span class="n">tables</span><span class="p">,</span>
            <span class="n">row</span><span class="p">[</span><span class="n">campo_cumulo</span><span class="p">],</span>
            <span class="n">row</span><span class="p">[</span><span class="s1">&#39;CAMPOS A ACUMULAR&#39;</span><span class="p">],</span>
            <span class="n">row</span><span class="p">[</span><span class="s1">&#39;LIMITE O RETENCION&#39;</span><span class="p">],</span>
            <span class="n">campo_cumulo</span><span class="p">,</span>
            <span class="n">diccionario_cumulos</span><span class="p">[</span><span class="n">campo_cumulo</span><span class="p">][</span><span class="mi">4</span><span class="p">]</span>
        <span class="p">)</span>
        <span class="n">df_inicial</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">concat</span><span class="p">([</span><span class="n">df_inicial</span><span class="p">,</span> <span class="n">df_agregar</span><span class="p">],</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>

    <span class="c1"># Se renombran las columnas para reflejar correctamente el tipo de cúmulo aplicado.</span>
    <span class="n">df_inicial</span><span class="o">.</span><span class="n">rename</span><span class="p">(</span>
        <span class="n">columns</span><span class="o">=</span><span class="p">{</span>
            <span class="s1">&#39;CUMULO&#39;</span><span class="p">:</span> <span class="n">diccionario_cumulos</span><span class="p">[</span><span class="n">campo_cumulo</span><span class="p">][</span><span class="mi">0</span><span class="p">],</span>
            <span class="s1">&#39;PORCENTAJE&#39;</span><span class="p">:</span> <span class="n">diccionario_cumulos</span><span class="p">[</span><span class="n">campo_cumulo</span><span class="p">][</span><span class="mi">1</span><span class="p">],</span>
            <span class="s1">&#39;LIMITE O RETENCION&#39;</span><span class="p">:</span> <span class="n">diccionario_cumulos</span><span class="p">[</span><span class="n">campo_cumulo</span><span class="p">][</span><span class="mi">2</span><span class="p">],</span>
            <span class="s1">&#39;CAPITAL POSTERIOR&#39;</span><span class="p">:</span> <span class="n">diccionario_cumulos</span><span class="p">[</span><span class="n">campo_cumulo</span><span class="p">][</span><span class="mi">5</span><span class="p">],</span>
            <span class="s1">&#39;CUMULO_PAGADOS&#39;</span><span class="p">:</span> <span class="n">diccionario_cumulos</span><span class="p">[</span><span class="n">campo_cumulo</span><span class="p">][</span><span class="mi">6</span><span class="p">]</span>
        <span class="p">},</span>
        <span class="n">inplace</span><span class="o">=</span><span class="kc">True</span>
    <span class="p">)</span>

    <span class="k">return</span> <span class="n">df_inicial</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>

<div class="doc doc-object doc-function">


<h2 id="S2_Funciones.ejecuta_query" class="doc doc-heading">
            <code class="highlight language-python"><span class="n">ejecuta_query</span><span class="p">(</span><span class="n">consulta</span><span class="p">,</span> <span class="n">periodo_inicio</span><span class="p">,</span> <span class="n">periodo_fin</span><span class="p">,</span> <span class="n">diccionario_querys</span><span class="p">,</span> <span class="n">parametros_split</span><span class="p">,</span> <span class="n">ruta_extensa</span><span class="p">,</span> <span class="n">name_file</span><span class="o">=</span><span class="kc">None</span><span class="p">)</span></code>

</h2>


    <div class="doc doc-contents ">

        <p>Ejecuta una query especifica</p>


<p><span class="doc-section-title">Parameters:</span></p>
    <table>
      <thead>
        <tr>
          <th>Name</th>
          <th>Type</th>
          <th>Description</th>
          <th>Default</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
                <code>consulta</code>
            </td>
            <td>
                  <code>str</code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>nombre de la consulta a ejecutar</p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>periodo_inicio</code>
            </td>
            <td>
                  <code>int</code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Periodo donde inicia la consulta, en caso de ser necesario</p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>periodo_fin</code>
            </td>
            <td>
                  <code>int</code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Periodo donde termina la consulta, en caso de ser necesario</p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>diccionario_querys</code>
            </td>
            <td>
                  <code>dict[str, <span title="typing.Any">Any</span>]</code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Diccionario que contiene toda la informacion relevante de todas las consultas que vamos a ejecutar</p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>parametros_split</code>
            </td>
            <td>
                  <code><span title="pandas.DataFrame">DataFrame</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Cuando una query requiere ser aperturada, este dataframe tiene la informacion que necesitamos</p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>ruta_extensa</code>
            </td>
            <td>
                  <code>str</code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>agregado a la ruta de exportacion</p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>name_file</code>
            </td>
            <td>
                  <code>str</code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Nombre, by default None</p>
              </div>
            </td>
            <td>
                  <code>None</code>
            </td>
          </tr>
      </tbody>
    </table>

            <details class="quote">
              <summary>Source code in <code>S2_Funciones.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">1147</span>
<span class="normal">1148</span>
<span class="normal">1149</span>
<span class="normal">1150</span>
<span class="normal">1151</span>
<span class="normal">1152</span>
<span class="normal">1153</span>
<span class="normal">1154</span>
<span class="normal">1155</span>
<span class="normal">1156</span>
<span class="normal">1157</span>
<span class="normal">1158</span>
<span class="normal">1159</span>
<span class="normal">1160</span>
<span class="normal">1161</span>
<span class="normal">1162</span>
<span class="normal">1163</span>
<span class="normal">1164</span>
<span class="normal">1165</span>
<span class="normal">1166</span>
<span class="normal">1167</span>
<span class="normal">1168</span>
<span class="normal">1169</span>
<span class="normal">1170</span>
<span class="normal">1171</span>
<span class="normal">1172</span>
<span class="normal">1173</span>
<span class="normal">1174</span>
<span class="normal">1175</span>
<span class="normal">1176</span>
<span class="normal">1177</span>
<span class="normal">1178</span>
<span class="normal">1179</span>
<span class="normal">1180</span>
<span class="normal">1181</span>
<span class="normal">1182</span>
<span class="normal">1183</span>
<span class="normal">1184</span>
<span class="normal">1185</span>
<span class="normal">1186</span>
<span class="normal">1187</span>
<span class="normal">1188</span>
<span class="normal">1189</span>
<span class="normal">1190</span>
<span class="normal">1191</span>
<span class="normal">1192</span>
<span class="normal">1193</span>
<span class="normal">1194</span>
<span class="normal">1195</span>
<span class="normal">1196</span>
<span class="normal">1197</span>
<span class="normal">1198</span>
<span class="normal">1199</span>
<span class="normal">1200</span>
<span class="normal">1201</span>
<span class="normal">1202</span>
<span class="normal">1203</span>
<span class="normal">1204</span>
<span class="normal">1205</span>
<span class="normal">1206</span>
<span class="normal">1207</span>
<span class="normal">1208</span>
<span class="normal">1209</span>
<span class="normal">1210</span>
<span class="normal">1211</span>
<span class="normal">1212</span>
<span class="normal">1213</span>
<span class="normal">1214</span>
<span class="normal">1215</span>
<span class="normal">1216</span>
<span class="normal">1217</span>
<span class="normal">1218</span>
<span class="normal">1219</span>
<span class="normal">1220</span>
<span class="normal">1221</span>
<span class="normal">1222</span>
<span class="normal">1223</span>
<span class="normal">1224</span>
<span class="normal">1225</span>
<span class="normal">1226</span>
<span class="normal">1227</span>
<span class="normal">1228</span>
<span class="normal">1229</span>
<span class="normal">1230</span>
<span class="normal">1231</span>
<span class="normal">1232</span>
<span class="normal">1233</span>
<span class="normal">1234</span>
<span class="normal">1235</span>
<span class="normal">1236</span>
<span class="normal">1237</span>
<span class="normal">1238</span>
<span class="normal">1239</span>
<span class="normal">1240</span>
<span class="normal">1241</span>
<span class="normal">1242</span>
<span class="normal">1243</span>
<span class="normal">1244</span>
<span class="normal">1245</span>
<span class="normal">1246</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span> <span class="nf">ejecuta_query</span><span class="p">(</span><span class="n">consulta</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">periodo_inicio</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span> <span class="n">periodo_fin</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span> <span class="n">diccionario_querys</span><span class="p">:</span> <span class="nb">dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span><span class="n">Any</span><span class="p">],</span> <span class="n">parametros_split</span><span class="p">:</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">,</span> <span class="n">ruta_extensa</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span><span class="n">name_file</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="kc">None</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Ejecuta una query especifica</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    consulta : str</span>
<span class="sd">        nombre de la consulta a ejecutar</span>
<span class="sd">    periodo_inicio : int</span>
<span class="sd">        Periodo donde inicia la consulta, en caso de ser necesario</span>
<span class="sd">    periodo_fin : int</span>
<span class="sd">        Periodo donde termina la consulta, en caso de ser necesario</span>
<span class="sd">    diccionario_querys : dict[str,Any]</span>
<span class="sd">        Diccionario que contiene toda la informacion relevante de todas las consultas que vamos a ejecutar</span>
<span class="sd">    parametros_split : pd.DataFrame</span>
<span class="sd">        Cuando una query requiere ser aperturada, este dataframe tiene la informacion que necesitamos</span>
<span class="sd">    ruta_extensa : str</span>
<span class="sd">        agregado a la ruta de exportacion</span>
<span class="sd">    name_file : str, optional</span>
<span class="sd">        Nombre, by default None</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="c1"># Tiempo inicial</span>
    <span class="n">start_time</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span>

    <span class="c1"># Mostramos en pantalla que query estamos realizando</span>
    <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Realizando consulta </span><span class="si">{}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">consulta</span><span class="p">))</span>

    <span class="c1"># Calculos sobre el diccionario de contratos</span>
    <span class="n">columnas</span><span class="o">=</span><span class="n">diccionario_querys</span><span class="p">[</span><span class="s1">&#39;CAMPOS QUERY&#39;</span><span class="p">][</span><span class="n">consulta</span><span class="p">]</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;,&#39;</span><span class="p">)</span>
    <span class="n">cols_date</span> <span class="o">=</span> <span class="n">diccionario_querys</span><span class="p">[</span><span class="s1">&#39;CAMPOS FECHAS&#39;</span><span class="p">][</span><span class="n">consulta</span><span class="p">]</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;,&#39;</span><span class="p">)</span> <span class="k">if</span> <span class="n">diccionario_querys</span><span class="p">[</span><span class="s1">&#39;CAMPOS FECHAS&#39;</span><span class="p">][</span><span class="n">consulta</span><span class="p">]</span> <span class="k">else</span> <span class="p">[]</span>
    <span class="n">sistema</span><span class="o">=</span><span class="n">diccionario_querys</span><span class="p">[</span><span class="s1">&#39;SISTEMA&#39;</span><span class="p">][</span><span class="n">consulta</span><span class="p">]</span>
    <span class="n">desfase_meses</span><span class="o">=</span><span class="n">diccionario_querys</span><span class="p">[</span><span class="s1">&#39;DESFASE&#39;</span><span class="p">][</span><span class="n">consulta</span><span class="p">]</span>
    <span class="n">tipo_exportar</span><span class="o">=</span><span class="n">diccionario_querys</span><span class="p">[</span><span class="s1">&#39;TIPO EXPORTAR&#39;</span><span class="p">][</span><span class="n">consulta</span><span class="p">]</span>
    <span class="n">carpeta</span><span class="o">=</span><span class="n">diccionario_querys</span><span class="p">[</span><span class="s1">&#39;CARPETA&#39;</span><span class="p">][</span><span class="n">consulta</span><span class="p">]</span>
    <span class="n">subcarpeta</span><span class="o">=</span><span class="n">diccionario_querys</span><span class="p">[</span><span class="s1">&#39;SUBCARPETA&#39;</span><span class="p">][</span><span class="n">consulta</span><span class="p">]</span>
    <span class="n">tipo_calculo</span><span class="o">=</span><span class="n">diccionario_querys</span><span class="p">[</span><span class="s1">&#39;TIPO CALCULO&#39;</span><span class="p">][</span><span class="n">consulta</span><span class="p">]</span>

    <span class="c1"># Calculo de fechas y periodos y otros parametros</span>
    <span class="n">fecha_inicio</span><span class="o">=</span><span class="n">datetime</span><span class="o">.</span><span class="n">datetime</span><span class="p">(</span><span class="nb">int</span><span class="p">(</span><span class="n">periodo_inicio</span><span class="o">/</span><span class="mi">100</span><span class="p">),</span><span class="n">periodo_inicio</span><span class="o">%</span><span class="mi">100</span><span class="p">,</span><span class="mi">1</span><span class="p">)</span>
    <span class="n">fecha_inicio</span><span class="o">=</span><span class="n">fecha_inicio</span><span class="o">-</span><span class="n">pd</span><span class="o">.</span><span class="n">offsets</span><span class="o">.</span><span class="n">MonthEnd</span><span class="p">(</span><span class="n">desfase_meses</span><span class="o">+</span><span class="mi">1</span><span class="p">)</span><span class="o">+</span><span class="n">datetime</span><span class="o">.</span><span class="n">timedelta</span><span class="p">(</span><span class="n">days</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
    <span class="n">fecha_fin</span><span class="o">=</span><span class="n">datetime</span><span class="o">.</span><span class="n">datetime</span><span class="p">(</span><span class="nb">int</span><span class="p">(</span><span class="n">periodo_fin</span><span class="o">/</span><span class="mi">100</span><span class="p">),</span><span class="n">periodo_fin</span><span class="o">%</span><span class="mi">100</span><span class="p">,</span><span class="mi">1</span><span class="p">)</span>
    <span class="n">fecha_fin</span><span class="o">=</span><span class="n">fecha_fin</span><span class="o">-</span><span class="n">pd</span><span class="o">.</span><span class="n">offsets</span><span class="o">.</span><span class="n">MonthEnd</span><span class="p">(</span><span class="n">desfase_meses</span><span class="p">)</span>
    <span class="n">periodo_fin</span><span class="o">=</span><span class="n">fecha_fin</span><span class="o">.</span><span class="n">year</span><span class="o">*</span><span class="mi">100</span><span class="o">+</span><span class="n">fecha_fin</span><span class="o">.</span><span class="n">month</span>
    <span class="n">periodo_inicio</span><span class="o">=</span><span class="n">fecha_inicio</span><span class="o">.</span><span class="n">year</span><span class="o">*</span><span class="mi">100</span><span class="o">+</span><span class="n">fecha_inicio</span><span class="o">.</span><span class="n">month</span>
    <span class="k">if</span> <span class="n">carpeta</span><span class="p">:</span> <span class="n">ruta_exportar_query</span><span class="o">=</span><span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">ruta_extensa</span><span class="si">}</span><span class="s1">1 Input</span><span class="se">\\</span><span class="si">{</span><span class="n">tipo_calculo</span><span class="si">}</span><span class="se">\\</span><span class="si">{</span><span class="n">subcarpeta</span><span class="si">}</span><span class="se">\\</span><span class="si">{</span><span class="n">carpeta</span><span class="si">}</span><span class="se">\\</span><span class="s1">&#39;</span>
    <span class="k">else</span><span class="p">:</span> <span class="n">ruta_exportar_query</span><span class="o">=</span><span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">ruta_extensa</span><span class="si">}</span><span class="s1">1 Input</span><span class="se">\\</span><span class="si">{</span><span class="n">tipo_calculo</span><span class="si">}</span><span class="se">\\</span><span class="si">{</span><span class="n">subcarpeta</span><span class="si">}</span><span class="se">\\</span><span class="s1">&#39;</span>
    <span class="c1"># Traemos el archivo de la query</span>
    <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">ruta_extensa</span><span class="o">+</span><span class="s1">&#39;0 Querys Automaticas</span><span class="se">\\</span><span class="s1">&#39;</span><span class="o">+</span><span class="n">consulta</span><span class="o">+</span><span class="s1">&#39;.sql&#39;</span><span class="p">,</span> <span class="s1">&#39;r&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">query_txt</span><span class="p">:</span> <span class="n">query</span> <span class="o">=</span> <span class="n">query_txt</span><span class="o">.</span><span class="n">read</span><span class="p">()</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">,</span><span class="s1">&#39; &#39;</span><span class="p">)</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s1">&#39;fecha_inicio&#39;</span><span class="p">,</span><span class="nb">str</span><span class="p">(</span><span class="n">fecha_inicio</span><span class="p">)[</span><span class="mi">0</span><span class="p">:</span><span class="mi">10</span><span class="p">])</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s1">&#39;fecha_fin&#39;</span><span class="p">,</span><span class="nb">str</span><span class="p">(</span><span class="n">fecha_fin</span><span class="p">)[</span><span class="mi">0</span><span class="p">:</span><span class="mi">10</span><span class="p">])</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s1">&#39;periodo_fin&#39;</span><span class="p">,</span><span class="nb">str</span><span class="p">(</span><span class="n">periodo_fin</span><span class="p">)[</span><span class="mi">0</span><span class="p">:</span><span class="mi">10</span><span class="p">])</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s1">&#39;año_proceso&#39;</span><span class="p">,</span><span class="nb">str</span><span class="p">(</span><span class="n">fecha_fin</span><span class="o">.</span><span class="n">year</span><span class="p">))</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s1">&#39;mes_proceso&#39;</span><span class="p">,</span><span class="nb">str</span><span class="p">(</span><span class="n">fecha_fin</span><span class="o">.</span><span class="n">month</span><span class="p">))</span>

    <span class="c1"># Conexion sql</span>
    <span class="k">if</span> <span class="n">sistema</span><span class="o">==</span><span class="s1">&#39;GES&#39;</span><span class="p">:</span> <span class="n">connection</span> <span class="o">=</span> <span class="n">cx_Oracle</span><span class="o">.</span><span class="n">connect</span><span class="p">(</span><span class="n">user</span><span class="o">=</span><span class="s2">&quot;USU_BCATALDO&quot;</span><span class="p">,</span> <span class="n">password</span><span class="o">=</span><span class="s2">&quot;SAmu3l.20204*&quot;</span><span class="p">,</span><span class="n">dsn</span><span class="o">=</span><span class="s2">&quot;prod_zs.santanderseguros.cl.bsch:1526/gesvida&quot;</span><span class="p">,</span><span class="n">encoding</span><span class="o">=</span><span class="s2">&quot;UTF-8&quot;</span><span class="p">)</span>
    <span class="c1"># if sistema==&#39;GES&#39;: connection = cx_Oracle.connect(user=&quot;USU_SLABRIN&quot;, password=&quot;ZS_3Ngreso&quot;,dsn=&quot;prod_zs.santanderseguros.cl.bsch:1526/gesvida&quot;,encoding=&quot;UTF-8&quot;)</span>
    <span class="c1"># if sistema==&#39;GES&#39;: connection = cx_Oracle.connect(user=&quot;USU_JTOBAR&quot;, password=&quot;31415Fermat&quot;,dsn=&quot;prod_zs.santanderseguros.cl.bsch:1526/gesvida&quot;,encoding=&quot;UTF-8&quot;)</span>
    <span class="c1"># if sistema==&#39;GES&#39;: connection = oracledb.connect(user=&quot;USU_JTOBAR&quot;, password=&quot;31415Fermat&quot;,dsn=&quot;prod_zs.santanderseguros.cl.bsch:1526/gesvida&quot;)</span>
    <span class="c1"># if sistema==&#39;GES&#39;: connection = cx_Oracle.connect(user=&quot;USU_YDAVILA&quot;, password=&quot;Actuarial7777!&quot;,dsn=&quot;prod_zs.santanderseguros.cl.bsch:1526/gesvida&quot;,encoding=&quot;UTF-8&quot;)</span>
    <span class="k">if</span> <span class="n">sistema</span><span class="o">==</span><span class="s1">&#39;IAXIS&#39;</span><span class="p">:</span><span class="n">connection</span> <span class="o">=</span> <span class="n">cx_Oracle</span><span class="o">.</span><span class="n">connect</span><span class="p">(</span><span class="n">user</span><span class="o">=</span><span class="s2">&quot;USR_ZS_BCATALDO&quot;</span><span class="p">,</span> <span class="n">password</span><span class="o">=</span><span class="s2">&quot;SAturn0.20204*&quot;</span><span class="p">,</span><span class="n">dsn</span><span class="o">=</span><span class="s2">&quot;zsiaxisbd.santanderseguros.cl.bsch:1521/praxis&quot;</span><span class="p">,</span><span class="n">encoding</span><span class="o">=</span><span class="s2">&quot;UTF-8&quot;</span><span class="p">)</span>    
    <span class="c1"># if sistema==&#39;IAXIS&#39;:connection = oracledb.connect(user=&quot;USR_ZS_BCATALDO&quot;, password=&quot;Inicio_01&quot;,dsn=&quot;zsiaxisbd.santanderseguros.cl.bsch:1521/praxis&quot;)    </span>
    <span class="k">if</span> <span class="n">sistema</span><span class="o">==</span><span class="s1">&#39;IAXIS TEST&#39;</span><span class="p">:</span><span class="n">connection</span> <span class="o">=</span> <span class="n">cx_Oracle</span><span class="o">.</span><span class="n">connect</span><span class="p">(</span><span class="n">user</span><span class="o">=</span><span class="s2">&quot;AXIS_D401&quot;</span><span class="p">,</span> <span class="n">password</span><span class="o">=</span><span class="s2">&quot;F|=fX10JZ{p9&quot;</span><span class="p">,</span><span class="n">dsn</span><span class="o">=</span><span class="s2">&quot;180.153.43.74:1521/praxis_predb&quot;</span><span class="p">,</span><span class="n">encoding</span><span class="o">=</span><span class="s2">&quot;UTF-8&quot;</span><span class="p">)</span>    
    <span class="c1"># Lectura de datos y pasamos a dataframe</span>
    <span class="n">cursor</span> <span class="o">=</span> <span class="n">connection</span><span class="o">.</span><span class="n">cursor</span><span class="p">()</span>
    <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Ejecutando query&#39;</span><span class="p">)</span>
    <span class="n">cursor</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="n">query</span><span class="p">)</span>
    <span class="c1"># cursor.execute(&quot;select t.aserut rut from altavida.t0058 t where rownum&lt;100&quot;)</span>
    <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Pegando resultados de la query&#39;</span><span class="p">)</span>
    <span class="n">resultado_query</span> <span class="o">=</span> <span class="n">cursor</span><span class="o">.</span><span class="n">fetchall</span><span class="p">()</span>
    <span class="n">df</span><span class="o">=</span><span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="nb">list</span><span class="p">(</span><span class="n">resultado_query</span><span class="p">))</span>
    <span class="k">if</span> <span class="n">df</span><span class="o">.</span><span class="n">empty</span><span class="p">:</span> 
        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;La consulta - </span><span class="si">{</span><span class="n">consulta</span><span class="si">}</span><span class="s1"> - arrojó 0 registros como resultado. REVISAR!&#39;</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">name_file</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">archivo_reporte_global</span><span class="o">=</span><span class="nb">open</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">ruta_extensa</span><span class="si">}</span><span class="s1">4 Reportes del Proceso</span><span class="se">\\</span><span class="s1">Reporte Proceso Cierre </span><span class="si">{</span><span class="n">name_file</span><span class="si">}</span><span class="s1">.txt&#39;</span><span class="p">,</span><span class="s1">&#39;a&#39;</span><span class="p">)</span>
            <span class="n">archivo_reporte_global</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">time</span><span class="o">.</span><span class="n">strftime</span><span class="p">(</span><span class="s2">&quot;%Y-%m-</span><span class="si">%d</span><span class="s2"> %H:%M:%S&quot;</span><span class="p">,</span><span class="w"> </span><span class="n">time</span><span class="o">.</span><span class="n">localtime</span><span class="p">(</span><span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()))</span><span class="si">}</span><span class="s1"> - Se ejecutó query </span><span class="si">{</span><span class="n">consulta</span><span class="si">}</span><span class="s1">, pero el resultado arrojó una respuesta vacia. REVISAR!</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">)</span>
            <span class="n">archivo_reporte_global</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
        <span class="k">return</span>
    <span class="n">df</span><span class="o">.</span><span class="n">columns</span><span class="o">=</span><span class="n">columnas</span>
    <span class="c1"># Conversión a fechas de las columnas</span>
    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">cols_date</span><span class="p">)</span><span class="o">&gt;</span><span class="mi">0</span><span class="p">:</span>    
        <span class="k">for</span> <span class="n">col</span> <span class="ow">in</span> <span class="n">cols_date</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">df</span><span class="p">[</span><span class="n">col</span><span class="p">]</span><span class="o">.</span><span class="n">dtype</span><span class="o">==</span><span class="nb">object</span><span class="p">:</span> <span class="n">df</span><span class="p">[</span><span class="n">col</span><span class="p">]</span><span class="o">=</span><span class="n">pd</span><span class="o">.</span><span class="n">to_datetime</span><span class="p">(</span><span class="n">df</span><span class="p">[</span><span class="n">col</span><span class="p">],</span><span class="nb">format</span><span class="o">=</span><span class="s1">&#39;%Y-%m-</span><span class="si">%d</span><span class="s1">&#39;</span><span class="p">,</span> <span class="n">errors</span><span class="o">=</span><span class="s1">&#39;coerce&#39;</span><span class="p">)</span>

    <span class="c1"># Exportamos la data</span>
    <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Exportando datos de la query. La consulta tiene </span><span class="si">{}</span><span class="s1"> registros&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">df</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]))</span>

    <span class="k">if</span> <span class="n">tipo_exportar</span><span class="o">==</span><span class="s1">&#39;historico&#39;</span><span class="p">:</span><span class="n">terminacion_archivo</span><span class="o">=</span><span class="s1">&#39;.txt&#39;</span> 
    <span class="k">if</span> <span class="p">(</span><span class="n">tipo_exportar</span><span class="o">==</span><span class="s1">&#39;periodo&#39;</span><span class="p">)</span><span class="o">&amp;</span><span class="p">(</span><span class="n">periodo_fin</span><span class="o">==</span><span class="n">periodo_inicio</span><span class="p">):</span><span class="n">terminacion_archivo</span><span class="o">=</span><span class="s1">&#39; &#39;</span><span class="o">+</span><span class="nb">str</span><span class="p">(</span><span class="n">periodo_fin</span><span class="p">)</span><span class="o">+</span><span class="s1">&#39;.txt&#39;</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">tipo_exportar</span><span class="o">==</span><span class="s1">&#39;periodo&#39;</span><span class="p">)</span><span class="o">&amp;</span><span class="p">(</span><span class="n">periodo_fin</span><span class="o">!=</span><span class="n">periodo_inicio</span><span class="p">):</span><span class="n">terminacion_archivo</span><span class="o">=</span><span class="s1">&#39; &#39;</span><span class="o">+</span><span class="nb">str</span><span class="p">(</span><span class="n">periodo_inicio</span><span class="p">)</span><span class="o">+</span><span class="s1">&#39;-&#39;</span><span class="o">+</span><span class="nb">str</span><span class="p">(</span><span class="n">periodo_fin</span><span class="p">)</span><span class="o">+</span><span class="s1">&#39;.txt&#39;</span>
    <span class="k">if</span> <span class="n">tipo_exportar</span><span class="o">==</span><span class="s1">&#39;fecha&#39;</span><span class="p">:</span><span class="n">terminacion_archivo</span><span class="o">=</span><span class="s1">&#39; (&#39;</span><span class="o">+</span><span class="nb">str</span><span class="p">(</span><span class="n">datetime</span><span class="o">.</span><span class="n">datetime</span><span class="o">.</span><span class="n">now</span><span class="p">())[</span><span class="mi">0</span><span class="p">:</span><span class="mi">10</span><span class="p">]</span><span class="o">+</span><span class="s1">&#39;).txt&#39;</span>
    <span class="n">nombre_archivo_salida</span><span class="o">=</span><span class="n">consulta</span><span class="o">+</span><span class="n">terminacion_archivo</span>
    <span class="c1">######## DEBEMOS PEGAR DIRECTAMENTE EN LA RUTA QUE CORRESPONDE</span>
    <span class="c1">######## ADEMAS, DEBEMOS IMPORTAR EL SEPARADOR Y DECIMAL INPUT DE PARAMETROS PARA QUE COINCIDA CON LO QUE VAMOS A LEER EN EL CALCULO</span>
    <span class="k">if</span> <span class="n">carpeta</span><span class="p">:</span>
        <span class="n">Path</span><span class="p">(</span><span class="n">ruta_exportar_query</span><span class="p">)</span><span class="o">.</span><span class="n">mkdir</span><span class="p">(</span><span class="n">parents</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">exist_ok</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
        <span class="n">df</span><span class="o">.</span><span class="n">to_csv</span><span class="p">(</span><span class="n">ruta_exportar_query</span><span class="o">+</span><span class="n">nombre_archivo_salida</span><span class="p">,</span><span class="n">sep</span><span class="o">=</span><span class="s1">&#39;;&#39;</span><span class="p">,</span><span class="n">decimal</span><span class="o">=</span><span class="s1">&#39;.&#39;</span><span class="p">,</span><span class="n">encoding</span><span class="o">=</span><span class="s1">&#39;UTF-8&#39;</span><span class="p">,</span><span class="n">date_format</span><span class="o">=</span><span class="s1">&#39;</span><span class="si">%d</span><span class="s1">-%m-%Y&#39;</span><span class="p">,</span><span class="n">index</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
    <span class="n">parametros_split_filter</span><span class="o">=</span><span class="n">parametros_split</span><span class="p">[</span><span class="n">parametros_split</span><span class="p">[</span><span class="s1">&#39;QUERY&#39;</span><span class="p">]</span><span class="o">==</span><span class="n">consulta</span><span class="p">]</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">parametros_split_filter</span><span class="o">.</span><span class="n">empty</span> <span class="p">:</span> <span class="n">split_querys</span><span class="p">(</span><span class="n">df</span><span class="p">,</span><span class="n">parametros_split_filter</span><span class="p">,</span><span class="n">ruta_exportar_query</span><span class="p">,</span><span class="n">terminacion_archivo</span><span class="p">,</span><span class="n">sistema</span><span class="p">)</span>
    <span class="c1"># Mido tiempo de ejecucion</span>
    <span class="n">total_time</span> <span class="o">=</span> <span class="nb">round</span><span class="p">((</span><span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span><span class="o">-</span><span class="n">start_time</span><span class="p">)</span><span class="o">/</span><span class="mi">60</span><span class="p">,</span> <span class="mi">2</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;El tiempo total de ejecución fue de </span><span class="si">%s</span><span class="s1"> minutos&#39;</span> <span class="o">%</span> <span class="n">total_time</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">name_file</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">archivo_reporte_global</span><span class="o">=</span><span class="nb">open</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">ruta_extensa</span><span class="si">}</span><span class="s1">4 Reportes del Proceso</span><span class="se">\\</span><span class="s1">Reporte Proceso Cierre </span><span class="si">{</span><span class="n">name_file</span><span class="si">}</span><span class="s1">.txt&#39;</span><span class="p">,</span><span class="s1">&#39;a&#39;</span><span class="p">)</span>
        <span class="n">archivo_reporte_global</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">time</span><span class="o">.</span><span class="n">strftime</span><span class="p">(</span><span class="s2">&quot;%Y-%m-</span><span class="si">%d</span><span class="s2"> %H:%M:%S&quot;</span><span class="p">,</span><span class="w"> </span><span class="n">time</span><span class="o">.</span><span class="n">localtime</span><span class="p">(</span><span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()))</span><span class="si">}</span><span class="s1"> - Se ejecutó query </span><span class="si">{</span><span class="n">consulta</span><span class="si">}</span><span class="s1"> </span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">)</span>
        <span class="n">archivo_reporte_global</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>

<div class="doc doc-object doc-function">


<h2 id="S2_Funciones.escribe_reporta" class="doc doc-heading">
            <code class="highlight language-python"><span class="n">escribe_reporta</span><span class="p">(</span><span class="n">reporte</span><span class="p">,</span> <span class="n">texto</span><span class="p">)</span></code>

</h2>


    <div class="doc doc-contents ">

        <p>Escribe en un archivo txt, que ya debe venir abierto previamente el texto que le indiquemos</p>


<p><span class="doc-section-title">Parameters:</span></p>
    <table>
      <thead>
        <tr>
          <th>Name</th>
          <th>Type</th>
          <th>Description</th>
          <th>Default</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
                <code>reporte</code>
            </td>
            <td>
                  <code>archivo txt</code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>es el archivo donde escribiremos la informacion a reportar</p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>texto</code>
            </td>
            <td>
                  <code>string</code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>contiene el texto a escribir</p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
      </tbody>
    </table>

            <details class="quote">
              <summary>Source code in <code>S2_Funciones.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">18</span>
<span class="normal">19</span>
<span class="normal">20</span>
<span class="normal">21</span>
<span class="normal">22</span>
<span class="normal">23</span>
<span class="normal">24</span>
<span class="normal">25</span>
<span class="normal">26</span>
<span class="normal">27</span>
<span class="normal">28</span>
<span class="normal">29</span>
<span class="normal">30</span>
<span class="normal">31</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span> <span class="nf">escribe_reporta</span><span class="p">(</span><span class="n">reporte</span><span class="p">:</span> <span class="n">TextIO</span><span class="p">,</span><span class="n">texto</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Escribe en un archivo txt, que ya debe venir abierto previamente el texto que le indiquemos</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    reporte : archivo txt</span>
<span class="sd">        es el archivo donde escribiremos la informacion a reportar</span>
<span class="sd">    texto : string</span>
<span class="sd">        contiene el texto a escribir</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">reporte</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">texto</span><span class="p">)</span>
    <span class="n">reporte</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">)</span>
    <span class="c1"># Igualmente mostramos en pantalla lo que escribiremos en el reporte</span>
    <span class="nb">print</span><span class="p">(</span><span class="n">texto</span><span class="p">)</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>

<div class="doc doc-object doc-function">


<h2 id="S2_Funciones.filtra_una_combinacion" class="doc doc-heading">
            <code class="highlight language-python"><span class="n">filtra_una_combinacion</span><span class="p">(</span><span class="n">df</span><span class="p">,</span> <span class="n">lista_campos</span><span class="p">,</span> <span class="n">tabla_parametros</span><span class="p">,</span> <span class="n">combinacion</span><span class="p">,</span> <span class="n">cols_cruce</span><span class="p">)</span></code>

</h2>


    <div class="doc doc-contents ">

        <p>Funcion que filtra un dataframe de acuerdo a las caracteristicas de 1 tipo_calculo de reaseguro especificado
    Ademas, tiene la funcion de poder hacer un merge_asof cuando el tipo_calculo asignado para un producto cambia en el tiempo</p>

            <details class="quote">
              <summary>Source code in <code>S2_Funciones.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"> 50</span>
<span class="normal"> 51</span>
<span class="normal"> 52</span>
<span class="normal"> 53</span>
<span class="normal"> 54</span>
<span class="normal"> 55</span>
<span class="normal"> 56</span>
<span class="normal"> 57</span>
<span class="normal"> 58</span>
<span class="normal"> 59</span>
<span class="normal"> 60</span>
<span class="normal"> 61</span>
<span class="normal"> 62</span>
<span class="normal"> 63</span>
<span class="normal"> 64</span>
<span class="normal"> 65</span>
<span class="normal"> 66</span>
<span class="normal"> 67</span>
<span class="normal"> 68</span>
<span class="normal"> 69</span>
<span class="normal"> 70</span>
<span class="normal"> 71</span>
<span class="normal"> 72</span>
<span class="normal"> 73</span>
<span class="normal"> 74</span>
<span class="normal"> 75</span>
<span class="normal"> 76</span>
<span class="normal"> 77</span>
<span class="normal"> 78</span>
<span class="normal"> 79</span>
<span class="normal"> 80</span>
<span class="normal"> 81</span>
<span class="normal"> 82</span>
<span class="normal"> 83</span>
<span class="normal"> 84</span>
<span class="normal"> 85</span>
<span class="normal"> 86</span>
<span class="normal"> 87</span>
<span class="normal"> 88</span>
<span class="normal"> 89</span>
<span class="normal"> 90</span>
<span class="normal"> 91</span>
<span class="normal"> 92</span>
<span class="normal"> 93</span>
<span class="normal"> 94</span>
<span class="normal"> 95</span>
<span class="normal"> 96</span>
<span class="normal"> 97</span>
<span class="normal"> 98</span>
<span class="normal"> 99</span>
<span class="normal">100</span>
<span class="normal">101</span>
<span class="normal">102</span>
<span class="normal">103</span>
<span class="normal">104</span>
<span class="normal">105</span>
<span class="normal">106</span>
<span class="normal">107</span>
<span class="normal">108</span>
<span class="normal">109</span>
<span class="normal">110</span>
<span class="normal">111</span>
<span class="normal">112</span>
<span class="normal">113</span>
<span class="normal">114</span>
<span class="normal">115</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span> <span class="nf">filtra_una_combinacion</span><span class="p">(</span><span class="n">df</span><span class="p">:</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">,</span><span class="n">lista_campos</span><span class="p">:</span> <span class="nb">list</span><span class="p">[</span><span class="nb">str</span><span class="p">],</span><span class="n">tabla_parametros</span><span class="p">:</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">,</span><span class="n">combinacion</span><span class="p">:</span> <span class="nb">set</span><span class="p">[</span><span class="nb">str</span><span class="p">],</span><span class="n">cols_cruce</span><span class="p">:</span> <span class="nb">list</span><span class="p">[</span><span class="nb">str</span><span class="p">])</span> <span class="o">-&gt;</span> <span class="nb">tuple</span><span class="p">[</span><span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">,</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">,</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">]:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Funcion que filtra un dataframe de acuerdo a las caracteristicas de 1 tipo_calculo de reaseguro especificado</span>
<span class="sd">        Ademas, tiene la funcion de poder hacer un merge_asof cuando el tipo_calculo asignado para un producto cambia en el tiempo</span>
<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">        df : pd.DataFrame</span>
<span class="sd">        DataFrame</span>
<span class="sd">        El DataFrame que contiene los datos a filtrar.</span>
<span class="sd">        lista_campos : list[str]</span>
<span class="sd">        Lista de nombres de columnas en el DataFrame que se utilizarán para el filtrado.</span>
<span class="sd">        tabla_parametros : DataFrame</span>
<span class="sd">        DataFrame que contiene los parámetros de filtrado.</span>
<span class="sd">        combinacion : list[str]</span>
<span class="sd">        Lista de nombres de columnas que representan una combinación específica de valores para el filtrado.</span>
<span class="sd">        cols_cruce : list[str]</span>
<span class="sd">        Lista de nombres de columnas que se utilizarán para realizar el cruce entre el DataFrame y la tabla de parámetros.</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        tuple[DataFrame, DataFrame, DataFrame]</span>
<span class="sd">        Una tupla que contiene tres DataFrames:</span>
<span class="sd">        - El DataFrame filtrado que coincide con la combinación específica.</span>
<span class="sd">        - El DataFrame restante después de eliminar las filas filtradas.</span>
<span class="sd">        - La tabla de parámetros original.</span>
<span class="sd">        &quot;&quot;&quot;</span>
    <span class="c1"># * Calculos iniciales</span>
    <span class="c1"># df_filtrado que será el que se irá cruzando con la tabla de las asignaciones</span>
    <span class="n">df_filtrado</span><span class="p">:</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="o">=</span><span class="n">df</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
    <span class="c1"># Se guarda el indice para no perder el orden de los registros</span>
    <span class="n">df_filtrado</span><span class="p">[</span><span class="s1">&#39;INDICE&#39;</span><span class="p">]</span><span class="o">=</span><span class="n">df_filtrado</span><span class="o">.</span><span class="n">index</span>
    <span class="c1"># Tabla auxiliar que tendrá filtrado lo que vamos a cruzar</span>
    <span class="n">tabla_parametros_filtrada</span><span class="p">:</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="o">=</span><span class="n">tabla_parametros</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
    <span class="c1"># Combinacion de campos que vamos a utilizar para cruzar</span>
    <span class="n">combinacion_list</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">combinacion</span><span class="p">)</span>
    <span class="c1"># Campos que no vamos a cruzar</span>
    <span class="n">combi_out</span><span class="o">=</span><span class="nb">list</span><span class="p">(</span><span class="nb">set</span><span class="p">(</span><span class="n">lista_campos</span><span class="p">)</span><span class="o">.</span><span class="n">difference</span><span class="p">(</span><span class="n">combinacion_list</span><span class="p">))</span>
    <span class="n">tabla_parametros_filtrada</span> <span class="o">=</span> <span class="n">tabla_parametros_filtrada</span><span class="o">.</span><span class="n">dropna</span><span class="p">(</span><span class="n">subset</span><span class="o">=</span><span class="n">combinacion_list</span><span class="p">)</span> <span class="c1"># type: ignore</span>
    <span class="n">tabla_parametros_quitar</span><span class="p">:</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="o">=</span><span class="n">tabla_parametros_filtrada</span><span class="o">.</span><span class="n">dropna</span><span class="p">(</span><span class="n">subset</span><span class="o">=</span><span class="n">combi_out</span><span class="p">,</span><span class="n">how</span><span class="o">=</span><span class="s1">&#39;all&#39;</span><span class="p">)</span>
    <span class="n">tabla_parametros_filtrada</span><span class="o">=</span><span class="n">tabla_parametros_filtrada</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">tabla_parametros_filtrada</span><span class="o">.</span><span class="n">index</span><span class="o">.</span><span class="n">difference</span><span class="p">(</span><span class="n">tabla_parametros_quitar</span><span class="o">.</span><span class="n">index</span><span class="p">)]</span><span class="o">.</span><span class="n">reset_index</span><span class="p">(</span><span class="n">drop</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">tabla_parametros_filtrada</span><span class="o">.</span><span class="n">empty</span><span class="p">:</span> <span class="k">return</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(),</span><span class="n">df</span><span class="p">,</span><span class="n">tabla_parametros</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">tpf_sin_inicio</span><span class="p">:</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="o">=</span><span class="n">tabla_parametros_filtrada</span><span class="p">[</span><span class="n">tabla_parametros_filtrada</span><span class="p">[</span><span class="s1">&#39;INICIO DEL CONTRATO&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">isnull</span><span class="p">()]</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
        <span class="n">tpf_con_inicio</span><span class="p">:</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="o">=</span><span class="n">tabla_parametros_filtrada</span><span class="p">[</span><span class="o">~</span><span class="n">tabla_parametros_filtrada</span><span class="p">[</span><span class="s1">&#39;INICIO DEL CONTRATO&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">isnull</span><span class="p">()]</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
        <span class="c1"># Pregunta si necesitamos hacer un merge o merge_asof, en caso de tener cambio de contratos en el tiempo</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">tpf_sin_inicio</span><span class="o">.</span><span class="n">empty</span><span class="p">:</span> <span class="n">df_filtrado_sin_inicio</span><span class="o">=</span><span class="n">df_filtrado</span><span class="o">.</span><span class="n">merge</span><span class="p">(</span><span class="n">tpf_sin_inicio</span><span class="p">[</span><span class="n">combinacion_list</span><span class="o">+</span><span class="n">cols_cruce</span><span class="p">],</span><span class="n">how</span><span class="o">=</span><span class="s1">&#39;inner&#39;</span><span class="p">,</span><span class="n">on</span><span class="o">=</span><span class="n">combinacion_list</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span> <span class="n">df_filtrado_sin_inicio</span><span class="o">=</span><span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">()</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">tpf_con_inicio</span><span class="o">.</span><span class="n">empty</span><span class="p">:</span>
            <span class="n">tpf_con_inicio_unicos</span><span class="o">=</span><span class="n">tpf_con_inicio</span><span class="p">[</span><span class="n">combinacion_list</span><span class="p">]</span><span class="o">.</span><span class="n">drop_duplicates</span><span class="p">()</span>
            <span class="n">df_filtrado_con_inicio</span><span class="o">=</span><span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">()</span>
            <span class="c1"># Recorre el dataframe para cada registro de filtro que deba hacer, para ir concatenandolos en el df que necesitamos</span>
            <span class="k">for</span> <span class="n">index</span><span class="p">,</span> <span class="n">row</span> <span class="ow">in</span> <span class="n">tpf_con_inicio_unicos</span><span class="o">.</span><span class="n">iterrows</span><span class="p">():</span>
                <span class="n">lista_valores</span><span class="o">=</span><span class="nb">list</span><span class="p">(</span><span class="n">row</span><span class="p">)</span>
                <span class="n">df_filtrado_con_inicio_aux</span><span class="o">=</span><span class="n">df_filtrado</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
                <span class="n">tpf_con_inicio_filtrada</span><span class="o">=</span><span class="n">tpf_con_inicio</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
                <span class="k">for</span> <span class="n">col</span><span class="p">,</span><span class="n">valor</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">combinacion_list</span><span class="p">,</span><span class="n">lista_valores</span><span class="p">):</span>
                    <span class="n">df_filtrado_con_inicio_aux</span><span class="o">=</span><span class="n">df_filtrado_con_inicio_aux</span><span class="p">[</span><span class="n">df_filtrado_con_inicio_aux</span><span class="p">[</span><span class="n">col</span><span class="p">]</span><span class="o">==</span><span class="n">valor</span><span class="p">]</span>
                    <span class="n">tpf_con_inicio_filtrada</span><span class="o">=</span><span class="n">tpf_con_inicio_filtrada</span><span class="p">[</span><span class="n">tpf_con_inicio_filtrada</span><span class="p">[</span><span class="n">col</span><span class="p">]</span><span class="o">==</span><span class="n">valor</span><span class="p">]</span>
                <span class="n">df_filtrado_con_inicio_aux</span><span class="o">=</span><span class="n">pd</span><span class="o">.</span><span class="n">merge_asof</span><span class="p">(</span><span class="n">df_filtrado_con_inicio_aux</span><span class="o">.</span><span class="n">sort_values</span><span class="p">(</span><span class="s1">&#39;FECHA CRUCE VIGENCIAS&#39;</span><span class="p">),</span><span class="n">tpf_con_inicio_filtrada</span><span class="p">[</span><span class="n">cols_cruce</span><span class="p">]</span><span class="o">.</span><span class="n">sort_values</span><span class="p">(</span><span class="s1">&#39;INICIO DEL CONTRATO&#39;</span><span class="p">),</span><span class="n">left_on</span><span class="o">=</span><span class="s1">&#39;FECHA CRUCE VIGENCIAS&#39;</span><span class="p">,</span><span class="n">right_on</span><span class="o">=</span><span class="s1">&#39;INICIO DEL CONTRATO&#39;</span><span class="p">)</span>
                <span class="n">df_filtrado_con_inicio_aux</span><span class="o">=</span><span class="n">df_filtrado_con_inicio_aux</span><span class="o">.</span><span class="n">dropna</span><span class="p">(</span><span class="n">subset</span><span class="o">=</span><span class="n">cols_cruce</span><span class="p">)</span>
                <span class="n">df_filtrado_con_inicio</span><span class="o">=</span><span class="n">pd</span><span class="o">.</span><span class="n">concat</span><span class="p">([</span><span class="n">df_filtrado_con_inicio</span><span class="p">,</span><span class="n">df_filtrado_con_inicio_aux</span><span class="p">])</span>
        <span class="k">else</span><span class="p">:</span> <span class="n">df_filtrado_con_inicio</span><span class="o">=</span><span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">()</span>
        <span class="n">df_filtrado</span><span class="o">=</span><span class="n">pd</span><span class="o">.</span><span class="n">concat</span><span class="p">([</span><span class="n">df_filtrado_con_inicio</span><span class="p">,</span><span class="n">df_filtrado_sin_inicio</span><span class="p">])</span>
        <span class="n">df_a_filtrar</span><span class="p">:</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="o">=</span><span class="n">df</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">df</span><span class="o">.</span><span class="n">index</span><span class="o">.</span><span class="n">difference</span><span class="p">(</span><span class="n">df_filtrado</span><span class="p">[</span><span class="s1">&#39;INDICE&#39;</span><span class="p">])]</span> <span class="c1"># type: ignore</span>
        <span class="n">df_filtrado</span><span class="o">=</span><span class="n">df_filtrado</span><span class="o">.</span><span class="n">drop</span><span class="p">(</span><span class="n">columns</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;INDICE&#39;</span><span class="p">])</span>
        <span class="n">tabla_parametros_a_filtrar</span><span class="o">=</span><span class="n">tabla_parametros</span>
        <span class="k">return</span> <span class="n">df_filtrado</span><span class="p">,</span><span class="n">df_a_filtrar</span><span class="p">,</span><span class="n">tabla_parametros_a_filtrar</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>

<div class="doc doc-object doc-function">


<h2 id="S2_Funciones.get_all_subsets" class="doc doc-heading">
            <code class="highlight language-python"><span class="n">get_all_subsets</span><span class="p">(</span><span class="n">s</span><span class="p">)</span></code>

</h2>


    <div class="doc doc-contents ">

        <p>Genera todos los subconjuntos de un conjunto 's'.
    Parameters:
    s (set): El conjunto de entrada para el cual se deben generar los subconjuntos.
     Returns:
    list: Una lista de conjuntos que representa todos los subconjuntos de 's'.</p>

            <details class="quote">
              <summary>Source code in <code>S2_Funciones.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">34</span>
<span class="normal">35</span>
<span class="normal">36</span>
<span class="normal">37</span>
<span class="normal">38</span>
<span class="normal">39</span>
<span class="normal">40</span>
<span class="normal">41</span>
<span class="normal">42</span>
<span class="normal">43</span>
<span class="normal">44</span>
<span class="normal">45</span>
<span class="normal">46</span>
<span class="normal">47</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span> <span class="nf">get_all_subsets</span><span class="p">(</span><span class="n">s</span><span class="p">:</span> <span class="nb">list</span><span class="p">[</span><span class="nb">str</span><span class="p">])</span> <span class="o">-&gt;</span> <span class="nb">list</span><span class="p">[</span><span class="nb">set</span><span class="p">[</span><span class="nb">str</span><span class="p">]]:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Genera todos los subconjuntos de un conjunto &#39;s&#39;.</span>
<span class="sd">        Parameters:</span>
<span class="sd">        s (set): El conjunto de entrada para el cual se deben generar los subconjuntos.</span>
<span class="sd">         Returns:</span>
<span class="sd">        list: Una lista de conjuntos que representa todos los subconjuntos de &#39;s&#39;.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="c1"># Convert the input set into a list to ensure order of elements in subsets.</span>
    <span class="n">s_list</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">s</span><span class="p">)</span>
    <span class="c1"># Generate all possible combinations of elements in the list.</span>
    <span class="n">all_combinations</span> <span class="o">=</span> <span class="n">chain</span><span class="o">.</span><span class="n">from_iterable</span><span class="p">(</span><span class="n">combinations</span><span class="p">(</span><span class="n">s_list</span><span class="p">,</span> <span class="n">r</span><span class="p">)</span> <span class="k">for</span> <span class="n">r</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">s_list</span><span class="p">)</span> <span class="o">+</span> <span class="mi">1</span><span class="p">))</span>
    <span class="c1"># Convert each combination into a set to obtain subsets.</span>
    <span class="k">return</span> <span class="p">[</span><span class="nb">set</span><span class="p">(</span><span class="n">comb</span><span class="p">)</span> <span class="k">for</span> <span class="n">comb</span> <span class="ow">in</span> <span class="n">all_combinations</span><span class="p">]</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>

<div class="doc doc-object doc-function">


<h2 id="S2_Funciones.identificador_anonimo" class="doc doc-heading">
            <code class="highlight language-python"><span class="n">identificador_anonimo</span><span class="p">(</span><span class="n">df</span><span class="p">,</span> <span class="n">campos</span><span class="p">)</span></code>

</h2>


    <div class="doc doc-contents ">

        <p>Anonimizador de datos</p>


<p><span class="doc-section-title">Parameters:</span></p>
    <table>
      <thead>
        <tr>
          <th>Name</th>
          <th>Type</th>
          <th>Description</th>
          <th>Default</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
                <code>df</code>
            </td>
            <td>
                  <code><span title="pandas.DataFrame">DataFrame</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>dataframe con la informacion (datos que vamos a anonimizar y datos que mantendremos)</p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>campos</code>
            </td>
            <td>
                  <code>list[str]</code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>campos que voy a a anonimizar</p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
      </tbody>
    </table>


    <p><span class="doc-section-title">Returns:</span></p>
    <table>
      <thead>
        <tr>
          <th>Type</th>
          <th>Description</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
                  <code><span title="pandas.DataFrame">DataFrame</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>dataframe con el campo de anonimizacion</p>
              </div>
            </td>
          </tr>
      </tbody>
    </table>

            <details class="quote">
              <summary>Source code in <code>S2_Funciones.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">1045</span>
<span class="normal">1046</span>
<span class="normal">1047</span>
<span class="normal">1048</span>
<span class="normal">1049</span>
<span class="normal">1050</span>
<span class="normal">1051</span>
<span class="normal">1052</span>
<span class="normal">1053</span>
<span class="normal">1054</span>
<span class="normal">1055</span>
<span class="normal">1056</span>
<span class="normal">1057</span>
<span class="normal">1058</span>
<span class="normal">1059</span>
<span class="normal">1060</span>
<span class="normal">1061</span>
<span class="normal">1062</span>
<span class="normal">1063</span>
<span class="normal">1064</span>
<span class="normal">1065</span>
<span class="normal">1066</span>
<span class="normal">1067</span>
<span class="normal">1068</span>
<span class="normal">1069</span>
<span class="normal">1070</span>
<span class="normal">1071</span>
<span class="normal">1072</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span> <span class="nf">identificador_anonimo</span><span class="p">(</span><span class="n">df</span><span class="p">:</span><span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">,</span> <span class="n">campos</span><span class="p">:</span> <span class="nb">list</span><span class="p">[</span><span class="nb">str</span><span class="p">])</span> <span class="o">-&gt;</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Anonimizador de datos</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    df : pd.DataFrame</span>
<span class="sd">        dataframe con la informacion (datos que vamos a anonimizar y datos que mantendremos)</span>
<span class="sd">    campos : list[str]</span>
<span class="sd">        campos que voy a a anonimizar</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    pd.DataFrame</span>
<span class="sd">        dataframe con el campo de anonimizacion</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="c1"># Crear un DataFrame con combinaciones únicas de los identificadores</span>
    <span class="n">identificadores_unicos</span> <span class="o">=</span> <span class="n">df</span><span class="p">[</span><span class="n">campos</span><span class="p">]</span><span class="o">.</span><span class="n">drop_duplicates</span><span class="p">()</span>
    <span class="n">nro_ruts</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">identificadores_unicos</span><span class="p">)</span>
    <span class="c1"># Generar números aleatorios para las combinaciones únicas</span>
    <span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">seed</span><span class="p">(</span><span class="mi">1000</span><span class="p">)</span>  <span class="c1"># Fijar semilla para reproducibilidad</span>
    <span class="n">valores_aleatorios</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">choice</span><span class="p">(</span><span class="nb">range</span><span class="p">(</span><span class="mi">1000000</span><span class="p">,</span> <span class="mi">9999999</span><span class="p">),</span><span class="n">size</span><span class="o">=</span><span class="n">nro_ruts</span><span class="p">,</span><span class="n">replace</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
    <span class="n">identificadores_unicos</span><span class="p">[</span><span class="s1">&#39;IDENTIFICADOR&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">valores_aleatorios</span>
    <span class="c1"># Hacer un merge para asignar los valores anonimizados al DataFrame original</span>
    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">identificadores_unicos</span><span class="p">[</span><span class="s1">&#39;IDENTIFICADOR&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">drop_duplicates</span><span class="p">())</span> <span class="o">==</span><span class="n">nro_ruts</span><span class="p">:</span>
        <span class="n">df</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">merge</span><span class="p">(</span><span class="n">identificadores_unicos</span><span class="p">,</span> <span class="n">on</span><span class="o">=</span><span class="n">campos</span><span class="p">,</span> <span class="n">how</span><span class="o">=</span><span class="s1">&#39;left&#39;</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Revisar los identificadores unicos. No fueron bien asignados&#39;</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">df</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>

<div class="doc doc-object doc-function">


<h2 id="S2_Funciones.recargos" class="doc doc-heading">
            <code class="highlight language-python"><span class="n">recargos</span><span class="p">(</span><span class="n">df</span><span class="p">,</span> <span class="n">parameters</span><span class="p">,</span> <span class="n">calcula_recargos</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span></code>

</h2>


    <div class="doc doc-contents ">

        <p>Calcula Recargos en la prima de reaseguro asociados a asegurados con sobreprima o extraprima
Tambien tiene la opcion de solo marcar los registros que tienen recargo, sin calcularlo directamente</p>


<p><span class="doc-section-title">Parameters:</span></p>
    <table>
      <thead>
        <tr>
          <th>Name</th>
          <th>Type</th>
          <th>Description</th>
          <th>Default</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
                <code>df</code>
            </td>
            <td>
                  <code><span title="pandas.DataFrame">DataFrame</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>dataframe de asegurados</p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>parameters</code>
            </td>
            <td>
                  <code><a class="autorefs autorefs-internal" title="S0_Loaders.Parameter_Loader" href="#S0_Loaders.Parameter_Loader">Parameter_Loader</a></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Objeto que contiene parámetros relevantes para la lógica del cálculo</p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>calcula_recargos</code>
            </td>
            <td>
                  <code>int</code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>binario que indica si calculamos o no los recargos, by default 1</p>
              </div>
            </td>
            <td>
                  <code>1</code>
            </td>
          </tr>
      </tbody>
    </table>


    <p><span class="doc-section-title">Returns:</span></p>
    <table>
      <thead>
        <tr>
          <th>Type</th>
          <th>Description</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
                  <code><span title="pandas.DataFrame">DataFrame</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>dataframe de asegurados con recargos</p>
              </div>
            </td>
          </tr>
      </tbody>
    </table>

            <details class="quote">
              <summary>Source code in <code>S2_Funciones.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">910</span>
<span class="normal">911</span>
<span class="normal">912</span>
<span class="normal">913</span>
<span class="normal">914</span>
<span class="normal">915</span>
<span class="normal">916</span>
<span class="normal">917</span>
<span class="normal">918</span>
<span class="normal">919</span>
<span class="normal">920</span>
<span class="normal">921</span>
<span class="normal">922</span>
<span class="normal">923</span>
<span class="normal">924</span>
<span class="normal">925</span>
<span class="normal">926</span>
<span class="normal">927</span>
<span class="normal">928</span>
<span class="normal">929</span>
<span class="normal">930</span>
<span class="normal">931</span>
<span class="normal">932</span>
<span class="normal">933</span>
<span class="normal">934</span>
<span class="normal">935</span>
<span class="normal">936</span>
<span class="normal">937</span>
<span class="normal">938</span>
<span class="normal">939</span>
<span class="normal">940</span>
<span class="normal">941</span>
<span class="normal">942</span>
<span class="normal">943</span>
<span class="normal">944</span>
<span class="normal">945</span>
<span class="normal">946</span>
<span class="normal">947</span>
<span class="normal">948</span>
<span class="normal">949</span>
<span class="normal">950</span>
<span class="normal">951</span>
<span class="normal">952</span>
<span class="normal">953</span>
<span class="normal">954</span>
<span class="normal">955</span>
<span class="normal">956</span>
<span class="normal">957</span>
<span class="normal">958</span>
<span class="normal">959</span>
<span class="normal">960</span>
<span class="normal">961</span>
<span class="normal">962</span>
<span class="normal">963</span>
<span class="normal">964</span>
<span class="normal">965</span>
<span class="normal">966</span>
<span class="normal">967</span>
<span class="normal">968</span>
<span class="normal">969</span>
<span class="normal">970</span>
<span class="normal">971</span>
<span class="normal">972</span>
<span class="normal">973</span>
<span class="normal">974</span>
<span class="normal">975</span>
<span class="normal">976</span>
<span class="normal">977</span>
<span class="normal">978</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span> <span class="nf">recargos</span><span class="p">(</span><span class="n">df</span><span class="p">:</span><span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">,</span> <span class="n">parameters</span><span class="p">:</span> <span class="n">Parameter_Loader</span><span class="p">,</span><span class="n">calcula_recargos</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Calcula Recargos en la prima de reaseguro asociados a asegurados con sobreprima o extraprima</span>
<span class="sd">    Tambien tiene la opcion de solo marcar los registros que tienen recargo, sin calcularlo directamente</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    df : pd.DataFrame</span>
<span class="sd">        dataframe de asegurados</span>
<span class="sd">    parameters : Parameter_Loader</span>
<span class="sd">        Objeto que contiene parámetros relevantes para la lógica del cálculo</span>
<span class="sd">    calcula_recargos : int, optional</span>
<span class="sd">        binario que indica si calculamos o no los recargos, by default 1</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    pd.DataFrame</span>
<span class="sd">        dataframe de asegurados con recargos</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">ruta_recargos</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="n">parameters</span><span class="o">.</span><span class="n">parameters</span><span class="p">[</span><span class="s1">&#39;ruta_recargos&#39;</span><span class="p">]</span>
    <span class="n">separador_input</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="n">parameters</span><span class="o">.</span><span class="n">parameters</span><span class="p">[</span><span class="s1">&#39;separador_input&#39;</span><span class="p">]</span>
    <span class="n">decimal_input</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="n">parameters</span><span class="o">.</span><span class="n">parameters</span><span class="p">[</span><span class="s1">&#39;decimal_input&#39;</span><span class="p">]</span>
    <span class="n">ruta_output</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="n">parameters</span><span class="o">.</span><span class="n">parameters</span><span class="p">[</span><span class="s1">&#39;ruta_output&#39;</span><span class="p">]</span>
    <span class="n">fecha_inicio_mes</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="n">parameters</span><span class="o">.</span><span class="n">parameters</span><span class="p">[</span><span class="s1">&#39;fecha_inicio_mes&#39;</span><span class="p">]</span>
    <span class="n">df</span><span class="o">.</span><span class="n">rename</span><span class="p">(</span><span class="n">columns</span><span class="o">=</span><span class="p">{</span><span class="s1">&#39;PRIMA REASEGURO&#39;</span><span class="p">:</span><span class="s1">&#39;PRIMA REASEGURO SIN RECARGO&#39;</span><span class="p">},</span><span class="n">inplace</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
    <span class="n">cols_df_final</span><span class="o">=</span><span class="nb">list</span><span class="p">(</span><span class="n">df</span><span class="o">.</span><span class="n">columns</span><span class="p">)</span><span class="o">+</span><span class="p">[</span><span class="s1">&#39;RECARGO&#39;</span><span class="p">]</span>
    <span class="c1"># CALCULOS PARA IAXIS</span>
    <span class="n">cols_date_iaxis</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;FECHA_INICIO_RECARGO&#39;</span><span class="p">]</span>
    <span class="c1"># recargos_iaxis=pd.read_csv(ruta_recargos+&#39;1. Inputs Auxiliares\\Recargos\\&#39;+&#39;Recargos iAxis &#39;+str(periodo)+&#39;.txt&#39;,sep=separador_input,decimal=decimal_input,encoding=&#39;latin-1&#39;,low_memory=False,date_format=&#39;%d-%m-%Y&#39;,parse_dates=cols_date_iaxis)</span>
    <span class="n">recargos_iaxis</span><span class="o">=</span><span class="n">pd</span><span class="o">.</span><span class="n">read_csv</span><span class="p">(</span><span class="n">ruta_recargos</span><span class="o">+</span><span class="s1">&#39;1. Inputs Auxiliares</span><span class="se">\\</span><span class="s1">Recargos</span><span class="se">\\</span><span class="s1">&#39;</span><span class="o">+</span><span class="s1">&#39;Recargos iAxis.txt&#39;</span><span class="p">,</span><span class="n">sep</span><span class="o">=</span><span class="n">separador_input</span><span class="p">,</span><span class="n">decimal</span><span class="o">=</span><span class="n">decimal_input</span><span class="p">,</span><span class="n">encoding</span><span class="o">=</span><span class="s1">&#39;latin-1&#39;</span><span class="p">,</span><span class="n">low_memory</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span><span class="n">date_format</span><span class="o">=</span><span class="s1">&#39;</span><span class="si">%d</span><span class="s1">-%m-%Y&#39;</span><span class="p">,</span><span class="n">parse_dates</span><span class="o">=</span><span class="n">cols_date_iaxis</span><span class="p">)</span>
    <span class="c1"># extraprima_iaxis=recargos_iaxis[(recargos_iaxis[&#39;FECHA_INICIO_RECARGO&#39;]&lt;=fecha_cierre)&amp;(recargos_iaxis[&#39;TIPO_RECARGO&#39;]==&#39;Extraprima (tanto por mil)&#39;)&amp;(recargos_iaxis[&#39;VALOR_RECARGO&#39;]&gt;0)][[&#39;SSEGURO&#39;,&#39;NRIESGO&#39;,&#39;CODIGO COBERTURA IAXIS&#39;,&#39;VALOR_RECARGO&#39;]]</span>
    <span class="c1"># sobreprima_iaxis=recargos_iaxis[(recargos_iaxis[&#39;FECHA_INICIO_RECARGO&#39;]&lt;=fecha_cierre)&amp;(recargos_iaxis[&#39;TIPO_RECARGO&#39;]==&#39;Sobreprima (%)&#39;)&amp;(recargos_iaxis[&#39;VALOR_RECARGO&#39;]&gt;0)][[&#39;SSEGURO&#39;,&#39;NRIESGO&#39;,&#39;CODIGO COBERTURA IAXIS&#39;,&#39;VALOR_RECARGO&#39;]]</span>
    <span class="n">extraprima_iaxis</span><span class="o">=</span><span class="n">recargos_iaxis</span><span class="p">[(</span><span class="n">recargos_iaxis</span><span class="p">[</span><span class="s1">&#39;TIPO_RECARGO&#39;</span><span class="p">]</span><span class="o">==</span><span class="s1">&#39;Extraprima (tanto por mil)&#39;</span><span class="p">)</span><span class="o">&amp;</span><span class="p">(</span><span class="n">recargos_iaxis</span><span class="p">[</span><span class="s1">&#39;VALOR_RECARGO&#39;</span><span class="p">]</span><span class="o">&gt;</span><span class="mi">0</span><span class="p">)][[</span><span class="s1">&#39;SSEGURO&#39;</span><span class="p">,</span><span class="s1">&#39;NRIESGO&#39;</span><span class="p">,</span><span class="s1">&#39;CODIGO COBERTURA IAXIS&#39;</span><span class="p">,</span><span class="s1">&#39;VALOR_RECARGO&#39;</span><span class="p">]]</span>
    <span class="n">sobreprima_iaxis</span><span class="o">=</span><span class="n">recargos_iaxis</span><span class="p">[(</span><span class="n">recargos_iaxis</span><span class="p">[</span><span class="s1">&#39;TIPO_RECARGO&#39;</span><span class="p">]</span><span class="o">==</span><span class="s1">&#39;Sobreprima (%)&#39;</span><span class="p">)</span><span class="o">&amp;</span><span class="p">(</span><span class="n">recargos_iaxis</span><span class="p">[</span><span class="s1">&#39;VALOR_RECARGO&#39;</span><span class="p">]</span><span class="o">&gt;</span><span class="mi">0</span><span class="p">)][[</span><span class="s1">&#39;SSEGURO&#39;</span><span class="p">,</span><span class="s1">&#39;NRIESGO&#39;</span><span class="p">,</span><span class="s1">&#39;CODIGO COBERTURA IAXIS&#39;</span><span class="p">,</span><span class="s1">&#39;VALOR_RECARGO&#39;</span><span class="p">]]</span>
    <span class="n">extraprima_iaxis</span><span class="o">.</span><span class="n">rename</span><span class="p">(</span><span class="n">columns</span><span class="o">=</span><span class="p">{</span><span class="s1">&#39;VALOR_RECARGO&#39;</span><span class="p">:</span><span class="s1">&#39;VALOR_RECARGO_EXTRAPRIMA&#39;</span><span class="p">},</span><span class="n">inplace</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
    <span class="n">sobreprima_iaxis</span><span class="o">.</span><span class="n">rename</span><span class="p">(</span><span class="n">columns</span><span class="o">=</span><span class="p">{</span><span class="s1">&#39;VALOR_RECARGO&#39;</span><span class="p">:</span><span class="s1">&#39;VALOR_RECARGO_SOBREPRIMA&#39;</span><span class="p">},</span><span class="n">inplace</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
    <span class="n">df_iaxis</span><span class="o">=</span><span class="n">df</span><span class="p">[</span><span class="n">df</span><span class="p">[</span><span class="s1">&#39;BASE&#39;</span><span class="p">]</span><span class="o">==</span><span class="s1">&#39;IAXIS&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
    <span class="n">df_iaxis</span><span class="o">=</span><span class="n">df_iaxis</span><span class="o">.</span><span class="n">merge</span><span class="p">(</span><span class="n">extraprima_iaxis</span><span class="p">,</span><span class="n">how</span><span class="o">=</span><span class="s1">&#39;left&#39;</span><span class="p">,</span><span class="n">on</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;SSEGURO&#39;</span><span class="p">,</span><span class="s1">&#39;NRIESGO&#39;</span><span class="p">,</span><span class="s1">&#39;CODIGO COBERTURA IAXIS&#39;</span><span class="p">])</span>
    <span class="n">df_iaxis</span><span class="o">=</span><span class="n">df_iaxis</span><span class="o">.</span><span class="n">merge</span><span class="p">(</span><span class="n">sobreprima_iaxis</span><span class="p">,</span><span class="n">how</span><span class="o">=</span><span class="s1">&#39;left&#39;</span><span class="p">,</span><span class="n">on</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;SSEGURO&#39;</span><span class="p">,</span><span class="s1">&#39;NRIESGO&#39;</span><span class="p">,</span><span class="s1">&#39;CODIGO COBERTURA IAXIS&#39;</span><span class="p">])</span>
    <span class="k">if</span> <span class="n">calcula_recargos</span><span class="o">==</span><span class="mi">1</span><span class="p">:</span>
        <span class="n">df_iaxis</span><span class="p">[</span><span class="s1">&#39;RECARGO&#39;</span><span class="p">]</span><span class="o">=</span><span class="p">(</span><span class="n">df_iaxis</span><span class="p">[</span><span class="s1">&#39;VALOR_RECARGO_SOBREPRIMA&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">fillna</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span><span class="o">/</span><span class="mi">100</span><span class="o">*</span><span class="n">df_iaxis</span><span class="p">[</span><span class="s1">&#39;PRIMA REASEGURO SIN RECARGO&#39;</span><span class="p">]</span><span class="o">+</span><span class="n">df_iaxis</span><span class="p">[</span><span class="s1">&#39;VALOR_RECARGO_EXTRAPRIMA&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">fillna</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span><span class="o">/</span><span class="mi">1000</span><span class="o">*</span><span class="n">df_iaxis</span><span class="p">[</span><span class="s1">&#39;CAPITAL CEDIDO TOTAL&#39;</span><span class="p">]</span><span class="o">*</span><span class="mi">1</span><span class="o">/</span><span class="mi">12</span><span class="p">)</span><span class="o">*</span><span class="n">df_iaxis</span><span class="p">[</span><span class="s1">&#39;PARTICIPACION DEL REASEGURADOR&#39;</span><span class="p">]</span>
        <span class="n">df_iaxis</span><span class="p">[</span><span class="n">df_iaxis</span><span class="p">[</span><span class="s1">&#39;RECARGO&#39;</span><span class="p">]</span><span class="o">&gt;</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">to_csv</span><span class="p">(</span><span class="n">ruta_output</span><span class="o">+</span><span class="s1">&#39;3. Recargos iAxis Detalle.csv&#39;</span><span class="p">,</span><span class="n">sep</span><span class="o">=</span><span class="s1">&#39;;&#39;</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span> 
        <span class="c1"># df_iaxis[&#39;RECARGO&#39;]=np.where((df_iaxis[&#39;VALOR_RECARGO_SOBREPRIMA&#39;].isnull())&amp;(df_iaxis[&#39;VALOR_RECARGO_EXTRAPRIMA&#39;].isnull()),0,1)</span>
        <span class="n">df_iaxis</span><span class="p">[</span><span class="s1">&#39;RECARGO&#39;</span><span class="p">]</span><span class="o">=</span><span class="n">df_iaxis</span><span class="p">[</span><span class="s1">&#39;VALOR_RECARGO_SOBREPRIMA&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">fillna</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span><span class="o">/</span><span class="mi">100</span>
    <span class="c1"># CALCULOS PARA GES</span>
    <span class="c1"># recargos_ges_cr=pd.read_csv(ruta_recargos+&#39;1. Inputs Auxiliares\\Recargos\\&#39;+&#39;Recargos GES Credit &#39;+str(periodo)+&#39;.txt&#39;,sep=separador_input,decimal=decimal_input,encoding=&#39;latin-1&#39;,low_memory=False)</span>
    <span class="c1"># recargos_ges_ind=pd.read_csv(ruta_recargos+&#39;1. Inputs Auxiliares\\Recargos\\&#39;+&#39;Recargos GES Individuales &#39;+str(periodo)+&#39;.txt&#39;,sep=separador_input,decimal=decimal_input,encoding=&#39;latin-1&#39;,low_memory=False)</span>
    <span class="n">recargos_ges_cr</span><span class="o">=</span><span class="n">pd</span><span class="o">.</span><span class="n">read_csv</span><span class="p">(</span><span class="n">ruta_recargos</span><span class="o">+</span><span class="s1">&#39;1. Inputs Auxiliares</span><span class="se">\\</span><span class="s1">Recargos</span><span class="se">\\</span><span class="s1">&#39;</span><span class="o">+</span><span class="s1">&#39;Recargos GES Credit.txt&#39;</span><span class="p">,</span><span class="n">sep</span><span class="o">=</span><span class="n">separador_input</span><span class="p">,</span><span class="n">decimal</span><span class="o">=</span><span class="n">decimal_input</span><span class="p">,</span><span class="n">encoding</span><span class="o">=</span><span class="s1">&#39;latin-1&#39;</span><span class="p">,</span><span class="n">low_memory</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
    <span class="n">recargos_ges_ind</span><span class="o">=</span><span class="n">pd</span><span class="o">.</span><span class="n">read_csv</span><span class="p">(</span><span class="n">ruta_recargos</span><span class="o">+</span><span class="s1">&#39;1. Inputs Auxiliares</span><span class="se">\\</span><span class="s1">Recargos</span><span class="se">\\</span><span class="s1">&#39;</span><span class="o">+</span><span class="s1">&#39;Recargos GES Individuales.txt&#39;</span><span class="p">,</span><span class="n">sep</span><span class="o">=</span><span class="n">separador_input</span><span class="p">,</span><span class="n">decimal</span><span class="o">=</span><span class="n">decimal_input</span><span class="p">,</span><span class="n">encoding</span><span class="o">=</span><span class="s1">&#39;latin-1&#39;</span><span class="p">,</span><span class="n">low_memory</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
    <span class="n">df_ges</span><span class="o">=</span><span class="n">df</span><span class="p">[</span><span class="n">df</span><span class="p">[</span><span class="s1">&#39;BASE&#39;</span><span class="p">]</span><span class="o">==</span><span class="s1">&#39;GES&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
    <span class="n">df_ges</span><span class="o">=</span><span class="n">df_ges</span><span class="o">.</span><span class="n">merge</span><span class="p">(</span><span class="n">recargos_ges_cr</span><span class="p">,</span><span class="n">how</span><span class="o">=</span><span class="s1">&#39;left&#39;</span><span class="p">,</span><span class="n">left_on</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;POLIZA&#39;</span><span class="p">,</span><span class="s1">&#39;RUT&#39;</span><span class="p">,</span><span class="s1">&#39;CERTIFICADO&#39;</span><span class="p">,</span><span class="s1">&#39;CODIGO COBERTURA&#39;</span><span class="p">],</span><span class="n">right_on</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;POLIZA_T0057&#39;</span><span class="p">,</span><span class="s1">&#39;RUT_T0057&#39;</span><span class="p">,</span><span class="s1">&#39;SECUENCIAL&#39;</span><span class="p">,</span><span class="s1">&#39;CODIGO_COBERTURA&#39;</span><span class="p">],</span><span class="n">suffixes</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;&#39;</span><span class="p">,</span> <span class="s1">&#39;_x&#39;</span><span class="p">])</span>
    <span class="n">df_ges</span><span class="o">=</span><span class="n">df_ges</span><span class="o">.</span><span class="n">merge</span><span class="p">(</span><span class="n">recargos_ges_ind</span><span class="p">,</span><span class="n">how</span><span class="o">=</span><span class="s1">&#39;left&#39;</span><span class="p">,</span><span class="n">left_on</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;POLIZA&#39;</span><span class="p">,</span><span class="s1">&#39;RUT&#39;</span><span class="p">,</span><span class="s1">&#39;CERTIFICADO&#39;</span><span class="p">,</span><span class="s1">&#39;CODIGO COBERTURA&#39;</span><span class="p">],</span><span class="n">right_on</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;POLIZA&#39;</span><span class="p">,</span><span class="s1">&#39;RUT&#39;</span><span class="p">,</span><span class="s1">&#39;SECUENCIAL&#39;</span><span class="p">,</span><span class="s1">&#39;CODIGO_COBERTURA&#39;</span><span class="p">],</span><span class="n">suffixes</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;&#39;</span><span class="p">,</span> <span class="s1">&#39;_x&#39;</span><span class="p">])</span>
    <span class="k">if</span> <span class="n">calcula_recargos</span><span class="o">==</span><span class="mi">1</span><span class="p">:</span>
        <span class="n">df_ges</span><span class="p">[</span><span class="s1">&#39;RECARGO&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">((</span><span class="n">df_ges</span><span class="p">[</span><span class="s1">&#39;FECHA_EFECTO&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">dt</span><span class="o">.</span><span class="n">to_period</span><span class="p">(</span><span class="s1">&#39;M&#39;</span><span class="p">)</span> <span class="o">+</span> <span class="n">df_ges</span><span class="p">[</span><span class="s1">&#39;MESES_SOBREPRIMA_ACTIVIDAD&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">fillna</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">int</span><span class="p">))</span><span class="o">.</span><span class="n">dt</span><span class="o">.</span><span class="n">to_timestamp</span><span class="p">()</span><span class="o">&lt;</span><span class="n">fecha_inicio_mes</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="n">df_ges</span><span class="p">[</span><span class="s1">&#39;PRIMA REASEGURO SIN RECARGO&#39;</span><span class="p">]</span><span class="o">*</span><span class="n">df_ges</span><span class="p">[</span><span class="s1">&#39;SOBREPRIMA_ACTIVIDAD&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">fillna</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span><span class="o">/</span><span class="mi">100</span><span class="p">)</span><span class="o">+</span>\
                        <span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">((</span><span class="n">df_ges</span><span class="p">[</span><span class="s1">&#39;FECHA_EFECTO&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">dt</span><span class="o">.</span><span class="n">to_period</span><span class="p">(</span><span class="s1">&#39;M&#39;</span><span class="p">)</span> <span class="o">+</span> <span class="n">df_ges</span><span class="p">[</span><span class="s1">&#39;MESES_SOBREPRIMA_MEDICO&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">fillna</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">int</span><span class="p">))</span><span class="o">.</span><span class="n">dt</span><span class="o">.</span><span class="n">to_timestamp</span><span class="p">()</span><span class="o">&lt;</span><span class="n">fecha_inicio_mes</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="n">df_ges</span><span class="p">[</span><span class="s1">&#39;PRIMA REASEGURO SIN RECARGO&#39;</span><span class="p">]</span><span class="o">*</span><span class="n">df_ges</span><span class="p">[</span><span class="s1">&#39;SOBREPRIMA_MEDICO&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">fillna</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span><span class="o">/</span><span class="mi">100</span><span class="p">)</span><span class="o">+</span>\
                        <span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">((</span><span class="n">df_ges</span><span class="p">[</span><span class="s1">&#39;FECHA_EFECTO&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">dt</span><span class="o">.</span><span class="n">to_period</span><span class="p">(</span><span class="s1">&#39;M&#39;</span><span class="p">)</span> <span class="o">+</span> <span class="n">df_ges</span><span class="p">[</span><span class="s1">&#39;MESES_SOBREPRIMA_DEPORTE&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">fillna</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">int</span><span class="p">))</span><span class="o">.</span><span class="n">dt</span><span class="o">.</span><span class="n">to_timestamp</span><span class="p">()</span><span class="o">&lt;</span><span class="n">fecha_inicio_mes</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="n">df_ges</span><span class="p">[</span><span class="s1">&#39;PRIMA REASEGURO SIN RECARGO&#39;</span><span class="p">]</span><span class="o">*</span><span class="n">df_ges</span><span class="p">[</span><span class="s1">&#39;SOBREPRIMA_DEPORTE&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">fillna</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span><span class="o">/</span><span class="mi">100</span><span class="p">)</span><span class="o">+</span>\
                        <span class="n">df_ges</span><span class="p">[</span><span class="s1">&#39;PRIMA REASEGURO SIN RECARGO&#39;</span><span class="p">]</span><span class="o">*</span><span class="n">df_ges</span><span class="p">[</span><span class="s1">&#39;PORCENTAJE_RECARGO&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">fillna</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span><span class="o">/</span><span class="mi">100</span><span class="o">+</span>\
                        <span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">((</span><span class="n">df_ges</span><span class="p">[</span><span class="s1">&#39;FECHA_EFECTO&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">dt</span><span class="o">.</span><span class="n">to_period</span><span class="p">(</span><span class="s1">&#39;M&#39;</span><span class="p">)</span> <span class="o">+</span> <span class="n">df_ges</span><span class="p">[</span><span class="s1">&#39;MESES_EXTRAPRIMA&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">fillna</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">int</span><span class="p">))</span><span class="o">.</span><span class="n">dt</span><span class="o">.</span><span class="n">to_timestamp</span><span class="p">()</span><span class="o">&lt;</span><span class="n">fecha_inicio_mes</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="n">df_ges</span><span class="p">[</span><span class="s1">&#39;CAPITAL CEDIDO TOTAL&#39;</span><span class="p">]</span><span class="o">*</span><span class="n">df_ges</span><span class="p">[</span><span class="s1">&#39;EXTRAPRIMA&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">fillna</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span><span class="o">/</span><span class="mi">1000</span><span class="p">)</span><span class="o">*</span><span class="mi">1</span><span class="o">/</span><span class="mi">12</span><span class="p">)</span><span class="o">*</span><span class="n">df_ges</span><span class="p">[</span><span class="s1">&#39;PARTICIPACION DEL REASEGURADOR&#39;</span><span class="p">]</span>
        <span class="n">df_ges</span><span class="p">[</span><span class="n">df_ges</span><span class="p">[</span><span class="s1">&#39;RECARGO&#39;</span><span class="p">]</span><span class="o">&gt;</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">to_csv</span><span class="p">(</span><span class="n">ruta_output</span><span class="o">+</span><span class="s1">&#39;3. Recargos GES Detalle.csv&#39;</span><span class="p">,</span><span class="n">sep</span><span class="o">=</span><span class="s1">&#39;;&#39;</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span> 
        <span class="c1"># df_ges[&#39;RECARGO&#39;]=np.where((df_ges[&#39;ORIGEN&#39;].isnull())&amp;(df_ges[&#39;PORCENTAJE_RECARGO&#39;].isnull()),0,1)</span>
        <span class="n">df_ges</span><span class="p">[</span><span class="s1">&#39;RECARGO&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">((</span><span class="n">df_ges</span><span class="p">[</span><span class="s1">&#39;FECHA_EFECTO&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">dt</span><span class="o">.</span><span class="n">to_period</span><span class="p">(</span><span class="s1">&#39;M&#39;</span><span class="p">)</span> <span class="o">+</span> <span class="n">df_ges</span><span class="p">[</span><span class="s1">&#39;MESES_SOBREPRIMA_ACTIVIDAD&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">fillna</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">int</span><span class="p">))</span><span class="o">.</span><span class="n">dt</span><span class="o">.</span><span class="n">to_timestamp</span><span class="p">()</span><span class="o">&lt;</span><span class="n">fecha_inicio_mes</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="n">df_ges</span><span class="p">[</span><span class="s1">&#39;SOBREPRIMA_ACTIVIDAD&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">fillna</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span><span class="o">/</span><span class="mi">100</span><span class="p">)</span><span class="o">+</span>\
                        <span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">((</span><span class="n">df_ges</span><span class="p">[</span><span class="s1">&#39;FECHA_EFECTO&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">dt</span><span class="o">.</span><span class="n">to_period</span><span class="p">(</span><span class="s1">&#39;M&#39;</span><span class="p">)</span> <span class="o">+</span> <span class="n">df_ges</span><span class="p">[</span><span class="s1">&#39;MESES_SOBREPRIMA_MEDICO&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">fillna</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">int</span><span class="p">))</span><span class="o">.</span><span class="n">dt</span><span class="o">.</span><span class="n">to_timestamp</span><span class="p">()</span><span class="o">&lt;</span><span class="n">fecha_inicio_mes</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="n">df_ges</span><span class="p">[</span><span class="s1">&#39;SOBREPRIMA_MEDICO&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">fillna</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span><span class="o">/</span><span class="mi">100</span><span class="p">)</span><span class="o">+</span>\
                        <span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">((</span><span class="n">df_ges</span><span class="p">[</span><span class="s1">&#39;FECHA_EFECTO&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">dt</span><span class="o">.</span><span class="n">to_period</span><span class="p">(</span><span class="s1">&#39;M&#39;</span><span class="p">)</span> <span class="o">+</span> <span class="n">df_ges</span><span class="p">[</span><span class="s1">&#39;MESES_SOBREPRIMA_DEPORTE&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">fillna</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">int</span><span class="p">))</span><span class="o">.</span><span class="n">dt</span><span class="o">.</span><span class="n">to_timestamp</span><span class="p">()</span><span class="o">&lt;</span><span class="n">fecha_inicio_mes</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="n">df_ges</span><span class="p">[</span><span class="s1">&#39;SOBREPRIMA_DEPORTE&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">fillna</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span><span class="o">/</span><span class="mi">100</span><span class="p">)</span><span class="o">+</span>\
                        <span class="n">df_ges</span><span class="p">[</span><span class="s1">&#39;PORCENTAJE_RECARGO&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">fillna</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span><span class="o">/</span><span class="mi">100</span>
    <span class="c1"># CREACION DF_FINAL</span>
    <span class="n">df_final</span><span class="o">=</span><span class="n">pd</span><span class="o">.</span><span class="n">concat</span><span class="p">([</span><span class="n">df_iaxis</span><span class="p">[</span><span class="n">cols_df_final</span><span class="p">],</span><span class="n">df_ges</span><span class="p">[</span><span class="n">cols_df_final</span><span class="p">]],</span><span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">calcula_recargos</span><span class="o">==</span><span class="mi">1</span><span class="p">:</span> <span class="n">df_final</span><span class="p">[</span><span class="s1">&#39;PRIMA REASEGURO&#39;</span><span class="p">]</span><span class="o">=</span><span class="n">df_final</span><span class="p">[</span><span class="s1">&#39;PRIMA REASEGURO SIN RECARGO&#39;</span><span class="p">]</span><span class="o">+</span><span class="n">df_final</span><span class="p">[</span><span class="s1">&#39;RECARGO&#39;</span><span class="p">]</span>
    <span class="k">return</span> <span class="n">df_final</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>

<div class="doc doc-object doc-function">


<h2 id="S2_Funciones.split_querys" class="doc doc-heading">
            <code class="highlight language-python"><span class="n">split_querys</span><span class="p">(</span><span class="n">df</span><span class="p">,</span> <span class="n">parametros_split_filter</span><span class="p">,</span> <span class="n">ruta_exportar_query</span><span class="p">,</span> <span class="n">terminacion_archivo</span><span class="p">,</span> <span class="n">sistema</span><span class="p">)</span></code>

</h2>


    <div class="doc doc-contents ">

        <p>Proceso que apertura una query extraida en caso de ser necesario</p>


<p><span class="doc-section-title">Parameters:</span></p>
    <table>
      <thead>
        <tr>
          <th>Name</th>
          <th>Type</th>
          <th>Description</th>
          <th>Default</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
                <code>df</code>
            </td>
            <td>
                  <code><span title="pandas.DataFrame">DataFrame</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>consulta original extraida</p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>parametros_split_filter</code>
            </td>
            <td>
                  <code><span title="pandas.DataFrame">DataFrame</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>informacion de la apertura que debemos hacer</p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>ruta_exportar_query</code>
            </td>
            <td>
                  <code>str</code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Ruta a exportar</p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>terminacion_archivo</code>
            </td>
            <td>
                  <code>str</code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Terminacion del archivo de exportacion</p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>sistema</code>
            </td>
            <td>
                  <code>str</code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Sistema de Adm de BBDD (GES o IAXIS)</p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
      </tbody>
    </table>

            <details class="quote">
              <summary>Source code in <code>S2_Funciones.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">1249</span>
<span class="normal">1250</span>
<span class="normal">1251</span>
<span class="normal">1252</span>
<span class="normal">1253</span>
<span class="normal">1254</span>
<span class="normal">1255</span>
<span class="normal">1256</span>
<span class="normal">1257</span>
<span class="normal">1258</span>
<span class="normal">1259</span>
<span class="normal">1260</span>
<span class="normal">1261</span>
<span class="normal">1262</span>
<span class="normal">1263</span>
<span class="normal">1264</span>
<span class="normal">1265</span>
<span class="normal">1266</span>
<span class="normal">1267</span>
<span class="normal">1268</span>
<span class="normal">1269</span>
<span class="normal">1270</span>
<span class="normal">1271</span>
<span class="normal">1272</span>
<span class="normal">1273</span>
<span class="normal">1274</span>
<span class="normal">1275</span>
<span class="normal">1276</span>
<span class="normal">1277</span>
<span class="normal">1278</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span> <span class="nf">split_querys</span><span class="p">(</span><span class="n">df</span><span class="p">:</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">,</span><span class="n">parametros_split_filter</span><span class="p">:</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">,</span><span class="n">ruta_exportar_query</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span><span class="n">terminacion_archivo</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span><span class="n">sistema</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Proceso que apertura una query extraida en caso de ser necesario</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    df : pd.DataFrame</span>
<span class="sd">        consulta original extraida</span>
<span class="sd">    parametros_split_filter : pd.DataFrame</span>
<span class="sd">        informacion de la apertura que debemos hacer</span>
<span class="sd">    ruta_exportar_query : str</span>
<span class="sd">        Ruta a exportar</span>
<span class="sd">    terminacion_archivo : str</span>
<span class="sd">        Terminacion del archivo de exportacion</span>
<span class="sd">    sistema : str</span>
<span class="sd">        Sistema de Adm de BBDD (GES o IAXIS)</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">df_aux</span><span class="o">=</span><span class="n">df</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
    <span class="k">for</span> <span class="n">index</span><span class="p">,</span><span class="n">row</span> <span class="ow">in</span> <span class="n">parametros_split_filter</span><span class="o">.</span><span class="n">iterrows</span><span class="p">():</span>
        <span class="n">contrato</span><span class="o">=</span><span class="n">row</span><span class="p">[</span><span class="s1">&#39;CONTRATO&#39;</span><span class="p">]</span>
        <span class="n">productos</span><span class="o">=</span><span class="nb">list</span><span class="p">(</span><span class="nb">map</span><span class="p">(</span><span class="nb">int</span><span class="p">,</span><span class="n">row</span><span class="p">[</span><span class="s1">&#39;PRODUCTOS CONTRATO&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;-&#39;</span><span class="p">)))</span> <span class="k">if</span> <span class="n">row</span><span class="p">[</span><span class="s1">&#39;PRODUCTOS CONTRATO&#39;</span><span class="p">]</span> <span class="k">else</span> <span class="s1">&#39;&#39;</span>
        <span class="n">polizas</span><span class="o">=</span><span class="nb">list</span><span class="p">(</span><span class="nb">map</span><span class="p">(</span><span class="nb">int</span><span class="p">,</span><span class="n">row</span><span class="p">[</span><span class="s1">&#39;POLIZAS CONTRATO&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;-&#39;</span><span class="p">)))</span> <span class="k">if</span> <span class="n">row</span><span class="p">[</span><span class="s1">&#39;POLIZAS CONTRATO&#39;</span><span class="p">]</span> <span class="k">else</span> <span class="s1">&#39;&#39;</span>
        <span class="n">tipo_condicion</span><span class="o">=</span><span class="n">row</span><span class="p">[</span><span class="s1">&#39;TIPO CONDICION&#39;</span><span class="p">]</span>
        <span class="n">aplica_split</span><span class="o">=</span><span class="n">row</span><span class="p">[</span><span class="s1">&#39;APLICA&#39;</span><span class="p">]</span>
        <span class="n">cond_prods</span><span class="o">=</span><span class="n">pd</span><span class="o">.</span><span class="n">Series</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">full</span><span class="p">(</span><span class="n">df_aux</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span><span class="kc">True</span><span class="p">))</span> <span class="k">if</span> <span class="ow">not</span> <span class="n">productos</span> <span class="k">else</span> <span class="n">df_aux</span><span class="p">[</span><span class="s1">&#39;PRODUCTO&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">isin</span><span class="p">(</span><span class="n">productos</span><span class="p">)</span> <span class="k">if</span> <span class="n">tipo_condicion</span><span class="o">==</span><span class="mi">1</span> <span class="k">else</span> <span class="o">~</span><span class="n">df_aux</span><span class="p">[</span><span class="s1">&#39;PRODUCTO&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">isin</span><span class="p">(</span><span class="n">productos</span><span class="p">)</span>
        <span class="n">cond_pols</span><span class="o">=</span><span class="n">pd</span><span class="o">.</span><span class="n">Series</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">full</span><span class="p">(</span><span class="n">df_aux</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span><span class="kc">True</span><span class="p">))</span> <span class="k">if</span> <span class="ow">not</span> <span class="n">polizas</span> <span class="k">else</span> <span class="n">df_aux</span><span class="p">[</span><span class="s1">&#39;POLIZA&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">isin</span><span class="p">(</span><span class="n">polizas</span><span class="p">)</span> <span class="k">if</span> <span class="n">tipo_condicion</span><span class="o">==</span><span class="mi">1</span> <span class="k">else</span> <span class="o">~</span><span class="n">df_aux</span><span class="p">[</span><span class="s1">&#39;POLIZA&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">isin</span><span class="p">(</span><span class="n">polizas</span><span class="p">)</span>
        <span class="n">df_export</span><span class="o">=</span><span class="n">df_aux</span><span class="p">[</span><span class="n">cond_prods</span><span class="o">&amp;</span><span class="n">cond_pols</span><span class="p">]</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
        <span class="n">df_aux</span><span class="o">=</span><span class="n">df_aux</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">df_aux</span><span class="o">.</span><span class="n">index</span><span class="o">.</span><span class="n">difference</span><span class="p">(</span><span class="n">df_export</span><span class="o">.</span><span class="n">index</span><span class="p">)]</span><span class="o">.</span><span class="n">reset_index</span><span class="p">(</span><span class="n">drop</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
        <span class="n">terminacion_ges</span><span class="o">=</span><span class="s1">&#39; GES&#39;</span> <span class="k">if</span> <span class="n">sistema</span><span class="o">==</span><span class="s1">&#39;GES&#39;</span> <span class="k">else</span> <span class="s1">&#39;&#39;</span>
        <span class="n">Path</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">ruta_exportar_query</span><span class="si">}{</span><span class="n">contrato</span><span class="si">}</span><span class="se">\\</span><span class="s1">&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">mkdir</span><span class="p">(</span><span class="n">parents</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">exist_ok</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
        <span class="k">if</span> <span class="p">(</span><span class="ow">not</span> <span class="n">df_export</span><span class="o">.</span><span class="n">empty</span><span class="p">)</span><span class="o">&amp;</span><span class="p">(</span><span class="n">aplica_split</span><span class="o">==</span><span class="mi">1</span><span class="p">):</span> <span class="n">df_export</span><span class="o">.</span><span class="n">to_csv</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">ruta_exportar_query</span><span class="si">}{</span><span class="n">contrato</span><span class="si">}</span><span class="se">\\</span><span class="s1">Expuestos </span><span class="si">{</span><span class="n">contrato</span><span class="si">}{</span><span class="n">terminacion_ges</span><span class="si">}{</span><span class="n">terminacion_archivo</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">,</span><span class="n">sep</span><span class="o">=</span><span class="s1">&#39;;&#39;</span><span class="p">,</span><span class="n">decimal</span><span class="o">=</span><span class="s1">&#39;.&#39;</span><span class="p">,</span><span class="n">encoding</span><span class="o">=</span><span class="s1">&#39;UTF-8&#39;</span><span class="p">,</span><span class="n">date_format</span><span class="o">=</span><span class="s1">&#39;</span><span class="si">%d</span><span class="s1">-%m-%Y&#39;</span><span class="p">,</span><span class="n">index</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>



  </div>

    </div>

</div>

<div class="doc doc-object doc-module">



<a id="S3_Pre_Procesamiento"></a>
    <div class="doc doc-contents first">

        <p>Preprocesamiento de las bases de datos</p>








  <div class="doc doc-children">









<div class="doc doc-object doc-function">


<h2 id="S3_Pre_Procesamiento.pre_procesamiento" class="doc doc-heading">
            <code class="highlight language-python"><span class="n">pre_procesamiento</span><span class="p">(</span><span class="n">parameters</span><span class="p">,</span> <span class="n">tables</span><span class="p">)</span></code>

</h2>


    <div class="doc doc-contents ">

        <p>Funcion de preprocesamiento de la data
Leemos la data proveniente de ambos sistemas de administracion de bases de datos (GES e IAXIS) y entregamos una unica salida que será el input de los calculos de reaseguro (prima o siniestros)
Antes de realizar los calculos de asignacion de contratos de reaseguro, calculo de primas de reaseguro y cesiones, debemos hacer ciertas transformaciones a la data
Estas dependerán principalmente de que contrato de reaseguro estemos trabajando, o si el contrato es de prima unica o recurrente
Tambien hay un tratamiento completamente diferente cuando trabajamos los siniestros, que se dividen entre Vida y Generales</p>


<p><span class="doc-section-title">Parameters:</span></p>
    <table>
      <thead>
        <tr>
          <th>Name</th>
          <th>Type</th>
          <th>Description</th>
          <th>Default</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
                <code>parameters</code>
            </td>
            <td>
                  <code><a class="autorefs autorefs-internal" title="S0_Loaders.Parameter_Loader" href="#S0_Loaders.Parameter_Loader">Parameter_Loader</a></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Contiene los parametros del calculo</p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>tables</code>
            </td>
            <td>
                  <code><a class="autorefs autorefs-internal" title="S0_Loaders.Parameter_Loader" href="#S0_Loaders.Parameter_Loader">Parameter_Loader</a></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Contiene las tablas que ayudan a calcular los contratos de reaseguro</p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
      </tbody>
    </table>


    <p><span class="doc-section-title">Returns:</span></p>
    <table>
      <thead>
        <tr>
          <th>Type</th>
          <th>Description</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
                  <code><span title="pandas.DataFrame">DataFrame</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Entrega el dataframe listo para ser procesado por el calculador de prima de reaseguro o de siniestros de reaseguro, segun corresponda</p>
              </div>
            </td>
          </tr>
      </tbody>
    </table>

            <details class="quote">
              <summary>Source code in <code>S3_Pre_Procesamiento.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"> 18</span>
<span class="normal"> 19</span>
<span class="normal"> 20</span>
<span class="normal"> 21</span>
<span class="normal"> 22</span>
<span class="normal"> 23</span>
<span class="normal"> 24</span>
<span class="normal"> 25</span>
<span class="normal"> 26</span>
<span class="normal"> 27</span>
<span class="normal"> 28</span>
<span class="normal"> 29</span>
<span class="normal"> 30</span>
<span class="normal"> 31</span>
<span class="normal"> 32</span>
<span class="normal"> 33</span>
<span class="normal"> 34</span>
<span class="normal"> 35</span>
<span class="normal"> 36</span>
<span class="normal"> 37</span>
<span class="normal"> 38</span>
<span class="normal"> 39</span>
<span class="normal"> 40</span>
<span class="normal"> 41</span>
<span class="normal"> 42</span>
<span class="normal"> 43</span>
<span class="normal"> 44</span>
<span class="normal"> 45</span>
<span class="normal"> 46</span>
<span class="normal"> 47</span>
<span class="normal"> 48</span>
<span class="normal"> 49</span>
<span class="normal"> 50</span>
<span class="normal"> 51</span>
<span class="normal"> 52</span>
<span class="normal"> 53</span>
<span class="normal"> 54</span>
<span class="normal"> 55</span>
<span class="normal"> 56</span>
<span class="normal"> 57</span>
<span class="normal"> 58</span>
<span class="normal"> 59</span>
<span class="normal"> 60</span>
<span class="normal"> 61</span>
<span class="normal"> 62</span>
<span class="normal"> 63</span>
<span class="normal"> 64</span>
<span class="normal"> 65</span>
<span class="normal"> 66</span>
<span class="normal"> 67</span>
<span class="normal"> 68</span>
<span class="normal"> 69</span>
<span class="normal"> 70</span>
<span class="normal"> 71</span>
<span class="normal"> 72</span>
<span class="normal"> 73</span>
<span class="normal"> 74</span>
<span class="normal"> 75</span>
<span class="normal"> 76</span>
<span class="normal"> 77</span>
<span class="normal"> 78</span>
<span class="normal"> 79</span>
<span class="normal"> 80</span>
<span class="normal"> 81</span>
<span class="normal"> 82</span>
<span class="normal"> 83</span>
<span class="normal"> 84</span>
<span class="normal"> 85</span>
<span class="normal"> 86</span>
<span class="normal"> 87</span>
<span class="normal"> 88</span>
<span class="normal"> 89</span>
<span class="normal"> 90</span>
<span class="normal"> 91</span>
<span class="normal"> 92</span>
<span class="normal"> 93</span>
<span class="normal"> 94</span>
<span class="normal"> 95</span>
<span class="normal"> 96</span>
<span class="normal"> 97</span>
<span class="normal"> 98</span>
<span class="normal"> 99</span>
<span class="normal">100</span>
<span class="normal">101</span>
<span class="normal">102</span>
<span class="normal">103</span>
<span class="normal">104</span>
<span class="normal">105</span>
<span class="normal">106</span>
<span class="normal">107</span>
<span class="normal">108</span>
<span class="normal">109</span>
<span class="normal">110</span>
<span class="normal">111</span>
<span class="normal">112</span>
<span class="normal">113</span>
<span class="normal">114</span>
<span class="normal">115</span>
<span class="normal">116</span>
<span class="normal">117</span>
<span class="normal">118</span>
<span class="normal">119</span>
<span class="normal">120</span>
<span class="normal">121</span>
<span class="normal">122</span>
<span class="normal">123</span>
<span class="normal">124</span>
<span class="normal">125</span>
<span class="normal">126</span>
<span class="normal">127</span>
<span class="normal">128</span>
<span class="normal">129</span>
<span class="normal">130</span>
<span class="normal">131</span>
<span class="normal">132</span>
<span class="normal">133</span>
<span class="normal">134</span>
<span class="normal">135</span>
<span class="normal">136</span>
<span class="normal">137</span>
<span class="normal">138</span>
<span class="normal">139</span>
<span class="normal">140</span>
<span class="normal">141</span>
<span class="normal">142</span>
<span class="normal">143</span>
<span class="normal">144</span>
<span class="normal">145</span>
<span class="normal">146</span>
<span class="normal">147</span>
<span class="normal">148</span>
<span class="normal">149</span>
<span class="normal">150</span>
<span class="normal">151</span>
<span class="normal">152</span>
<span class="normal">153</span>
<span class="normal">154</span>
<span class="normal">155</span>
<span class="normal">156</span>
<span class="normal">157</span>
<span class="normal">158</span>
<span class="normal">159</span>
<span class="normal">160</span>
<span class="normal">161</span>
<span class="normal">162</span>
<span class="normal">163</span>
<span class="normal">164</span>
<span class="normal">165</span>
<span class="normal">166</span>
<span class="normal">167</span>
<span class="normal">168</span>
<span class="normal">169</span>
<span class="normal">170</span>
<span class="normal">171</span>
<span class="normal">172</span>
<span class="normal">173</span>
<span class="normal">174</span>
<span class="normal">175</span>
<span class="normal">176</span>
<span class="normal">177</span>
<span class="normal">178</span>
<span class="normal">179</span>
<span class="normal">180</span>
<span class="normal">181</span>
<span class="normal">182</span>
<span class="normal">183</span>
<span class="normal">184</span>
<span class="normal">185</span>
<span class="normal">186</span>
<span class="normal">187</span>
<span class="normal">188</span>
<span class="normal">189</span>
<span class="normal">190</span>
<span class="normal">191</span>
<span class="normal">192</span>
<span class="normal">193</span>
<span class="normal">194</span>
<span class="normal">195</span>
<span class="normal">196</span>
<span class="normal">197</span>
<span class="normal">198</span>
<span class="normal">199</span>
<span class="normal">200</span>
<span class="normal">201</span>
<span class="normal">202</span>
<span class="normal">203</span>
<span class="normal">204</span>
<span class="normal">205</span>
<span class="normal">206</span>
<span class="normal">207</span>
<span class="normal">208</span>
<span class="normal">209</span>
<span class="normal">210</span>
<span class="normal">211</span>
<span class="normal">212</span>
<span class="normal">213</span>
<span class="normal">214</span>
<span class="normal">215</span>
<span class="normal">216</span>
<span class="normal">217</span>
<span class="normal">218</span>
<span class="normal">219</span>
<span class="normal">220</span>
<span class="normal">221</span>
<span class="normal">222</span>
<span class="normal">223</span>
<span class="normal">224</span>
<span class="normal">225</span>
<span class="normal">226</span>
<span class="normal">227</span>
<span class="normal">228</span>
<span class="normal">229</span>
<span class="normal">230</span>
<span class="normal">231</span>
<span class="normal">232</span>
<span class="normal">233</span>
<span class="normal">234</span>
<span class="normal">235</span>
<span class="normal">236</span>
<span class="normal">237</span>
<span class="normal">238</span>
<span class="normal">239</span>
<span class="normal">240</span>
<span class="normal">241</span>
<span class="normal">242</span>
<span class="normal">243</span>
<span class="normal">244</span>
<span class="normal">245</span>
<span class="normal">246</span>
<span class="normal">247</span>
<span class="normal">248</span>
<span class="normal">249</span>
<span class="normal">250</span>
<span class="normal">251</span>
<span class="normal">252</span>
<span class="normal">253</span>
<span class="normal">254</span>
<span class="normal">255</span>
<span class="normal">256</span>
<span class="normal">257</span>
<span class="normal">258</span>
<span class="normal">259</span>
<span class="normal">260</span>
<span class="normal">261</span>
<span class="normal">262</span>
<span class="normal">263</span>
<span class="normal">264</span>
<span class="normal">265</span>
<span class="normal">266</span>
<span class="normal">267</span>
<span class="normal">268</span>
<span class="normal">269</span>
<span class="normal">270</span>
<span class="normal">271</span>
<span class="normal">272</span>
<span class="normal">273</span>
<span class="normal">274</span>
<span class="normal">275</span>
<span class="normal">276</span>
<span class="normal">277</span>
<span class="normal">278</span>
<span class="normal">279</span>
<span class="normal">280</span>
<span class="normal">281</span>
<span class="normal">282</span>
<span class="normal">283</span>
<span class="normal">284</span>
<span class="normal">285</span>
<span class="normal">286</span>
<span class="normal">287</span>
<span class="normal">288</span>
<span class="normal">289</span>
<span class="normal">290</span>
<span class="normal">291</span>
<span class="normal">292</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span> <span class="nf">pre_procesamiento</span><span class="p">(</span><span class="n">parameters</span><span class="p">:</span> <span class="n">Parameter_Loader</span><span class="p">,</span> <span class="n">tables</span><span class="p">:</span> <span class="n">Parameter_Loader</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Funcion de preprocesamiento de la data</span>
<span class="sd">    Leemos la data proveniente de ambos sistemas de administracion de bases de datos (GES e IAXIS) y entregamos una unica salida que será el input de los calculos de reaseguro (prima o siniestros)</span>
<span class="sd">    Antes de realizar los calculos de asignacion de contratos de reaseguro, calculo de primas de reaseguro y cesiones, debemos hacer ciertas transformaciones a la data</span>
<span class="sd">    Estas dependerán principalmente de que contrato de reaseguro estemos trabajando, o si el contrato es de prima unica o recurrente</span>
<span class="sd">    Tambien hay un tratamiento completamente diferente cuando trabajamos los siniestros, que se dividen entre Vida y Generales</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    parameters : Parameter_Loader</span>
<span class="sd">        Contiene los parametros del calculo </span>
<span class="sd">    tables : Parameter_Loader</span>
<span class="sd">        Contiene las tablas que ayudan a calcular los contratos de reaseguro</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    pd.DataFrame</span>
<span class="sd">        Entrega el dataframe listo para ser procesado por el calculador de prima de reaseguro o de siniestros de reaseguro, segun corresponda</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="c1"># * definimos variables de uso frecuente dentro de `parameters` que se utilizaran en la funcion</span>
    <span class="c1"># Caracteristicas del contrato</span>
    <span class="n">tipo_calculo</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="n">parameters</span><span class="o">.</span><span class="n">parameters</span><span class="p">[</span><span class="s1">&#39;tipo_calculo&#39;</span><span class="p">]</span>
    <span class="n">tipo_contrato</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="n">parameters</span><span class="o">.</span><span class="n">parameters</span><span class="p">[</span><span class="s1">&#39;tipo_contrato&#39;</span><span class="p">]</span>
    <span class="n">contrato</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="n">parameters</span><span class="o">.</span><span class="n">parameters</span><span class="p">[</span><span class="s1">&#39;contrato&#39;</span><span class="p">]</span>
    <span class="n">clasificacion_contrato</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="n">parameters</span><span class="o">.</span><span class="n">parameters</span><span class="p">[</span><span class="s1">&#39;clasificacion_contrato&#39;</span><span class="p">]</span>
    <span class="c1"># Fechas de cierre</span>
    <span class="n">fecha_cierre</span><span class="p">:</span> <span class="n">datetime</span><span class="o">.</span><span class="n">datetime</span> <span class="o">=</span> <span class="n">parameters</span><span class="o">.</span><span class="n">parameters</span><span class="p">[</span><span class="s1">&#39;fecha_cierre&#39;</span><span class="p">]</span>
    <span class="n">fecha_inicio_mes</span><span class="p">:</span> <span class="n">datetime</span><span class="o">.</span><span class="n">datetime</span> <span class="o">=</span> <span class="n">parameters</span><span class="o">.</span><span class="n">parameters</span><span class="p">[</span><span class="s1">&#39;fecha_inicio_mes&#39;</span><span class="p">]</span>
    <span class="n">periodo</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="n">parameters</span><span class="o">.</span><span class="n">parameters</span><span class="p">[</span><span class="s1">&#39;periodo&#39;</span><span class="p">]</span>
    <span class="c1"># Campos tecnicos mas especializados</span>
    <span class="n">campo_rut_duplicados</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="n">parameters</span><span class="o">.</span><span class="n">parameters</span><span class="p">[</span><span class="s1">&#39;campo_rut_duplicados&#39;</span><span class="p">]</span>
    <span class="n">edad_casos_perdidos</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="n">parameters</span><span class="o">.</span><span class="n">parameters</span><span class="p">[</span><span class="s1">&#39;edad_casos_perdidos&#39;</span><span class="p">]</span>
    <span class="n">dias_exposicion</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="n">parameters</span><span class="o">.</span><span class="n">parameters</span><span class="p">[</span><span class="s1">&#39;dias_exposicion&#39;</span><span class="p">]</span>
    <span class="n">tdm_mensual</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="n">parameters</span><span class="o">.</span><span class="n">parameters</span><span class="p">[</span><span class="s1">&#39;tdm_mensual&#39;</span><span class="p">]</span>
    <span class="n">archivo_reporte</span><span class="p">:</span> <span class="n">Any</span> <span class="o">=</span> <span class="n">parameters</span><span class="o">.</span><span class="n">parameters</span><span class="p">[</span><span class="s1">&#39;archivo_reporte&#39;</span><span class="p">]</span>
    <span class="c1"># Sobre que bases considerar y cuales nombres tienen los archivos que debemos leer</span>
    <span class="n">base_iaxis</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="n">parameters</span><span class="o">.</span><span class="n">parameters</span><span class="p">[</span><span class="s1">&#39;base_iaxis&#39;</span><span class="p">]</span>
    <span class="n">base_ges</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="n">parameters</span><span class="o">.</span><span class="n">parameters</span><span class="p">[</span><span class="s1">&#39;base_ges&#39;</span><span class="p">]</span>   
    <span class="n">archivo_input</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="n">parameters</span><span class="o">.</span><span class="n">parameters</span><span class="p">[</span><span class="s1">&#39;archivo_input&#39;</span><span class="p">]</span>
    <span class="n">archivo_input_ges</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="n">parameters</span><span class="o">.</span><span class="n">parameters</span><span class="p">[</span><span class="s1">&#39;archivo_input_ges&#39;</span><span class="p">]</span>
    <span class="c1"># Sobre como debemos importar y exportar la data</span>
    <span class="n">separador_input</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="n">parameters</span><span class="o">.</span><span class="n">parameters</span><span class="p">[</span><span class="s1">&#39;separador_input&#39;</span><span class="p">]</span>
    <span class="n">decimal_input</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="n">parameters</span><span class="o">.</span><span class="n">parameters</span><span class="p">[</span><span class="s1">&#39;decimal_input&#39;</span><span class="p">]</span>
    <span class="n">separador_output</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="n">parameters</span><span class="o">.</span><span class="n">parameters</span><span class="p">[</span><span class="s1">&#39;separador_output&#39;</span><span class="p">]</span>
    <span class="n">decimal_output</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="n">parameters</span><span class="o">.</span><span class="n">parameters</span><span class="p">[</span><span class="s1">&#39;decimal_output&#39;</span><span class="p">]</span>
    <span class="c1"># Rutas de entradas y de salidas</span>
    <span class="n">ruta_output</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="n">parameters</span><span class="o">.</span><span class="n">parameters</span><span class="p">[</span><span class="s1">&#39;ruta_output&#39;</span><span class="p">]</span>
    <span class="n">ruta_input</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="n">parameters</span><span class="o">.</span><span class="n">parameters</span><span class="p">[</span><span class="s1">&#39;ruta_input&#39;</span><span class="p">]</span>
    <span class="n">ruta_pyme</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="n">parameters</span><span class="o">.</span><span class="n">parameters</span><span class="p">[</span><span class="s1">&#39;ruta_pyme&#39;</span><span class="p">]</span>
    <span class="n">ruta_otros</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="n">parameters</span><span class="o">.</span><span class="n">parameters</span><span class="p">[</span><span class="s1">&#39;ruta_otros&#39;</span><span class="p">]</span>
    <span class="n">ruta_si</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="n">parameters</span><span class="o">.</span><span class="n">parameters</span><span class="p">[</span><span class="s1">&#39;ruta_si&#39;</span><span class="p">]</span>
    <span class="n">ruta_uso_seguro</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="n">parameters</span><span class="o">.</span><span class="n">parameters</span><span class="p">[</span><span class="s1">&#39;ruta_uso_seguro&#39;</span><span class="p">]</span>

    <span class="c1"># Algunas escrituras en pantalla y en el archivo de reportes</span>
    <span class="n">escribe_reporta</span><span class="p">(</span><span class="n">archivo_reporte</span><span class="p">,</span><span class="s1">&#39;COMIENZA LA LECTURA DE LAS BASES DE DATOS:</span><span class="se">\n</span><span class="si">{}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">time</span><span class="o">.</span><span class="n">strftime</span><span class="p">(</span><span class="s1">&#39;%Y-%m-</span><span class="si">%d</span><span class="s1"> %H:%M:%S&#39;</span><span class="p">,</span> <span class="n">time</span><span class="o">.</span><span class="n">localtime</span><span class="p">(</span><span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()))))</span>
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;Contrato </span><span class="si">{</span><span class="n">contrato</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>

    <span class="c1"># * preprocesamiento de los expuestos (para calculo de prima de reaseguro)</span>
    <span class="k">if</span> <span class="n">tipo_calculo</span><span class="o">==</span><span class="s1">&#39;Prima de Reaseguro&#39;</span><span class="p">:</span>
        <span class="c1"># Inputs de otras fuentes</span>
        <span class="n">polizas_pyme</span><span class="p">:</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span> <span class="o">=</span> <span class="n">tables</span><span class="o">.</span><span class="n">get_table_txt</span><span class="p">(</span><span class="n">file_path</span><span class="o">=</span><span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">ruta_pyme</span><span class="si">}</span><span class="s1">1. Inputs Auxiliares</span><span class="se">\\</span><span class="s1">Polizas Pyme</span><span class="se">\\</span><span class="s1">Polizas Pyme.txt&#39;</span><span class="p">,</span> <span class="n">decimal</span><span class="o">=</span><span class="n">decimal_input</span><span class="p">,</span> <span class="n">separador</span><span class="o">=</span><span class="n">separador_input</span><span class="p">,</span> <span class="n">campos_fecha</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
        <span class="n">cti</span><span class="p">:</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span> <span class="o">=</span> <span class="n">tables</span><span class="o">.</span><span class="n">get_table_txt</span><span class="p">(</span><span class="n">file_path</span><span class="o">=</span><span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">ruta_otros</span><span class="si">}</span><span class="s1">1. Inputs Auxiliares</span><span class="se">\\</span><span class="s1">Otros</span><span class="se">\\</span><span class="s1">CTI.txt&#39;</span><span class="p">,</span> <span class="n">decimal</span><span class="o">=</span><span class="n">decimal_input</span><span class="p">,</span> <span class="n">separador</span><span class="o">=</span><span class="n">separador_input</span><span class="p">,</span> <span class="n">campos_fecha</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
        <span class="n">innominadas</span><span class="p">:</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span> <span class="o">=</span> <span class="n">tables</span><span class="o">.</span><span class="n">get_table_txt</span><span class="p">(</span><span class="n">file_path</span><span class="o">=</span><span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">ruta_otros</span><span class="si">}</span><span class="s1">1. Inputs Auxiliares</span><span class="se">\\</span><span class="s1">Otros</span><span class="se">\\</span><span class="s1">polizas_innominadas.txt&#39;</span><span class="p">,</span> <span class="n">decimal</span><span class="o">=</span><span class="n">decimal_input</span><span class="p">,</span> <span class="n">separador</span><span class="o">=</span><span class="n">separador_input</span><span class="p">,</span> <span class="n">campos_fecha</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
        <span class="n">cobs_ges</span><span class="p">:</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span> <span class="o">=</span> <span class="n">tables</span><span class="o">.</span><span class="n">get_table_xlsx</span><span class="p">(</span><span class="n">sheet_name</span> <span class="o">=</span> <span class="s1">&#39;Coberturas GES&#39;</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">contrato</span><span class="o">==</span><span class="s1">&#39;Complementario UC&#39;</span><span class="p">:</span> <span class="n">uso_seguro_com_uc</span><span class="p">:</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span> <span class="o">=</span> <span class="n">tables</span><span class="o">.</span><span class="n">get_table_txt</span><span class="p">(</span><span class="n">file_path</span><span class="o">=</span><span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">ruta_uso_seguro</span><span class="si">}</span><span class="s1">1. Inputs Auxiliares</span><span class="se">\\</span><span class="s1">Com UC</span><span class="se">\\</span><span class="s1">COM UC Uso del Seguro Hist </span><span class="si">{</span><span class="n">periodo</span><span class="si">}</span><span class="s1">.txt&#39;</span><span class="p">,</span> <span class="n">decimal</span><span class="o">=</span><span class="n">decimal_input</span><span class="p">,</span> <span class="n">separador</span><span class="o">=</span><span class="n">separador_input</span><span class="p">,</span> <span class="n">campos_fecha</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
        <span class="c1"># Dependiendo del contrato, son diferentes los campos de tipo fecha que debemos transformar</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">tipo_contrato</span><span class="o">==</span><span class="s1">&#39;Vida&#39;</span><span class="p">)</span><span class="o">&amp;</span><span class="p">(</span><span class="n">contrato</span> <span class="ow">not</span> <span class="ow">in</span> <span class="p">[</span><span class="s1">&#39;K-Fijo&#39;</span><span class="p">,</span><span class="s1">&#39;Desgravamen No Licitado&#39;</span><span class="p">,</span><span class="s1">&#39;Multisocios&#39;</span><span class="p">]):</span> <span class="n">cols_date</span><span class="p">,</span><span class="n">cols_date_ges</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;FEC_NAC&#39;</span><span class="p">,</span><span class="s1">&#39;FECHA_EFECTO&#39;</span><span class="p">,</span><span class="s1">&#39;FECHA_VENCIMIENTO&#39;</span><span class="p">,</span><span class="s1">&#39;FINI_RENOV_ANUAL&#39;</span><span class="p">,</span><span class="s1">&#39;FFIN_RENOV_ANUAL&#39;</span><span class="p">,</span><span class="s1">&#39;FECHA_ANULACION&#39;</span><span class="p">],[</span><span class="s1">&#39;FEC_NAC&#39;</span><span class="p">,</span><span class="s1">&#39;FECHA_EFECTO&#39;</span><span class="p">,</span><span class="s1">&#39;FECHA_VENCIMIENTO&#39;</span><span class="p">]</span>
        <span class="k">elif</span> <span class="p">(</span><span class="n">tipo_contrato</span><span class="o">==</span><span class="s1">&#39;Vida&#39;</span><span class="p">)</span><span class="o">&amp;</span><span class="p">(</span><span class="n">contrato</span> <span class="ow">in</span> <span class="p">[</span><span class="s1">&#39;Desgravamen No Licitado&#39;</span><span class="p">,</span><span class="s1">&#39;Multisocios&#39;</span><span class="p">]):</span> <span class="n">cols_date</span><span class="p">,</span><span class="n">cols_date_ges</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;FEC_NAC&#39;</span><span class="p">,</span><span class="s1">&#39;FECHA_EFECTO&#39;</span><span class="p">,</span><span class="s1">&#39;FECHA_VENCIMIENTO&#39;</span><span class="p">,</span><span class="s1">&#39;FINI_RENOV_ANUAL&#39;</span><span class="p">,</span><span class="s1">&#39;FFIN_RENOV_ANUAL&#39;</span><span class="p">,</span><span class="s1">&#39;FECHA_ANULACION&#39;</span><span class="p">],[</span><span class="s1">&#39;FEC_NAC&#39;</span><span class="p">,</span><span class="s1">&#39;FECHA_EFECTO&#39;</span><span class="p">,</span><span class="s1">&#39;FECHA_VENCIMIENTO&#39;</span><span class="p">,</span><span class="s1">&#39;FECHA_INICIO_CRED&#39;</span><span class="p">,</span><span class="s1">&#39;FECHA_FIN_CRED&#39;</span><span class="p">]</span>
        <span class="k">elif</span> <span class="p">(</span><span class="n">tipo_contrato</span><span class="o">==</span><span class="s1">&#39;Vida&#39;</span><span class="p">)</span><span class="o">&amp;</span><span class="p">(</span><span class="n">contrato</span><span class="o">==</span><span class="s1">&#39;K-Fijo&#39;</span><span class="p">):</span> <span class="n">cols_date</span><span class="p">,</span><span class="n">cols_date_ges</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;FEC_NAC&#39;</span><span class="p">,</span><span class="s1">&#39;FECHA_EFECTO&#39;</span><span class="p">,</span><span class="s1">&#39;FECHA_VENCIMIENTO&#39;</span><span class="p">,</span><span class="s1">&#39;FECHA_ANULACION&#39;</span><span class="p">,</span><span class="s1">&#39;FECHA_CONTABILIZACION_ANULACION&#39;</span><span class="p">],[</span><span class="s1">&#39;FEC_NAC&#39;</span><span class="p">,</span><span class="s1">&#39;FECHA_EFECTO&#39;</span><span class="p">,</span><span class="s1">&#39;FECHA_VENCIMIENTO&#39;</span><span class="p">,</span><span class="s1">&#39;FECHA_PREPAGO&#39;</span><span class="p">,</span><span class="s1">&#39;FECHA_RENUNCIA&#39;</span><span class="p">,</span><span class="s1">&#39;FECHA_FIN_VIGENCIA&#39;</span><span class="p">]</span>
        <span class="k">elif</span> <span class="n">clasificacion_contrato</span> <span class="o">==</span><span class="s1">&#39;Cesantia PU&#39;</span><span class="p">:</span> <span class="n">cols_date</span><span class="p">,</span><span class="n">cols_date_ges</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;FEC_NAC&#39;</span><span class="p">,</span><span class="s1">&#39;FECHA_EFECTO&#39;</span><span class="p">,</span><span class="s1">&#39;FECHA_VENCIMIENTO&#39;</span><span class="p">,</span><span class="s1">&#39;FECHA_ANULACION&#39;</span><span class="p">,</span><span class="s1">&#39;FECHA_CONTABILIZACION_ANULACION&#39;</span><span class="p">],[</span><span class="s1">&#39;FEC_NAC&#39;</span><span class="p">,</span><span class="s1">&#39;FECHA_EFECTO&#39;</span><span class="p">,</span><span class="s1">&#39;FECHA_VENCIMIENTO&#39;</span><span class="p">,</span><span class="s1">&#39;FECHA_PREPAGO&#39;</span><span class="p">,</span><span class="s1">&#39;FECHA_RENUNCIA&#39;</span><span class="p">,</span><span class="s1">&#39;FECHA_FIN_VIGENCIA&#39;</span><span class="p">]</span>
        <span class="k">elif</span> <span class="p">(</span><span class="n">tipo_contrato</span><span class="o">==</span><span class="s1">&#39;Generales&#39;</span><span class="p">)</span><span class="o">&amp;</span><span class="p">(</span><span class="s1">&#39;Incendio y Sismo&#39;</span> <span class="ow">in</span> <span class="n">contrato</span><span class="p">):</span> <span class="n">cols_date</span><span class="p">,</span><span class="n">cols_date_ges</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;FECHA_EFECTO&#39;</span><span class="p">,</span><span class="s1">&#39;FECHA_VENCIMIENTO&#39;</span><span class="p">,</span><span class="s1">&#39;FINI_RENOV_ANUAL&#39;</span><span class="p">,</span><span class="s1">&#39;FFIN_RENOV_ANUAL&#39;</span><span class="p">,</span><span class="s1">&#39;FECHA_ANULACION&#39;</span><span class="p">],[</span><span class="s1">&#39;FECHA_EFECTO&#39;</span><span class="p">,</span><span class="s1">&#39;FECHA_VENCIMIENTO&#39;</span><span class="p">]</span>
        <span class="k">elif</span> <span class="p">(</span><span class="n">tipo_contrato</span><span class="o">==</span><span class="s1">&#39;Generales&#39;</span><span class="p">)</span><span class="o">&amp;</span><span class="p">(</span><span class="n">contrato</span><span class="o">==</span><span class="s1">&#39;Cesantia PR&#39;</span><span class="p">):</span> <span class="n">cols_date</span><span class="p">:</span> <span class="nb">list</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;FEC_NAC&#39;</span><span class="p">,</span><span class="s1">&#39;FECHA_EFECTO&#39;</span><span class="p">,</span><span class="s1">&#39;FECHA_VENCIMIENTO&#39;</span><span class="p">,</span><span class="s1">&#39;FINI_RENOV_ANUAL&#39;</span><span class="p">,</span><span class="s1">&#39;FFIN_RENOV_ANUAL&#39;</span><span class="p">,</span><span class="s1">&#39;FECHA_ANULACION&#39;</span><span class="p">]</span>
        <span class="c1"># * LECTURA DE BASES DE DATOS IAXIS</span>
        <span class="k">if</span> <span class="n">base_iaxis</span><span class="o">==</span><span class="mi">1</span><span class="p">:</span>
            <span class="c1"># Lectura de BBDD y tablas de parametria</span>
            <span class="n">df_iaxis</span><span class="p">:</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="o">=</span><span class="n">pd</span><span class="o">.</span><span class="n">read_csv</span><span class="p">(</span><span class="n">ruta_input</span><span class="o">+</span><span class="n">archivo_input</span><span class="p">,</span><span class="n">sep</span><span class="o">=</span><span class="n">separador_input</span><span class="p">,</span><span class="n">decimal</span><span class="o">=</span><span class="n">decimal_input</span><span class="p">,</span><span class="n">parse_dates</span><span class="o">=</span><span class="n">cols_date</span><span class="p">,</span><span class="n">date_format</span><span class="o">=</span><span class="s1">&#39;</span><span class="si">%d</span><span class="s1">-%m-%Y&#39;</span><span class="p">,</span><span class="n">encoding</span><span class="o">=</span><span class="s1">&#39;latin-1&#39;</span><span class="p">,</span><span class="n">low_memory</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
            <span class="n">estados_iaxis</span><span class="p">:</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span> <span class="o">=</span> <span class="n">tables</span><span class="o">.</span><span class="n">get_table_xlsx</span><span class="p">(</span><span class="n">sheet_name</span> <span class="o">=</span> <span class="s1">&#39;Estados IAXIS&#39;</span><span class="p">)</span>
            <span class="n">canales_venta</span><span class="p">:</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span> <span class="o">=</span> <span class="n">tables</span><span class="o">.</span><span class="n">get_table_xlsx</span><span class="p">(</span><span class="n">sheet_name</span> <span class="o">=</span> <span class="s1">&#39;Canal Venta&#39;</span><span class="p">)</span>
            <span class="k">for</span> <span class="n">col</span> <span class="ow">in</span> <span class="n">cols_date</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">df_iaxis</span><span class="p">[</span><span class="n">col</span><span class="p">]</span><span class="o">.</span><span class="n">dtype</span><span class="o">!=</span><span class="s1">&#39;datetime64[ns]&#39;</span><span class="p">:</span> <span class="n">df_iaxis</span><span class="p">[</span><span class="n">col</span><span class="p">]</span><span class="o">=</span><span class="n">pd</span><span class="o">.</span><span class="n">to_datetime</span><span class="p">(</span><span class="n">df_iaxis</span><span class="p">[</span><span class="n">col</span><span class="p">],</span><span class="nb">format</span> <span class="o">=</span> <span class="s1">&#39;</span><span class="si">%d</span><span class="s1">-%m-%Y&#39;</span><span class="p">,</span> <span class="n">errors</span><span class="o">=</span><span class="s1">&#39;coerce&#39;</span><span class="p">)</span>   
            <span class="c1"># Algunas transformaciones iniciales</span>
            <span class="n">df_iaxis</span><span class="p">[</span><span class="s1">&#39;IPRIANU&#39;</span><span class="p">]</span><span class="o">=</span><span class="nb">round</span><span class="p">(</span><span class="n">df_iaxis</span><span class="p">[</span><span class="s1">&#39;IPRIANU&#39;</span><span class="p">],</span><span class="mi">4</span><span class="p">)</span>
            <span class="n">df_iaxis</span><span class="p">[</span><span class="s1">&#39;ICAPITAL&#39;</span><span class="p">]</span><span class="o">=</span><span class="nb">round</span><span class="p">(</span><span class="n">df_iaxis</span><span class="p">[</span><span class="s1">&#39;ICAPITAL&#39;</span><span class="p">],</span><span class="mi">4</span><span class="p">)</span>
            <span class="n">df_iaxis</span><span class="p">[</span><span class="s1">&#39;BASE&#39;</span><span class="p">]</span><span class="o">=</span><span class="s1">&#39;IAXIS&#39;</span>
            <span class="k">if</span> <span class="s1">&#39;FECHA_CONTABILIZACION_ANULACION&#39;</span> <span class="ow">in</span> <span class="n">df_iaxis</span><span class="o">.</span><span class="n">columns</span><span class="p">:</span><span class="n">df_iaxis</span><span class="p">[</span><span class="s1">&#39;PERIODO_CONTABILIZACION&#39;</span><span class="p">]</span><span class="o">=</span><span class="n">df_iaxis</span><span class="p">[</span><span class="s1">&#39;FECHA_CONTABILIZACION_ANULACION&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">dt</span><span class="o">.</span><span class="n">year</span><span class="o">*</span><span class="mi">100</span><span class="o">+</span><span class="n">df_iaxis</span><span class="p">[</span><span class="s1">&#39;FECHA_CONTABILIZACION_ANULACION&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">dt</span><span class="o">.</span><span class="n">month</span>
            <span class="k">if</span> <span class="s1">&#39;NRO_OPERACION&#39;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">df_iaxis</span><span class="o">.</span><span class="n">columns</span><span class="p">:</span><span class="n">df_iaxis</span><span class="p">[</span><span class="s1">&#39;NRO_OPERACION&#39;</span><span class="p">]</span><span class="o">=</span><span class="mi">0</span>
            <span class="k">else</span><span class="p">:</span> <span class="n">df_iaxis</span><span class="p">[</span><span class="s1">&#39;NRO_OPERACION&#39;</span><span class="p">]</span><span class="o">=</span><span class="n">df_iaxis</span><span class="p">[</span><span class="s1">&#39;NRO_OPERACION&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">fillna</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
            <span class="c1"># Obtenemos nombre del canal de venta</span>
            <span class="k">if</span> <span class="s1">&#39;CANAL_VENTA&#39;</span> <span class="ow">in</span> <span class="n">df_iaxis</span><span class="o">.</span><span class="n">columns</span><span class="p">:</span> <span class="n">df_iaxis</span><span class="o">=</span><span class="n">df_iaxis</span><span class="o">.</span><span class="n">merge</span><span class="p">(</span><span class="n">canales_venta</span><span class="p">,</span><span class="n">how</span><span class="o">=</span><span class="s1">&#39;left&#39;</span><span class="p">,</span><span class="n">on</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;CANAL_VENTA&#39;</span><span class="p">])</span>
            <span class="c1"># uso del seguro para el contrato Complementario UC</span>
            <span class="k">if</span> <span class="n">contrato</span><span class="o">==</span><span class="s1">&#39;Complementario UC&#39;</span><span class="p">:</span> <span class="n">df_iaxis</span><span class="p">[</span><span class="s1">&#39;USO SEGURO&#39;</span><span class="p">]</span><span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">((</span><span class="n">df_iaxis</span><span class="p">[</span><span class="s1">&#39;SSEGURO&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">isin</span><span class="p">(</span><span class="n">uso_seguro_com_uc</span><span class="p">[</span><span class="s1">&#39;SSEGURO&#39;</span><span class="p">]))</span><span class="o">&amp;</span><span class="p">(</span><span class="n">df_iaxis</span><span class="p">[</span><span class="s1">&#39;MOTIVO_BAJA&#39;</span><span class="p">]</span><span class="o">==</span><span class="mi">306</span><span class="p">),</span><span class="mi">1</span><span class="p">,</span><span class="mi">0</span><span class="p">)</span>
            <span class="c1"># Tratamiento del campo PERIOD_TASA para aquellos contratos que poseen saldo insoluto</span>
            <span class="k">if</span> <span class="s1">&#39;PERIOD_TASA&#39;</span> <span class="ow">in</span> <span class="n">df_iaxis</span><span class="o">.</span><span class="n">columns</span><span class="p">:</span><span class="n">df_iaxis</span><span class="p">[</span><span class="s1">&#39;TASA_CRED&#39;</span><span class="p">]</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">df_iaxis</span><span class="p">[</span><span class="s1">&#39;PERIOD_TASA&#39;</span><span class="p">]</span><span class="o">==</span><span class="mi">12</span><span class="p">,</span><span class="n">df_iaxis</span><span class="p">[</span><span class="s1">&#39;TASA_CRED&#39;</span><span class="p">]</span><span class="o">/</span><span class="mi">100</span><span class="p">,</span><span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">df_iaxis</span><span class="p">[</span><span class="s1">&#39;PERIOD_TASA&#39;</span><span class="p">]</span><span class="o">==</span><span class="mi">1</span><span class="p">,(</span><span class="mi">1</span><span class="o">+</span><span class="n">df_iaxis</span><span class="p">[</span><span class="s1">&#39;TASA_CRED&#39;</span><span class="p">]</span><span class="o">/</span><span class="mi">100</span><span class="p">)</span><span class="o">**</span><span class="p">(</span><span class="mi">1</span><span class="o">/</span><span class="mi">12</span><span class="p">)</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span><span class="n">df_iaxis</span><span class="p">[</span><span class="s1">&#39;TASA_CRED&#39;</span><span class="p">]</span><span class="o">/</span><span class="mi">100</span><span class="p">))</span>
            <span class="c1"># Marcamos polizas CTI (Colectivo de Tratamiento Individual)</span>
            <span class="n">df_iaxis</span><span class="p">[</span><span class="s1">&#39;CTI&#39;</span><span class="p">]</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">df_iaxis</span><span class="p">[</span><span class="s1">&#39;PRODUCTO&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">isin</span><span class="p">(</span><span class="nb">list</span><span class="p">(</span><span class="n">cti</span><span class="p">[</span><span class="s1">&#39;PRODUCTO&#39;</span><span class="p">])),</span><span class="mi">1</span><span class="p">,</span><span class="mi">0</span><span class="p">)</span>
            <span class="c1"># VALIDADOR DE DATA 1: UNICIDAD DENTRO DE LA BASE IAXIS</span>
            <span class="n">cols_dup_iaxis</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;SSEGURO&#39;</span><span class="p">,</span><span class="s1">&#39;COD_COB&#39;</span><span class="p">,</span><span class="s1">&#39;NRIESGO&#39;</span><span class="p">]</span> <span class="k">if</span> <span class="n">tipo_contrato</span><span class="o">==</span><span class="s1">&#39;Vida&#39;</span> <span class="k">else</span> <span class="p">[</span><span class="s1">&#39;SSEGURO&#39;</span><span class="p">,</span><span class="s1">&#39;COD_COB&#39;</span><span class="p">]</span>
            <span class="n">duplicados_iaxis</span><span class="o">=</span><span class="n">df_iaxis</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">df_iaxis</span><span class="o">.</span><span class="n">duplicated</span><span class="p">(</span><span class="n">subset</span><span class="o">=</span><span class="n">cols_dup_iaxis</span><span class="p">,</span><span class="n">keep</span><span class="o">=</span><span class="kc">False</span><span class="p">)]</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="p">(</span><span class="n">duplicados_iaxis</span><span class="o">.</span><span class="n">empty</span><span class="p">):</span> 
                <span class="n">escribe_reporta</span><span class="p">(</span><span class="n">archivo_reporte</span><span class="p">,</span><span class="s1">&#39;El dataframe iAxis de entrada contiene </span><span class="si">{}</span><span class="s1"> registros duplicados. Revisar!&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">duplicados_iaxis</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]))</span>
                <span class="n">duplicados_iaxis</span><span class="o">.</span><span class="n">to_csv</span><span class="p">(</span><span class="n">ruta_output</span><span class="o">+</span><span class="s1">&#39;0.1.1 Duplicados iAxis.csv&#39;</span><span class="p">,</span><span class="n">sep</span><span class="o">=</span><span class="n">separador_output</span><span class="p">,</span><span class="n">decimal</span><span class="o">=</span><span class="n">decimal_output</span><span class="p">,</span><span class="n">date_format</span><span class="o">=</span><span class="s1">&#39;</span><span class="si">%d</span><span class="s1">-%m-%Y&#39;</span><span class="p">,</span><span class="n">index</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
                <span class="n">df_iaxis</span><span class="o">=</span><span class="n">df_iaxis</span><span class="o">.</span><span class="n">drop_duplicates</span><span class="p">()</span>
                <span class="n">duplicados_drop_iaxis</span><span class="o">=</span><span class="n">df_iaxis</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">df_iaxis</span><span class="o">.</span><span class="n">duplicated</span><span class="p">(</span><span class="n">subset</span><span class="o">=</span><span class="n">cols_dup_iaxis</span><span class="p">,</span><span class="n">keep</span><span class="o">=</span><span class="kc">False</span><span class="p">)]</span>
                <span class="k">if</span> <span class="ow">not</span> <span class="p">(</span><span class="n">duplicados_drop_iaxis</span><span class="o">.</span><span class="n">empty</span><span class="p">):</span> 
                    <span class="n">escribe_reporta</span><span class="p">(</span><span class="n">archivo_reporte</span><span class="p">,</span><span class="s1">&#39;Luego de eliminar duplicados, la base input de iAxis contiene </span><span class="si">{}</span><span class="s1"> registros duplicados. Revisar!&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">duplicados_drop_iaxis</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]))</span>
                    <span class="n">duplicados_drop_iaxis</span><span class="o">.</span><span class="n">to_csv</span><span class="p">(</span><span class="n">ruta_output</span><span class="o">+</span><span class="s1">&#39;0.1.2 Duplicados iAxis Drop.csv&#39;</span><span class="p">,</span><span class="n">sep</span><span class="o">=</span><span class="n">separador_output</span><span class="p">,</span><span class="n">decimal</span><span class="o">=</span><span class="n">decimal_output</span><span class="p">,</span><span class="n">date_format</span><span class="o">=</span><span class="s1">&#39;</span><span class="si">%d</span><span class="s1">-%m-%Y&#39;</span><span class="p">,</span><span class="n">index</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
            <span class="c1"># Cruces con tablas de parametria</span>
            <span class="n">df_iaxis</span><span class="o">=</span><span class="n">df_iaxis</span><span class="o">.</span><span class="n">merge</span><span class="p">(</span><span class="n">estados_iaxis</span><span class="p">[[</span><span class="s1">&#39;ESTADO&#39;</span><span class="p">,</span><span class="s1">&#39;APLICA ESTADO&#39;</span><span class="p">]],</span><span class="n">how</span><span class="o">=</span><span class="s1">&#39;left&#39;</span><span class="p">,</span><span class="n">on</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;ESTADO&#39;</span><span class="p">])</span>
            <span class="n">df_iaxis</span><span class="o">=</span><span class="n">df_iaxis</span><span class="p">[</span><span class="n">df_iaxis</span><span class="p">[</span><span class="s1">&#39;APLICA ESTADO&#39;</span><span class="p">]</span><span class="o">==</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
            <span class="n">df_iaxis</span><span class="o">=</span><span class="n">df_iaxis</span><span class="o">.</span><span class="n">merge</span><span class="p">(</span><span class="n">polizas_pyme</span><span class="p">,</span><span class="n">how</span><span class="o">=</span><span class="s1">&#39;left&#39;</span><span class="p">,</span><span class="n">on</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;POLIZA&#39;</span><span class="p">])</span>
            <span class="n">df_iaxis</span><span class="p">[</span><span class="s1">&#39;TIPO_POLIZA_LETRA&#39;</span><span class="p">]</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">df_iaxis</span><span class="p">[</span><span class="s1">&#39;TIPO_POLIZA_LETRA&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">isnull</span><span class="p">(),</span><span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">df_iaxis</span><span class="p">[</span><span class="s1">&#39;TIPO_POLIZA&#39;</span><span class="p">]</span><span class="o">==</span><span class="mi">1</span><span class="p">,</span><span class="s1">&#39;I&#39;</span><span class="p">,</span><span class="s1">&#39;C&#39;</span><span class="p">),</span><span class="n">df_iaxis</span><span class="p">[</span><span class="s1">&#39;TIPO_POLIZA_LETRA&#39;</span><span class="p">])</span>
            <span class="c1"># Tratamiento de saldos insolutos para el contrato de desgravamen no licitado</span>
            <span class="k">if</span> <span class="n">contrato</span> <span class="o">==</span><span class="s1">&#39;Desgravamen No Licitado&#39;</span><span class="p">:</span>
                <span class="n">saldos_insolutos_detalle</span><span class="p">:</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span> <span class="o">=</span> <span class="n">tables</span><span class="o">.</span><span class="n">get_table_txt</span><span class="p">(</span><span class="n">file_path</span><span class="o">=</span><span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">ruta_si</span><span class="si">}</span><span class="s1">1. Inputs Auxiliares</span><span class="se">\\</span><span class="s1">Saldos Insolutos</span><span class="se">\\</span><span class="s1">Saldos Insolutos </span><span class="si">{</span><span class="n">periodo</span><span class="si">}</span><span class="s1">.txt&#39;</span><span class="p">,</span> <span class="n">decimal</span><span class="o">=</span><span class="n">decimal_input</span><span class="p">,</span> <span class="n">separador</span><span class="o">=</span><span class="n">separador_input</span><span class="p">,</span> <span class="n">campos_fecha</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
                <span class="n">saldos_insolutos_detalle</span><span class="p">[</span><span class="s1">&#39;NRO_OPERACION&#39;</span><span class="p">]</span><span class="o">=</span><span class="n">saldos_insolutos_detalle</span><span class="p">[</span><span class="s1">&#39;NRO_OPERACION&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">str</span><span class="p">)</span><span class="o">.</span><span class="n">str</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s1">&#39;K&#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">float</span><span class="p">)</span>
                <span class="n">df_iaxis</span><span class="o">=</span><span class="n">df_iaxis</span><span class="o">.</span><span class="n">merge</span><span class="p">(</span><span class="n">saldos_insolutos_detalle</span><span class="p">,</span><span class="n">how</span><span class="o">=</span><span class="s1">&#39;left&#39;</span><span class="p">,</span><span class="n">on</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;POLIZA&#39;</span><span class="p">,</span><span class="s1">&#39;RUT&#39;</span><span class="p">,</span><span class="s1">&#39;NRO_OPERACION&#39;</span><span class="p">])</span>
        <span class="c1"># * LECTURA DE BASES DE DATOS GES</span>
        <span class="k">if</span> <span class="n">base_ges</span><span class="o">==</span><span class="mi">1</span><span class="p">:</span> 
            <span class="c1"># Lectura de BBDD y tablas de parametria</span>
            <span class="n">df_ges</span><span class="p">:</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="o">=</span><span class="n">pd</span><span class="o">.</span><span class="n">read_csv</span><span class="p">(</span><span class="n">ruta_input</span><span class="o">+</span><span class="n">archivo_input_ges</span><span class="p">,</span><span class="n">sep</span><span class="o">=</span><span class="n">separador_input</span><span class="p">,</span><span class="n">decimal</span><span class="o">=</span><span class="n">decimal_input</span><span class="p">,</span><span class="n">parse_dates</span><span class="o">=</span><span class="n">cols_date_ges</span><span class="p">,</span><span class="n">date_format</span><span class="o">=</span><span class="s1">&#39;</span><span class="si">%d</span><span class="s1">-%m-%Y&#39;</span><span class="p">,</span><span class="n">encoding</span><span class="o">=</span><span class="s1">&#39;latin-1&#39;</span><span class="p">,</span><span class="n">low_memory</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
            <span class="n">estados_ges</span><span class="p">:</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span> <span class="o">=</span> <span class="n">tables</span><span class="o">.</span><span class="n">get_table_xlsx</span><span class="p">(</span><span class="n">sheet_name</span> <span class="o">=</span> <span class="s1">&#39;Estados GES&#39;</span><span class="p">)</span>
            <span class="n">forma_pago</span><span class="p">:</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span> <span class="o">=</span> <span class="n">tables</span><span class="o">.</span><span class="n">get_table_xlsx</span><span class="p">(</span><span class="n">sheet_name</span> <span class="o">=</span> <span class="s1">&#39;Forma Pago&#39;</span><span class="p">)</span>
            <span class="n">planes_ges</span><span class="p">:</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span> <span class="o">=</span> <span class="n">tables</span><span class="o">.</span><span class="n">get_table_xlsx</span><span class="p">(</span><span class="n">sheet_name</span> <span class="o">=</span> <span class="s1">&#39;Planes GES&#39;</span><span class="p">)</span>
            <span class="k">for</span> <span class="n">col</span> <span class="ow">in</span> <span class="n">cols_date_ges</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">df_ges</span><span class="p">[</span><span class="n">col</span><span class="p">]</span><span class="o">.</span><span class="n">dtype</span><span class="o">!=</span><span class="s1">&#39;datetime64[ns]&#39;</span><span class="p">:</span> <span class="n">df_ges</span><span class="p">[</span><span class="n">col</span><span class="p">]</span><span class="o">=</span><span class="n">pd</span><span class="o">.</span><span class="n">to_datetime</span><span class="p">(</span><span class="n">df_ges</span><span class="p">[</span><span class="n">col</span><span class="p">],</span><span class="nb">format</span> <span class="o">=</span> <span class="s1">&#39;</span><span class="si">%d</span><span class="s1">-%m-%Y&#39;</span><span class="p">,</span> <span class="n">errors</span><span class="o">=</span><span class="s1">&#39;coerce&#39;</span><span class="p">)</span>            
            <span class="c1"># Algunas transformaciones iniciales</span>
            <span class="n">df_ges</span><span class="p">[</span><span class="s1">&#39;CTI&#39;</span><span class="p">]</span><span class="o">=</span><span class="mi">0</span>
            <span class="c1"># Tratamiento del campo PERIOD_TASA para aquellos contratos que poseen saldo insoluto</span>
            <span class="k">if</span> <span class="s1">&#39;PERIOD_TASA&#39;</span> <span class="ow">in</span> <span class="n">df_ges</span><span class="o">.</span><span class="n">columns</span><span class="p">:</span><span class="n">df_ges</span><span class="p">[</span><span class="s1">&#39;TASA_CRED&#39;</span><span class="p">]</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">df_ges</span><span class="p">[</span><span class="s1">&#39;PERIOD_TASA&#39;</span><span class="p">]</span><span class="o">==</span><span class="s1">&#39;M&#39;</span><span class="p">,</span><span class="n">df_ges</span><span class="p">[</span><span class="s1">&#39;TASA_CRED&#39;</span><span class="p">]</span><span class="o">/</span><span class="mi">100</span><span class="p">,</span><span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">df_ges</span><span class="p">[</span><span class="s1">&#39;PERIOD_TASA&#39;</span><span class="p">]</span><span class="o">==</span><span class="s1">&#39;A&#39;</span><span class="p">,(</span><span class="mi">1</span><span class="o">+</span><span class="n">df_ges</span><span class="p">[</span><span class="s1">&#39;TASA_CRED&#39;</span><span class="p">]</span><span class="o">/</span><span class="mi">100</span><span class="p">)</span><span class="o">**</span><span class="p">(</span><span class="mi">1</span><span class="o">/</span><span class="mi">12</span><span class="p">)</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span><span class="n">df_ges</span><span class="p">[</span><span class="s1">&#39;TASA_CRED&#39;</span><span class="p">]</span><span class="o">/</span><span class="mi">100</span><span class="p">))</span>
            <span class="c1"># Corrige las tasas para los contratos de prima unica de cesantia</span>
            <span class="k">if</span> <span class="n">clasificacion_contrato</span><span class="o">==</span><span class="s1">&#39;Cesantia PU&#39;</span><span class="p">:</span> <span class="n">df_ges</span><span class="o">=</span><span class="n">corrige_tasas_ges</span><span class="p">(</span><span class="n">df_ges</span><span class="p">,</span> <span class="n">parameters</span><span class="p">)</span>
            <span class="c1"># VALIDADOR DE DATA 1: UNICIDAD DENTRO DE LA BASE GES</span>
            <span class="n">duplicados_ges</span><span class="o">=</span><span class="n">df_ges</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">df_ges</span><span class="o">.</span><span class="n">duplicated</span><span class="p">(</span><span class="n">subset</span><span class="o">=</span><span class="p">[</span><span class="n">campo_rut_duplicados</span><span class="p">,</span><span class="s1">&#39;POLIZA&#39;</span><span class="p">,</span><span class="s1">&#39;CERTIFICADO&#39;</span><span class="p">,</span><span class="s1">&#39;NRO_OPERACION&#39;</span><span class="p">,</span><span class="s1">&#39;COD_COB&#39;</span><span class="p">],</span><span class="n">keep</span><span class="o">=</span><span class="kc">False</span><span class="p">)]</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="p">(</span><span class="n">duplicados_ges</span><span class="o">.</span><span class="n">empty</span><span class="p">):</span> 
                <span class="n">escribe_reporta</span><span class="p">(</span><span class="n">archivo_reporte</span><span class="p">,</span><span class="s1">&#39;El dataframe GES de entrada contiene </span><span class="si">{}</span><span class="s1"> registros duplicados. Revisar!&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">duplicados_ges</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]))</span>
                <span class="n">duplicados_ges</span><span class="o">.</span><span class="n">to_csv</span><span class="p">(</span><span class="n">ruta_output</span><span class="o">+</span><span class="s1">&#39;0. Duplicados GES.csv&#39;</span><span class="p">,</span><span class="n">sep</span><span class="o">=</span><span class="n">separador_output</span><span class="p">,</span><span class="n">decimal</span><span class="o">=</span><span class="n">decimal_output</span><span class="p">,</span><span class="n">date_format</span><span class="o">=</span><span class="s1">&#39;</span><span class="si">%d</span><span class="s1">-%m-%Y&#39;</span><span class="p">,</span><span class="n">index</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
                <span class="n">df_ges</span><span class="o">=</span><span class="n">df_ges</span><span class="o">.</span><span class="n">drop_duplicates</span><span class="p">()</span>
                <span class="n">duplicados_drop_ges</span><span class="o">=</span><span class="n">df_ges</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">df_ges</span><span class="o">.</span><span class="n">duplicated</span><span class="p">(</span><span class="n">subset</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;POLIZA&#39;</span><span class="p">,</span><span class="s1">&#39;CERTIFICADO&#39;</span><span class="p">,</span><span class="s1">&#39;NRO_OPERACION&#39;</span><span class="p">,</span><span class="s1">&#39;COD_COB&#39;</span><span class="p">],</span><span class="n">keep</span><span class="o">=</span><span class="kc">False</span><span class="p">)]</span>
                <span class="k">if</span> <span class="ow">not</span> <span class="p">(</span><span class="n">duplicados_drop_ges</span><span class="o">.</span><span class="n">empty</span><span class="p">):</span> 
                    <span class="n">escribe_reporta</span><span class="p">(</span><span class="n">archivo_reporte</span><span class="p">,</span><span class="s1">&#39;Luego de eliminar duplicados, la base input de GES contiene </span><span class="si">{}</span><span class="s1"> registros duplicados. Revisar!&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">duplicados_drop_ges</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]))</span>
                    <span class="n">duplicados_drop_ges</span><span class="o">.</span><span class="n">to_csv</span><span class="p">(</span><span class="n">ruta_output</span><span class="o">+</span><span class="s1">&#39;0. Duplicados GES Drop.csv&#39;</span><span class="p">,</span><span class="n">sep</span><span class="o">=</span><span class="n">separador_output</span><span class="p">,</span><span class="n">decimal</span><span class="o">=</span><span class="n">decimal_output</span><span class="p">,</span><span class="n">date_format</span><span class="o">=</span><span class="s1">&#39;</span><span class="si">%d</span><span class="s1">-%m-%Y&#39;</span><span class="p">,</span><span class="n">index</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
            <span class="c1"># Creacion de la variable FECHA_ANULACION (no existe en GES) que depende de que contrato estemos trabajando</span>
            <span class="k">if</span> <span class="p">(</span><span class="n">clasificacion_contrato</span> <span class="o">!=</span><span class="s1">&#39;Cesantia PU&#39;</span><span class="p">)</span><span class="o">&amp;</span><span class="p">(</span><span class="n">contrato</span><span class="o">!=</span><span class="s1">&#39;K-Fijo&#39;</span><span class="p">):</span> <span class="n">df_ges</span><span class="p">[</span><span class="s1">&#39;FECHA_ANULACION&#39;</span><span class="p">]</span><span class="o">=</span><span class="n">pd</span><span class="o">.</span><span class="n">to_datetime</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">((</span><span class="n">df_ges</span><span class="p">[</span><span class="s1">&#39;FECHA_VENCIMIENTO&#39;</span><span class="p">]</span><span class="o">&gt;=</span><span class="n">fecha_inicio_mes</span><span class="p">)</span><span class="o">&amp;</span><span class="p">(</span><span class="n">df_ges</span><span class="p">[</span><span class="s1">&#39;FECHA_VENCIMIENTO&#39;</span><span class="p">]</span><span class="o">&lt;=</span><span class="n">fecha_cierre</span><span class="p">),</span><span class="n">df_ges</span><span class="p">[</span><span class="s1">&#39;FECHA_VENCIMIENTO&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">str</span><span class="p">),</span><span class="s1">&#39;&#39;</span><span class="p">),</span> <span class="nb">format</span> <span class="o">=</span> <span class="s1">&#39;%Y-%m-</span><span class="si">%d</span><span class="s1">&#39;</span><span class="p">,</span> <span class="n">errors</span><span class="o">=</span><span class="s1">&#39;coerce&#39;</span><span class="p">)</span>
            <span class="k">elif</span> <span class="n">contrato</span><span class="o">==</span><span class="s1">&#39;K-Fijo&#39;</span><span class="p">:</span>
                <span class="n">df_ges</span><span class="p">[</span><span class="s1">&#39;FEC AUX NA&#39;</span><span class="p">]</span><span class="o">=</span><span class="mi">0</span>
                <span class="n">df_ges</span><span class="p">[</span><span class="s1">&#39;FEC AUX NA&#39;</span><span class="p">]</span><span class="o">=</span><span class="n">pd</span><span class="o">.</span><span class="n">to_datetime</span><span class="p">(</span><span class="n">df_ges</span><span class="p">[</span><span class="s1">&#39;FEC AUX NA&#39;</span><span class="p">],</span><span class="nb">format</span> <span class="o">=</span> <span class="s1">&#39;</span><span class="si">%d</span><span class="s1">-%m-%Y&#39;</span><span class="p">,</span> <span class="n">errors</span><span class="o">=</span><span class="s1">&#39;coerce&#39;</span><span class="p">)</span>
                <span class="n">df_ges</span><span class="p">[</span><span class="s1">&#39;FECHA_ANULACION&#39;</span><span class="p">]</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="o">~</span><span class="n">df_ges</span><span class="p">[</span><span class="s1">&#39;FECHA_RENUNCIA&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">isnull</span><span class="p">(),</span><span class="n">df_ges</span><span class="p">[</span><span class="s1">&#39;FECHA_RENUNCIA&#39;</span><span class="p">],</span><span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="o">~</span><span class="n">df_ges</span><span class="p">[</span><span class="s1">&#39;FECHA_PREPAGO&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">isnull</span><span class="p">(),</span><span class="n">df_ges</span><span class="p">[</span><span class="s1">&#39;FECHA_PREPAGO&#39;</span><span class="p">],</span><span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">df_ges</span><span class="p">[</span><span class="s1">&#39;FECHA_FIN_VIGENCIA&#39;</span><span class="p">]</span><span class="o">==</span><span class="n">df_ges</span><span class="p">[</span><span class="s1">&#39;FECHA_VENCIMIENTO&#39;</span><span class="p">],</span><span class="n">df_ges</span><span class="p">[</span><span class="s1">&#39;FEC AUX NA&#39;</span><span class="p">],</span><span class="n">df_ges</span><span class="p">[</span><span class="s1">&#39;FECHA_FIN_VIGENCIA&#39;</span><span class="p">])))</span>
                <span class="n">df_ges</span><span class="o">=</span><span class="n">df_ges</span><span class="o">.</span><span class="n">drop</span><span class="p">(</span><span class="n">columns</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;FEC AUX NA&#39;</span><span class="p">],</span><span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
                <span class="n">df_ges</span><span class="p">[</span><span class="s1">&#39;PERIODO_CONTABILIZACION&#39;</span><span class="p">]</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">df_ges</span><span class="p">[</span><span class="s1">&#39;FECHA_ANULACION&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">isnull</span><span class="p">(),</span><span class="n">np</span><span class="o">.</span><span class="n">nan</span><span class="p">,</span><span class="n">np</span><span class="o">.</span><span class="n">maximum</span><span class="p">(</span><span class="n">df_ges</span><span class="p">[</span><span class="s1">&#39;PERIODO_CONTABILIZACION&#39;</span><span class="p">],</span><span class="n">df_ges</span><span class="p">[</span><span class="s1">&#39;FECHA_ANULACION&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">dt</span><span class="o">.</span><span class="n">year</span><span class="o">*</span><span class="mi">100</span><span class="o">+</span><span class="n">df_ges</span><span class="p">[</span><span class="s1">&#39;FECHA_ANULACION&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">dt</span><span class="o">.</span><span class="n">month</span><span class="p">))</span>
                <span class="n">df_ges</span><span class="p">[</span><span class="s1">&#39;FECHA_CONTABILIZACION_ANULACION&#39;</span><span class="p">]</span><span class="o">=</span><span class="n">pd</span><span class="o">.</span><span class="n">to_datetime</span><span class="p">(</span><span class="n">df_ges</span><span class="p">[</span><span class="s1">&#39;PERIODO_CONTABILIZACION&#39;</span><span class="p">],</span><span class="nb">format</span><span class="o">=</span><span class="s1">&#39;%Y%m&#39;</span><span class="p">,</span> <span class="n">errors</span><span class="o">=</span><span class="s1">&#39;coerce&#39;</span><span class="p">)</span><span class="o">+</span> <span class="n">MonthEnd</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
            <span class="c1"># Transformaciones finales</span>
            <span class="n">df_ges</span><span class="o">=</span><span class="n">df_ges</span><span class="o">.</span><span class="n">merge</span><span class="p">(</span><span class="n">forma_pago</span><span class="p">,</span><span class="n">how</span><span class="o">=</span><span class="s1">&#39;left&#39;</span><span class="p">,</span><span class="n">on</span><span class="o">=</span><span class="s1">&#39;FORMA_PAGO&#39;</span><span class="p">)</span>
            <span class="n">df_ges</span><span class="p">[</span><span class="s1">&#39;TIPO_POLIZA_LETRA&#39;</span><span class="p">]</span><span class="o">=</span><span class="n">df_ges</span><span class="p">[</span><span class="s1">&#39;TIPO_POLIZA&#39;</span><span class="p">]</span>
            <span class="n">df_ges</span><span class="p">[</span><span class="s1">&#39;TIPO_POLIZA&#39;</span><span class="p">]</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">df_ges</span><span class="p">[</span><span class="s1">&#39;TIPO_POLIZA_LETRA&#39;</span><span class="p">]</span><span class="o">==</span><span class="s1">&#39;C&#39;</span><span class="p">,</span><span class="mi">2</span><span class="p">,</span><span class="mi">1</span><span class="p">)</span>
            <span class="n">df_ges</span><span class="p">[</span><span class="s1">&#39;BASE&#39;</span><span class="p">]</span><span class="o">=</span><span class="s1">&#39;GES&#39;</span>
            <span class="c1"># Calculamos fechas de renovacion de los contratos de prima recurrente</span>
            <span class="n">df_ges</span><span class="p">[</span><span class="s1">&#39;FINI_RENOV_ANUAL&#39;</span><span class="p">],</span><span class="n">df_ges</span><span class="p">[</span><span class="s1">&#39;FFIN_RENOV_ANUAL&#39;</span><span class="p">]</span><span class="o">=</span><span class="n">calculo_fechas_renovacion</span><span class="p">(</span><span class="n">df_ges</span><span class="p">,</span> <span class="s1">&#39;FECHA_EFECTO&#39;</span><span class="p">,</span> <span class="s1">&#39;FECHA_VENCIMIENTO&#39;</span><span class="p">,</span> <span class="s1">&#39;FECHA_ANULACION&#39;</span><span class="p">,</span><span class="s1">&#39;FORMA_PAGO_CODIGO&#39;</span><span class="p">,</span> <span class="n">periodo</span><span class="p">)</span>
            <span class="c1"># Anualizacion de la prima de vida GES</span>
            <span class="k">if</span> <span class="n">tipo_contrato</span><span class="o">==</span><span class="s1">&#39;Vida&#39;</span><span class="p">:</span><span class="n">df_ges</span><span class="p">[</span><span class="s1">&#39;IPRIANU&#39;</span><span class="p">]</span><span class="o">=</span><span class="n">df_ges</span><span class="p">[</span><span class="s1">&#39;IPRIANU&#39;</span><span class="p">]</span><span class="o">*</span><span class="n">df_ges</span><span class="p">[</span><span class="s1">&#39;FACTOR ANUALIZACION&#39;</span><span class="p">]</span>
            <span class="c1"># traemos codigos de planes GES</span>
            <span class="n">df_ges</span><span class="o">=</span><span class="n">df_ges</span><span class="o">.</span><span class="n">merge</span><span class="p">(</span><span class="n">planes_ges</span><span class="p">,</span><span class="n">how</span><span class="o">=</span><span class="s1">&#39;left&#39;</span><span class="p">,</span><span class="n">on</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;PRODUCTO&#39;</span><span class="p">,</span><span class="s1">&#39;PLAN_DESC&#39;</span><span class="p">])</span>
            <span class="n">df_ges</span><span class="p">[</span><span class="s1">&#39;COD_PLAN&#39;</span><span class="p">]</span><span class="o">=</span><span class="n">df_ges</span><span class="p">[</span><span class="s1">&#39;COD_PLAN&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">fillna</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
            <span class="c1"># Algunos estados pueden no aplicar</span>
            <span class="n">df_ges</span><span class="o">=</span><span class="n">df_ges</span><span class="o">.</span><span class="n">merge</span><span class="p">(</span><span class="n">estados_ges</span><span class="p">[[</span><span class="s1">&#39;ESTADO&#39;</span><span class="p">,</span><span class="s1">&#39;APLICA ESTADO&#39;</span><span class="p">]],</span><span class="n">how</span><span class="o">=</span><span class="s1">&#39;left&#39;</span><span class="p">,</span><span class="n">on</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;ESTADO&#39;</span><span class="p">])</span>
            <span class="n">df_ges</span><span class="o">=</span><span class="n">df_ges</span><span class="p">[</span><span class="n">df_ges</span><span class="p">[</span><span class="s1">&#39;APLICA ESTADO&#39;</span><span class="p">]</span><span class="o">==</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
            <span class="k">if</span> <span class="s1">&#39;POLVIGENTE&#39;</span> <span class="ow">in</span> <span class="n">df_ges</span><span class="o">.</span><span class="n">columns</span><span class="p">:</span> <span class="n">df_ges</span><span class="o">=</span><span class="n">df_ges</span><span class="p">[</span><span class="o">~</span><span class="n">df_ges</span><span class="p">[</span><span class="s1">&#39;POLVIGENTE&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">isin</span><span class="p">([</span><span class="mi">9</span><span class="p">])]</span>
            <span class="c1"># Tratamiento de saldos insolutos para el contrato de desgravamen no licitado</span>
            <span class="k">if</span> <span class="n">contrato</span><span class="o">==</span><span class="s1">&#39;Desgravamen No Licitado&#39;</span><span class="p">:</span>
                <span class="n">df_ges</span><span class="p">[</span><span class="s1">&#39;ICAPITAL&#39;</span><span class="p">]</span><span class="o">=</span><span class="n">df_ges</span><span class="p">[</span><span class="s1">&#39;POLASECFI&#39;</span><span class="p">]</span>
                <span class="n">df_ges</span><span class="o">.</span><span class="n">drop</span><span class="p">(</span><span class="n">columns</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;POLCFIORI&#39;</span><span class="p">,</span><span class="s1">&#39;POLASECFI&#39;</span><span class="p">],</span><span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span><span class="n">inplace</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
                <span class="n">df_ges</span><span class="p">[</span><span class="s1">&#39;NRO_OPERACION&#39;</span><span class="p">]</span><span class="o">=</span><span class="n">pd</span><span class="o">.</span><span class="n">to_numeric</span><span class="p">(</span><span class="n">df_ges</span><span class="p">[</span><span class="s1">&#39;NRO_OPERACION&#39;</span><span class="p">],</span><span class="n">errors</span> <span class="o">=</span> <span class="s1">&#39;coerce&#39;</span><span class="p">)</span>
                <span class="n">df_ges</span><span class="o">=</span><span class="n">df_ges</span><span class="o">.</span><span class="n">merge</span><span class="p">(</span><span class="n">saldos_insolutos_detalle</span><span class="p">,</span><span class="n">how</span><span class="o">=</span><span class="s1">&#39;left&#39;</span><span class="p">,</span><span class="n">on</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;POLIZA&#39;</span><span class="p">,</span><span class="s1">&#39;RUT&#39;</span><span class="p">,</span><span class="s1">&#39;NRO_OPERACION&#39;</span><span class="p">])</span>
        <span class="c1"># JUNTAMOS LAS BASES DEPENDIENDO DE CUALES EXISTEN</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">base_iaxis</span><span class="o">==</span><span class="mi">1</span><span class="p">)</span><span class="o">&amp;</span><span class="p">(</span><span class="n">base_ges</span><span class="o">==</span><span class="mi">1</span><span class="p">):</span>
            <span class="n">df_0_0</span><span class="p">:</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="o">=</span><span class="n">pd</span><span class="o">.</span><span class="n">concat</span><span class="p">([</span><span class="n">df_iaxis</span><span class="p">,</span><span class="n">df_ges</span><span class="p">],</span><span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
        <span class="k">elif</span> <span class="n">base_iaxis</span><span class="o">==</span><span class="mi">1</span><span class="p">:</span>
            <span class="n">df_0_0</span><span class="p">:</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="o">=</span><span class="n">df_iaxis</span>
        <span class="k">elif</span> <span class="n">base_ges</span><span class="o">==</span><span class="mi">1</span><span class="p">:</span>
            <span class="n">df_0_0</span><span class="p">:</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="o">=</span><span class="n">df_ges</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">()</span>
        <span class="c1"># * Calculos con las bases de GES a iAxis unidas</span>
        <span class="c1"># CALCULOS DE VARIABLES EXTRAS Y CAMBIOS DE NOMBRE DE ALGUNAS VARIABLES</span>
        <span class="n">escribe_reporta</span><span class="p">(</span><span class="n">archivo_reporte</span><span class="p">,</span><span class="s1">&#39;El dataframe input posee una prima neta de </span><span class="si">{}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">nansum</span><span class="p">(</span><span class="n">df_0_0</span><span class="p">[</span><span class="s1">&#39;IPRIANU&#39;</span><span class="p">])))</span>
        <span class="n">df_0_0</span><span class="p">[</span><span class="s1">&#39;NRO_OPERACION&#39;</span><span class="p">]</span><span class="o">=</span><span class="n">df_0_0</span><span class="p">[</span><span class="s1">&#39;NRO_OPERACION&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">fillna</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
        <span class="k">if</span> <span class="s1">&#39;CANAL_DESC&#39;</span> <span class="ow">in</span> <span class="n">df_0_0</span><span class="o">.</span><span class="n">columns</span><span class="p">:</span> <span class="n">df_0_0</span><span class="p">[</span><span class="s1">&#39;CANAL_DESC&#39;</span><span class="p">]</span><span class="o">=</span><span class="n">df_0_0</span><span class="p">[</span><span class="s1">&#39;CANAL_DESC&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">str</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span>
        <span class="n">df_0_1</span><span class="o">=</span><span class="n">df_0_0</span><span class="o">.</span><span class="n">merge</span><span class="p">(</span><span class="n">cobs_ges</span><span class="p">[[</span><span class="s1">&#39;COD_COB&#39;</span><span class="p">,</span><span class="s1">&#39;COB_GES&#39;</span><span class="p">]],</span><span class="n">how</span><span class="o">=</span><span class="s1">&#39;left&#39;</span><span class="p">,</span><span class="n">on</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;COD_COB&#39;</span><span class="p">],</span><span class="n">suffixes</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;&#39;</span><span class="p">,</span><span class="s1">&#39;_x&#39;</span><span class="p">])</span> <span class="c1"># type: ignore</span>
        <span class="n">df_0_1</span><span class="p">[</span><span class="s1">&#39;COB_GES&#39;</span><span class="p">]</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">df_0_1</span><span class="p">[</span><span class="s1">&#39;COB_GES&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">isnull</span><span class="p">(),</span><span class="n">df_0_1</span><span class="p">[</span><span class="s1">&#39;COD_COB&#39;</span><span class="p">],</span><span class="n">df_0_1</span><span class="p">[</span><span class="s1">&#39;COB_GES&#39;</span><span class="p">])</span>
        <span class="n">df_0_1</span><span class="o">.</span><span class="n">rename</span><span class="p">(</span><span class="n">columns</span><span class="o">=</span><span class="p">{</span><span class="s1">&#39;COD_PLAN&#39;</span><span class="p">:</span><span class="s1">&#39;PLAN&#39;</span><span class="p">,</span><span class="s1">&#39;IPRIANU&#39;</span><span class="p">:</span><span class="s1">&#39;PRIMA NETA ANUAL&#39;</span><span class="p">,</span><span class="s1">&#39;COB_GES&#39;</span><span class="p">:</span><span class="s1">&#39;CODIGO COBERTURA&#39;</span><span class="p">,</span><span class="s1">&#39;COD_COB&#39;</span><span class="p">:</span><span class="s1">&#39;CODIGO COBERTURA IAXIS&#39;</span><span class="p">},</span><span class="n">inplace</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
        <span class="n">df_0_1</span><span class="p">[</span><span class="s1">&#39;POL_PROD&#39;</span><span class="p">]</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">((</span><span class="n">df_0_1</span><span class="p">[</span><span class="s1">&#39;TIPO_POLIZA_LETRA&#39;</span><span class="p">]</span><span class="o">==</span><span class="s1">&#39;I&#39;</span><span class="p">)</span><span class="o">|</span><span class="p">(</span><span class="n">df_0_1</span><span class="p">[</span><span class="s1">&#39;CTI&#39;</span><span class="p">]</span><span class="o">==</span><span class="mi">1</span><span class="p">),</span><span class="n">df_0_1</span><span class="p">[</span><span class="s1">&#39;PRODUCTO&#39;</span><span class="p">],</span><span class="n">df_0_1</span><span class="p">[</span><span class="s1">&#39;POLIZA&#39;</span><span class="p">])</span>
        <span class="n">df_0_1</span><span class="p">[</span><span class="s1">&#39;FECHA CIERRE&#39;</span><span class="p">]</span><span class="o">=</span><span class="n">fecha_cierre</span>
        <span class="n">df_0_1</span><span class="p">[</span><span class="s1">&#39;FECHA CIERRE&#39;</span><span class="p">]</span><span class="o">=</span><span class="n">df_0_1</span><span class="p">[</span><span class="s1">&#39;FECHA CIERRE&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="n">df_0_1</span><span class="p">[</span><span class="s1">&#39;FECHA_EFECTO&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">dtype</span><span class="p">)</span>
        <span class="n">df_0_1</span><span class="p">[</span><span class="s1">&#39;INNOMINADA&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">df_0_1</span><span class="p">[</span><span class="s1">&#39;POLIZA&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">isin</span><span class="p">(</span><span class="nb">list</span><span class="p">(</span><span class="n">innominadas</span><span class="p">[</span><span class="s1">&#39;POLIZA&#39;</span><span class="p">])),</span><span class="mi">1</span><span class="p">,</span><span class="mi">0</span><span class="p">)</span>
        <span class="n">df_0_1</span><span class="p">[</span><span class="s1">&#39;EDAD&#39;</span><span class="p">],</span><span class="n">df_0_1</span><span class="p">[</span><span class="s1">&#39;ISSUE EDAD&#39;</span><span class="p">]</span><span class="o">=</span><span class="n">calcula_edad</span><span class="p">(</span><span class="n">df_0_1</span><span class="p">[</span><span class="s1">&#39;RUT&#39;</span><span class="p">],</span><span class="n">df_0_1</span><span class="p">[</span><span class="s1">&#39;FEC_NAC&#39;</span><span class="p">],</span><span class="n">fecha_cierre</span><span class="p">,</span><span class="n">edad_casos_perdidos</span><span class="p">,</span><span class="mi">108</span><span class="p">,</span><span class="n">archivo_reporte</span><span class="p">,</span><span class="n">reporta_issues</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">edad_inf</span> <span class="o">=</span> <span class="mi">18</span><span class="p">,</span> <span class="n">aplica_edad_prom_cartera</span> <span class="o">=</span> <span class="mi">1</span><span class="p">)</span>
        <span class="c1"># Calculo edad de ingreso</span>
        <span class="k">if</span> <span class="s1">&#39;FEC_NAC&#39;</span> <span class="ow">in</span> <span class="n">df_0_1</span><span class="o">.</span><span class="n">columns</span><span class="p">:</span> 
            <span class="n">escribe_reporta</span><span class="p">(</span><span class="n">archivo_reporte</span><span class="p">,</span><span class="s1">&#39;Calculando edad de ingreso&#39;</span><span class="p">)</span>
            <span class="n">df_0_1</span><span class="p">[</span><span class="s1">&#39;EDAD INGRESO&#39;</span><span class="p">],</span><span class="n">df_0_1</span><span class="p">[</span><span class="s1">&#39;ISSUE EDAD INGR&#39;</span><span class="p">]</span><span class="o">=</span><span class="n">calcula_edad</span><span class="p">(</span><span class="n">df_0_1</span><span class="p">[</span><span class="s1">&#39;RUT&#39;</span><span class="p">],</span><span class="n">df_0_1</span><span class="p">[</span><span class="s1">&#39;FEC_NAC&#39;</span><span class="p">],</span><span class="n">df_0_1</span><span class="p">[</span><span class="s1">&#39;FECHA_EFECTO&#39;</span><span class="p">],</span><span class="n">edad_casos_perdidos</span><span class="p">,</span><span class="mi">108</span><span class="p">,</span><span class="n">archivo_reporte</span><span class="p">,</span><span class="n">reporta_issues</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">edad_inf</span> <span class="o">=</span> <span class="mi">18</span><span class="p">,</span> <span class="n">aplica_edad_prom_cartera</span> <span class="o">=</span> <span class="mi">1</span><span class="p">)</span>
        <span class="c1"># CALCULOS ESPECIFICOS POR CADA CONTRATO</span>
        <span class="c1"># CALCULOS DE FECHAS DE INICIO/FIN DE EXPOSICION: SE DIFERENCIAN ENTRE PRIMA UNICA (CESANTIA Y K-FIJO) DEL RESTO</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">clasificacion_contrato</span> <span class="o">!=</span><span class="s1">&#39;Cesantia PU&#39;</span><span class="p">)</span><span class="o">&amp;</span><span class="p">(</span><span class="n">contrato</span><span class="o">!=</span><span class="s1">&#39;K-Fijo&#39;</span><span class="p">):</span>
            <span class="n">df_0_1</span><span class="p">[</span><span class="s1">&#39;FINI_RENOV_ANUAL&#39;</span><span class="p">],</span><span class="n">df_0_1</span><span class="p">[</span><span class="s1">&#39;FFIN_RENOV_ANUAL&#39;</span><span class="p">]</span><span class="o">=</span><span class="n">calculo_fechas_renovacion</span><span class="p">(</span><span class="n">df_0_1</span><span class="p">,</span> <span class="s1">&#39;FECHA_EFECTO&#39;</span><span class="p">,</span> <span class="s1">&#39;FECHA_VENCIMIENTO&#39;</span><span class="p">,</span> <span class="s1">&#39;FECHA_ANULACION&#39;</span><span class="p">,</span><span class="s1">&#39;FORMA_PAGO_CODIGO&#39;</span><span class="p">,</span> <span class="n">periodo</span><span class="p">,</span><span class="mi">0</span><span class="p">)</span>
            <span class="n">df_0_1</span><span class="p">[</span><span class="s1">&#39;FECHA FIN EXP&#39;</span><span class="p">]</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="o">~</span><span class="n">df_0_1</span><span class="p">[</span><span class="s1">&#39;FECHA_ANULACION&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">isnull</span><span class="p">(),</span><span class="n">df_0_1</span><span class="p">[</span><span class="s1">&#39;FECHA_ANULACION&#39;</span><span class="p">],</span><span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">df_0_1</span><span class="p">[</span><span class="s1">&#39;FECHA_VENCIMIENTO&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">isnull</span><span class="p">(),</span><span class="n">df_0_1</span><span class="p">[</span><span class="s1">&#39;FFIN_RENOV_ANUAL&#39;</span><span class="p">],</span><span class="n">df_0_1</span><span class="p">[</span><span class="s1">&#39;FECHA_VENCIMIENTO&#39;</span><span class="p">]))</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">df_0_1</span><span class="p">[</span><span class="s1">&#39;FEC AUX NA&#39;</span><span class="p">]</span><span class="o">=</span><span class="mi">0</span>
            <span class="n">df_0_1</span><span class="p">[</span><span class="s1">&#39;FEC AUX NA&#39;</span><span class="p">]</span><span class="o">=</span><span class="n">pd</span><span class="o">.</span><span class="n">to_datetime</span><span class="p">(</span><span class="n">df_0_1</span><span class="p">[</span><span class="s1">&#39;FEC AUX NA&#39;</span><span class="p">],</span><span class="nb">format</span> <span class="o">=</span> <span class="s1">&#39;</span><span class="si">%d</span><span class="s1">-%m-%Y&#39;</span><span class="p">,</span> <span class="n">errors</span><span class="o">=</span><span class="s1">&#39;coerce&#39;</span><span class="p">)</span>
            <span class="n">df_0_1</span><span class="p">[</span><span class="s1">&#39;FECHA_ANULACION&#39;</span><span class="p">]</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">df_0_1</span><span class="p">[</span><span class="s1">&#39;FECHA_ANULACION&#39;</span><span class="p">]</span><span class="o">&lt;=</span><span class="n">fecha_cierre</span><span class="p">,</span><span class="n">df_0_1</span><span class="p">[</span><span class="s1">&#39;FECHA_ANULACION&#39;</span><span class="p">],</span><span class="n">df_0_1</span><span class="p">[</span><span class="s1">&#39;FEC AUX NA&#39;</span><span class="p">])</span>
        <span class="c1"># * CALCULOS GENERICOS PARA BASES DE VIDA PRIMA RECURRENTE</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">tipo_contrato</span><span class="o">==</span><span class="s1">&#39;Vida&#39;</span><span class="p">)</span><span class="o">&amp;</span><span class="p">(</span><span class="n">contrato</span><span class="o">!=</span><span class="s1">&#39;K-Fijo&#39;</span><span class="p">):</span>
            <span class="n">meses_renta</span><span class="p">:</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span> <span class="o">=</span> <span class="n">tables</span><span class="o">.</span><span class="n">get_table_xlsx</span><span class="p">(</span><span class="n">sheet_name</span> <span class="o">=</span> <span class="s1">&#39;Meses Renta&#39;</span><span class="p">)</span>
            <span class="n">saldo_insoluto</span><span class="p">:</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span> <span class="o">=</span> <span class="n">tables</span><span class="o">.</span><span class="n">get_table_xlsx</span><span class="p">(</span><span class="n">sheet_name</span> <span class="o">=</span> <span class="s1">&#39;Saldo Insoluto&#39;</span><span class="p">)</span>
            <span class="n">df_0_1</span><span class="p">[</span><span class="s1">&#39;EXPOSICION MENSUAL&#39;</span><span class="p">]</span><span class="o">=</span><span class="n">calcula_exposicion</span><span class="p">(</span><span class="n">df_0_1</span><span class="p">,</span><span class="s1">&#39;FECHA_EFECTO&#39;</span><span class="p">,</span><span class="s1">&#39;FECHA FIN EXP&#39;</span><span class="p">,</span><span class="n">dias_exposicion</span><span class="p">,</span><span class="n">fecha_inicio_mes</span><span class="p">,</span><span class="n">fecha_cierre</span><span class="p">)</span>
            <span class="n">df_0_1</span><span class="p">[</span><span class="s1">&#39;TIPO ASEGURADO&#39;</span><span class="p">]</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">((</span><span class="n">df_0_1</span><span class="p">[</span><span class="s1">&#39;RUT&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">isnull</span><span class="p">())</span><span class="o">|</span><span class="p">(</span><span class="n">df_0_1</span><span class="p">[</span><span class="s1">&#39;RUT&#39;</span><span class="p">]</span><span class="o">==</span><span class="n">df_0_1</span><span class="p">[</span><span class="s1">&#39;RUT_CONTRATANTE&#39;</span><span class="p">]),</span><span class="s1">&#39;Titular&#39;</span><span class="p">,</span><span class="s1">&#39;Adicional&#39;</span><span class="p">)</span>
            <span class="n">escribe_reporta</span><span class="p">(</span><span class="n">archivo_reporte</span><span class="p">,</span><span class="s1">&#39;Calculando edad de renovacion&#39;</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">contrato</span> <span class="o">==</span> <span class="s1">&#39;Desgravamen No Licitado&#39;</span><span class="p">:</span> <span class="n">df_0_1</span><span class="p">[</span><span class="s1">&#39;EDAD RENOVACION&#39;</span><span class="p">],</span><span class="n">df_0_1</span><span class="p">[</span><span class="s1">&#39;ISSUE EDAD RENOV&#39;</span><span class="p">]</span><span class="o">=</span><span class="n">calcula_edad</span><span class="p">(</span><span class="n">df_0_1</span><span class="p">[</span><span class="s1">&#39;RUT&#39;</span><span class="p">],</span><span class="n">df_0_1</span><span class="p">[</span><span class="s1">&#39;FEC_NAC&#39;</span><span class="p">],</span><span class="n">fecha_inicio_mes</span><span class="p">,</span><span class="n">edad_casos_perdidos</span><span class="p">,</span><span class="mi">108</span><span class="p">,</span><span class="n">archivo_reporte</span><span class="p">,</span><span class="n">reporta_issues</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span><span class="n">edad_inf</span> <span class="o">=</span> <span class="mi">18</span><span class="p">,</span> <span class="n">aplica_edad_prom_cartera</span> <span class="o">=</span> <span class="mi">1</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span> <span class="n">df_0_1</span><span class="p">[</span><span class="s1">&#39;EDAD RENOVACION&#39;</span><span class="p">],</span><span class="n">df_0_1</span><span class="p">[</span><span class="s1">&#39;ISSUE EDAD RENOV&#39;</span><span class="p">]</span><span class="o">=</span><span class="n">calcula_edad</span><span class="p">(</span><span class="n">df_0_1</span><span class="p">[</span><span class="s1">&#39;RUT&#39;</span><span class="p">],</span><span class="n">df_0_1</span><span class="p">[</span><span class="s1">&#39;FEC_NAC&#39;</span><span class="p">],</span><span class="n">df_0_1</span><span class="p">[</span><span class="s1">&#39;FINI_RENOV_ANUAL&#39;</span><span class="p">],</span><span class="n">edad_casos_perdidos</span><span class="p">,</span><span class="mi">108</span><span class="p">,</span><span class="n">archivo_reporte</span><span class="p">,</span><span class="n">reporta_issues</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">edad_inf</span> <span class="o">=</span> <span class="mi">18</span><span class="p">,</span> <span class="n">aplica_edad_prom_cartera</span> <span class="o">=</span> <span class="mi">1</span><span class="p">)</span>
            <span class="n">df_0_2</span><span class="o">=</span><span class="n">df_0_1</span><span class="o">.</span><span class="n">merge</span><span class="p">(</span><span class="n">meses_renta</span><span class="p">,</span><span class="n">how</span><span class="o">=</span><span class="s1">&#39;left&#39;</span><span class="p">,</span><span class="n">on</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;CODIGO COBERTURA&#39;</span><span class="p">],</span><span class="n">suffixes</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;&#39;</span><span class="p">,</span><span class="s1">&#39;_x&#39;</span><span class="p">])</span> <span class="c1"># type: ignore</span>
            <span class="k">if</span> <span class="n">contrato</span><span class="o">==</span><span class="s1">&#39;Desgravamen No Licitado&#39;</span><span class="p">:</span> <span class="n">df_0_2</span><span class="p">[</span><span class="s1">&#39;MONTO ASEGURADO&#39;</span><span class="p">]</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">df_0_2</span><span class="p">[</span><span class="s1">&#39;MESES RENTA&#39;</span><span class="p">]</span><span class="o">==</span><span class="mi">1</span><span class="p">,</span><span class="mi">1</span><span class="p">,(</span><span class="mi">1</span><span class="o">-</span><span class="p">(</span><span class="mi">1</span><span class="o">+</span><span class="n">tdm_mensual</span><span class="p">)</span><span class="o">**</span><span class="p">(</span><span class="o">-</span><span class="n">df_0_2</span><span class="p">[</span><span class="s1">&#39;MESES RENTA&#39;</span><span class="p">]))</span><span class="o">/</span><span class="n">tdm_mensual</span><span class="p">)</span><span class="o">*</span><span class="n">df_0_2</span><span class="p">[</span><span class="s1">&#39;ICAPITAL&#39;</span><span class="p">]</span>
            <span class="k">else</span><span class="p">:</span> <span class="n">df_0_2</span><span class="p">[</span><span class="s1">&#39;MONTO ASEGURADO&#39;</span><span class="p">]</span><span class="o">=</span><span class="n">df_0_2</span><span class="p">[</span><span class="s1">&#39;ICAPITAL&#39;</span><span class="p">]</span>
            <span class="n">df_0_3</span><span class="o">=</span><span class="n">df_0_2</span><span class="o">.</span><span class="n">merge</span><span class="p">(</span><span class="n">saldo_insoluto</span><span class="p">,</span><span class="n">how</span><span class="o">=</span><span class="s1">&#39;left&#39;</span><span class="p">,</span><span class="n">on</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;PRODUCTO&#39;</span><span class="p">,</span><span class="s1">&#39;CODIGO COBERTURA&#39;</span><span class="p">,</span><span class="s1">&#39;BASE&#39;</span><span class="p">],</span><span class="n">suffixes</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;&#39;</span><span class="p">,</span><span class="s1">&#39;_x&#39;</span><span class="p">])</span> <span class="c1"># type: ignore</span>
            <span class="n">df_0_3</span><span class="p">[</span><span class="s1">&#39;APLICA CALCULO SALDO INSOLUTO&#39;</span><span class="p">]</span><span class="o">=</span><span class="n">df_0_3</span><span class="p">[</span><span class="s1">&#39;APLICA CALCULO SALDO INSOLUTO&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">fillna</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
            <span class="c1"># * ESPECIFICO DE DESG NL: PRODUCTOS CON CAPITAL COMO EL SALDO INSOLUTO DEBEN CALCULARSE</span>
            <span class="k">if</span> <span class="n">contrato</span> <span class="ow">in</span> <span class="p">[</span><span class="s1">&#39;Desgravamen No Licitado&#39;</span><span class="p">]:</span>
                <span class="n">df_0_4</span><span class="o">=</span><span class="n">df_0_3</span><span class="p">[</span><span class="n">df_0_3</span><span class="p">[</span><span class="s1">&#39;APLICA CALCULO SALDO INSOLUTO&#39;</span><span class="p">]</span><span class="o">==</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
                <span class="n">df_0_4_resto</span><span class="o">=</span><span class="n">df_0_3</span><span class="p">[</span><span class="n">df_0_3</span><span class="p">[</span><span class="s1">&#39;APLICA CALCULO SALDO INSOLUTO&#39;</span><span class="p">]</span><span class="o">==</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
                <span class="n">df_0_4</span><span class="p">[</span><span class="s1">&#39;FECHA_FIN_CRED&#39;</span><span class="p">]</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">df_0_4</span><span class="p">[</span><span class="s1">&#39;BASE&#39;</span><span class="p">]</span><span class="o">==</span><span class="s1">&#39;GES&#39;</span><span class="p">,</span><span class="n">np</span><span class="o">.</span><span class="n">maximum</span><span class="p">(</span><span class="n">df_0_4</span><span class="p">[</span><span class="s1">&#39;FECHA_VENCIMIENTO&#39;</span><span class="p">],</span><span class="n">df_0_4</span><span class="p">[</span><span class="s1">&#39;FECHA_FIN_CRED&#39;</span><span class="p">]),</span><span class="n">df_0_4</span><span class="p">[</span><span class="s1">&#39;FECHA_VENCIMIENTO&#39;</span><span class="p">])</span>
                <span class="n">df_0_4</span><span class="p">[</span><span class="s1">&#39;NCUOTAS&#39;</span><span class="p">]</span><span class="o">=</span><span class="p">((</span><span class="n">df_0_4</span><span class="p">[</span><span class="s1">&#39;FECHA_FIN_CRED&#39;</span><span class="p">]</span><span class="o">-</span><span class="n">df_0_4</span><span class="p">[</span><span class="s1">&#39;FECHA_EFECTO&#39;</span><span class="p">])</span><span class="o">.</span><span class="n">dt</span><span class="o">.</span><span class="n">days</span><span class="o">/</span><span class="mi">365</span><span class="o">*</span><span class="mi">12</span><span class="p">)</span><span class="o">.</span><span class="n">round</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
                <span class="n">df_0_4</span><span class="p">[</span><span class="s1">&#39;NCUOTAS FALTANTES&#39;</span><span class="p">]</span><span class="o">=</span><span class="p">((</span><span class="n">df_0_4</span><span class="p">[</span><span class="s1">&#39;FECHA_FIN_CRED&#39;</span><span class="p">]</span><span class="o">-</span><span class="n">fecha_cierre</span><span class="p">)</span><span class="o">.</span><span class="n">dt</span><span class="o">.</span><span class="n">days</span><span class="o">/</span><span class="mi">365</span><span class="o">*</span><span class="mi">12</span><span class="p">)</span><span class="o">.</span><span class="n">round</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
                <span class="n">df_0_4</span><span class="p">[</span><span class="s1">&#39;PERIODO_EFECTO&#39;</span><span class="p">]</span><span class="o">=</span><span class="n">df_0_4</span><span class="p">[</span><span class="s1">&#39;FECHA_EFECTO&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">dt</span><span class="o">.</span><span class="n">year</span><span class="o">*</span><span class="mi">100</span><span class="o">+</span><span class="n">df_0_4</span><span class="p">[</span><span class="s1">&#39;FECHA_EFECTO&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">dt</span><span class="o">.</span><span class="n">month</span>
                <span class="n">df_0_4</span><span class="o">=</span><span class="n">completa_campo_total</span><span class="p">(</span><span class="n">df_0_4</span><span class="p">,</span><span class="s1">&#39;TASA_CRED&#39;</span><span class="p">,[[</span><span class="s1">&#39;PRODUCTO&#39;</span><span class="p">,</span><span class="s1">&#39;PERIODO_EFECTO&#39;</span><span class="p">],[</span><span class="s1">&#39;PERIODO_EFECTO&#39;</span><span class="p">]],</span> <span class="n">parameters</span><span class="p">)</span>
                <span class="n">df_0_4</span><span class="p">[</span><span class="s1">&#39;SALDO INSOLUTO CALCULADO&#39;</span><span class="p">]</span><span class="o">=</span><span class="n">df_0_4</span><span class="p">[</span><span class="s1">&#39;ICAPITAL&#39;</span><span class="p">]</span><span class="o">*</span><span class="p">(</span><span class="mi">1</span><span class="o">-</span><span class="p">(</span><span class="mi">1</span><span class="o">+</span><span class="n">df_0_4</span><span class="p">[</span><span class="s1">&#39;TASA_CRED_FINAL&#39;</span><span class="p">])</span><span class="o">**</span><span class="p">(</span><span class="o">-</span><span class="n">df_0_4</span><span class="p">[</span><span class="s1">&#39;NCUOTAS FALTANTES&#39;</span><span class="p">]))</span><span class="o">/</span><span class="p">(</span><span class="mi">1</span><span class="o">-</span><span class="p">(</span><span class="mi">1</span><span class="o">+</span><span class="n">df_0_4</span><span class="p">[</span><span class="s1">&#39;TASA_CRED_FINAL&#39;</span><span class="p">])</span><span class="o">**</span><span class="p">(</span><span class="o">-</span><span class="n">df_0_4</span><span class="p">[</span><span class="s1">&#39;NCUOTAS&#39;</span><span class="p">]))</span>
                <span class="n">df_0_4</span><span class="p">[</span><span class="s1">&#39;MONTO ASEGURADO&#39;</span><span class="p">]</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">df_0_4</span><span class="p">[</span><span class="s1">&#39;SALDO_INSOLUTO&#39;</span><span class="p">]</span><span class="o">&gt;</span><span class="mi">0</span><span class="p">,</span><span class="n">df_0_4</span><span class="p">[</span><span class="s1">&#39;SALDO_INSOLUTO&#39;</span><span class="p">],</span><span class="n">np</span><span class="o">.</span><span class="n">maximum</span><span class="p">(</span><span class="n">df_0_4</span><span class="p">[</span><span class="s1">&#39;SALDO INSOLUTO CALCULADO&#39;</span><span class="p">],</span><span class="mi">0</span><span class="p">))</span> 
                <span class="n">df_0_5</span><span class="o">=</span><span class="n">pd</span><span class="o">.</span><span class="n">concat</span><span class="p">([</span><span class="n">df_0_4</span><span class="p">,</span><span class="n">df_0_4_resto</span><span class="p">],</span><span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
                <span class="n">df_0_5</span> <span class="o">=</span> <span class="n">df_0_5</span><span class="o">.</span><span class="n">reset_index</span><span class="p">(</span><span class="n">drop</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
                <span class="c1"># ! Solicitud area de productos: producto 331 se encuentra con coberturas duplicados y problemas de capitales mal asignados</span>
                <span class="n">df_331</span> <span class="o">=</span> <span class="n">df_0_5</span><span class="p">[(</span><span class="n">df_0_5</span><span class="p">[</span><span class="s1">&#39;PRODUCTO&#39;</span><span class="p">]</span><span class="o">==</span><span class="mi">331</span><span class="p">)</span><span class="o">&amp;</span><span class="p">(</span><span class="n">df_0_5</span><span class="p">[</span><span class="s1">&#39;BASE&#39;</span><span class="p">]</span><span class="o">==</span><span class="s1">&#39;IAXIS&#39;</span><span class="p">)</span><span class="o">&amp;</span><span class="p">(</span><span class="n">df_0_5</span><span class="p">[</span><span class="s1">&#39;CODIGO COBERTURA&#39;</span><span class="p">]</span><span class="o">==</span><span class="mi">12</span><span class="p">)]</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
                <span class="n">df_resto</span> <span class="o">=</span> <span class="n">df_0_5</span><span class="p">[</span><span class="o">~</span><span class="n">df_0_5</span><span class="o">.</span><span class="n">index</span><span class="o">.</span><span class="n">isin</span><span class="p">(</span><span class="n">df_331</span><span class="o">.</span><span class="n">index</span><span class="p">)]</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
                <span class="n">df_331</span><span class="p">[</span><span class="s1">&#39;PRIMA NETA ANUAL&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">df_331</span><span class="o">.</span><span class="n">groupby</span><span class="p">(</span><span class="s1">&#39;SSEGURO&#39;</span><span class="p">)[</span><span class="s1">&#39;PRIMA NETA ANUAL&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">transform</span><span class="p">(</span><span class="s1">&#39;sum&#39;</span><span class="p">)</span>
                <span class="n">df_331</span> <span class="o">=</span> <span class="n">df_331</span><span class="p">[</span><span class="n">df_331</span><span class="p">[</span><span class="s1">&#39;CODIGO COBERTURA IAXIS&#39;</span><span class="p">]</span><span class="o">==</span><span class="mi">1200</span><span class="p">]</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
                <span class="n">df_0_6</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">concat</span><span class="p">([</span><span class="n">df_resto</span><span class="p">,</span><span class="n">df_331</span><span class="p">])</span><span class="o">.</span><span class="n">reset_index</span><span class="p">(</span><span class="n">drop</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
                <span class="n">df_final_0</span><span class="o">=</span><span class="n">df_0_6</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
            <span class="k">else</span><span class="p">:</span> <span class="n">df_final_0</span><span class="o">=</span><span class="n">df_0_3</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
            <span class="c1"># * Tratamiento saldo insoluto para Multisocios</span>
            <span class="k">if</span> <span class="n">contrato</span> <span class="ow">in</span> <span class="p">[</span><span class="s1">&#39;Multisocios&#39;</span><span class="p">]:</span>
                <span class="n">df_0_3</span><span class="p">[</span><span class="s1">&#39;FECHA_FIN_CRED&#39;</span><span class="p">]</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">df_0_3</span><span class="p">[</span><span class="s1">&#39;BASE&#39;</span><span class="p">]</span><span class="o">==</span><span class="s1">&#39;GES&#39;</span><span class="p">,</span><span class="n">np</span><span class="o">.</span><span class="n">maximum</span><span class="p">(</span><span class="n">df_0_3</span><span class="p">[</span><span class="s1">&#39;FECHA_VENCIMIENTO&#39;</span><span class="p">],</span><span class="n">df_0_3</span><span class="p">[</span><span class="s1">&#39;FECHA_FIN_CRED&#39;</span><span class="p">]),</span><span class="n">df_0_3</span><span class="p">[</span><span class="s1">&#39;FECHA_VENCIMIENTO&#39;</span><span class="p">])</span>
                <span class="n">df_0_3</span><span class="p">[</span><span class="s1">&#39;NCUOTAS&#39;</span><span class="p">]</span><span class="o">=</span><span class="p">((</span><span class="n">df_0_3</span><span class="p">[</span><span class="s1">&#39;FECHA_FIN_CRED&#39;</span><span class="p">]</span><span class="o">-</span><span class="n">df_0_3</span><span class="p">[</span><span class="s1">&#39;FECHA_EFECTO&#39;</span><span class="p">])</span><span class="o">.</span><span class="n">dt</span><span class="o">.</span><span class="n">days</span><span class="o">/</span><span class="mi">365</span><span class="o">*</span><span class="mi">12</span><span class="p">)</span><span class="o">.</span><span class="n">round</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
                <span class="n">df_0_3</span><span class="p">[</span><span class="s1">&#39;NCUOTAS FALTANTES&#39;</span><span class="p">]</span><span class="o">=</span><span class="p">((</span><span class="n">df_0_3</span><span class="p">[</span><span class="s1">&#39;FECHA_FIN_CRED&#39;</span><span class="p">]</span><span class="o">-</span><span class="n">fecha_cierre</span><span class="p">)</span><span class="o">.</span><span class="n">dt</span><span class="o">.</span><span class="n">days</span><span class="o">/</span><span class="mi">365</span><span class="o">*</span><span class="mi">12</span><span class="p">)</span><span class="o">.</span><span class="n">round</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
                <span class="n">df_0_3</span><span class="p">[</span><span class="s1">&#39;PERIODO_EFECTO&#39;</span><span class="p">]</span><span class="o">=</span><span class="n">df_0_3</span><span class="p">[</span><span class="s1">&#39;FECHA_EFECTO&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">dt</span><span class="o">.</span><span class="n">year</span><span class="o">*</span><span class="mi">100</span><span class="o">+</span><span class="n">df_0_3</span><span class="p">[</span><span class="s1">&#39;FECHA_EFECTO&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">dt</span><span class="o">.</span><span class="n">month</span>
                <span class="n">df_0_3</span><span class="o">=</span><span class="n">completa_campo_total</span><span class="p">(</span><span class="n">df_0_3</span><span class="p">,</span><span class="s1">&#39;TASA_CRED&#39;</span><span class="p">,[[</span><span class="s1">&#39;PRODUCTO&#39;</span><span class="p">,</span><span class="s1">&#39;PERIODO_EFECTO&#39;</span><span class="p">],[</span><span class="s1">&#39;PERIODO_EFECTO&#39;</span><span class="p">]],</span> <span class="n">parameters</span><span class="p">)</span>
                <span class="n">df_0_3</span><span class="p">[</span><span class="s1">&#39;SALDO INSOLUTO CALCULADO&#39;</span><span class="p">]</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">df_0_3</span><span class="p">[</span><span class="s1">&#39;FECHA_FIN_CRED&#39;</span><span class="p">]</span><span class="o">&lt;</span><span class="n">fecha_cierre</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="n">df_0_3</span><span class="p">[</span><span class="s1">&#39;ICAPITAL&#39;</span><span class="p">]</span><span class="o">*</span><span class="p">(</span><span class="mi">1</span><span class="o">-</span><span class="p">(</span><span class="mi">1</span><span class="o">+</span><span class="n">df_0_3</span><span class="p">[</span><span class="s1">&#39;TASA_CRED_FINAL&#39;</span><span class="p">])</span><span class="o">**</span><span class="p">(</span><span class="o">-</span><span class="n">df_0_3</span><span class="p">[</span><span class="s1">&#39;NCUOTAS FALTANTES&#39;</span><span class="p">]))</span><span class="o">/</span><span class="p">(</span><span class="mi">1</span><span class="o">-</span><span class="p">(</span><span class="mi">1</span><span class="o">+</span><span class="n">df_0_3</span><span class="p">[</span><span class="s1">&#39;TASA_CRED_FINAL&#39;</span><span class="p">])</span><span class="o">**</span><span class="p">(</span><span class="o">-</span><span class="n">df_0_3</span><span class="p">[</span><span class="s1">&#39;NCUOTAS&#39;</span><span class="p">])))</span>
                <span class="n">df_0_3</span><span class="p">[</span><span class="s1">&#39;MONTO ASEGURADO&#39;</span><span class="p">]</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">maximum</span><span class="p">(</span><span class="n">df_0_3</span><span class="p">[</span><span class="s1">&#39;SALDO INSOLUTO CALCULADO&#39;</span><span class="p">],</span><span class="mi">0</span><span class="p">)</span>
                <span class="n">df_final_0</span><span class="o">=</span><span class="n">df_0_3</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
        <span class="c1"># * CALCULOS PARA K-FIJO</span>
        <span class="k">elif</span> <span class="p">(</span><span class="n">tipo_contrato</span><span class="o">==</span><span class="s1">&#39;Vida&#39;</span><span class="p">)</span><span class="o">&amp;</span><span class="p">(</span><span class="n">contrato</span><span class="o">==</span><span class="s1">&#39;K-Fijo&#39;</span><span class="p">):</span> 
            <span class="n">df_0_1</span><span class="p">[</span><span class="s1">&#39;EXPOSICION MENSUAL&#39;</span><span class="p">]</span><span class="o">=</span><span class="mi">1</span>
            <span class="n">escribe_reporta</span><span class="p">(</span><span class="n">archivo_reporte</span><span class="p">,</span><span class="s1">&#39;Calculando edad de renovacion&#39;</span><span class="p">)</span>
            <span class="n">df_0_1</span><span class="p">[</span><span class="s1">&#39;EDAD RENOVACION&#39;</span><span class="p">],</span><span class="n">df_0_1</span><span class="p">[</span><span class="s1">&#39;ISSUE EDAD RENOV&#39;</span><span class="p">]</span><span class="o">=</span><span class="n">calcula_edad</span><span class="p">(</span><span class="n">df_0_1</span><span class="p">[</span><span class="s1">&#39;RUT&#39;</span><span class="p">],</span><span class="n">df_0_1</span><span class="p">[</span><span class="s1">&#39;FEC_NAC&#39;</span><span class="p">],</span><span class="n">fecha_inicio_mes</span><span class="p">,</span><span class="n">edad_casos_perdidos</span><span class="p">,</span><span class="mi">108</span><span class="p">,</span><span class="n">archivo_reporte</span><span class="p">,</span><span class="n">reporta_issues</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">edad_inf</span> <span class="o">=</span> <span class="mi">18</span><span class="p">,</span> <span class="n">aplica_edad_prom_cartera</span> <span class="o">=</span> <span class="mi">1</span><span class="p">)</span>
            <span class="n">df_0_1</span><span class="p">[</span><span class="s1">&#39;PLAZO MESES&#39;</span><span class="p">]</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">maximum</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="nb">round</span><span class="p">((</span><span class="n">df_0_1</span><span class="p">[</span><span class="s1">&#39;FECHA_VENCIMIENTO&#39;</span><span class="p">]</span><span class="o">-</span><span class="n">df_0_1</span><span class="p">[</span><span class="s1">&#39;FECHA_EFECTO&#39;</span><span class="p">])</span><span class="o">.</span><span class="n">dt</span><span class="o">.</span><span class="n">days</span><span class="o">/</span><span class="p">(</span><span class="mf">365.25</span><span class="o">/</span><span class="mi">12</span><span class="p">),</span><span class="mi">0</span><span class="p">))</span>
            <span class="n">df_0_1</span><span class="p">[</span><span class="s1">&#39;MONTO ASEGURADO&#39;</span><span class="p">]</span><span class="o">=</span><span class="n">df_0_1</span><span class="p">[</span><span class="s1">&#39;ICAPITAL&#39;</span><span class="p">]</span>
            <span class="n">df_0_2</span><span class="o">=</span><span class="n">df_0_1</span><span class="p">[</span><span class="n">df_0_1</span><span class="p">[</span><span class="s1">&#39;FECHA_EFECTO&#39;</span><span class="p">]</span><span class="o">&lt;=</span><span class="n">fecha_cierre</span><span class="p">]</span>
            <span class="n">df_final_0</span><span class="o">=</span><span class="n">df_0_2</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
        <span class="c1"># * Exportamos Edades con problemas</span>
        <span class="c1"># EXPORTO EDADES CON ISSUES</span>
        <span class="k">if</span> <span class="s1">&#39;ISSUE EDAD INGR&#39;</span> <span class="ow">in</span> <span class="n">df_final_0</span><span class="o">.</span><span class="n">columns</span><span class="p">:</span>
            <span class="k">if</span> <span class="nb">sum</span><span class="p">(</span><span class="n">df_final_0</span><span class="p">[</span><span class="s1">&#39;ISSUE EDAD INGR&#39;</span><span class="p">])</span><span class="o">&gt;</span><span class="mi">0</span><span class="p">:</span> <span class="n">df_final_0</span><span class="p">[</span><span class="n">df_final_0</span><span class="p">[</span><span class="s1">&#39;ISSUE EDAD INGR&#39;</span><span class="p">]</span><span class="o">==</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">to_csv</span><span class="p">(</span><span class="n">ruta_output</span><span class="o">+</span><span class="s1">&#39;0. Edades de Ingreso a Revisar.csv&#39;</span><span class="p">,</span><span class="n">sep</span><span class="o">=</span><span class="n">separador_output</span><span class="p">,</span><span class="n">decimal</span><span class="o">=</span><span class="n">decimal_output</span><span class="p">,</span><span class="n">date_format</span><span class="o">=</span><span class="s1">&#39;</span><span class="si">%d</span><span class="s1">-%m-%Y&#39;</span><span class="p">,</span><span class="n">index</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
        <span class="k">if</span> <span class="s1">&#39;ISSUE EDAD RENOV&#39;</span> <span class="ow">in</span> <span class="n">df_final_0</span><span class="o">.</span><span class="n">columns</span><span class="p">:</span>
            <span class="k">if</span> <span class="nb">sum</span><span class="p">(</span><span class="n">df_final_0</span><span class="p">[</span><span class="s1">&#39;ISSUE EDAD RENOV&#39;</span><span class="p">])</span><span class="o">&gt;</span><span class="mi">0</span><span class="p">:</span> <span class="n">df_final_0</span><span class="p">[</span><span class="n">df_final_0</span><span class="p">[</span><span class="s1">&#39;ISSUE EDAD RENOV&#39;</span><span class="p">]</span><span class="o">==</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">to_csv</span><span class="p">(</span><span class="n">ruta_output</span><span class="o">+</span><span class="s1">&#39;0. Edades de Renovacion a Revisar.csv&#39;</span><span class="p">,</span><span class="n">sep</span><span class="o">=</span><span class="n">separador_output</span><span class="p">,</span><span class="n">decimal</span><span class="o">=</span><span class="n">decimal_output</span><span class="p">,</span><span class="n">date_format</span><span class="o">=</span><span class="s1">&#39;</span><span class="si">%d</span><span class="s1">-%m-%Y&#39;</span><span class="p">,</span><span class="n">index</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
        <span class="n">escribe_reporta</span><span class="p">(</span><span class="n">archivo_reporte</span><span class="p">,</span><span class="s1">&#39;El dataframe input luego de ser pre-procesado posee una prima neta de </span><span class="si">{}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">nansum</span><span class="p">(</span><span class="n">df_final_0</span><span class="p">[</span><span class="s1">&#39;PRIMA NETA ANUAL&#39;</span><span class="p">])))</span>
    <span class="c1"># * Ultimos filtros</span>
    <span class="c1"># Trabajamos con el df_final_0 y hacemos todas las operaciones que debamos hacer en general</span>
    <span class="n">df_final_1</span><span class="o">=</span><span class="n">df_final_0</span><span class="p">[</span><span class="n">df_final_0</span><span class="p">[</span><span class="s1">&#39;EXPOSICION MENSUAL&#39;</span><span class="p">]</span><span class="o">&gt;</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
    <span class="c1"># ! Solicitud Productos: Trabajar con los asegurados que estan vigentes a fin de mes</span>
    <span class="n">df_final_2</span><span class="o">=</span><span class="n">df_final_1</span><span class="p">[(</span><span class="n">df_final_1</span><span class="p">[</span><span class="s1">&#39;FECHA_VENCIMIENTO&#39;</span><span class="p">]</span><span class="o">&gt;=</span><span class="n">fecha_cierre</span><span class="p">)</span><span class="o">|</span><span class="p">(</span><span class="n">df_final_1</span><span class="p">[</span><span class="s1">&#39;FECHA_VENCIMIENTO&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">isnull</span><span class="p">())]</span>
    <span class="n">df_final_3</span><span class="o">=</span><span class="n">df_final_2</span><span class="p">[(</span><span class="n">df_final_2</span><span class="p">[</span><span class="s1">&#39;FECHA_ANULACION&#39;</span><span class="p">]</span><span class="o">&gt;=</span><span class="n">fecha_cierre</span><span class="p">)</span><span class="o">|</span><span class="p">(</span><span class="n">df_final_2</span><span class="p">[</span><span class="s1">&#39;FECHA_ANULACION&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">isnull</span><span class="p">())]</span>
    <span class="k">return</span> <span class="n">df_final_3</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>



  </div>

    </div>

</div>

<div class="doc doc-object doc-module">



<a id="S4_Calculos_Renovacion"></a>
    <div class="doc doc-contents first">

        <p>Modulo para calcular la renovación de reaseguro para un contrato específico.</p>








  <div class="doc doc-children">









<div class="doc doc-object doc-function">


<h2 id="S4_Calculos_Renovacion.calculos_renovacion" class="doc doc-heading">
            <code class="highlight language-python"><span class="n">calculos_renovacion</span><span class="p">(</span><span class="n">parameters</span><span class="p">,</span> <span class="n">tables</span><span class="p">,</span> <span class="n">ruta_salidas</span><span class="p">)</span></code>

</h2>


    <div class="doc doc-contents ">

        <p>Realiza los calculos de asociados a la renovacion de reaseguro para un contrato en específico.</p>


<p><span class="doc-section-title">Parameters:</span></p>
    <table>
      <thead>
        <tr>
          <th>Name</th>
          <th>Type</th>
          <th>Description</th>
          <th>Default</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
                <code>parameters</code>
            </td>
            <td>
                  <code><a class="autorefs autorefs-internal" title="S0_Loaders.Parameter_Loader" href="#S0_Loaders.Parameter_Loader">Parameter_Loader</a></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Contiene todos los parametros de la ejecución</p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>tables</code>
            </td>
            <td>
                  <code><a class="autorefs autorefs-internal" title="S0_Loaders.Parameter_Loader" href="#S0_Loaders.Parameter_Loader">Parameter_Loader</a></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Contiene las tablas de parametria que se utilizan durante el proceso</p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>ruta_salidas</code>
            </td>
            <td>
                  <code>str</code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Contiene la ruta donde se guardarán los resultados principales de los calculos</p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
      </tbody>
    </table>

            <details class="quote">
              <summary>Source code in <code>S4_Calculos_Renovacion.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"> 17</span>
<span class="normal"> 18</span>
<span class="normal"> 19</span>
<span class="normal"> 20</span>
<span class="normal"> 21</span>
<span class="normal"> 22</span>
<span class="normal"> 23</span>
<span class="normal"> 24</span>
<span class="normal"> 25</span>
<span class="normal"> 26</span>
<span class="normal"> 27</span>
<span class="normal"> 28</span>
<span class="normal"> 29</span>
<span class="normal"> 30</span>
<span class="normal"> 31</span>
<span class="normal"> 32</span>
<span class="normal"> 33</span>
<span class="normal"> 34</span>
<span class="normal"> 35</span>
<span class="normal"> 36</span>
<span class="normal"> 37</span>
<span class="normal"> 38</span>
<span class="normal"> 39</span>
<span class="normal"> 40</span>
<span class="normal"> 41</span>
<span class="normal"> 42</span>
<span class="normal"> 43</span>
<span class="normal"> 44</span>
<span class="normal"> 45</span>
<span class="normal"> 46</span>
<span class="normal"> 47</span>
<span class="normal"> 48</span>
<span class="normal"> 49</span>
<span class="normal"> 50</span>
<span class="normal"> 51</span>
<span class="normal"> 52</span>
<span class="normal"> 53</span>
<span class="normal"> 54</span>
<span class="normal"> 55</span>
<span class="normal"> 56</span>
<span class="normal"> 57</span>
<span class="normal"> 58</span>
<span class="normal"> 59</span>
<span class="normal"> 60</span>
<span class="normal"> 61</span>
<span class="normal"> 62</span>
<span class="normal"> 63</span>
<span class="normal"> 64</span>
<span class="normal"> 65</span>
<span class="normal"> 66</span>
<span class="normal"> 67</span>
<span class="normal"> 68</span>
<span class="normal"> 69</span>
<span class="normal"> 70</span>
<span class="normal"> 71</span>
<span class="normal"> 72</span>
<span class="normal"> 73</span>
<span class="normal"> 74</span>
<span class="normal"> 75</span>
<span class="normal"> 76</span>
<span class="normal"> 77</span>
<span class="normal"> 78</span>
<span class="normal"> 79</span>
<span class="normal"> 80</span>
<span class="normal"> 81</span>
<span class="normal"> 82</span>
<span class="normal"> 83</span>
<span class="normal"> 84</span>
<span class="normal"> 85</span>
<span class="normal"> 86</span>
<span class="normal"> 87</span>
<span class="normal"> 88</span>
<span class="normal"> 89</span>
<span class="normal"> 90</span>
<span class="normal"> 91</span>
<span class="normal"> 92</span>
<span class="normal"> 93</span>
<span class="normal"> 94</span>
<span class="normal"> 95</span>
<span class="normal"> 96</span>
<span class="normal"> 97</span>
<span class="normal"> 98</span>
<span class="normal"> 99</span>
<span class="normal">100</span>
<span class="normal">101</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span> <span class="nf">calculos_renovacion</span><span class="p">(</span><span class="n">parameters</span><span class="p">:</span> <span class="n">Parameter_Loader</span><span class="p">,</span> <span class="n">tables</span><span class="p">:</span> <span class="n">Parameter_Loader</span><span class="p">,</span> <span class="n">ruta_salidas</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Realiza los calculos de asociados a la renovacion de reaseguro para un contrato en específico.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    parameters : Parameter_Loader</span>
<span class="sd">        Contiene todos los parametros de la ejecución</span>
<span class="sd">    tables : Parameter_Loader</span>
<span class="sd">        Contiene las tablas de parametria que se utilizan durante el proceso</span>
<span class="sd">    ruta_salidas : str</span>
<span class="sd">        Contiene la ruta donde se guardarán los resultados principales de los calculos</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="c1"># * Traemos parametros y tablas que vamos a usar</span>
    <span class="c1"># Contrato de reaseguro</span>
    <span class="n">contrato</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="n">parameters</span><span class="o">.</span><span class="n">parameters</span><span class="p">[</span><span class="s1">&#39;contrato&#39;</span><span class="p">]</span>
    <span class="c1"># Matriz para asignar el nombre del producto</span>
    <span class="n">nombre_prods</span><span class="p">:</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span> <span class="o">=</span> <span class="n">tables</span><span class="o">.</span><span class="n">get_table_xlsx</span><span class="p">(</span><span class="n">sheet_name</span> <span class="o">=</span> <span class="s1">&#39;Nombre Productos Renovacion&#39;</span><span class="p">)</span>
    <span class="c1"># Matrices para asignar los campos RAMO_REAS y COB_REAS </span>
    <span class="c1"># ! Estos campos son solicitados por el área de productos y son dos matrices porque una es para el contrato de reaseguro de Desgravamen No Licitado, mientras que la otra matriz es para el resto de contratos</span>
    <span class="n">ramo_reas_otros</span><span class="p">:</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span> <span class="o">=</span> <span class="n">tables</span><span class="o">.</span><span class="n">get_table_xlsx</span><span class="p">(</span><span class="n">sheet_name</span> <span class="o">=</span> <span class="s1">&#39;Ramo Reas Otros&#39;</span><span class="p">)</span>
    <span class="n">ramo_reas_desgnl</span><span class="p">:</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span> <span class="o">=</span> <span class="n">tables</span><span class="o">.</span><span class="n">get_table_xlsx</span><span class="p">(</span><span class="n">sheet_name</span> <span class="o">=</span> <span class="s1">&#39;Ramo Reas Desg NL&#39;</span><span class="p">)</span>

    <span class="c1"># * Calculos previos del proceso antes de asignar el contrato de reaseguro</span>
    <span class="c1"># Preprocesamiento de la Data: A las querys que se extraen de los sistemas de administracion de BBDD (GES e Iaxis) se le realizan ciertas transformaciones a la data antes de asignar contratos de reaseguro y realizar los calculos</span>
    <span class="n">df</span><span class="p">:</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span> <span class="o">=</span> <span class="n">pre_procesamiento</span><span class="p">(</span><span class="n">parameters</span><span class="p">,</span> <span class="n">tables</span><span class="p">)</span>
    <span class="c1"># ! Solicitado por el área de productos, anonimizamos el campo RUT</span>
    <span class="n">df</span> <span class="o">=</span> <span class="n">identificador_anonimo</span><span class="p">(</span><span class="n">df</span><span class="p">,</span> <span class="p">[</span><span class="s1">&#39;RUT&#39;</span><span class="p">])</span>
    <span class="c1">#  ! Solicitado por el área de productos, eliminamos los productos de Hospitalario 100% y productos fallecimiento COVID&#39;</span>
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;Se eliminarán </span><span class="si">{</span><span class="nb">sum</span><span class="p">(</span><span class="n">df</span><span class="p">[</span><span class="s2">&quot;PRODUCTO&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">isin</span><span class="p">([</span><span class="mi">88</span><span class="p">,</span><span class="mi">101</span><span class="p">,</span><span class="mi">193</span><span class="p">,</span><span class="mi">369</span><span class="p">,</span><span class="mi">370</span><span class="p">,</span><span class="mi">371</span><span class="p">,</span><span class="mi">372</span><span class="p">]))</span><span class="si">}</span><span class="s1"> registros que pertenecen a los productos de Hospitalario 100% y productos fallecimiento COVID&#39;</span><span class="p">)</span>
    <span class="n">df</span> <span class="o">=</span> <span class="n">df</span><span class="p">[</span><span class="o">~</span><span class="n">df</span><span class="p">[</span><span class="s1">&#39;PRODUCTO&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">isin</span><span class="p">([</span><span class="mi">88</span><span class="p">,</span><span class="mi">101</span><span class="p">,</span><span class="mi">193</span><span class="p">,</span><span class="mi">369</span><span class="p">,</span><span class="mi">370</span><span class="p">,</span><span class="mi">371</span><span class="p">,</span><span class="mi">372</span><span class="p">])]</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
    <span class="c1"># Campo para luego contar la cantidad de registros</span>
    <span class="n">df</span><span class="p">[</span><span class="s1">&#39;REGISTROS&#39;</span><span class="p">]</span><span class="o">=</span><span class="mi">1</span>
    <span class="c1"># Identificamos los registros que poseen recargos de sobreprima o extraprima</span>
    <span class="n">df</span> <span class="o">=</span> <span class="n">recargos</span><span class="p">(</span><span class="n">df</span><span class="p">,</span><span class="n">parameters</span><span class="p">,</span><span class="n">calcula_recargos</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>

    <span class="c1"># * Calculos de asignacion de contratos de reaseguro</span>
    <span class="c1"># Asignamos contrato de reaseguro a los registros</span>
    <span class="n">df</span> <span class="o">=</span> <span class="n">asignacion_contratos</span><span class="p">(</span><span class="n">df</span><span class="p">,</span> <span class="n">parameters</span><span class="p">,</span> <span class="n">tables</span><span class="p">,</span> <span class="n">mantiene_na</span> <span class="o">=</span> <span class="mi">1</span><span class="p">)</span>
    <span class="c1"># Asignamos vigencia del contrato a la que pertenecen los registros</span>
    <span class="n">df</span><span class="p">,</span><span class="n">df_deleted_vigencia</span> <span class="o">=</span> <span class="n">asignacion_vigencias</span><span class="p">(</span><span class="n">df</span><span class="p">,</span> <span class="n">parameters</span><span class="p">,</span> <span class="n">tables</span><span class="p">,</span> <span class="n">mantiene_na</span> <span class="o">=</span> <span class="mi">1</span><span class="p">)</span>

    <span class="c1"># * Calculos de cumulos asociados a los contratos</span>
    <span class="c1"># Cumulo sobre el monto asegurado que proviene de cada persona individualmente</span>
    <span class="n">df</span> <span class="o">=</span> <span class="n">cumulos</span><span class="p">(</span><span class="n">df</span><span class="p">,</span> <span class="n">parameters</span><span class="p">,</span> <span class="n">tables</span><span class="p">,</span> <span class="n">campo_cumulo</span> <span class="o">=</span> <span class="s1">&#39;RIESGO LIMITE INDIVIDUAL&#39;</span><span class="p">)</span>
    <span class="c1"># Cumulo sobre el monto asegurado que proviene del contrato en su conjunto</span>
    <span class="n">df</span> <span class="o">=</span> <span class="n">cumulos</span><span class="p">(</span><span class="n">df</span><span class="p">,</span> <span class="n">parameters</span><span class="p">,</span> <span class="n">tables</span><span class="p">,</span> <span class="n">campo_cumulo</span> <span class="o">=</span> <span class="s1">&#39;RIESGO LIMITE CONTRATO&#39;</span><span class="p">)</span>
    <span class="c1"># Cumulo sobre el monto asegurado que aplica sobre contratos de excedente</span>
    <span class="n">df</span> <span class="o">=</span> <span class="n">cumulos</span><span class="p">(</span><span class="n">df</span><span class="p">,</span> <span class="n">parameters</span><span class="p">,</span> <span class="n">tables</span><span class="p">,</span> <span class="n">campo_cumulo</span> <span class="o">=</span> <span class="s1">&#39;RIESGO RETENCION EXCEDENTE&#39;</span><span class="p">)</span>

    <span class="c1"># * Calculos de capitales cedidos y retenidos</span>
    <span class="n">df</span><span class="p">[</span><span class="s1">&#39;CAPITAL CEDIDO POST EXCEDENTE&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">df</span><span class="p">[</span><span class="s1">&#39;CAPITAL POST LIMITE CONTRATO&#39;</span><span class="p">]</span> <span class="o">*</span> <span class="p">(</span><span class="mi">1</span><span class="o">-</span><span class="n">df</span><span class="p">[</span><span class="s1">&#39;PORCENTAJE RETENCION EXCEDENTE&#39;</span><span class="p">])</span>
    <span class="n">df</span><span class="p">[</span><span class="s1">&#39;CAPITAL RETENIDO POST QS&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">df</span><span class="p">[</span><span class="s1">&#39;CAPITAL RETENIDO POST EXCEDENTE&#39;</span><span class="p">]</span> <span class="o">*</span> <span class="p">(</span><span class="mi">1</span><span class="o">-</span><span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">df</span><span class="p">[</span><span class="s1">&#39;CESION QS&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">isnull</span><span class="p">(),</span><span class="mi">0</span><span class="p">,</span><span class="n">df</span><span class="p">[</span><span class="s1">&#39;CESION QS&#39;</span><span class="p">]))</span>
    <span class="n">df</span><span class="p">[</span><span class="s1">&#39;CAPITAL CEDIDO QS&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">df</span><span class="p">[</span><span class="s1">&#39;CAPITAL RETENIDO POST EXCEDENTE&#39;</span><span class="p">]</span> <span class="o">-</span> <span class="n">df</span><span class="p">[</span><span class="s1">&#39;CAPITAL RETENIDO POST QS&#39;</span><span class="p">]</span>
    <span class="n">df</span><span class="p">[</span><span class="s1">&#39;CAPITAL RETENIDO TOTAL&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">df</span><span class="p">[</span><span class="s1">&#39;MONTO ASEGURADO&#39;</span><span class="p">]</span><span class="o">-</span><span class="p">(</span><span class="n">df</span><span class="p">[</span><span class="s1">&#39;CAPITAL CEDIDO POST EXCEDENTE&#39;</span><span class="p">]</span> <span class="o">+</span> <span class="n">df</span><span class="p">[</span><span class="s1">&#39;CAPITAL CEDIDO QS&#39;</span><span class="p">])</span>
    <span class="n">df</span><span class="p">[</span><span class="s1">&#39;CAPITAL CEDIDO TOTAL&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">df</span><span class="p">[</span><span class="s1">&#39;CAPITAL CEDIDO POST EXCEDENTE&#39;</span><span class="p">]</span> <span class="o">+</span> <span class="n">df</span><span class="p">[</span><span class="s1">&#39;CAPITAL CEDIDO QS&#39;</span><span class="p">]</span>
    <span class="n">df</span><span class="p">[</span><span class="s1">&#39;PORCENTAJE CEDIDO FINAL&#39;</span><span class="p">]</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">df</span><span class="p">[</span><span class="s1">&#39;MONTO ASEGURADO&#39;</span><span class="p">]</span><span class="o">&gt;</span><span class="mi">0</span><span class="p">,</span><span class="n">df</span><span class="p">[</span><span class="s1">&#39;CAPITAL CEDIDO TOTAL&#39;</span><span class="p">]</span><span class="o">/</span><span class="n">df</span><span class="p">[</span><span class="s1">&#39;MONTO ASEGURADO&#39;</span><span class="p">],</span><span class="n">df</span><span class="p">[</span><span class="s1">&#39;CESION QS&#39;</span><span class="p">]</span><span class="o">*</span><span class="n">df</span><span class="p">[</span><span class="s1">&#39;PORCENTAJE LIMITE INDIVIDUAL&#39;</span><span class="p">]</span><span class="o">*</span><span class="n">df</span><span class="p">[</span><span class="s1">&#39;PORCENTAJE LIMITE CONTRATO&#39;</span><span class="p">]</span><span class="o">*</span><span class="n">df</span><span class="p">[</span><span class="s1">&#39;PORCENTAJE RETENCION EXCEDENTE&#39;</span><span class="p">])</span>

    <span class="c1"># ! Solicitado por el área de productos</span>
    <span class="c1"># asignamos campos RAMO_REAS y COB_REAS </span>
    <span class="k">if</span> <span class="n">contrato</span><span class="o">==</span><span class="s1">&#39;Desgravamen No Licitado&#39;</span><span class="p">:</span>
        <span class="n">df</span> <span class="o">=</span> <span class="n">cruce_left</span><span class="p">(</span><span class="n">df</span><span class="p">,</span> <span class="n">ramo_reas_desgnl</span><span class="p">,</span> <span class="p">[</span><span class="s1">&#39;COBERTURA DEL CONTRATO&#39;</span><span class="p">],</span> <span class="p">[</span><span class="s1">&#39;COBERTURA DEL CONTRATO&#39;</span><span class="p">],</span><span class="n">parameters</span><span class="p">,</span><span class="n">name</span><span class="o">=</span><span class="s1">&#39;ramo_reas_desgnl&#39;</span><span class="p">)</span>
    <span class="k">elif</span> <span class="n">contrato</span> <span class="ow">in</span> <span class="p">[</span><span class="s1">&#39;Digital Klare&#39;</span><span class="p">,</span><span class="s1">&#39;K-Fijo&#39;</span><span class="p">,</span><span class="s1">&#39;AP + Urgencias Medicas&#39;</span><span class="p">,</span><span class="s1">&#39;Multisocios&#39;</span><span class="p">]:</span>
        <span class="n">df</span> <span class="o">=</span> <span class="n">cruce_left</span><span class="p">(</span><span class="n">df</span><span class="p">,</span> <span class="n">ramo_reas_otros</span><span class="p">,</span> <span class="p">[</span><span class="s1">&#39;POL_PROD&#39;</span><span class="p">,</span><span class="s1">&#39;CODIGO COBERTURA&#39;</span><span class="p">],</span> <span class="p">[</span><span class="s1">&#39;POL_PROD&#39;</span><span class="p">,</span><span class="s1">&#39;CODIGO COBERTURA&#39;</span><span class="p">],</span><span class="n">parameters</span><span class="p">,</span><span class="n">name</span><span class="o">=</span><span class="s1">&#39;ramo_reas_otros&#39;</span><span class="p">)</span>
    <span class="c1"># Asignamos nombre de producto</span>
    <span class="n">df</span> <span class="o">=</span> <span class="n">cruce_left</span><span class="p">(</span><span class="n">df</span><span class="p">,</span> <span class="n">nombre_prods</span><span class="p">,</span> <span class="p">[</span><span class="s1">&#39;PRODUCTO&#39;</span><span class="p">,</span><span class="s1">&#39;BASE&#39;</span><span class="p">],</span> <span class="p">[</span><span class="s1">&#39;PRODUCTO&#39;</span><span class="p">,</span><span class="s1">&#39;BASE&#39;</span><span class="p">],</span><span class="n">parameters</span><span class="p">,</span><span class="n">name</span><span class="o">=</span><span class="s1">&#39;nombre_prods&#39;</span><span class="p">)</span>
    <span class="c1"># Contrato K-Fijo no posee estos campos, así que los creamos para que la base sea uniforme para todos los contratos</span>
    <span class="k">if</span> <span class="n">contrato</span> <span class="o">==</span> <span class="s1">&#39;K-Fijo&#39;</span><span class="p">:</span>
        <span class="c1"># Creamos Meses de renta igual a 1</span>
        <span class="n">df</span><span class="p">[</span><span class="s1">&#39;MESES RENTA&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="mi">1</span>
        <span class="c1"># Creamos tipo de asegurado como titular</span>
        <span class="n">df</span><span class="p">[</span><span class="s1">&#39;TIPO ASEGURADO&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;Titular&#39;</span>
    <span class="c1"># Campos seleccionados tanto para la salida de uso interno como para la salida que se entregará a los reaseguradores        </span>
    <span class="n">campos_productos</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;FECHA_CIERRE&#39;</span><span class="p">,</span><span class="s1">&#39;BASE&#39;</span><span class="p">,</span><span class="s1">&#39;IDENTIFICADOR&#39;</span><span class="p">,</span><span class="s1">&#39;RUT&#39;</span><span class="p">,</span><span class="s1">&#39;SSEGURO&#39;</span><span class="p">,</span><span class="s1">&#39;POLIZA&#39;</span><span class="p">,</span><span class="s1">&#39;CERTIFICADO&#39;</span><span class="p">,</span><span class="s1">&#39;PRODUCTO&#39;</span><span class="p">,</span><span class="s1">&#39;NOMBRE_PRODUCTO&#39;</span><span class="p">,</span><span class="s1">&#39;PLAN&#39;</span><span class="p">,</span><span class="s1">&#39;CODIGO_COBERTURA&#39;</span><span class="p">,</span><span class="s1">&#39;CODIGO_COBERTURA_IAXIS&#39;</span><span class="p">,</span><span class="s1">&#39;CONTRATO_REASEGURO&#39;</span><span class="p">,</span><span class="s1">&#39;COBERTURA_DEL_CONTRATO&#39;</span><span class="p">,</span><span class="s1">&#39;RAMO_REAS&#39;</span><span class="p">,</span><span class="s1">&#39;COB_REAS&#39;</span><span class="p">,</span><span class="s1">&#39;FECHA_EFECTO&#39;</span><span class="p">,</span><span class="s1">&#39;FECHA_VENCIMIENTO&#39;</span><span class="p">,</span><span class="s1">&#39;FECHA_ANULACION&#39;</span><span class="p">,</span><span class="s1">&#39;FEC_NAC&#39;</span><span class="p">,</span><span class="s1">&#39;EDAD&#39;</span><span class="p">,</span><span class="s1">&#39;SEXO&#39;</span><span class="p">,</span><span class="s1">&#39;TIPO_POLIZA&#39;</span><span class="p">,</span><span class="s1">&#39;FORMA_PAGO_CODIGO&#39;</span><span class="p">,</span><span class="s1">&#39;MESES_RENTA&#39;</span><span class="p">,</span><span class="s1">&#39;INNOMINADA&#39;</span><span class="p">,</span><span class="s1">&#39;PRIMA_NETA_ANUAL&#39;</span><span class="p">,</span><span class="s1">&#39;ICAPITAL&#39;</span><span class="p">,</span><span class="s1">&#39;MONTO_ASEGURADO&#39;</span><span class="p">,</span><span class="s1">&#39;CAPITAL_RETENIDO_TOTAL&#39;</span><span class="p">,</span><span class="s1">&#39;CAPITAL_CEDIDO_TOTAL&#39;</span><span class="p">,</span><span class="s1">&#39;RECARGO&#39;</span><span class="p">]</span>
    <span class="n">campos_renovacion</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;FECHA_CIERRE&#39;</span><span class="p">,</span><span class="s1">&#39;BASE&#39;</span><span class="p">,</span><span class="s1">&#39;IDENTIFICADOR&#39;</span><span class="p">,</span><span class="s1">&#39;SSEGURO&#39;</span><span class="p">,</span><span class="s1">&#39;POLIZA&#39;</span><span class="p">,</span><span class="s1">&#39;CERTIFICADO&#39;</span><span class="p">,</span><span class="s1">&#39;PRODUCTO&#39;</span><span class="p">,</span><span class="s1">&#39;CODIGO_COBERTURA&#39;</span><span class="p">,</span><span class="s1">&#39;RAMO_REAS&#39;</span><span class="p">,</span><span class="s1">&#39;COB_REAS&#39;</span><span class="p">,</span><span class="s1">&#39;TIPO_POLIZA&#39;</span><span class="p">,</span><span class="s1">&#39;FECHA_EFECTO&#39;</span><span class="p">,</span><span class="s1">&#39;FECHA_VENCIMIENTO&#39;</span><span class="p">,</span><span class="s1">&#39;FEC_NAC&#39;</span><span class="p">,</span><span class="s1">&#39;EDAD&#39;</span><span class="p">,</span><span class="s1">&#39;SEXO&#39;</span><span class="p">,</span><span class="s1">&#39;MONTO_ASEGURADO&#39;</span><span class="p">]</span> 

    <span class="c1"># * Reporteria</span>
    <span class="c1"># pequeño script para que todos nuestros campos tengan guin bajo en vez de espacio</span>
    <span class="n">cols_new</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">for</span> <span class="n">col</span> <span class="ow">in</span> <span class="n">df</span><span class="o">.</span><span class="n">columns</span><span class="p">:</span>
        <span class="n">cols_new</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">col</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s1">&#39; &#39;</span><span class="p">,</span><span class="s1">&#39;_&#39;</span><span class="p">))</span>
    <span class="n">df</span><span class="o">.</span><span class="n">columns</span> <span class="o">=</span> <span class="n">cols_new</span>    
    <span class="c1"># Exportamos la salida de uso interno y la salida para los reaseguradores</span>
    <span class="n">df</span><span class="p">[</span><span class="n">df</span><span class="p">[</span><span class="s1">&#39;CONTRATO_REASEGURO&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">notnull</span><span class="p">()][</span><span class="n">campos_productos</span><span class="p">]</span><span class="o">.</span><span class="n">to_csv</span><span class="p">(</span><span class="n">ruta_salidas</span><span class="o">+</span><span class="sa">f</span><span class="s1">&#39;Detalle Renovacion </span><span class="si">{</span><span class="n">contrato</span><span class="si">}</span><span class="s1"> Uso Interno.txt.zip&#39;</span><span class="p">,</span><span class="n">sep</span><span class="o">=</span><span class="s1">&#39;;&#39;</span><span class="p">,</span><span class="n">decimal</span><span class="o">=</span><span class="s1">&#39;.&#39;</span><span class="p">,</span><span class="n">date_format</span><span class="o">=</span><span class="s1">&#39;</span><span class="si">%d</span><span class="s1">-%m-%Y&#39;</span><span class="p">,</span><span class="n">index</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
    <span class="n">df</span><span class="p">[</span><span class="n">df</span><span class="p">[</span><span class="s1">&#39;CONTRATO_REASEGURO&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">notnull</span><span class="p">()][</span><span class="n">campos_renovacion</span><span class="p">]</span><span class="o">.</span><span class="n">to_csv</span><span class="p">(</span><span class="n">ruta_salidas</span><span class="o">+</span><span class="sa">f</span><span class="s1">&#39;Detalle Renovacion </span><span class="si">{</span><span class="n">contrato</span><span class="si">}</span><span class="s1"> Reaseguradores.txt.zip&#39;</span><span class="p">,</span><span class="n">sep</span><span class="o">=</span><span class="s1">&#39;;&#39;</span><span class="p">,</span><span class="n">decimal</span><span class="o">=</span><span class="s1">&#39;.&#39;</span><span class="p">,</span><span class="n">date_format</span><span class="o">=</span><span class="s1">&#39;</span><span class="si">%d</span><span class="s1">-%m-%Y&#39;</span><span class="p">,</span><span class="n">index</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>



  </div>

    </div>

</div><!-- ::: S5_Automatizacion_Calculos -->












                
              </article>
            </div>
          
          
<script>var target=document.getElementById(location.hash.slice(1));target&&target.name&&(target.checked=target.name.startsWith("__tabbed_"))</script>
        </div>
        
      </main>
      
        <footer class="md-footer">
  
  <div class="md-footer-meta md-typeset">
    <div class="md-footer-meta__inner md-grid">
      <div class="md-copyright">
  
  
    Made with
    <a href="https://squidfunk.github.io/mkdocs-material/" target="_blank" rel="noopener">
      Material for MkDocs
    </a>
  
</div>
      
    </div>
  </div>
</footer>
      
    </div>
    <div class="md-dialog" data-md-component="dialog">
      <div class="md-dialog__inner md-typeset"></div>
    </div>
    
    
    <script id="__config" type="application/json">{"base": "..", "features": [], "search": "../assets/javascripts/workers/search.6ce7567c.min.js", "translations": {"clipboard.copied": "Copied to clipboard", "clipboard.copy": "Copy to clipboard", "search.result.more.one": "1 more on this page", "search.result.more.other": "# more on this page", "search.result.none": "No matching documents", "search.result.one": "1 matching document", "search.result.other": "# matching documents", "search.result.placeholder": "Type to start searching", "search.result.term.missing": "Missing", "select.version": "Select version"}}</script>
    
    
      <script src="../assets/javascripts/bundle.88dd0f4e.min.js"></script>
      
    
  </body>
</html>